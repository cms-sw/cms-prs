{"additions": 131, "auther_ref": "build-stats", "auther_sha": "8a7b49e404dd3b62258639463bb31d2d9cadd4f0", "author": "cms-sw", "body": "Based on #172.\r\nThese changes allows cmsBuild to make use of build stats from previous runs and optimize the parallel build of multiple packages ( as long as the cpu and memory consumption of packages is under max cpu/memory limit). The format of build stats json file should be\r\n```\r\n{\r\n  # Some default values for unknown packages\r\n  \"defaults\": {\r\n    \"cpu\": (cpu%_single_process_jobs, cpu%_multi_process_jobs),\r\n    \"rss\": (rss_in_bytes_single_process_jobs, rss_in_bytes_multi_process_jobs),\r\n    \"time\": (build_time_single_process_job, build_time_for_multi_process_jobs)\r\n  },\r\n  # maximum resources available\r\n  \"resources\":{\"cpu\": max_cpu%_available, \"rss\": max_memory_available},\r\n  # stats of packages\r\n  \"packages\": { \"name\": {\"cpu\": value, \"rss\": value, \"time\": value}},\r\n  # some defaults for known packages, first item is name of package to match and 2nd item is the index in the data[\"defaults\"] for a resource\r\n  \"known\": [\r\n    (package_regexp, index_in_default), \r\n    ]\r\n  }\r\n```\r\ne.g.\r\n```\r\n{\r\n  \"defaults\": {\r\n    \"cpu\": (50, total_cpu%/4),\r\n    \"rss\": (total_memory/total_cpu, total_memory/4),\r\n    \"time\": (1, 300)\r\n  },\r\n  \"resources\":{\"cpu\": total_cpu%, \"rss\": total_memory},\r\n  \"packages\": {\r\n    \"root\": {\"cpu\": 800, \"rss\": 8GB, \"time\": 3600},\r\n    \"boost\": {\"cpu\": 640, \"rss\": 4GB, \"time\": 1800}\r\n  },\r\n  \"known\": [\r\n    (\"^.+-toolfile$\", 0), \r\n    (\"^data-.+$\", 0),\r\n    (\"^.+$\", 1)\r\n    ]\r\n  }\r\n```\r\n\r\nhere are some build results on a 16 core build machine\r\n1- Old pkgtools with `--builders 1 -j 16` : build time 12h15 for all externals (except gcc)\r\n\r\n![old-1builder](https://user-images.githubusercontent.com/4115138/111609925-141d8a80-87db-11eb-83f9-502dd805f50e.jpg)\r\n\r\n2- Old pkgtools with  `--builders 3 -j 16` : build time 8h10 for all externals (except gcc)\r\n\r\n![old-3builders](https://user-images.githubusercontent.com/4115138/111609984-24ce0080-87db-11eb-8eb0-a44493cbac84.jpg)\r\n\r\n3- New pkgtools with  `--builders 16 -j 16 --esstats stats-from-step1.json`  : build time 5h50\r\n\r\n![new](https://user-images.githubusercontent.com/4115138/111610667-e553e400-87db-11eb-9577-1ef88b93f453.jpg)\r\n\r\n", "branch": "V00-33-XX", "changed_files": 3, "closed_at": "1616480468", "comments": 10, "commits": 5, "created_at": "1616059245", "deletions": 14, "labels": ["externals-pending", "orp-pending", "pending-signatures", "tests-approved"], "merge_commit_sha": "b2fbeec058db9d55634dcf28abcf43915d2fec84", "merged_at": "1616480468", "merged_by": "smuzaffar", "number": 173, "release-notes": [], "review_comments": 0, "state": "closed", "title": "Teach cmsBuild to make use of build stats to optimize the build time", "updated_at": "1616480468", "user": "smuzaffar"}