{"additions": 15, "auther_ref": "devel_fixFastTimerDQMTransitionsTrue", "auther_sha": "c5af5ac82fb3fa3e531a6dd94e819552d269048b", "author": "missirol", "body": "#### PR description:\r\n\r\nI encountered a seg-fault from `FastTimerService` when using `enableDQMTransitions = True` (this parameter is set to `False` by default).\r\n\r\nA reproducer is below [*]. I _think_ it comes down to initialising the pointers used as members of the subclasses of the service (in particular, those of `PlotsPerElement`).\r\n\r\nWithout initialising them, one can get a crash for example in\r\nhttps://github.com/cms-sw/cmssw/blob/52c0dacc1af916e537cb419a39ec5845ae5087bf/HLTrigger/Timer/plugins/FastTimerService.cc#L477\r\nwhen this is called from\r\nhttps://github.com/cms-sw/cmssw/blob/52c0dacc1af916e537cb419a39ec5845ae5087bf/HLTrigger/Timer/plugins/FastTimerService.cc#L766\r\nbecause `run_` does not book \"byLS\" histograms\r\nhttps://github.com/cms-sw/cmssw/blob/52c0dacc1af916e537cb419a39ec5845ae5087bf/HLTrigger/Timer/plugins/FastTimerService.cc#L719\r\nbut an (uninitialised) non-zero pointer can pass\r\nhttps://github.com/cms-sw/cmssw/blob/52c0dacc1af916e537cb419a39ec5845ae5087bf/HLTrigger/Timer/plugins/FastTimerService.cc#L476\r\nleading to a seg fault one line below.\r\n\r\nInitially, I noticed that, if `enableDQM=False` (or if `enableDQM=True`, but the `DQMStore` service is not available) and `enableDQMTransitions=True`, `plots_.book` is not called, but `plots_.fill_lumi` and `plots_.fill_run` are still attempted, e.g.\r\nhttps://github.com/cms-sw/cmssw/blob/52c0dacc1af916e537cb419a39ec5845ae5087bf/HLTrigger/Timer/plugins/FastTimerService.cc#L1071\r\nIf the pointers are initialised to zero, there will not be a seg fault in any case, but I tried to improve the logic of the `if` clause preceding `fill_lumi/run` just for clarity (I initially thought this check was the problem, but this alone does not solve the seg-faults, because of the uninitialised pointers).\r\n\r\nMerely technical. No changes expected.\r\n\r\n[*]\r\n```py\r\nimport FWCore.ParameterSet.Config as cms\r\n\r\n# Process\r\nprocess = cms.Process('DQM')\r\n\r\nprocess.options.numberOfThreads = 4\r\nprocess.options.numberOfStreams = 0\r\nprocess.options.numberOfConcurrentLuminosityBlocks = 2\r\n\r\nprocess.maxEvents.input = 200\r\n\r\n# Source (EDM input)\r\nprocess.source = cms.Source('PoolSource',\r\n  fileNames = cms.untracked.vstring('/store/data/Run2022B/HLTPhysics/RAW/v1/000/355/456/00000/69b26b27-4bd1-4524-bc18-45f7b9b5e076.root')\r\n)\r\n\r\nprocess.load('DQMServices.Core.DQMStore_cfi')\r\n\r\n# FastTimerService (Service)\r\nfrom HLTrigger.Timer.FastTimerService_cfi import FastTimerService as _FastTimerService\r\nprocess.FastTimerService = _FastTimerService.clone(\r\n  dqmTimeRange = 2000,\r\n  enableDQM = True,\r\n  enableDQMTransitions = True,\r\n  enableDQMbyLumiSection = True,\r\n  enableDQMbyModule = True,\r\n  enableDQMbyPath = True,\r\n  enableDQMbyProcesses = True\r\n)\r\n```\r\n\r\n#### PR validation:\r\n\r\nTests with the reproducer.\r\n\r\n#### If this PR is a backport, please specify the original PR and why you need to backport that PR. If this PR will be backported, please specify to which release cycle the backport is meant for:\r\n\r\nN/A (small bugfix, maybe worth backports)", "branch": "master", "changed_files": 2, "closed_at": "1671525784", "comments": 7, "commits": 1, "created_at": "1671101749", "deletions": 15, "labels": ["hlt-approved", "fully-signed", "tests-approved", "orp-approved", "code-checks-approved"], "merge_commit_sha": "b8f6c0b331d49a3f0a4005dc677b22964ca2bf0d", "merged_at": "1671525784", "merged_by": "cmsbuild", "milestone": "CMSSW_13_0_X", "number": 40325, "release-notes": [], "review_comments": 0, "state": "closed", "title": "initialise pointers in subclasses of `FastTimerService`", "updated_at": "1671525784", "user": "missirol"}