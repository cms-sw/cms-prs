{"additions": 173, "auther_ref": "alpakaReducedEventSynchronize_140x", "auther_sha": "f6fc62f23cb96c818fe5f838d1e3d389e76b3f0b", "author": "fwyzard", "body": "#### PR description:\r\n\r\nBackport #44841 by @makortel to CMSSW 14.0.x:\r\n\r\n> Prompted by [#44769 (comment)](https://github.com/cms-sw/cmssw/issues/44769#issuecomment-2067257800) this PR reduces the amount of blocking `alpaka::wait()` calls (leading to `cudaEventSynchronize()` on NVIDIA GPU) via the EDMetadata destructor. To check the impact I used the reproducer #44769 (even if it eventually leads to an assertion failure). Initially the reproducer lead to 2470 calls to `cudaEventSynchronize()`.\r\n> \r\n> The first commit avoids calling `alpaka::wait()` in `EDProducer::produce()` when no asynchronous work was launched (possible async work is identified by the use of `device::Event::queue()` in any way, including consuming a device side data product). In this case there is no need to synchronize the device and host. This commit reduced the number of `cudaEventSynchronize()` calls to 2284 (-7.5 %).\r\n> \r\n> The second commit caches the alpaka::Event completion, so that `alpaka::wait()` does not need to be called again on an already-completed alpaka Event. This commit reduced the number of `cudaEventSynchronize()` calls to 2019 (-18 % wrt the starting point).\r\n> \r\n> The third commit avoids calling `alpaka::wait()` on the destructor of an `EDMetadata` when the Queue of the `EDMetadata` object has been re-used by another `EDMetadata` (in an `EDProducer::produce()` that consumed the device-side data product holding the first `EDMetadata` object). Since the only purpose of the `alpaka::wait()` in the `~EDMetadata()` is to ensure all asynchronous work of an edm::Event has completed before the edm::Stream moves to the next edm::Event, for any Queue it is enough to `wait()` on the alpaka::Event that was last recorded on that Queue. This commit reduced the number of `cudaEventSynchronize()` calls to 1462 (-40 % wrt the starting point).\r\n> \r\n> There is one case left (on purpose) where the `EDProducer::produce()` still calls `alpaka::wait()`. This happens when the `produce()` launches asynchronous work (i.e. calls `device::Event::queue()`), but does not produce any device-side data products. I can't imagine a good use case for such an EDProducer (except maybe a DQM-style module, but that would need a separate module base class in any case that could then deal with the necessary edm::Event-level synchronization\r\n> \r\n> I don't expect a huge impact from the reduction of these calls, as in the present cases in HLT the alpaka::Events should have completed by the time the `alpaka::wait()` is called. The stack traces in [#44769 (comment)](https://github.com/cms-sw/cmssw/issues/44769#issuecomment-2066613569) nevertheless show the `cudaEventSynchronize()` acquiring a lock even when the CUDA event was complete at the time the event was recorded, so at least this PR should reduce the contention on that lock.\r\n> \r\n> Resolves [cms-sw/framework-team#902](https://github.com/cms-sw/framework-team/issues/902)\r\n\r\n#### PR validation:\r\n\r\n`HeterogeneousCore/Alpaka{Core,Test}` unit tests pass.\r\n\r\nTest with a recent HLT menu on top of `CMSSW_14_0_5_patch2` shows a minor improvement in throughout:\r\n  - `CMSSW_14_0_5_patch2`: 670.5  1.9 ev/s\r\n  - with these changes: 673.0  2.0 ev/s\r\n\r\n#### If this PR is a backport please specify the original PR and why you need to backport that PR. If this PR will be backported please specify to which release cycle the backport is meant for:\r\n\r\nBackport of #44841 to CMSSW 14.0.x for data taking.", "branch": "CMSSW_14_0_X", "changed_files": 12, "closed_at": "1714586769", "comments": 9, "commits": 3, "created_at": "1714068883", "deletions": 10, "labels": ["fully-signed", "tests-approved", "orp-approved", "backport-ok", "heterogeneous-approved"], "merge_commit_sha": "93bb4f9aa8eb6ab6af21b7f8089e713c317f87ea", "merged_at": "1714586769", "merged_by": "cmsbuild", "milestone": "CMSSW_14_0_X", "number": 44854, "release-notes": [], "review_comments": 0, "state": "closed", "title": "Reduce Alpaka event synchronization calls via EDMetadata [14.0.x]", "updated_at": "1714586770", "user": "fwyzard"}