{"additions": 931, "auther_ref": "more_configurable_ca_hion", "auther_sha": "0c04805cf8796429f3a0fba7b134d5d13f5727fb", "author": "AdrianoDee", "body": "This PR proposes some modifications to the GPU (CUDA based) pixel track reconstruction in order, also, to be run smoothly for HIon events. The modifications include:\r\n\r\n1. definition of a new `HIonPhase1` pixel topology;\r\n2. adding `maxNumClustersPerModules` to `TrackerTraits` and increasing it to `2048` for HIon operations (and exampanding the `blockPrefixScan` for the `clusterChargeCut`);\r\n4. making the constants in `gpuCalibPixel` (such as the gains and the readout modes) configurable at run-time extending `SiPixelClusterThresholds` struct. This is not strictly needed but I feel would ease the things in future if these constants need to be changed;\r\n5. templating also `SiPixelRawToClusterCUDA` in order to include the changes when using an HIon topology (note that the name change is needed since, as far as I have understood, HLT would need to have both module names defined in the same release to do the migration);\r\n6. making `maxNumberOfDoublets`, `z0Cut`, `ptCut` and `phiCuts` configurable at run time (this will be needed to run offline pixel tracking/seeding on GPU);\r\n7. adding workflows for pixel tracking only reconstruction for HIon conditions for both \"legacy\" (`*.5`) and \"Patatrack\" (`*.501`,`*.502`) together with `Hydjet_Quenched_MinBias_5020GeV_cfi` and `Hydjet_Quenched_MinBias_5362GeV_cfi` in the matrix;\r\n8. adding Patatrack variants (`.501` and `.502`) for GPU-like `hiConformalPixelTracks` for `160` workflow; \r\n9. allows to run pixel vertexing without the splitting kernel (`doSplitting` flag), useless for HIon operations, given also that too much shared memory would be needed for the average number of tracks per vertices ([`MAXTK`](https://github.com/cms-sw/cmssw/blob/master/RecoTracker/PixelVertexFinding/plugins/gpuSplitVertices.h#L43)) in PbPb conditions;\r\n\r\nAny comment on this by HIon people is very welcome, especially on the w.f.s introduced.\r\n\r\nSolves #40623 #37425.\r\n\r\n## HI Physics performance plots\r\n\r\nHIon pixel tracking performance for:\r\n\r\n- online-like setup on with w.f. `14950.502_HydjetQMinBias_5362GeV+2023HI_Patatrack_PixelOnlyGPU` [here](https://adiflori.web.cern.ch/adiflori/hi_plots/pixel_tracks/);\r\n- offline `hiConformalPixelTracks` with w.f. `160.502_HydjetQ_MinBias_5362GeV_2023_ppReco` [here](https://adiflori.web.cern.ch/adiflori/hi_plots/conformal/);\r\n\r\nNote: these performance may be improved or changed and the sizes of the structures should be better tuned to fit the T4@P5 memory. But I'd leave this to HIon people that know better than me what they need. This PR is here to give the skeleton/template and to may way easier the validation and tuning.\r\n\r\n## Run2 2018 Data Throughput plots\r\n\r\nThe pp performance are basically untouched both in physics and throughput.\r\n\r\nOn `/EphemeralHLTPhysics1/Run2018D-v1/RAW` `run=323775` `lumi=53`\r\n\r\n![zoom-136.885502.png](https://adiflori.web.cern.ch/pulls/0021156c0eb6644f48fb9a0a9194f78ded7481bc/zoom.png)\r\n\r\n------\r\n\r\n### 10 July 2023 Update\r\n\r\nAddressed comments (from@fwyzard). Mostly:\r\n- restoring constant names for clustering thresholds under `CUDADataFormats/SiPixelCluster/interface/gpuClusteringConstants.h`;\r\n- clean up, removing duplicates, extra lines, adding explanatory comments, using `static_cast<T>` where needed; \r\n- allowing the `gpuClusterChargeCut` to run for more than `2*maxThreads` clusters per module;\r\n- protecting HIon and Phase 2 conflicts with `~phase2_tracker`;\r\n\r\nList of modules for @Martin-Grunewald .\r\n\r\nUnder `DQM/SiPixelHeterogeneous/`\r\n\r\n-`SiPixelHIonPhase1CompareRecHitsSoA` \r\n-`SiPixelHIonPhase1CompareTrackSoA`\r\n-`SiPixelHIonPhase1MonitorRecHitsSoA`\r\n-`SiPixelHIonPhase1MonitorTrackSoA`\r\n\r\nUnder `RecoLocalTracker/SiPixelClusterizer/`\r\n-`SiPixelDigisClustersFromSoAHIonPhase1`\r\n-`SiPixelRawToClusterCUDAHIonPhase1`\r\n\r\nUnder `RecoLocalTracker/SiPixelRecHits/`\r\n-`PixelCPEFastESProducerHIonPhase1`\r\n-`SiPixelRecHitCUDAHIonPhase1`\r\n-`SiPixelRecHitFromCUDAHIonPhase1`\r\n-`SiPixelRecHitSoAFromCUDAHIonPhase1`\r\n-`SiPixelRecHitSoAFromLegacyHIonPhase1`\r\n\r\nUnder `RecoTracker/PixelSeeding/`\r\n-`CAHitNtupletCUDAHIonPhase1`\r\n\r\nUnder `RecoTracker/PixelTrackFitting/`\r\n-`PixelTrackDumpCUDAHIonPhase1`\r\n-`PixelTrackProducerFromSoAHIonPhase1`\r\n-`PixelTrackSoAFromCUDAHIonPhase1`\r\n\r\nUnder `RecoTracker/PixelVertexFinding/`\r\n-`PixelVertexProducerCUDAHIonPhase1`\r\n\r\n\r\nTODO: re-produce throughput plots.\r\n\r\n(FYI @denerslemos)\r\n", "branch": "master", "changed_files": 64, "comments": 92, "commits": 2, "created_at": "1683812096", "deletions": 291, "labels": ["reconstruction-pending", "dqm-pending", "geometry-pending", "pending-signatures", "tests-approved", "orp-pending", "pdmv-pending", "upgrade-pending", "code-checks-approved", "heterogeneous-pending", "tracking", "trk"], "milestone": "CMSSW_13_2_X", "number": 41632, "release-notes": [], "review_comments": 79, "state": "open", "title": "More Configurable Pixel Tracks and HIon Template", "updated_at": "1689092185", "user": "AdrianoDee"}