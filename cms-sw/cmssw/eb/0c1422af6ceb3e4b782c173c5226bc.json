{"additions": 578, "auther_ref": "digimorphing_backport_v2", "auther_sha": "0e4b133ad9ae481ecb610f0ad2784d3f9258504f", "author": "CMSTrackerDPG", "body": "#### PR description:\r\n\r\n# Morphing Algorithm for Fake Digi Addition\r\n\r\nBackport of https://github.com/cms-sw/cmssw/pull/48734 to CMSSW_15_0_X\r\n\r\nThis PR introduces an alternative alpaka-based algorithm for pixel digi morphing. This implementation is equivalent in principle to the legacy implementation and to the other alpaka-based implementation in PR [#48343](https://github.com/cms-sw/cmssw/pull/48343) but supercedes the latter as it has issues with throughput due to memory usage. Like the other implementations, digi morphing is applied here only to specific detector regions which can be configured as shown below.\r\n\r\n## Configuration Options\r\n\r\nThe morphing behavior can be controlled in the EDProducer configuration with the following options:\r\n\r\n- **Enable Morphing:**\r\n  ```python\r\n  DoDigiMorphing = cms.bool(True)  # Default: False\r\n  ```\r\n- **Maximum Fakes per Module:**\r\n  ```python\r\n  MaxFakesInModule = cms.uint32(10000)  # Default: maxPixInModule * 2 / 5\r\n  ```\r\n\r\n## Regional Morphing\r\n\r\nRegions can be specified in the configuration as follows:\r\n\r\n- **Barrel Regions:**  \r\n  Use `LAYER,LADDER,MODULE` coordinates, with support for individual values or ranges (e.g., `1-12` for ladders 1 through 12).\r\n  ```python\r\n  barrelRegions = cms.vstring(\r\n      \"1,1-12,1-2\",\r\n      \"1,1-12,7-8\",\r\n      \"2,1-28,1\",\r\n      \"2,1-28,8\"\r\n  )  # Default: as shown above\r\n  ```\r\n\r\n- **Endcap Regions:**  \r\n  Use `DISK,BLADE,SIDE,PANEL` coordinates, with support for ranges.\r\n  ```python\r\n  endcapRegions = cms.vstring(\r\n      # Default: empty (no endcap regions selected)\r\n  )\r\n\r\nAlso includes fixes for digi morphing https://github.com/cms-sw/cmssw/pull/49021 backported to CMSSW_15_0_X. These fixes are needed for digi morphing to work properly for differen conditions (when acitve or not):\r\n\r\n- defining a `maxPixInModuleForMorphing` constant depending on the `TrackerTraits` to be used to define the number of threads for the `FindClus` kernel. This also sizes the histogram holding the pixels in a module:\r\n```python\r\nusing Hist = cms::alpakatools::HistoContainer<uint16_t,\r\n                                                      TrackerTraits::clusterBinning,\r\n                                                      TrackerTraits::maxPixInModuleForMorphing,\r\n                                                      TrackerTraits::clusterBits,\r\n                                                      uint16_t>;                                                      \r\n```\r\n- having a different `maxIterGPU` per topology (given the different number of pixels affects the number of iterations we can use to cover the full module);\r\n- limiting the `maxFakesInModule` configuration parameter to take into account the `maxPixInModuleForMorphing` max to avoid the histogram overflowing.\r\n\r\n#### PR validation:\r\n\r\nValidation results can be found here: https://indico.cern.ch/event/1567986/contributions/6647897/attachments/3116797/5527819/HLT_digi_morphing_validation.pdf", "branch": "CMSSW_15_0_X", "changed_files": 6, "closed_at": "1759819525", "comments": 26, "commits": 4, "created_at": "1756815263", "deletions": 50, "labels": ["geometry-pending", "reconstruction-approved", "pending-signatures", "tests-approved", "orp-approved", "urgent", "backport-ok", "heterogeneous-approved", "trk"], "merge_commit_sha": "bf53d59be3aaddb7e71bac49fac4dd9b40df0ad2", "merged_at": "1759819525", "merged_by": "cmsbuild", "milestone": "CMSSW_15_0_X", "number": 48832, "release-notes": [], "review_comments": 0, "state": "closed", "title": "[15_0_X] Digi Morphing for HLT", "updated_at": "1759819526", "user": "Chirayu18"}