{"additions": 671, "auther_ref": "deepsc-opt-zeropad-13_0_0pre4", "auther_sha": "582e8e1e832de0e397093e4ccdb3903494bc6574", "author": "valsdav", "body": "#### PR description:\r\n\r\nThis PR implements an optimization of the DeepSC model inference in Tensorflow. \r\n\r\nGiven the large timing difference between models with small/large zero-padded inputs, the idea is to evaluate two different models (with the same weights), but exported with a different internal padding size.\r\n\r\nOne model with a small zero-padding dimension (N. clusters = 15, max N. rechits = 20, configurable in the producer) and one has  the maximum dimension (N. clusters = 60, max N. rechits = 60).  The correct model to run is selected dynamically by the CMSSW code.    N.B: only one model is trained, and then exported with two different input size (TensorFlow technicality).\r\n\r\nIn general, the dynamic zero-padding strategy speeds up the evaluation up to ~8X.\r\nThe improvement is due to the fact that on average 90% of the windows are evaluated with the smaller\r\nzero-padding, much faster, model. \r\n\r\nMoreover the DeepSC model has been simplified from the version currently available in CMSSW to get a 4X speed-up (simpler rechits layer).\r\n\r\n![](https://dvalsecc.web.cern.ch/public/images/perf/cmssw_timing.png)\r\n\r\n#### Profiling\r\n\r\nProfiled the model on 100 ttbar events\r\n\r\n  - no zero-padding optimization [igprof](https://dvalsecc.web.cern.ch/cgi-bin/igprof-navigator/DeepSC/PR131X/pfthres_cl60_rl60_step3_igprofCPU/69).    `PFECALSuperClusterAlgo::buildAllSuperClustersDeepSC`  Rank [69] Reco time: 1.90%\r\n  - zero padding optimization [igprof](https://dvalsecc.web.cern.ch/cgi-bin/igprof-navigator/DeepSC/PR131X/pfthres_cl15_rl20_step3_igprofCPU/252).  `PFECALSuperClusterAlgo::buildAllSuperClustersDeepSC`  Rank [252] Reco time: 0.35%\r\n\r\n\r\n#### Documentation\r\n- [Poster](https://dvalsecc.web.cern.ch/public/posts/acat2202-deepsc-cms/) at ACAT2022: \r\n- Presentation at ML production meeting:  [indico](https://indico.cern.ch/event/1219538/#4-deepsc-inference-time-optimi )\r\n\r\n#### PR validation:\r\n\r\nTo be tested along with the updated models in PR https://github.com/cms-data/RecoEcal-EgammaClusterProducers/pull/4.\r\n", "branch": "master", "changed_files": 11, "comments": 40, "commits": 4, "created_at": "1677773995", "deletions": 128, "labels": ["reconstruction-pending", "pending-signatures", "tests-approved", "orp-pending", "requires-external", "code-checks-rejected"], "milestone": "CMSSW_16_0_X", "number": 40934, "release-notes": [], "review_comments": 0, "state": "open", "title": "Zero-padding optimization for DeepSC inference", "updated_at": "1757484218", "user": "valsdav"}