{"additions": 70, "auther_ref": "fastsim-refine-btagdeepflav-CHS", "auther_sha": "cc242848cb1f15727aa708df8bea2aa25144adfe", "author": "wolfmor", "body": "#### PR description:\r\n\r\n<!-- Please replace this text with a description of the feature proposed or problem addressed, specifying:\r\n  - what changes are expected in the output if any, \r\n  - what other PRs or externals it depends upon if any,\r\n  - link to any additional material useful to provide a documentation for this PR (slides, JIRA tickets, related pull requestes, hypernews, TWiki or Indico pages)  -->\r\nRequires: https://github.com/cms-data/PhysicsTools-NanoAOD/pull/14\r\n\r\nThis PR adds a function that uses a regression neural network to refine the DeepJet discriminators of CHS jets in NanoAOD for FastSim to better match FullSim. The function can be called by including the option `--customise PhysicsTools/NanoAOD/jetsAK4_CHS_cff.nanoAOD_refineFastSim_bTagDeepFlav` in the cmsDriver command and requires the ONNX model added in the above mentioned PR to cms-data. The original values are copied to new variables named with the suffix \"unrefined\".\r\n\r\nDue to a bug in ONNX runtime 1.10.0 (see [here](https://github.com/microsoft/onnxruntime/issues/10305)) graph optimization has to be disabled to evaluate the model. The corresponding option is implemented in BaseMVAValueMapProducer for the ONNX backend.\r\n\r\nThe technique has been presented at the [FastSim Days 2022 Workshop](https://indico.cern.ch/event/1191657/contributions/5016864/).\r\n\r\nA complete set of commands to produce NanoAOD files with refined DeepJet discriminators is:\r\n\r\n`cmsDriver.py TTbar_13TeV_TuneCUETP8M1_cfi  --relval 100000,1000 -s GEN,SIM,RECOBEFMIX,DIGI:pdigi_valid,L1,DIGI2RAW,L1Reco,RECO,VALIDATION:@standardValidation,DQM:@standardDQMFS -n 10 --conditions auto:run2_mc --beamspot Realistic25ns13TeV2016Collision --datatier GEN-SIM-DIGI-RECO,DQMIO --eventcontent FEVTDEBUGHLT,DQM --fast  --era Run2_2016\r\nGEN,SIM,RECOBEFMIX,DIGI:pdigi_valid,L1,DIGI2RAW,L1Reco,RECO,VALIDATION:@standardValidation,DQM:@standardDQMFS`\r\n\r\n`cmsDriver.py step3  -s PAT --era Run2_2016 -n -1 --conditions auto:run2_mc --mc  --datatier MINIAODSIM --eventcontent MINIAODSIM --filein file:TTbar_13TeV_TuneCUETP8M1_cfi_GEN_SIM_RECOBEFMIX_DIGI_L1_DIGI2RAW_L1Reco_RECO_VALIDATION_DQM.root --fast`\r\n\r\n`cmsDriver.py  --python_filename NanoAODrefined_cfg.py --eventcontent NANOAODSIM --fast --customise Configuration/DataProcessing/Utils.addMonitoring,PhysicsTools/NanoAOD/jetsAK4_CHS_cff.nanoAOD_refineFastSim_bTagDeepFlav --datatier NANOAODSIM --fileout file:step3_NANO.root --conditions auto:run2_mc --step NANO --filein \"file:step3_PAT.root\" --era run2_nanoAOD_106Xv2 --mc -n -1`\r\n\r\n#### PR validation:\r\n\r\n<!-- Please replace this text with a description of which tests have been performed to verify the correctness of the PR, including the eventual addition of new code for testing like unit tests, test configurations, additions or updates to the runTheMatrix test workflows -->\r\nThe neural network has been trained on GEN-synchronized FastSim/FullSim jet pairs from SUSY simplified model T1tttt events and has been validated also in TTbar events. In both cases, considerably improved agreement with the FullSim output and an improvement in correlations among output observables and external parameters is seen.\r\n\r\n#### If this PR is a backport please specify the original PR and why you need to backport that PR. If this PR will be backported please specify to which release cycle the backport is meant for:\r\n\r\n<!-- Please replace this text with any link to the master PR, or the intended backport release cycle numbers -->\r\n\r\nBefore submitting your pull requests, make sure you followed this checklist:\r\n- verify that the PR is really intended for the chosen branch\r\n- verify that changes follow [CMS Naming, Coding, And Style Rules](http://cms-sw.github.io/cms_coding_rules.html)\r\n- verify that the PR passes the basic test procedure suggested in the [CMSSW PR instructions](https://cms-sw.github.io/PRWorkflow.html)\r\n\r\n<!-- Please delete the text above after you verified all points of the checklist  -->\r\n", "branch": "CMSSW_12_6_X", "changed_files": 2, "closed_at": "1674025823", "comments": 3, "commits": 3, "created_at": "1673970967", "deletions": 3, "labels": ["reconstruction-pending", "pending-signatures", "tests-pending", "orp-pending", "xpog-pending"], "milestone": "CMSSW_12_6_X", "number": 40550, "release-notes": [], "review_comments": 0, "state": "closed", "title": "Add function to refine FastSim DeepJet discriminators", "updated_at": "1674025824", "user": "wolfmor"}