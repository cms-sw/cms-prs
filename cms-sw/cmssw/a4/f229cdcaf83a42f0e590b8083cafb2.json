{"additions": 33, "auther_ref": "FastSim_onCal_bugs", "auther_sha": "c8827f1a5f68ea5d4fb52a070404f46ee1b178fd", "author": "kpedro88", "body": "#### PR description:\r\n\r\nRecent technical work on the FastSim codebase has revealed several bugs in the calorimetry routines:\r\n1. Particles with negative values for `on*cal` (Ecal, Hcal, VFcal = HF) did not have their energy deposited / hits stored (roughly a per mille effect). Fix: use `abs(on*cal)`.\r\n2. Particles with nonzero values for both `onVFcal` and at least one other `on*cal` (in the endcap-forward transition region) had random hits stored (whatever was leftover in the hit map member variable in the HF shower library class). Fix:\r\n    * `clear()` the hit map immediately after storing its hits\r\n    * make the logic used for hit storage consistent: check `onEcal` and `onHcal` instead of `onVFcal`, in order to store the hits from the endcap shower simulation, which is actually used to simulate these transition region particles\r\n3. Hits in the HF had shower library corrections applied, even if the hits were not from the shower library simulation (again, whatever was leftover in the energy correction member variables in the HCAL response class). Fix:\r\n    * reset the energy correction member variables immediately after storing hits\r\n    * make the logic used for corrections more specific: only apply to hits that actually came from the shower library\r\n\r\nThe latter two bugs, which are more impactful, have existed since the introduction of the shower library in FastSim for Run 2 (#6854). The first bug may have existed even longer, since even the original FastSim particle propagation routine from Run 1 could potentially produce negative values for `on*cal`.\r\n\r\n#### PR validation:\r\n\r\nThe bug fixes implemented here lead to changes in the physics. These have been tested to ensure their impact looks physically reasonable.\r\n\r\nFastSim before vs. after the fixes, at the SimHit level:\r\n<details>\r\n<summary>HCAL hit multiplicity</summary>\r\n\r\n<img width=\"1276\" height=\"1252\" alt=\"HcalIeta\" src=\"https://github.com/user-attachments/assets/d2f03718-0ec9-4c20-b820-d60b8fea4c2b\" />\r\n</details>\r\n<details>\r\n<summary>HCAL hit energy</summary>\r\n\r\n<img width=\"1276\" height=\"1252\" alt=\"HcalIetaWt\" src=\"https://github.com/user-attachments/assets/4b8f24fd-719e-4168-b118-0d0068271a41\" />\r\n</details>\r\n\r\nFastSim vs. FullSim for MET:\r\n\r\n<details>\r\n<summary>Before fixes</summary>\r\n\r\n<img width=\"1276\" height=\"1252\" alt=\"PuppiMET_pt\" src=\"https://github.com/user-attachments/assets/3ac4d179-c187-41d6-97b2-5f648e886479\" />\r\n</details>\r\n<details>\r\n<summary>After fixes</summary>\r\n\r\n<img width=\"1276\" height=\"1252\" alt=\"PuppiMET_pt\" src=\"https://github.com/user-attachments/assets/8f065f12-50b3-45cc-bb5c-fd4e22d224ce\" />\r\n</details>\r\n\r\nMore detailed step-by-step validation of each bug fix was presented in the SIM meeting: https://indico.cern.ch/event/1618164/\r\n\r\n#### If this PR is a backport please specify the original PR and why you need to backport that PR. If this PR will be backported please specify to which release cycle the backport is meant for:\r\n\r\nNot a backport. It may be backported to earlier releases for production, depending on inputs from other areas (PPD, PC).\r\n", "branch": "master", "changed_files": 6, "comments": 6, "commits": 6, "created_at": "1764964726", "deletions": 16, "labels": ["fastsim-pending", "pending-signatures", "tests-approved", "orp-pending", "code-checks-approved"], "milestone": "CMSSW_16_0_X", "number": 49562, "release-notes": [], "review_comments": 0, "state": "open", "title": "FastSim calorimetry bug fixes", "updated_at": "1764973087", "user": "kpedro88"}