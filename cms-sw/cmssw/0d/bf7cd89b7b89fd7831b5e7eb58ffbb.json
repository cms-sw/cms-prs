{"additions": 2, "auther_ref": "clang-fix-link-RecoTracker-TkDetLayers-v2", "auther_sha": "9d550f797437dd4dea27750a0d00ce9f5ffdc15b", "author": "davidlt", "body": "The following fix is required due to a behavior difference between Clang\nand GCC. Clan does not correctly emulate GCC visibility pragma.\n\nSee PR22254: http://llvm.org/bugs/show_bug.cgi?id=22254\n\nThe link error involved the following two symbols:\n- `Plane::tangentPlane(Point3DBase<float, LocalTag> const&) const`\n- `Plane::tangentPlane(Point3DBase<float, GlobalTag> const&) const`\n\nOn link command we have `libTrackingToolsDetLayers.so` and\n`libTrackingToolsGeomPropagators.so`, which have undefined references\nfor above two symbols. These are usually resolved on dynamic loading.\n\nOn Clang `TECLayer.o` marked these particular symbols as HIDDEN.\n\n**Clang:**\n\n```\n  182: 0000000000000000     0 NOTYPE  GLOBAL HIDDEN   UND\n_ZNK5Plane12tangentPlaneERK11Point3DBaseIf8LocalTagE\n  183: 0000000000000000     0 NOTYPE  GLOBAL HIDDEN   UND\n_ZNK5Plane12tangentPlaneERK11Point3DBaseIf9GlobalTagE\n```\n\n**GCC:**\n\n```\n  261: 0000000000000000     0 NOTYPE  GLOBAL DEFAULT  UND\n_ZNK5Plane12tangentPlaneERK11Point3DBaseIf9GlobalTagE\n  262: 0000000000000000     0 NOTYPE  GLOBAL DEFAULT  UND\n_ZNK5Plane12tangentPlaneERK11Point3DBaseIf8LocalTagE\n```\n\n`TkDetUtil.h` inside visibility pragma section has forward declaration\nof class `Plane`. Thus Clang marked it as HIDDEN. Then linker was\ncomplaining that two libraries mentioned above reference a HIDDEN\nsymbols, which is not allowed as these sybmols are not public API.\n\nIn GCC `Plane` is with DEFAULT visbility, because the first declaration\nwins, thus the DEFAULT visibility. You cannot modify it later on.\n\nLesson here: do not add forward declaration for publicly available\nclasses in pragma visibility hidden section.\n\nSigned-off-by: David Abdurachmanov David.Abdurachmanov@cern.ch\n", "branch": "CMSSW_7_4_X", "changed_files": 1, "closed_at": "1421775987", "comments": 9, "commits": 1, "created_at": "1421612481", "deletions": 2, "labels": ["comparison-available", "pending-signatures", "reconstruction-pending", "tests-approved"], "merge_commit_sha": "0b9b9f451666fedff73d141e97369b923312cb0c", "merged_at": "1421775987", "merged_by": "ktf", "milestone": "Next CMSSW_7_4_X", "number": 7259, "release-notes": [], "review_comments": 0, "state": "closed", "title": "RecoTracker/TkDetLayers: resolve link issue with Clang", "updated_at": "1421873074", "user": "davidlt"}