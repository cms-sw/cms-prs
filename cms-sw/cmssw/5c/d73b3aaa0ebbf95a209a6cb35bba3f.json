{"additions": 84, "auther_ref": "ES_PopConAnalyzer", "auther_sha": "77461bc94e44fd4ba9b859ac56c189a9fb05b1e9", "author": "cms-AlCaDB", "body": "#### PR description:\r\n\r\nReviewing https://github.com/cms-sw/cmssw/pull/49556 I found several problems with proposed [CondTools/Hcal/plugins/HcalPulseDelaysPopConAnalyzer.cc](https://github.com/cms-sw/cmssw/pull/49556/changes#diff-cc48c1cf78b5745c2219e7efa85b9846a5c5e2aa860498cd90a0f3b3fa1faa1d) and many other (~40) PopConAnalyzers in CondTools/Hcal.\r\n\r\nThis PR introduced a base class for these PopConAnalyzers and corresponding PopConSourceHandlers that fix the problems. As an example `CastorElectronicsMapPopConAnalyzer` is refactored using this base class.\r\nNote: `initObject` was renamed to `initPayload`\r\n\r\nWith `HCalPulseDelays` as example, the problems are:\r\n1. Defnining duplicate members `m_source` and `m_populator` results in 2 separate instances of these fields (e.g. `HcalPulseDelaysPopConAnalyzer::m_source` and `PopConAnalyzer::m_source` ). Its not a proper use of inheritance and is dangerous and error-prone with any future changes (eg. access to `m_source` from the base `PopConAnalyzer` will access a different instance of the source).\r\n2. Re-implementing `write()` is a (potentially unecessary) code duplication\r\n3. `myDBObject` should not be defined as a raw pointer. Running `HcalPulseDelaysPopConAnalyzer.analyze` mutliple times (i.e. for multiple events) would result with a memory leak. It would be much better to use `unique_ptr` and `std::move` when calling `source.initObject()` to transfer the ownership. Accordingly `initObject()` should take a `unique_ptr` as the parameter to express taking ownership.\r\n\r\nProblem 3\\. is easy to fix by changing `myDbObject` and the parameter of `initObject` to `unique_ptr` .\r\n\r\nBecause `m_source`, `m_populator`, `write` and `endJob` are private is tricky to fix point 1. and 2. My idea is to move `source.initObject(myDBObject);` to `.analyze(...)` . This would allow not to redefine `write()` and using `source()` getter would allow not to redefine `m_source`.\r\n\r\nIt needs  to be confirmed that this would result in the same logic and behaviour. The difference I see is that it would be then run for every event instead of once, in `endJob()` . From what I understand `HcalPulseDelaysPopConAnalyzer` (and other `PopConAnalyzers` with the same pattern) is not meant to be run for multiple events (as multiple execution of `anaylze` would result in a memory leak), thus this change of behaviour resulting from moving `initObject` to `analyze` is not a problem. If this is not appropriate, let me know and I'll present an alternative solution.\r\n\r\n#### PR validation:\r\n\r\nTested by running `dbwriteCastorElectronicsMap_cfg.py` modified for writing to local sqlite and confirming that it wrote a payload to the db.\r\n\r\n#### If this PR is a backport please specify the original PR and why you need to backport that PR. If this PR will be backported please specify to which release cycle the backport is meant for:\r\n\r\n<!-- Please replace this text with any link to the master PR, or the intended backport release cycle numbers -->\r\n\r\nBefore submitting your pull requests, make sure you followed this checklist:\r\n- verify that the PR is really intended for the chosen branch\r\n- verify that changes follow [CMS Naming, Coding, And Style Rules](http://cms-sw.github.io/cms_coding_rules.html)\r\n- verify that the PR passes the basic test procedure suggested in the [CMSSW PR instructions](https://cms-sw.github.io/PRWorkflow.html)\r\n\r\n<!-- Please delete the text above after you verified all points of the checklist  -->\r\n", "branch": "master", "changed_files": 5, "comments": 6, "commits": 2, "created_at": "1769154157", "deletions": 105, "labels": ["db-pending", "pending-signatures", "tests-pending", "orp-pending", "code-checks-pending"], "milestone": "CMSSW_16_1_X", "number": 49905, "release-notes": [], "review_comments": 6, "state": "open", "title": "DRAFT: Base classes for refactor of CondTools/Hcal PopConAnalyzers and PopConSourceHandlers", "updated_at": "1769430884", "user": "JanChyczynski"}