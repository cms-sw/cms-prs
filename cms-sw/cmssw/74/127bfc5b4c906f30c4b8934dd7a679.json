{"additions": 2964, "auther_ref": "dd4hep_perf_3", "auther_sha": "8121aeb803d03f02e44b78c63bee66446e2dacde", "author": "ghugo83", "body": "This is based on the exact same observation as in https://github.com/cms-sw/cmssw/pull/32505 : when SpecPar blocks have the same name, all their paths are stacked together. This results in irrelevant paths (with regex) being looped over, hence a performance penalty.\r\n\r\nhttps://github.com/cms-sw/cmssw/pull/32505 proposed a simple fix for the Tracker (just addressing the issue directly in the XMLs); this is the equivalent for HCAL.\r\nUnnecessary HCAL paths (with regex) were looped over, for example at https://github.com/cms-sw/cmssw/blob/master/SimG4Core/Geometry/src/DD4hep_DDG4Builder.cc#L62\r\n\r\n**Summary of performance gains for FULL step 1 with DD4hep workflow (entire step with all initializations + XML parsing + CMS geo construction, up to event generation).**\r\nZMM, Run3, on my local (obviously only the order of magnitude is relevant).\r\n- **https://github.com/cms-sw/cmssw/pull/32505: ~205s -> ~140s**\r\n- **https://github.com/cms-sw/cmssw/pull/32511: ~140s -> ~85s**\r\n- **This PR: ~85s -> ~80s**\r\n- DDD is at ~42 s\r\n\r\n\r\nNB: The last occurrence of this issue (for Run 3) is in ZDC (zdcsens.xml and zdcProdCuts.xml). I will not address the ZDC case, as the paths there have no regex, hence the perf penalty is completely negligible, not worth the XMLs files versioning, risk of regression, etc.\r\n\r\nNB 2: https://github.com/cms-sw/cmssw/pull/32511 should be merged first. This branch is on top of my working branch, hence the diff with master will become relevant as soon as #32511 is merged.\r\n\r\n@ianna @civanch @cvuosalo ", "branch": "master", "changed_files": 22, "closed_at": "1610414888", "comments": 44, "commits": 18, "created_at": "1608286594", "deletions": 149, "labels": ["code-checks-approved", "fully-signed", "geometry-approved", "orp-approved", "simulation-approved", "tests-approved", "upgrade-approved", "urgent"], "merge_commit_sha": "07979839953d2dec3cd889c3d763dd3ec4b134f8", "merged_at": "1610414888", "merged_by": "cmsbuild", "milestone": "CMSSW_11_3_X", "number": 32540, "release-notes": [], "review_comments": 9, "state": "closed", "title": "Improve DD4hep workflow perf, step 3: Also reduced the number of paths (with regex) looped over for HCAL", "updated_at": "1610414888", "user": "ghugo83"}