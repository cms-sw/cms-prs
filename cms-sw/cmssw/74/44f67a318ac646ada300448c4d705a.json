{"additions": 74, "auther_ref": "devel_hltRatesMonNotPerPD_142X", "auther_sha": "e462503e89bb51032f600af5ad12abd22f81795e", "author": "missirol", "body": "#### PR description:\r\n\r\nThis PR suggests an update of the plugin `TriggerRatesMonitor`, a DQM plugin used inside the HLT menu to produce histograms counting the number of events accepted by a given trigger (L1T or HLT), Primary Dataset (PD) and stream.\r\n\r\nThe current implementation creates a subdirectory named `HLT/` which in turn contains a subdirectory for every PD; in each PD subdirectory, there are 5 histograms for each Path assigned to said PD.\r\n\r\nIf a Path is assigned to _N_ PDs, each of its 5 histograms will be created and filled _N_ times, leading to duplicate information. Such a duplication is particularly visible in the case of trigger menus such as the PbPb one,\r\nwhere there is a large number of PDs split in a round robin, with each PD having the same content in terms of trigger Paths. In addition, the current approach ignores trigger Paths which are not assigned to any PD (such Paths exist, they are normally used for monitoring purposes, to compute the result of a given trigger Path without writing out the events it accepts).\r\n\r\nThis PR removes the per-PD structure in the `HLT/` directory created by `TriggerRatesMonitor`, simply filling the latter directory with 5 histograms for every Path in the trigger menu (with 1 subdirectory per Path, each with 5 histograms), ignoring its relation to any PDs (information on the Primary Datasets is already provided in the `Datasets/` directory created by this same plugin).\r\n\r\nOn Oct-27 in run-387440, while using the 2024 PbPb menu in a commissioning run (no stable beams), a large delay in the macro-merging of the `DQMHistograms` pb files was observed, and the current suspicion is that the large size of these files in the PbPb menu might be part of the problem; this led to this attempt to reduce the number of histograms.\r\n\r\n#### PR validation:\r\n\r\nTested in `CMSSW_14_1_4` with the script below. After including this PR, the file size of the output `DQMHistograms` file in `.root` format in the example goes from ~30 MB to ~2 MB, and the number of histograms goes from 46743 to 3948.\r\n```bash\r\n#!/bin/bash -ex\r\n\r\n# run 387440, LSs 1-30\r\nINPUTFILE=root://eoscms.cern.ch//eos/cms/store/group/tsg/STORM/RAW/Run2024J_HIEphemeralHLTPhysics_run387440/235844d9-333c-43a9-9c92-b1ce47ce19d1.root\r\n\r\nHLTMENU=/cdaq/physics/Run2024HI/v1.0.0/HLT/V7\r\n\r\nrm -rf run387440*\r\n\r\n# create 1 file with 100 events from LS 15\r\nconvertToRaw -f 100 -l 100 -r 387440:15 -o . -- \"${INPUTFILE}\"\r\n\r\ntmpfile=$(mktemp)\r\nhltConfigFromDB --configName --adg \"${HLTMENU}\" > \"${tmpfile}\"\r\nsed -i 's|process = cms.Process( \"HLT\" )|from Configuration.Eras.Era_Run3_cff import Run3\\nprocess = cms.Process( \"HLT\", Run3 )|g' \"${tmpfile}\"\r\ncat <<@EOF >> \"${tmpfile}\"\r\n\r\nprocess.load('run387440_cff')\r\n\r\nprocess.hltOnlineBeamSpotESProducer.timeThreshold = int(1e6)\r\n\r\nprocess.options.wantSummary = True\r\nprocess.options.numberOfThreads = 1\r\nprocess.options.numberOfStreams = 0\r\n\r\n# override the GlobalTag, connection string and pfnPrefix\r\nfrom Configuration.AlCa.GlobalTag import GlobalTag as customiseGlobalTag\r\nprocess.GlobalTag = customiseGlobalTag(\r\n    process.GlobalTag,\r\n    globaltag = \"141X_dataRun3_HLT_v1\",\r\n    conditions = \"L1Menu_CollisionsHeavyIons2024_v1_0_5_xml,L1TUtmTriggerMenuRcd,frontier://FrontierProd/CMS_CONDITIONS,,9999-12-31 23:59:59.000\"\r\n)\r\n\r\n# run the Full L1T emulator, then repack the data into a new RAW collection, to be used by the HLT\r\nfrom HLTrigger.Configuration.CustomConfigs import L1REPACK\r\nprocess = L1REPACK(process, \"uGT\")\r\n\r\n# remove all output streams\r\nstreamPaths = [pathName for pathName in process.finalpaths_()]\r\nfor foo in streamPaths:\r\n    process.__delattr__(foo)\r\n\r\n# # to run using the same HLT prescales as used online in LS 231\r\n# process.PrescaleService.forceDefault = True\r\n@EOF\r\nedmConfigDump \"${tmpfile}\" > hlt.py\r\nrm -rf \"${tmpfile}\"\r\n\r\ncmsRun hlt.py &> hlt.log\r\n\r\nfastHadd add -o output_streamDQMHistograms.pb run387440/run*_ls*_streamDQMHistograms_pid*.pb\r\nfastHadd convert -o output_streamDQMHistograms.root output_streamDQMHistograms.pb\r\n\r\nrm -rf run387440* output_streamDQMHistograms.pb\r\n```\r\n\r\n#### If this PR is a backport, please specify the original PR and why you need to backport that PR. If this PR will be backported, please specify to which release cycle the backport is meant for:\r\n\r\nTo be backported to `CMSSW_14_1_X` for data-taking purposes (used at HLT).\r\n", "branch": "master", "changed_files": 1, "comments": 14, "commits": 1, "created_at": "1730096792", "deletions": 75, "labels": ["dqm-pending", "hlt-approved", "pending-signatures", "tests-approved", "orp-pending", "urgent", "code-checks-approved"], "milestone": "CMSSW_14_2_X", "number": 46522, "release-notes": [], "review_comments": 0, "state": "open", "title": "`TriggerRatesMonitor`: monitor all HLT Paths, but not per PD", "updated_at": "1730178301", "user": "missirol"}