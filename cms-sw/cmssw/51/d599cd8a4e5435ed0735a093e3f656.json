{"additions": 2, "auther_ref": "fix_ECAL_GPU_unpacking_overflow", "auther_sha": "77f22f1f9627f677b441e2bdfa09f898f8d555b9", "author": "fwyzard", "body": "#### PR description:\r\n\r\nAvoid a possible overflow in the ECAL GPU unpacking, that could lead to an out-of-bounds read from invalid memory.\r\n\r\nThe function `find_next_tower_block()` starts from the next memory location and keeps reading until it finds a valid payload, or it reaches the given trailer. However, there was no check that the initial value is not already at or beyond the trailer, which would result in loop that moves forward until it reaches an invalid memory address.\r\n\r\nThis condition has been observed online, for example\r\n```\r\nblock (14,0,0) thread (0,0,0)\r\nfind_next_tower_block(current_tower_block = 0x7fa96ba042c8, trailer = 0x7fa96ba042c0, ...)\r\n```\r\nresulting in\r\n```\r\nBegin processing the 951st record. Run 359699, Event 317644311, LumiSection 218 on stream 0 at 05-Oct-2022 00:55:27.426 CEST\r\n\r\nCUDA Exception: Warp Illegal Address\r\nThe exception was triggered at PC 0x7fff320ad230 (UnpackGPU.cu:57 in _ZN4ecal3raw21find_next_tower_blockERPKmS2_jj inlined from UnpackGPU.cu:252)\r\n\r\nThread 1 \"cmsRun\" received signal CUDA_EXCEPTION_14, Warp Illegal Address.\r\n[Switching focus to CUDA kernel 854, grid 25544, block (14,0,0), thread (30,0,0), device 0, sm 28, warp 0, lane 30]\r\necal::raw::kernel_unpack_test<32><<<(54,1,1),(32,1,1)>>> ()\r\n    at /data/cmsbld/jenkins/workspace/auto-builds/CMSSW_12_4_9-el8_amd64_gcc10/build/CMSSW_12_4_9-build/tmp/BUILDROOT/dc6747a684df926e1faea7ef7c301e1a/opt/cmssw/el8_amd64_gcc10/cms/cmssw/CMSSW_12_4_9/src/EventFilter/EcalRawToDigi/plugins/UnpackGPU.cu:57 in _ZN4ecal3raw21find_next_tower_blockERPKmS2_jj inlined from UnpackGPU.cu:252\r\n```\r\n\r\nThese changes will stop the loop if the initial value is at or beyond the trailer.\r\n\r\n#### PR validation:\r\n\r\nWith these changes the ECAL unpacker runs successfully through 10'000 the _error stream_ events.\r\n\r\n#### If this PR is a backport please specify the original PR and why you need to backport that PR. If this PR will be backported please specify to which release cycle the backport is meant for:\r\n\r\nTo be backported to 12.4.x and 12.5.x for data taking.", "branch": "master", "changed_files": 1, "comments": 6, "commits": 1, "created_at": "1664919788", "deletions": 2, "labels": ["reconstruction-pending", "pending-signatures", "tests-approved", "orp-pending", "code-checks-approved"], "milestone": "CMSSW_12_6_X", "number": 39617, "release-notes": [], "review_comments": 0, "state": "open", "title": "Fix overflow in ECAL GPU unpacking", "updated_at": "1664933275", "user": "fwyzard"}