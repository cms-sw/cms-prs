{"additions": 1, "auther_ref": "SiStrip_O2O_mail_fix", "auther_sha": "7c0c30648cce502aa78cdfcef96383f2de01263c", "author": "JanChyczynski", "body": "#### PR description:\r\n\r\nThis fixes an error encountered when testing moving `SiStripDetVOff_prompt` O2O from CMSSW_11_0_1 to 14_0_15_patch1. A copy of `SiStripDetVOff_prompt` - `SiStripDetVOff_prompt_test` was run for the tests and when it was failing it was trying to send a warning email which caused an exception. The exception's cause is providing a `bytes` object where `str` was expected.\r\n\r\n#### PR validation:\r\n\r\nTested by running `SiStripDetVOff_prompt_test` on CMSSW_14_0_15_patch1 with local changes (this PR's fix). The O2O was failing when testing providing the certificate for T0 API access (see https://github.com/cms-sw/cmssw/pull/45779) - setting TIER0_API_URL=https://cmsweb-preprod.cern.ch/t0wmadatasvc/prod/ (which requires the cert) but not setting X509_USER_CERT. An O2O failure in this test scenario is expected (no cert provided) but it shouldn't cause an error with the email warning and this PR fixes the email error.\r\n\r\nThe error was:\r\n```\r\n[ERROR] O2OJob SiStripDetVOff_prompt_test FAILED!\r\nTraceback (most recent call last):\r\n  File \"/cvmfs/cms.cern.ch/slc7_amd64_gcc12/cms/cmssw/CMSSW_14_0_15/bin/slc7_amd64_gcc12/o2oRun_SiStripDCS.py\", line 104, in <module>\r\n    sys.exit(main())\r\n  File \"/cvmfs/cms.cern.ch/slc7_amd64_gcc12/cms/cmssw/CMSSW_14_0_15/bin/slc7_amd64_gcc12/o2oRun_SiStripDCS.py\", line 93, in main\r\n    summary(args, is_ok, logfile)\r\n  File \"/cvmfs/cms.cern.ch/slc7_amd64_gcc12/cms/cmssw/CMSSW_14_0_15/bin/slc7_amd64_gcc12/o2oRun_SiStripDCS.py\", line 58, in summary\r\n    helper.send_mail(subject='%sDCS O2O Failure: %s' % (debugLabel, args.jobname),\r\n  File \"/cvmfs/cms.cern.ch/slc7_amd64_gcc12/cms/cmssw-patch/CMSSW_14_0_15_patch1/src/CondTools/SiStrip/python/o2o_helper.py\", line 137, in send_mail\r\n    msg.attach(MIMEText(message))\r\n  File \"/cvmfs/cms.cern.ch/slc7_amd64_gcc12/external/python3/3.9.14-4612d00f9f0430a19291545f1e47b4a4/lib/python3.9/email/mime/text.py\", line 34, in __init__\r\n    _text.encode('us-ascii')\r\nAttributeError: 'bytes' object has no attribute 'encode'\r\n```\r\n\r\nAfter the fix the expected certificate-related failure was:\r\n```\r\nWARNING: No certificate provided for Tier0 access\\n[2024-09-11 14:57:50,316] ERROR: ValueError for firstConditionSafeRun from Tier-0 Expecting value: line 1 column 1 (char 0) \\n[2024-09-11 14:57:50,319] ERROR: Changes rolled back.\\n[2024-09-11 14:57:50,319] ERROR: Error setting up Tier-0 data service: Invalid firstConditionSafeRun from Tier-0\\n'\r\n[2024-09-11 14:57:50,385] INFO: @@@Upload return code = -1@@@\r\nTraceback (most recent call last):\r\n  File \"/data/O2O/cmssw/CMSSW_14_0_15_patch1/bin/slc7_amd64_gcc12/SiStripDCSPopCon.py\", line 113, in <module>\r\n    main()\r\n  File \"/data/O2O/cmssw/CMSSW_14_0_15_patch1/bin/slc7_amd64_gcc12/SiStripDCSPopCon.py\", line 106, in main\r\n    runjob(args)\r\n  File \"/data/O2O/cmssw/CMSSW_14_0_15_patch1/bin/slc7_amd64_gcc12/SiStripDCSPopCon.py\", line 58, in runjob\r\n    f(dbFile=output_db, inputTag=args.inputTag, destTags=args.destTags, destDb=args.destDb, since=None,\r\n  File \"/data/O2O/cmssw/CMSSW_14_0_15_patch1/src/CondTools/SiStrip/python/o2o_helper.py\", line 128, in copy_payload\r\n    raise RuntimeError('Upload FAILED!')\r\nRuntimeError: Upload FAILED!\r\n```\r\n\r\n#### If this PR is a backport please specify the original PR and why you need to backport that PR. If this PR will be backported please specify to which release cycle the backport is meant for:\r\n\r\nWe need backports to 14_0_X and 14_1_X\r\nPRs:\r\nhttps://github.com/cms-sw/cmssw/pull/45978\r\nhttps://github.com/cms-sw/cmssw/pull/45979\r\n \r\nFYI @p-masterson @perrotta @PonIlya ", "branch": "master", "changed_files": 1, "closed_at": "1726116178", "comments": 10, "commits": 1, "created_at": "1726054604", "deletions": 1, "labels": ["fully-signed", "tests-approved", "db-approved", "bug-fix", "orp-approved", "urgent", "code-checks-approved", "trk"], "merge_commit_sha": "242094f63a1a2cf17659907b31565386dbe5f200", "merged_at": "1726116178", "merged_by": "cmsbuild", "milestone": "CMSSW_14_2_X", "number": 45977, "release-notes": [], "review_comments": 0, "state": "closed", "title": "o2oRun_SiStripDCS email warning fix", "updated_at": "1726131371", "user": "JanChyczynski"}