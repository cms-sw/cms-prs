{"additions": 26, "auther_ref": "cuda-py312-unittest", "auther_sha": "08ec95fb90bb56ebf6685c370e2b9bb5c6cc39cb", "author": "smuzaffar", "body": "This is a possible fix for failed CUDA/GPU tests with newer eigen which we see in PY312_X IBs.\r\n- simpleCholeskyTest.cu: Use different objects for `src` and `dst` while calling `invertNN` .  Chatgppt identifies\r\n```\r\nWhat goes wrong with invertNN(m, m)\r\n  - src(i,j) and dst(i,j) refer to the same object\r\n   - Writes to dst happen before all reads from src are finished\r\n   - On CPU, this happens to limp along\r\n   -  On GPU:\r\n        Different instruction ordering\r\n        Different register pressure\r\n        Different memory model\r\n        Guaranteed corruption\r\n```\r\n\r\n- testEigenGPUNoFit.cu: Again chatgpt identifies the following and suggest to use the invertNN for large matrix\r\n```\r\nCUDA cannot fully support all Eigen expressions on the device, especially:\r\n        Matrix.inverse()\r\n        SelfAdjointEigenSolver::computeDirect()\r\n    When you call in->inverse() in a __global__ kernel (like in kernelInverse5x5), Eigen will internally use permutation matrices (for LU or LDLT) on the GPU memory.\r\n\r\n    Eigen's permutation matrices use bounds-checked indexing. When they run on the device, some of these bounds checks fail because device memory isn't tracked the same way as host memory.\r\n\r\n    This triggers the applyTranspositionOnTheRight assertion failure.\r\n```\r\n\r\n- testEigenGPU.cu: Eigen already knows the dimensions at compile time. This change matches the rest of cmssw code where we use `riemannFit::Map*`\r\n\r\nThis is an attempt to fix these unit tests for new eigen but I am not sure if these are the correct fixes. \r\nFYI @fwyzard \r\n", "branch": "master", "changed_files": 3, "comments": 25, "commits": 2, "created_at": "1765977518", "deletions": 21, "labels": ["reconstruction-approved", "pending-signatures", "tests-approved", "orp-pending", "code-checks-approved", "heterogeneous-pending", "tracking"], "milestone": "CMSSW_16_1_X", "number": 49655, "release-notes": [], "review_comments": 0, "state": "open", "title": "Fix for cuda/eigen unit test", "updated_at": "1767792630", "user": "smuzaffar"}