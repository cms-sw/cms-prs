{"additions": 5, "auther_ref": "mm_fix_ObjectSelectorBase_throwOnMissing_15_0_X", "auther_sha": "fe07539a397ac0f2abee56797a9b3320fc393ef3", "author": "mmusich", "body": "backport of https://github.com/cms-sw/cmssw/pull/47359\r\n\r\n#### PR description:\r\n\r\nThis PR is a follow-up to https://github.com/cms-sw/cmssw/pull/45385.\r\nIt fixes the logic of `throwOnMissing` in `ObjectSelectorBase`. Before this PR the check at line:\r\n\r\nhttps://github.com/cms-sw/cmssw/blob/365705add198add5f751c863f47a182ecab0b137/CommonTools/UtilAlgos/interface/ObjectSelectorBase.h#L72-L74\r\n\r\nwas buggy, because the `source`  was never valid (as the consumes was acted upon only after the `if` at L75):\r\n\r\nhttps://github.com/cms-sw/cmssw/blob/365705add198add5f751c863f47a182ecab0b137/CommonTools/UtilAlgos/interface/ObjectSelectorBase.h#L75\r\n\r\nin that way, if `throwOnMissing_` was `false` (since `!source.isValid()` was always `false` at that point) the filter was always doing an early return, without saving any of the products.\r\n\r\n#### PR validation:\r\n\r\nThe PR validation done was similar to the one done for https://github.com/cms-sw/cmssw/pull/45357.\r\n\r\nRun the following command: \r\n```bash\r\nrunTheMatrix.py --what upgrade -l 12842.0 -t 4 -j 8 --nEvents=100\r\n```\r\n\r\nto produce an input file, then analyzed with `SagittaBiasNtuplizer` (introduced back then at PR https://github.com/cms-sw/cmssw/pull/44282) by using this patch:\r\n\r\n```diff\r\ndiff --git a/Alignment/OfflineValidation/test/SagittaBiasNtuplizer_cfg.py b/Alignment/OfflineValidation/test/SagittaBiasNtuplizer_cfg.py\r\nindex e5f08e57ebf..bfeb8c65021 100644\r\n--- a/Alignment/OfflineValidation/test/SagittaBiasNtuplizer_cfg.py\r\n+++ b/Alignment/OfflineValidation/test/SagittaBiasNtuplizer_cfg.py\r\n@@ -179,18 +179,19 @@ process.refittedTracks = RecoTracker.TrackProducer.TrackRefitter_cfi.TrackRefitt\r\n ####################################################################\r\n from RecoVertex.PrimaryVertexProducer.OfflinePrimaryVertices_cfi import offlinePrimaryVertices\r\n process.offlinePrimaryVerticesFromRefittedTrks = offlinePrimaryVertices.clone()\r\n-#process.offlinePrimaryVerticesFromRefittedTrks.TrackLabel = cms.InputTag(\"refittedVtxTracks\")\r\n-process.offlinePrimaryVerticesFromRefittedTrks.TrackLabel = cms.InputTag(\"refittedTracks\")\r\n+process.offlinePrimaryVerticesFromRefittedTrks.TrackLabel = cms.InputTag(\"refittedVtxTracks\")\r\n+#process.offlinePrimaryVerticesFromRefittedTrks.TrackLabel = cms.InputTag(\"refittedTracks\")\r\n \r\n ###################################################################\r\n # The analysis modules\r\n ###################################################################\r\n process.ZtoMMNtuple = cms.EDAnalyzer(\"SagittaBiasNtuplizer\",\r\n-                                     #tracks = cms.InputTag('refittedMuons'),\r\n-                                     useReco = cms.bool(True),\r\n-                                     muons = cms.InputTag('muons'),\r\n+                                     muonTracks = cms.InputTag('refittedMuons'),\r\n+                                     useReco = cms.bool(False),\r\n+                                     #muons = cms.InputTag('muons'),\r\n                                      doGen = cms.bool(True),\r\n-                                     tracks = cms.InputTag('refittedTracks'),\r\n+                                     #tracks = cms.InputTag('refittedTracks'),\r\n+                                     genParticles = cms.InputTag('TkAlDiMuonAndVertexGenMuonSelector'),\r\n                                      vertices = cms.InputTag('offlinePrimaryVerticesFromRefittedTrks'))\r\n \r\n process.DiMuonVertexValidation = cms.EDAnalyzer(\"DiMuonVertexValidation\",\r\n@@ -257,9 +258,9 @@ process.TFileService = cms.Service(\"TFileService\",\r\n # Path\r\n ###################################################################\r\n process.p1 = cms.Path(process.offlineBeamSpot\r\n-                      #* process.refittedMuons\r\n-                      #* process.refittedVtxTracks\r\n-                      * process.refittedTracks\r\n+                      * process.refittedMuons\r\n+                      * process.refittedVtxTracks\r\n+                      #* process.refittedTracks\r\n                       * process.offlinePrimaryVerticesFromRefittedTrks\r\n                       * process.ZtoMMNtuple) \r\n                       #* process.DiMuonVertexValidation\r\n```\r\n\r\nand analyzed with:\r\n \r\n```bash\r\ncmsRun SagittaBiasNtuplizer_cfg.py myfile=file:../../../12842.0_ZMM_13+2024/TkAlDiMuonAndVertex.root\r\n```\r\n Finally the resulting output ntuple has been checked for having appropriate branches filled.\r\n\r\n#### If this PR is a backport please specify the original PR and why you need to backport that PR. If this PR will be backported please specify to which release cycle the backport is meant for:\r\n\r\nverbatim backport of https://github.com/cms-sw/cmssw/pull/47359 to `CMSSW_15_0_X`\r\n", "branch": "CMSSW_15_0_X", "changed_files": 1, "comments": 7, "commits": 1, "created_at": "1739779581", "deletions": 2, "labels": ["reconstruction-approved", "fully-signed", "tests-approved", "orp-pending", "bug-fix", "backport"], "milestone": "CMSSW_15_0_X", "number": 47360, "release-notes": [], "review_comments": 0, "state": "open", "title": "[15.0.X] fix `throwOnMissing` logic in `ObjectSelectorBase`", "updated_at": "1739807345", "user": "mmusich"}