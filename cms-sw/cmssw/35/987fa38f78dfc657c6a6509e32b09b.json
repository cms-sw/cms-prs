{"additions": 42, "auther_ref": "fc-fixtopo20250402", "auther_sha": "77eeb67c48cfb8ed89575f4301c157d649173ec3", "author": "fabiocos", "body": "#### PR description:\r\n\r\nThis PR proposes a ~~n initial~~ solution for the problem reported in https://github.com/cms-sw/cmssw/issues/47652 . The ```MTDTopology``` input and construction are amended for the \"1.7\" ETL scenario (in D119), removing the main cause for the failures observed in wf 33634.0 , giving origin to catastrophic memory leaks. Several debugging printouts are extended to better allow inspection of the navigation in the ETL tacking geometry.\r\n\r\nExtensive tests on 10k MinBias events in both scenarios D118 and D119 show a much less frequent but similar issue in navigation to that fixed by these updates. ~~This is still under check, and~~ in order to protect against possible memory leaks due to that, or possible future updates, a protection is added in ```MTDDetSector::add``` where the effectively leak happen: if the number of ```comaptibleDets``` exceeds the maximum number of dets for the given ETL sector, an exception is thrown and the execution is gracefully stopped, preventing the code execution to pose a danger to the hosting machine.\r\n\r\nThe residual problem has been finally tracked to an incorrect definition of one input vector used for the ```MTDTopology``` definition, whose correction is added. \r\n\r\n#### PR validation:\r\n\r\nThe crash observed in https://github.com/cms-sw/cmssw/issues/47652 in a few tens of events is no more present in 10k MinBias events. The much less frequent crash that is now observed is present on both D118 and D119 scenarios on the first disk (while the previous one was on the reduced size face of the second disk for scenario D119). The protection manages to stop the code for such case:\r\n\r\n```\r\nMTDDetSector::compatibleDets found compatible det idetMin 1256 detId = 1665210901 at  (55.2775,-1.1375,299.479)  dist = 4.29447\r\n%MSG-d RectangularPlaneBounds:  TrackExtenderWithMTD:trackExtenderWithMTD  01-Apr-2025 18:20:58 CEST Run: 1 Event: 32 RectangularPlaneBounds.cc:14\r\npos  (6.49049,-0.766638,0)  errors x/y 1.20747 3.61343 scale 10 halfT/W/L 0.0025 1.08 1.07 inside(p) 0\r\n%MSG\r\nMTDDetSector::compatibleDets found compatible det idetMin 1257 detId = 1665210931 at  (57.5425,-1.1375,299.479)  dist = 6.53561\r\n----- Begin Fatal Exception 01-Apr-2025 18:20:59 CEST-----------------------\r\nAn exception of category 'MTDDetLayersFailure' occurred while\r\n   [0] Processing  Event run: 1 lumi: 2347 event: 32 stream: 0\r\n   [1] Running path 'dqmofflineOnPAT_1_step'\r\n   [2] Prefetching for module SingleTopTChannelLeptonDQM_miniAOD/'singleTopElectronMediumDQM_miniAOD'\r\n   [3] Prefetching for module PATMuonSlimmer/'slimmedMuons'\r\n   [4] Prefetching for module PATMuonSelector/'selectedPatMuons'\r\n   [5] Prefetching for module PATMuonProducer/'patMuons'\r\n   [6] Prefetching for module MuonProducer/'muons'\r\n   [7] Prefetching for module MuonIdProducer/'muons1stStep'\r\n   [8] Prefetching for module FastjetJetProducer/'ak4CaloJets'\r\n   [9] Prefetching for module RecoChargedRefCandidatePrimaryVertexSorter/'offlinePrimaryVertices'\r\n   [10] Prefetching for module ChargedRefCandidateProducer/'trackRefsForJetsBeforeSorting'\r\n   [11] Prefetching for module TrackWithVertexRefSelector/'trackWithVertexRefSelectorBeforeSorting'\r\n   [12] Prefetching for module PrimaryVertexProducer/'unsortedOfflinePrimaryVertices'\r\n   [13] Calling method for module TrackExtenderWithMTD/'trackExtenderWithMTD'\r\nException Message:\r\nETL compatibleDets in sector in excess of collection size: 1680\r\n----- End Fatal Exception -------------------------------------------------\r\n%MSG-w BeamFitter:  AlcaBeamMonitor:AlcaBeamMonitor@endLumi  01-Apr-2025 18:20:59 CEST Run: 1 Lumi: 2347\r\nNo event read! No Fitting!\r\n%MSG\r\n01-Apr-2025 18:21:03 CEST  Closed file file:step2.root\r\nCommand exited with non-zero status 65\r\n```\r\n\r\nThis issue disappears on both D118 and D119 after the last commit is added.", "branch": "master", "changed_files": 6, "comments": 21, "commits": 3, "created_at": "1743586656", "deletions": 24, "labels": ["geometry-pending", "reconstruction-approved", "pending-signatures", "tests-approved", "orp-pending", "upgrade-approved", "code-checks-approved"], "milestone": "CMSSW_15_1_X", "number": 47757, "release-notes": [], "review_comments": 0, "state": "open", "title": "MTD geometry: fix for geometry navigation issues in scenario D119", "updated_at": "1743926286", "user": "fabiocos"}