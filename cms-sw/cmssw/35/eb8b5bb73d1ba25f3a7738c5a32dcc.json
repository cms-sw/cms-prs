{"additions": 14, "auther_ref": "fix_ECAL_Quadrants", "auther_sha": "db38ed1fa7f2f8551c4846bf6e3f29a83d3dd2bb", "author": "ghugo83", "body": "**This PR fixes the handling of reflected volumes in CMSSW in DD4hep workflows.**\r\n\r\nThe key idea is that the handling of reflected volumes is different in old DD and DD4hep, as there are 2 different files in CMSSW:\r\n- old DD: https://github.com/cms-sw/cmssw/blob/master/SimG4Core/Geometry/src/DDG4Builder.cc \r\n- DD4hep: https://github.com/cms-sw/cmssw/blob/master/SimG4Core/Geometry/src/DD4hep_DDG4Builder.cc \r\n\r\nIn old DD, **there is a special treatment for reflected volumes, so that the volumes with _refl are added to the sensitive detector catalogue.**\r\nIn DD4hep, the G4 reflected volumes were properly created, **but their names with _refl were not added to the active detectors catalogue list.**\r\n**This resulted, further downstream in https://github.com/cms-sw/cmssw/blob/master/SimG4Core/SensitiveDetector/src/SensitiveDetector.cc#L53, to have the reflected volumes not set as active detectors.**\r\nThis issue did not appear with the TGeo trick, because the reflected volumes with TGeo, did not have the _refl names.\r\nThe reflected active volumes being not considered as sensitive detectors by G4, there were obviously no SimHit on them.\r\n\r\nThe proper list of active volumes is now fixed, and includes the active reflected volumes.\r\n\r\n\r\nNB: The affected active volumes, which are now present on a DD4hep workflow, and which were NOT considered as active volumes until now, without the TGeo trick, are:\r\n\r\n**In ECAL Endcap:**\r\nreflectedG4LogicalVolumeName = EFRY_refl\r\n-> This solves the ECAL Endcap quadrants issue.\r\n\r\n**In ECAL Barrel:**\r\nreflectedG4LogicalVolumeName = ebalgo:EBRY_01_refl\r\nreflectedG4LogicalVolumeName = ebalgo:EATJ_01_refl\r\nreflectedG4LogicalVolumeName = ebalgo:EAPD_01_refl\r\nreflectedG4LogicalVolumeName = ebalgo:EBRY_02_refl\r\nreflectedG4LogicalVolumeName = ebalgo:EATJ_02_refl\r\nreflectedG4LogicalVolumeName = ebalgo:EAPD_02_refl\r\nreflectedG4LogicalVolumeName = ebalgo:EBRY_03_refl\r\nreflectedG4LogicalVolumeName = ebalgo:EATJ_03_refl\r\nreflectedG4LogicalVolumeName = ebalgo:EAPD_03_refl\r\nreflectedG4LogicalVolumeName = ebalgo:EBRY_07_refl\r\nreflectedG4LogicalVolumeName = ebalgo:EBRY_04_refl\r\nreflectedG4LogicalVolumeName = ebalgo:EATJ_04_refl\r\nreflectedG4LogicalVolumeName = ebalgo:EAPD_04_refl\r\nreflectedG4LogicalVolumeName = ebalgo:EBRY_05_refl\r\nreflectedG4LogicalVolumeName = ebalgo:EATJ_05_refl\r\nreflectedG4LogicalVolumeName = ebalgo:EAPD_05_refl\r\nreflectedG4LogicalVolumeName = ebalgo:EBRY_06_refl\r\nreflectedG4LogicalVolumeName = ebalgo:EATJ_06_refl\r\nreflectedG4LogicalVolumeName = ebalgo:EAPD_06_refl\r\nreflectedG4LogicalVolumeName = ebalgo:EATJ_07_refl\r\nreflectedG4LogicalVolumeName = ebalgo:EAPD_07_refl\r\nreflectedG4LogicalVolumeName = ebalgo:EBRY_08_refl\r\nreflectedG4LogicalVolumeName = ebalgo:EATJ_08_refl\r\nreflectedG4LogicalVolumeName = ebalgo:EAPD_08_refl\r\nreflectedG4LogicalVolumeName = ebalgo:EBRY_09_refl\r\nreflectedG4LogicalVolumeName = ebalgo:EATJ_09_refl\r\nreflectedG4LogicalVolumeName = ebalgo:EAPD_09_refl\r\nreflectedG4LogicalVolumeName = ebalgo:EBRY_10_refl\r\nreflectedG4LogicalVolumeName = ebalgo:EATJ_10_refl\r\nreflectedG4LogicalVolumeName = ebalgo:EAPD_10_refl\r\nreflectedG4LogicalVolumeName = ebalgo:EBRY_11_refl\r\nreflectedG4LogicalVolumeName = ebalgo:EATJ_11_refl\r\nreflectedG4LogicalVolumeName = ebalgo:EAPD_11_refl\r\nreflectedG4LogicalVolumeName = ebalgo:EBRY_12_refl\r\nreflectedG4LogicalVolumeName = ebalgo:EATJ_12_refl\r\nreflectedG4LogicalVolumeName = ebalgo:EAPD_12_refl\r\nreflectedG4LogicalVolumeName = ebalgo:EBRY_13_refl\r\nreflectedG4LogicalVolumeName = ebalgo:EATJ_13_refl\r\nreflectedG4LogicalVolumeName = ebalgo:EAPD_13_refl\r\nreflectedG4LogicalVolumeName = ebalgo:EBRY_14_refl\r\nreflectedG4LogicalVolumeName = ebalgo:EATJ_14_refl\r\nreflectedG4LogicalVolumeName = ebalgo:EAPD_14_refl\r\nreflectedG4LogicalVolumeName = ebalgo:EBRY_15_refl\r\nreflectedG4LogicalVolumeName = ebalgo:EATJ_15_refl\r\nreflectedG4LogicalVolumeName = ebalgo:EAPD_15_refl\r\nreflectedG4LogicalVolumeName = ebalgo:EBRY_16_refl\r\nreflectedG4LogicalVolumeName = ebalgo:EATJ_16_refl\r\nreflectedG4LogicalVolumeName = ebalgo:EAPD_16_refl\r\nreflectedG4LogicalVolumeName = ebalgo:EBRY_17_refl\r\nreflectedG4LogicalVolumeName = ebalgo:EATJ_17_refl\r\nreflectedG4LogicalVolumeName = ebalgo:EAPD_17_refl\r\n\r\n**In CSC:**\r\nreflectedG4LogicalVolumeName = csc:ME1A_ActiveGasVol_refl\r\nreflectedG4LogicalVolumeName = csc:ME11_ActiveGasVol_refl\r\nreflectedG4LogicalVolumeName = csc:ME12_ActiveGasVol_refl\r\nreflectedG4LogicalVolumeName = csc:ME13_ActiveGasVol_refl\r\nreflectedG4LogicalVolumeName = csc:ME21_ActiveGasVol_refl\r\nreflectedG4LogicalVolumeName = csc:ME22_ActiveGasVol_refl\r\nreflectedG4LogicalVolumeName = csc:ME31_ActiveGasVol_refl\r\nreflectedG4LogicalVolumeName = csc:ME32_ActiveGasVol_refl\r\nreflectedG4LogicalVolumeName = csc:ME41_ActiveGasVol_refl\r\nreflectedG4LogicalVolumeName = csc:ME42_ActiveGasVol_refl\r\n\r\n\r\nNB 2: PR quickly done here, might push a few commits to clean it.\r\n\r\n@ianna @civanch @bsunanda @cvuosalo ", "branch": "master", "changed_files": 1, "closed_at": "1605969034", "comments": 16, "commits": 3, "created_at": "1605891058", "deletions": 0, "labels": ["code-checks-approved", "comparison-available", "fully-signed", "orp-approved", "simulation-approved", "tests-approved", "urgent"], "merge_commit_sha": "d3024a8d8db2a3d8d3895d00f919f238d6757413", "merged_at": "1605969034", "merged_by": "cmsbuild", "milestone": "CMSSW_11_2_X", "number": 32218, "release-notes": [], "review_comments": 4, "state": "closed", "title": "Fix ECAL Endcap quadrants issue with DD4hep reflected volumes + Also fix ECAL Barrel and CSCs reflected active detectors", "updated_at": "1605969035", "user": "ghugo83"}