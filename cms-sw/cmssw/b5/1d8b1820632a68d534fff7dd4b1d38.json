{"additions": 1021, "auther_ref": "auto_gpu_workflows", "auther_sha": "ad06d7898affbe9dd78964f046eb2dd04d8309b9", "author": "fwyzard", "body": "#### PR description:\r\n\r\nRedesign the GPU workflows:\r\n  - the CPU (*e.g. `###.501`) and GPU (`###.502`) workflows should now be as close as possible;\r\n  - the implementation of the CPU and GPU workflows has been simplified;\r\n  - all GPU workflows use the `SwitchProducerCUDA` mechanism to detect if a GPU is available and offload a module or task to the GPU; if not, they automatically fall back to the equivalent CPU modules and tasks;\r\n  - when the \"gpu\" modifier is used, the pixel local reconstruction workflow used the \"HLT\" payload type both on the CPU and on the GPU, for better consistency of the results;\r\n  - the \"Patatrack\" pixel tracks reconstruction on CPU is based on a modifier (`pixelNtupletFit`) instead of a customisation, in line with the other workflows;\r\n  - the HCAL-only workflows should follow more closely the implementation of the general reconstruction sequence, both for Run 2 (2018) and Run 3 scenarios.\r\n\r\nSome changes to the relevant EDProducers have made the definition of the workflows easier:\r\n  - the SoA-to-legacy HCAL rechit producer has been updated to make the production of the SoA and/or legacy collections optional;\r\n  - the legacy ECAL unpacker has been updated to declare only the event products it will actually produce;\r\n  - the default labels used in many modules have been updated to reflect the labels used in the configuration.\r\n\r\nSome other general changes and code clean up:\r\n  - remove some no-longer-used files as well as some commented-out code\r\n  - always `clone()` a module used in a `SwitchProducerCUDA`\r\n  - move the implementation of the `gpuVertexFinder` kernels from gpuVertexFinderImpl.h to gpuVertexFinder.cc\r\n\r\nThe update has been presented here: https://indico.cern.ch/event/1033022/#47-gpu-workflows .\r\n\r\n#### PR validation:\r\n\r\nThe GPU workflows (*e.g.* `###.502`) now work also without a GPU:\r\n```\r\nCUDA_VISIBLE_DEVICES= runTheMatrix.py -w upgrade -j 16 -l 10824.501,10824.502,10824.505,10824.506,10824.511,10824.512,10824.521,10824.522,11634.501,11634.502,11634.505,11634.506,11634.511,11634.512,11634.521,11634.522\r\n...\r\n10824.501_TTbar_13+2018_Patatrack_PixelOnlyCPU+TTbar_13TeV_TuneCUETP8M1_GenSim+Digi+RecoFakeHLT+HARVESTFakeHLT Step0-PASSED Step1-PASSED Step2-PASSED Step3-PASSED  - time date Sat Apr 24 08:26:11 2021-date Sat Apr 24 08:21:54 2021; exit: 0 0 0 0\r\n10824.502_TTbar_13+2018_Patatrack_PixelOnlyGPU+TTbar_13TeV_TuneCUETP8M1_GenSim+Digi+RecoFakeHLT+HARVESTFakeHLT Step0-PASSED Step1-PASSED Step2-PASSED Step3-PASSED  - time date Sat Apr 24 08:26:08 2021-date Sat Apr 24 08:21:55 2021; exit: 0 0 0 0\r\n10824.505_TTbar_13+2018_Patatrack_PixelOnlyTripletsCPU+TTbar_13TeV_TuneCUETP8M1_GenSim+Digi+RecoFakeHLT+HARVESTFakeHLT Step0-PASSED Step1-PASSED Step2-PASSED Step3-PASSED  - time date Sat Apr 24 08:26:12 2021-date Sat Apr 24 08:21:55 2021; exit: 0 0 0 0\r\n10824.506_TTbar_13+2018_Patatrack_PixelOnlyTripletsGPU+TTbar_13TeV_TuneCUETP8M1_GenSim+Digi+RecoFakeHLT+HARVESTFakeHLT Step0-PASSED Step1-PASSED Step2-PASSED Step3-PASSED  - time date Sat Apr 24 08:26:08 2021-date Sat Apr 24 08:21:56 2021; exit: 0 0 0 0\r\n10824.511_TTbar_13+2018_Patatrack_ECALOnlyCPU+TTbar_13TeV_TuneCUETP8M1_GenSim+Digi+RecoFakeHLT+HARVESTFakeHLT Step0-PASSED Step1-PASSED Step2-PASSED Step3-PASSED  - time date Sat Apr 24 08:26:03 2021-date Sat Apr 24 08:21:56 2021; exit: 0 0 0 0\r\n10824.512_TTbar_13+2018_Patatrack_ECALOnlyGPU+TTbar_13TeV_TuneCUETP8M1_GenSim+Digi+RecoFakeHLT+HARVESTFakeHLT Step0-PASSED Step1-PASSED Step2-PASSED Step3-PASSED  - time date Sat Apr 24 08:26:03 2021-date Sat Apr 24 08:21:57 2021; exit: 0 0 0 0\r\n10824.521_TTbar_13+2018_Patatrack_HCALOnlyCPU+TTbar_13TeV_TuneCUETP8M1_GenSim+Digi+RecoFakeHLT+HARVESTFakeHLT Step0-PASSED Step1-PASSED Step2-PASSED Step3-PASSED  - time date Sat Apr 24 08:26:03 2021-date Sat Apr 24 08:21:57 2021; exit: 0 0 0 0\r\n10824.522_TTbar_13+2018_Patatrack_HCALOnlyGPU+TTbar_13TeV_TuneCUETP8M1_GenSim+Digi+RecoFakeHLT+HARVESTFakeHLT Step0-PASSED Step1-PASSED Step2-PASSED Step3-PASSED  - time date Sat Apr 24 08:26:03 2021-date Sat Apr 24 08:21:58 2021; exit: 0 0 0 0\r\n11634.501_TTbar_14TeV+2021_Patatrack_PixelOnlyCPU+TTbar_14TeV_TuneCP5_GenSim+Digi+Reco+HARVEST Step0-PASSED Step1-PASSED Step2-PASSED Step3-PASSED  - time date Sat Apr 24 08:26:20 2021-date Sat Apr 24 08:21:58 2021; exit: 0 0 0 0\r\n11634.502_TTbar_14TeV+2021_Patatrack_PixelOnlyGPU+TTbar_14TeV_TuneCP5_GenSim+Digi+Reco+HARVEST Step0-PASSED Step1-PASSED Step2-PASSED Step3-PASSED  - time date Sat Apr 24 08:26:17 2021-date Sat Apr 24 08:21:59 2021; exit: 0 0 0 0\r\n11634.505_TTbar_14TeV+2021_Patatrack_PixelOnlyTripletsCPU+TTbar_14TeV_TuneCP5_GenSim+Digi+Reco+HARVEST Step0-PASSED Step1-PASSED Step2-PASSED Step3-PASSED  - time date Sat Apr 24 08:26:20 2021-date Sat Apr 24 08:21:59 2021; exit: 0 0 0 0\r\n11634.506_TTbar_14TeV+2021_Patatrack_PixelOnlyTripletsGPU+TTbar_14TeV_TuneCP5_GenSim+Digi+Reco+HARVEST Step0-PASSED Step1-PASSED Step2-PASSED Step3-PASSED  - time date Sat Apr 24 08:26:17 2021-date Sat Apr 24 08:22:00 2021; exit: 0 0 0 0\r\n11634.511_TTbar_14TeV+2021_Patatrack_ECALOnlyCPU+TTbar_14TeV_TuneCP5_GenSim+Digi+Reco+HARVEST Step0-PASSED Step1-PASSED Step2-PASSED Step3-PASSED  - time date Sat Apr 24 08:26:13 2021-date Sat Apr 24 08:22:00 2021; exit: 0 0 0 0\r\n11634.512_TTbar_14TeV+2021_Patatrack_ECALOnlyGPU+TTbar_14TeV_TuneCP5_GenSim+Digi+Reco+HARVEST Step0-PASSED Step1-PASSED Step2-PASSED Step3-PASSED  - time date Sat Apr 24 08:26:13 2021-date Sat Apr 24 08:22:01 2021; exit: 0 0 0 0\r\n11634.521_TTbar_14TeV+2021_Patatrack_HCALOnlyCPU+TTbar_14TeV_TuneCP5_GenSim+Digi+Reco+HARVEST Step0-PASSED Step1-PASSED Step2-PASSED Step3-PASSED  - time date Sat Apr 24 08:26:12 2021-date Sat Apr 24 08:22:01 2021; exit: 0 0 0 0\r\n11634.522_TTbar_14TeV+2021_Patatrack_HCALOnlyGPU+TTbar_14TeV_TuneCP5_GenSim+Digi+Reco+HARVEST Step0-PASSED Step1-PASSED Step2-PASSED Step3-PASSED  - time date Sat Apr 24 08:26:12 2021-date Sat Apr 24 08:22:02 2021; exit: 0 0 0 0\r\n16 16 16 16 tests passed, 0 0 0 0 failed\r\n```\r\n", "branch": "master", "changed_files": 64, "closed_at": "1620740090", "comments": 124, "commits": 11, "created_at": "1618344161", "deletions": 980, "labels": ["alca-approved", "code-checks-approved", "dqm-approved", "fully-signed", "operations-approved", "orp-approved", "pdmv-approved", "reconstruction-approved", "simulation-approved", "tests-approved", "upgrade-approved"], "merge_commit_sha": "bb6b6cead35e2df086f89f91ee0193cd2e52441e", "merged_at": "1620740089", "merged_by": "cmsbuild", "milestone": "CMSSW_12_0_X", "number": 33428, "release-notes": [], "review_comments": 21, "state": "closed", "title": "Redesign all GPU workflows to detect if a GPU is present, and fall back to CPU otherwise", "updated_at": "1620740090", "user": "fwyzard"}