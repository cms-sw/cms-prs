{"additions": 2, "auther_ref": "devel_fixDuplicatesOfNanoMetadata", "auther_sha": "b02da57622756f8ab699873f46dba58a03c67b4d", "author": "missirol", "body": "#### PR description:\r\n\r\nThe module `nanoMetadata` is defined (with the same exact definition) in three different `cff` files:\r\n\r\nhttps://github.com/cms-sw/cmssw/blob/a8a0be07cf733c297800282bffcd4749450f88a6/DPGAnalysis/HcalNanoAOD/python/hcalNano_cff.py#L6\r\nhttps://github.com/cms-sw/cmssw/blob/a8a0be07cf733c297800282bffcd4749450f88a6/PhysicsTools/NanoAOD/python/nano_cff.py#L32\r\nhttps://github.com/cms-sw/cmssw/blob/a8a0be07cf733c297800282bffcd4749450f88a6/PhysicsTools/NanoAOD/python/nanogen_cff.py#L13\r\n\r\nAs far as I know, having multiple definitions should be avoided, and it can lead to problems when loading those `cff` fragments together in the same configuration (for example, in this particular case, when attempting to combine different NanoAOD \"flavours\" in the same job).\r\n\r\nThis PR removes the extra definitions, taking `nano_cff` as the file that defines `nanoMetadata`, and importing the latter from the former `cff` when needed (following what is done already in some other `cff` fragments in CMSSW).\r\n\r\n#### PR validation:\r\n\r\nWithout this PR, the command in [1] leads to the runtime error in [2]. With this PR, [1] runs without crashing. This was tested in `CMSSW_16_0_0_pre4`, and I would expect the same behaviour in 16_1_X.\r\n\r\n[1]\r\n```bash\r\ncmsDriver.py tmp --process TEST --python_filename tmp_cfg.py --fileout file:tmp_out.root \\\r\n  --filein /store/mc/Run3Winter25Digi/QCD_Bin-PT-15to7000_Par-PT-flat2022_TuneCP5_13p6TeV_pythia8/GEN-SIM-RAW/FlatPU0to120_142X_mcRun3_2025_realistic_v9-v4/2520000/00491803-ed8e-4011-bfc1-e503706c64f8.root \\\r\n  --mc --conditions auto:phase1_2025_realistic --geometry DB:Extended \\\r\n  --scenario pp --era Run3_2025 \\\r\n  --datatier NANOAOD --eventcontent NANOAOD \\\r\n  --nThreads 1 --nStreams 0 \\\r\n  -n 10 \\\r\n  -s RAW2DIGI,NANO:@GEN+@L1DPG\r\n```\r\n\r\n[2]\r\n```bash\r\nRAW2DIGI,NANO:@GEN+@L1DPG,ENDJOB\r\nwith DB:\r\nentry /store/mc/Run3Winter25Digi/QCD_Bin-PT-15to7000_Par-PT-flat2022_TuneCP5_13p6TeV_pythia8/GEN-SIM-RAW/FlatPU0to120_142X_mcRun3_2025_realistic_v9-v4/2520000/00491803-ed8e-4011-bfc1-e503706c64f8.root\r\nStep: RAW2DIGI Spec: \r\nStep: NANO Spec: ['@GEN', '@L1DPG']\r\nin prepare_nano @GEN+@L1DPG\r\n@GEN+@L1DPG\r\nNANO: scheduling: nanogenSequence from PhysicsTools/NanoAOD/nanogen_cff\r\nNANO: scheduling: l1tNanoSequence from DPGAnalysis/L1TNanoAOD/l1tNano_cff\r\nTraceback (most recent call last):\r\n  File \"/cvmfs/cms.cern.ch/el8_amd64_gcc13/cms/cmssw/CMSSW_16_0_0_pre4/bin/el8_amd64_gcc13/cmsDriver.py\", line 40, in <module>\r\n    run()\r\n  File \"/cvmfs/cms.cern.ch/el8_amd64_gcc13/cms/cmssw/CMSSW_16_0_0_pre4/bin/el8_amd64_gcc13/cmsDriver.py\", line 16, in run\r\n    configBuilder.prepare()\r\n  File \"/cvmfs/cms.cern.ch/el8_amd64_gcc13/cms/cmssw/CMSSW_16_0_0_pre4/src/Configuration/Applications/python/ConfigBuilder.py\", line 2349, in prepare\r\n    self.addStandardSequences()\r\n  File \"/cvmfs/cms.cern.ch/el8_amd64_gcc13/cms/cmssw/CMSSW_16_0_0_pre4/src/Configuration/Applications/python/ConfigBuilder.py\", line 857, in addStandardSequences\r\n    getattr(self,\"prepare_\"+stepName)(stepSpec = '+'.join(stepSpec))\r\n  File \"/cvmfs/cms.cern.ch/el8_amd64_gcc13/cms/cmssw/CMSSW_16_0_0_pre4/src/Configuration/Applications/python/ConfigBuilder.py\", line 1878, in prepare_NANO\r\n    self.loadAndRemember(_cff)\r\n  File \"/cvmfs/cms.cern.ch/el8_amd64_gcc13/cms/cmssw/CMSSW_16_0_0_pre4/src/Configuration/Applications/python/ConfigBuilder.py\", line 365, in loadAndRemember\r\n    self.process.load(includeFile)\r\n  File \"/cvmfs/cms.cern.ch/el8_amd64_gcc13/cms/cmssw/CMSSW_16_0_0_pre4/src/FWCore/ParameterSet/python/Config.py\", line 711, in load\r\n    self.extend(sys.modules[moduleName])\r\n  File \"/cvmfs/cms.cern.ch/el8_amd64_gcc13/cms/cmssw/CMSSW_16_0_0_pre4/src/FWCore/ParameterSet/python/Config.py\", line 734, in extend\r\n    self.__setattr__(name,item)\r\n  File \"/cvmfs/cms.cern.ch/el8_amd64_gcc13/cms/cmssw/CMSSW_16_0_0_pre4/src/FWCore/ParameterSet/python/Config.py\", line 489, in __setattr__\r\n    raise ValueError(msg1+\"sequence \"+s.label_()+msg2)\r\nValueError: Trying to override definition of nanoMetadata while it is used by the sequence nanogenSequence\r\n new object defined in: [...]/CMSSW_16_0_0_pre4/src/PhysicsTools/NanoAOD/python/nano_cff.py\r\n existing object defined in: [...]/CMSSW_16_0_0_pre4/src/PhysicsTools/NanoAOD/python/nanogen_cff.py\r\n```\r\n\r\n#### If this PR is a backport, please specify the original PR and why you need to backport that PR. If this PR will be backported, please specify to which release cycle the backport is meant for:\r\n\r\nN/A\r\n", "branch": "master", "changed_files": 2, "comments": 9, "commits": 1, "created_at": "1770736784", "deletions": 14, "labels": ["fully-signed", "tests-approved", "orp-pending", "code-checks-approved", "xpog-approved", "hcal"], "milestone": "CMSSW_16_1_X", "number": 50102, "release-notes": [], "review_comments": 0, "state": "open", "title": "NanoAOD: remove duplicates of `nanoMetadata` in `cff` fragments", "updated_at": "1771225482", "user": "missirol"}