{"additions": 143, "auther_ref": "Phase1-HE22", "auther_sha": "c5d59a48e995201a4141831f8740262dff0c3e46", "author": "kpedro88", "body": "The SiPM simulation is inherently nonlinear due to pixel saturation/recovery. This requires knowing when all photoelectrons arrive at the SiPM, with fine time binning (0.5ns). For regular mixing, this is handled appropriately, because all SimHits are treated the same way. However, premixing by default adds CaloSamples, which have already gone through the full electronics simulation. Because of the nonlinearity in SiPMs, those CaloSamples should not just be added linearly.\r\n\r\nThe solution is:\r\n1. In premix stage 1, skip pixel saturation/recovery and SiPM pulse shape smearing: just put \"raw\" photoelectrons (after photostatistics and Y11 time offset) into CaloSamples, and store CaloSamples -> QIE11 data frames with 500 samples (0.5ns binning)\r\n2. Redefine `HcalSiPMHitResponse::add(const CaloSamples& signal)` to add photoelectrons to intermediate array (must be called before `finalizeHits()`)\r\n\r\n[These slides](https://indico.cern.ch/event/622214/contributions/2509760/attachments/1427537/2190910/sipm_premixing_nonlinearity.pdf) have more details, as well as a contrived simulation with high energy deposits for both signal and PU to demonstrate the problem and solution.\r\n\r\nStoring 500 samples per dataframe instead of 10 leads to a 10% increase in the size of the premixed input file for the 2018 scenario (full HE upgrade) using `AVE_35_BX_25ns`. The increase for 2017 with HE Plan1 is less than 1%.\r\n\r\nThis PR also:\r\n* improves the debugging tools introduced in #16907 to work with premixing\r\n* removes hardcoded `MAXSAMPLES = 10` from CaloSamples classes (This was previously implemented very inconsistently/unsafely - any size could be set, but the underlying data array was fixed at size 10. Now these classes just use vectors.)\r\n* uses QIE11 TDC bits to store the error bit for premixing, instead of the flag word (much simpler and more extensible, probably should have been done in the first place), therefore now-unneeded changes from #16057 are reverted\r\n\r\nThis PR will be backported to 90X.\r\n\r\nattn: @mdhildreth, @igv4321, @abdoulline, @jmmans ", "branch": "master", "changed_files": 25, "closed_at": "1490258713", "comments": 63, "commits": 12, "created_at": "1489499890", "deletions": 77, "labels": ["alca-approved", "comparison-available", "l1-pending", "operations-pending", "orp-pending", "pending-signatures", "reconstruction-approved", "simulation-approved", "tests-approved"], "merge_commit_sha": "8811ec3b7d8437c37e6fbe8c11274d7699241561", "merged_at": "1490258712", "merged_by": "davidlange6", "milestone": "CMSSW_9_1_X", "number": 17920, "release-notes": [], "review_comments": 7, "state": "closed", "title": "Handle SiPM nonlinearity in premixing", "updated_at": "1490305602", "user": "kpedro88"}