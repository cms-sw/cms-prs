{"additions": 42, "auther_ref": "clonewars_74x", "auther_sha": "79c210da69a6c8b4411d784fe83ca8e30895a506", "author": "dmitrijus", "body": "(backport from https://github.com/cms-sw/cmssw/pull/9066)\n\nPreviously, DQMStore would implicitly create a number of TH1 copies:\n\n```\n  func DQMStore::mergeAndResetMEsRunSummaryCache:\n    ...\n    MonitorElement global_me(*i); <- constructor makes an internal copy of th1 (fixed: 1)\n    global_me.globalize()\n    ...\n    gme = data_.insert(global_me) <- insert calls the same copy constructor (fixed: 2)\n```\n\n  global_me is used as a key (in a set) to find an actual object to work on.\n  It is not used outside that and once the actual object is found,\n  global_me is just left to be destroyed at the end of the loop.\n\n  This is not a leak, but the TH1::Clone is just useless,\n  since the key comparison does not depend on it.\n\nSo I've implemented:\n1. Special tagged constructor which does not clone the internal th1 object,\n   and just sets it to nullptr (perfect for searching in a set).\n2. Special move constructor which will move the TH1 object.\n   The old object will have TH1 unset.\n   This makes std::set::insert not to make a clone of TH1 internally\n   when inserting a transient (on the stack) object.\n3. Disabled the assignment operator to avoid confusion/complexity.\n   It was never actually used and move-constructor is complex enough already.\n\nResult: running 25.0 (with 1000 events) on 8 threads:\n- ~300mb less memory (peak rss)\n- 60s faster (5%)\n\nThe code runs at end of the job, so in theory, the number of events does not matter.\nOnly the number of streams used (it shouldn't improve anything on a single stream job).\n\nDmitrijus\n", "branch": "CMSSW_7_4_X", "changed_files": 3, "closed_at": "1434463068", "comments": 9, "commits": 2, "created_at": "1432606229", "deletions": 34, "labels": ["comparison-pending", "dqm-approved", "fully-signed", "tests-approved"], "merge_commit_sha": "9046d33ba7c949f166f3347acc9e99f037c1d5d2", "merged_at": "1434463068", "merged_by": "cmsbuild", "milestone": "Next CMSSW_7_4_X", "number": 9267, "release-notes": [], "review_comments": 0, "state": "closed", "title": "Do less cloning of TH1 objects in the DQMStore (backport to 74x) ", "updated_at": "1434463068", "user": "dmitrijus"}