{"additions": 1, "auther_ref": "fixTTreeCache", "auther_sha": "deb89db83d4afdbf0055135931ed3c8c2e922eed", "author": "makortel", "body": "#### PR description:\r\n\r\nWhile testing RNTuple, I encountered suspiciously large number of singular reads for TTree (i.e. `PoolSource`) with `application-only` storage cache hint (mimics remote files by triggering the use of `TTreeCache`s) and prompt reading (`source.delayReadingEventProducts = False`). Inspection of code revealed the `getEntryForAllBranches()` and `selectCaches()` are using a different `TTreeCache`, causing the data to be read twice. This PR changes the `getEntryForAllBranches()` to use the same `TTreeCache` as the `selectCache()`.\r\n\r\n(for curiosity I tested also the other way around, i.e. changing `selectCache()`, but that didn't improve)\r\n\r\nThe new read numbers below are consistent with the numbers we saw in spring at the time of https://github.com/cms-sw/cmssw/pull/48088. I still had my CMSSW developer area around, and there the code used the `rawTreeCache_` in both functions. So something happened between the tests and the PR, and I didn't catch it in the code review.\r\n\r\nResolves https://github.com/cms-sw/framework-team/issues/1602\r\n\r\n#### PR validation:\r\n\r\nIn a test MiniAOD-only job using 2024 data as input with 1000 events on 1 and 8 threads the number of singular reads and their data volume decreases by orders of magnitude, and the data volume read more than once also decreases. The 1 and 8 thread jobs give same numbers, so I show them only once below\r\n\r\n| | CMSSW_15_1_0_pre6 | This PR |\r\n|---|---|---|\r\n| Singular reads | 92620 | 21 |\r\n| Singular read data volume (MB) | 329.84 | 4.71 |\r\n| Vector reads | 22 | 17 |\r\n| Vector read elements | 322 | 176 |\r\n| Vector read data volume (MB) | 374.21 | 352.97 |\r\n| Duplicate read data volume | 346.42 | 0.05 |\r\n\r\n\r\n#### If this PR is a backport please specify the original PR and why you need to backport that PR. If this PR will be backported please specify to which release cycle the backport is meant for:\r\n\r\nTo be backported to 15_1_X", "branch": "master", "changed_files": 1, "comments": 10, "commits": 1, "created_at": "1759750088", "deletions": 1, "labels": ["core-pending", "pending-signatures", "tests-approved", "orp-pending", "code-checks-approved"], "milestone": "CMSSW_16_0_X", "number": 49070, "release-notes": [], "review_comments": 0, "state": "open", "title": "Use the right TTreeCache in `RootTree::getEntryForAllBranches()` for prompt reading", "updated_at": "1759766135", "user": "makortel"}