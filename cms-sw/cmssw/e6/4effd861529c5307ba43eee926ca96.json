{"additions": 4698, "auther_ref": "concurrentIOVs1May2019R", "auther_sha": "cdd50a021485dac1f016b55e21456ea1b1413c24", "author": "wddgit", "body": "PR description:\r\n\r\nThis implements core support for concurrent IOVs. More work needs to be done before CMSSW is actually running concurrent IOVs. Outside of core tests, there are not any ESSources that have been modified to actually support this kind of concurrency. The core will continue to support and properly run existing ESSources and ESProducers, but the IOVs will not be processed concurrently.\r\n\r\nThe only changes outside the core are to CondDBESSource, FWLiteESSource, and FWLiteESRecordWriterAnalyzer. These changes are the minimal changes necessary to work with the revised core code. They do not migrate these modules to support concurrent IOVs.\r\n\r\nThere are two independent ways to control the number of concurrent IOVs:\r\n\r\nFirst one can set the number of IOVs allowed to be processed at the same time for each EventSetupRecord as follows. In the configuration:\r\n```\r\nprocess.options = dict(\r\n   ...\r\n   eventSetup = dict(\r\n        numberOfConcurrentIOVs = 4,\r\n        forceNumberOfConcurrentIOVs = dict(\r\n            SomeRecord = 4\r\n        )\r\n    )\r\n)\r\n```\r\n\r\nIn the C++ definition of an EventSetupRecord type:\r\n```\r\n  static constexpr bool allowConcurrentIOVs_ = false;\r\n```\r\n\r\nnumberOfConcurrentIOVs sets the number of IOVs for all types of EventSetupRecord (defaults to 1). The boolean defined in the C++ class overrides this for a specific EventSetupRecord type (by default this is defined true in the base class). The value in forceNumberOfConcurrentIOVs overrides both numberOfConcurrentIOVs and the value in the C++ class for specified EventSetupRecord types (by default this parameter set is empty).\r\n\r\nThe second way of controlling this relates to ESSources. Existing ESSources often rely on the time ordering of calls to setIntervalFor and the associated functions that produce data for that interval. In the past the produce function always referred to the immediately preceding setIntervalFor function call. But with concurrent IOVs, this can no longer be true. The Framework will enforce the old time ordering of function calls for existing ESSources. As ESSources are modified to support concurrent IOVs, the following function should be added to ESSource C++ class definition:\r\n```\r\n    bool isConcurrentFinder() const override { return true; }\r\n```\r\n\r\nIn many but not all cases, existing ESProducers will work in concurrent IOV mode without modification. Most ESSources are going to require work to migrate. We are already looking at CondDBESSource (PoolDBESSource) to see what changes are needed there.\r\n\r\nNote that the two mechanisms described above are independent of each other.\r\n\r\nIf numberOfConcurrentIOVs is set to greater than one and nothing else is done, things might fail horribly. It will take a record by record review of the associated/dependent ESSource and ESProducer code to determine what will and will not function properly with more than one concurrent IOV.\r\n\r\nThe new EventSetupRecordIOVQueue class is at the heart of all this. It is probably the most important part of the new code in this PR.\r\n\r\nPR validation:\r\n\r\nThis should not effect the results of existing tests. Without modifying things as described above, IOVs will not be running concurrently and everything should be the same. Even when IOVs are running concurrently, this should not modify behavior or results other than performance improvements caused by increasing concurrency at IOV boundaries.", "branch": "master", "changed_files": 86, "closed_at": "1567752894", "comments": 213, "commits": 25, "created_at": "1556741247", "deletions": 2161, "labels": ["alca-approved", "analysis-approved", "code-checks-approved", "comparison-available", "core-approved", "db-approved", "fully-signed", "orp-approved", "requires-external", "tests-approved"], "merge_commit_sha": "c9396534362e1fbd474b6f70970bfe20851a64ff", "merged_at": "1567752894", "merged_by": "cmsbuild", "milestone": "CMSSW_11_0_X", "number": 26592, "release-notes": [], "review_comments": 133, "state": "closed", "title": "Implement core support for concurrent IOVs", "updated_at": "1568019109", "user": "wddgit"}