{"additions": 88, "auther_ref": "rework_cudaIsEnabled", "auther_sha": "cc325b93989ff537898fd8841ef47d37968da0fc", "author": "fwyzard", "body": "#### PR description:\r\n\r\nAutodetect if a GPU can be used with CMSSW.\r\nA GPU is deemed usable if\r\n  - it is visible to `cudaGetDeviceCount()`;\r\n  - it can be selected by `cudaSetDevice()`;\r\n  - it can allocate a small amount of GPU memory;\r\n  - it can run a kernel.\r\n\r\nThe last point in particular ensures that CMSSW has been built to support the GPUs \"compute capability\" (*e.g.* 7.0 for a Tesla v100, *etc.*).\r\n\r\n`cudaComputeCapabilities` now prints `(unsupported)` after a GPU name if it cannot be used by CMSSW.\r\n\r\n#### PR validation:\r\n\r\nWith a version of CMSSW built to support only compute capability 7.5:\r\n```bash\r\n$ cudaComputeCapabilities \r\n   0     7.0    NVIDIA Tesla V100-PCIE-32GB (unsupported)\r\n   1     7.5    NVIDIA Tesla T4\r\n\r\n$ cudaIsEnabled && echo true || echo false\r\ntrue\r\n```\r\n\r\nAfter hiding the usable GPU:\r\n```bash\r\n$ export CUDA_VISIBLE_DEVICES=0\r\n\r\n$ cudaComputeCapabilities \r\n   0     7.0    NVIDIA Tesla V100-PCIE-32GB (unsupported)\r\n\r\n$ cudaIsEnabled && echo true || echo false\r\nfalse\r\n```\r\n\r\nAfter hiding the unusable GPU:\r\n```bash\r\n$ export CUDA_VISIBLE_DEVICES=1\r\n\r\n$ cudaComputeCapabilities \r\n   0     7.5    NVIDIA Tesla T4\r\n\r\n$ cudaIsEnabled && echo true || echo false\r\ntrue\r\n```\r\n\r\nAfter hiding all GPUs (or on a machine without GPUs):\r\n```bash\r\n$ export CUDA_VISIBLE_DEVICES= \r\n\r\n$ cudaComputeCapabilities \r\ncudaComputeCapabilities: no CUDA-capable device is detected\r\n\r\n$ cudaIsEnabled && echo true || echo false\r\nfalse\r\n```\r\n\r\n#### If this PR is a backport please specify the original PR and why you need to backport that PR:\r\n\r\nBackport of #33561", "branch": "CMSSW_11_3_X", "changed_files": 5, "closed_at": "1619647241", "comments": 9, "commits": 1, "created_at": "1619593045", "deletions": 24, "labels": ["backport", "fully-signed", "heterogeneous-approved", "orp-approved", "tests-approved"], "merge_commit_sha": "d274c7ae4a3581b2a269b4b1723108ecde70eea6", "merged_at": "1619647241", "merged_by": "cmsbuild", "milestone": "CMSSW_11_3_X", "number": 33562, "release-notes": [], "review_comments": 0, "state": "closed", "title": "Autodetect if a GPU can be used with CMSSW (11.3.x)", "updated_at": "1619647242", "user": "fwyzard"}