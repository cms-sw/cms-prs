{"additions": 41, "auther_ref": "dev/nano-genWeightTable", "auther_sha": "c8a0f0b6fd9718d7065e5746228c4a332f7311fa", "author": "hqucms", "body": "#### PR description:\r\n\r\nThis PR implements a possible mitigation of the LHEScaleSumw issue, as discussed in the [PPD general meeting](https://indico.cern.ch/event/1470301/#6-xpog-remini-renano-discussio) today. Feedback is welcome!\r\n\r\nBasically a configurable option `allowedNumScaleWeights` is introduced to `GenWeightsTableProducer`, which can take a list of numbers, and the number of scale variation weights identified by parsing the `initrwgt` header of `LHERunInfoProduct` must match one of the values provided in `allowedNumScaleWeights`, otherwise a `LogicError` is thrown. The default value of `allowedNumScaleWeights` is set to 9 as it is the expected number of scale variations in the standard setup. An empty list for `allowedNumScaleWeights` means any number of scale variation weights is allowed and no check is performed.\r\n\r\nThis PR also fixes the parsing of certain MadGraph headers where it fails to pick up the central weight, as in some cases the central weight is outside any weight group. This has led to some NanoAOD samples containing only 8 (instead of 9) scale weights.\r\n\r\nRelated issue: https://github.com/cms-sw/cmssw/issues/43784\r\n\r\n#### PR validation:\r\n\r\nPasses local tests with:\r\n- [x]  a `normal` MadGraph file with the expected, 9 scale weights: \r\n     - `/store/mc/Run3Summer22EEMiniAODv4/DYGto2LG-1Jets_MLL-50_PTG-10to50_TuneCP5_13p6TeV_amcatnloFXFX-pythia8/MINIAODSIM/130X_mcRun3_2022_realistic_postEE_v6-v2/30000/0fd00136-3752-4096-8e82-4b6fcd656da4.root`\r\n- [x] a buggy MadGraph file with no PDF/scale weights and missing the`initrwgt` header : \r\n    - `/store/mc/Run3Summer22EEMiniAODv4/DYGto2LG-1Jets_MLL-50_PTG-10to50_TuneCP5_13p6TeV_amcatnloFXFX-pythia8/MINIAODSIM/130X_mcRun3_2022_realistic_postEE_v6-v2/40000/c22ada93-447e-4db9-bee9-fcb3ab3e7fa9.root`\r\n- [x] another MG file where only 8 scale weights were identified before the change:\r\n    - `/store/mc/RunIISummer20UL16MiniAODAPVv2/TTZ-ZToBB-TTTo2L_TuneCP5_13TeV-amcatnlo-pythia8/MINIAODSIM/106X_mcRun2_asymptotic_preVFP_v11-v2/2560000/02890624-0027-E345-880C-C8372B42C942.root`\r\n\r\n\r\n#### Update on Nov 19\r\n\r\nA large-scale test was performed to check essentially all generator configurations in UL18 and 2022. Basically I took all the samples in GrASP for UL18 and 2022, then group them by the `short name`, and then pick only one sample for each generator suffix (e.g., `madgraphMLM-pythia8`) from the group and run `GenWeightsTableProducer` on one file.\r\n\r\nA few modifications (https://github.com/cms-sw/cmssw/pull/46573/commits/c8a0f0b6fd9718d7065e5746228c4a332f7311fa) was made based on the findings from the test:\r\n- Restrict the check to MadGraph samples, and more specifically, MG5 version `2.x.y`. \r\n   - it was found some PowHeg MiNNLO samples are configured with more scale variations\r\n   - there are few MG samples using MG version 3.x (with pLHE workflow), and the current code cannot parse MG 3.x headers consistently\r\n- Fixed another scenario where the central weight is not identified -- basically if the `mg_reweighting` group appears before the scale variation group.\r\n\r\nAfter these changes, all ~500 sample groups for 2022 passed the test, and only 2 (out of ~1100) sample groups in UL18 still fail (modulo 5-10% failures due to unable to access files via xrootd which are not accounted here):\r\n -  VH SMEFT:\r\n    - WHJet_HToBB_WToLNu_M-125_TuneCP5_SMEFTsim_topU3l_13TeV-madgraphMLM-pythia8\r\n    - ZHJet_HToBB_ZToLL_M-125_TuneCP5_SMEFTsim_topU3l_13TeV-madgraphMLM-pythia8\r\n    - ZHJet_HToBB_ZToNuNu_M-125_TuneCP5_SMEFTsim_topU3l_13TeV-madgraphMLM-pythia8\r\n    - (it seems these samples are misconfigured with `None = systematics_program`?)\r\n- IDM:\r\n    - IDM_MuMuHH_MA100_MH45_MHp150_TuneCP5_13TeV-madgraph-pythia8\r\n    - IDM_MuMuHH_MA120_MH72_MHp150_TuneCP5_13TeV-madgraph-pythia8\r\n    - IDM_MuMuHH_MA150_MH80_MHp193_TuneCP5_13TeV-madgraph-pythia8\r\n    - (these have `systematics = systematics_program`  but still no scale weights)\r\n", "branch": "master", "changed_files": 2, "comments": 33, "commits": 2, "created_at": "1730394946", "deletions": 7, "labels": ["pending-signatures", "tests-approved", "orp-pending", "code-checks-approved", "xpog-approved", "ppd-pending"], "milestone": "CMSSW_15_0_X", "number": 46573, "release-notes": [], "review_comments": 0, "state": "open", "title": "[NANO] Implement a check on the number of scale variation weights in GenWeightsTableProducer", "updated_at": "1732786410", "user": "hqucms"}