{"additions": 1, "auther_ref": "devel_fixBufferOfInitMsgBuilder", "auther_sha": "79ef5e2ff8273a50d6763e16b4393f7ce5685960", "author": "missirol", "body": "#### PR description:\r\n\r\nThis PR fixes a problem reported by @fwyzard when running the full HLT GRun menu using `GlobalEvFOutputModule` as `cms.OutputModule` (which is how the HLT produces output files online).\r\n\r\nThe issue occurs in the `beginRun` stage, when serializing the content of the \"INI\" streamer files: the size of the buffer given by `InitMsgBuilder` to `EventMsgBuilder` can be too small if the number of L1 and HL triggers is above certain values.\r\n\r\nThe current size of `256` is insufficient, for example, in the presence of 500 L1T seeds and 500 HLT paths.\r\n\r\nThe issue leads to a crash, and it can be reproduced with this minimal update of the relevant DAQ unit test.\r\n```diff\r\ndiff --git a/EventFilter/Utilities/test/startFU.py b/EventFilter/Utilities/test/startFU.py\r\nindex c00d612aae8..9133a1196aa 100644\r\n--- a/EventFilter/Utilities/test/startFU.py\r\n+++ b/EventFilter/Utilities/test/startFU.py\r\n@@ -128,6 +128,9 @@ process.tcdsRawToDigi.InputLabel = cms.InputTag(\"rawDataCollector\")\r\n process.p1 = cms.Path(process.a*process.tcdsRawToDigi*process.filter1)\r\n process.p2 = cms.Path(process.b*process.filter2)\r\n \r\n+for pidx in range(3,1000):\r\n+  setattr(process, f'p{pidx}', cms.Path(process.b))\r\n+\r\n process.streamA = cms.OutputModule(\"EvFOutputModule\",\r\n     SelectEvents = cms.untracked.PSet(SelectEvents = cms.vstring( 'p1' ))\r\n )\r\n```\r\n```\r\n./EventFilter/Utilities/test/LocalRunBUFU.sh\r\n```\r\nTo my knowledge, this problem affects both `GlobalEvFOutputModule` and `EvFOutputModule`.\r\n\r\nGiven the deadline for `12_4_0_pre4` (and possible need for a patch release in `12_3_X`), this PR applies a minimal fix increasing the buffer size.\r\n\r\nA buffer size of `640` should be sufficient for 512 L1T seeds and 2000 HLT paths (the current HLT menu for pp collisions has approx. 800 paths).\r\n\r\nIn the near future, the algorithm could be improved to find an optimal buffer size based on the number of L1 and HL triggers in the configuration.\r\n\r\nThis PR will need to be backported at least to `12_3_X`.\r\n\r\nDebugged with @fwyzard.\r\n\r\n#### PR validation:\r\n\r\nManual tests. This fix solves the original issue found when testing the full GRun menu.\r\n\r\n#### If this PR is a backport, please specify the original PR and why you need to backport that PR:\r\n\r\nN/A", "branch": "master", "changed_files": 1, "closed_at": "1652400002", "comments": 16, "commits": 1, "created_at": "1652381904", "deletions": 1, "labels": ["core-approved", "fully-signed", "tests-approved", "bug-fix", "orp-approved", "urgent", "code-checks-approved"], "merge_commit_sha": "26382617b6c43d06b88f0d8c130ab40eed948c72", "merged_at": "1652400002", "merged_by": "cmsbuild", "milestone": "CMSSW_12_4_X", "number": 37937, "release-notes": [], "review_comments": 0, "state": "closed", "title": "increase size of buffer in `InitMsgBuilder`", "updated_at": "1652400003", "user": "missirol"}