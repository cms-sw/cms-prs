{"additions": 379, "auther_ref": "AlignmentTrackSelectorPhase2_12_5_X", "auther_sha": "651c25a09e7facf2fc30ffb2d1df90e24426c3da", "author": "mmusich", "body": "#### PR description:\r\n\r\nThis is a follow-up of PR https://github.com/cms-sw/cmssw/pull/39858.\r\nAfter the backport of that PR (https://github.com/cms-sw/cmssw/pull/39898) was integrated, it was possible to test the production of RelVal samples (see e.g. on DAS: [/RelValMinBias_14TeV/CMSSW_12_5_2-TkAlMinBias-125X_mcRun4_realistic_v3_2026D88PU-v1/ALCARECO](https://cmsweb.cern.ch/das/request?view=list&limit=50&instance=prod%2Fglobal&input=dataset%3D/RelValMinBias_14TeV/CMSSW_12_5_2-TkAlMinBias-125X_mcRun4_realistic_v3_2026D88PU-v1/ALCARECO)).\r\nWhen trying to run over it, it became clear that is not possible to refit tracks, due to the missing event products (the Phase-2 Outer Tracker clusters) that are necessary for CPE re-computation, leading to this error:\r\n\r\n```\r\nBegin processing the 1st record. Run 1, Event 301, LumiSection 4 on stream 6 at 13-Dec-2022 12:50:01.219 CET\r\n----- Begin Fatal Exception 13-Dec-2022 12:50:57 CET-----------------------\r\nAn exception of category 'ProductNotFound' occurred while\r\n   [0] Processing  Event run: 1 lumi: 4 event: 306 stream: 2\r\n   [1] Running path 'p2'\r\n   [2] Calling method for module TrackRefitter/'FinalTrackRefitter'\r\nException Message:\r\nRefCore: A request to resolve a reference to a product of type 'edmNew::DetSetVector<Phase2TrackerCluster1D>' with ProductID '4:449'\r\ncan not be satisfied because the product cannot be found.\r\nProbably the branch containing the product is not stored in the input file.\r\n   Additional Info:\r\n      [a] If you wish to continue processing events after a ProductNotFound exception,\r\nadd \"SkipEvent = cms.untracked.vstring('ProductNotFound')\" to the \"options\" PSet in the configuration.\r\n\r\n----- End Fatal Exception -------------------------------------------------\r\n```\r\n\r\nThis PR adds the minimal amount of changes in the `CommonTools/RecoAlgos` package in order to be able to retain the Phase-2 OT clusters after running the `AlignmentTrackSelector` module that relies on it:\r\n\r\nhttps://github.com/cms-sw/cmssw/blob/52c0dacc1af916e537cb419a39ec5845ae5087bf/Alignment/CommonAlignmentProducer/plugins/AlignmentTrackSelectorModule.cc#L13-L17\r\n\r\nThis is done in commit 3c18fe00873f1260753d964175ed30466970f3ba.\r\nSecondly the `outputCommands` of all the Tracker Alignment ALCARECO producers is modified in order to retain `Phase2TrackerCluster1DedmNewDetSetVector` in the output - in case the production is run for Phase-2 - while removing `SiStripClusteredmNewDetSetVector` (since there is no SiStrip detector in phase-2). I profit of that to re-adjust the commands for event contents to cope with no SCAL in Run3 that were leftover from https://github.com/cms-sw/cmssw/pull/38415 and https://github.com/cms-sw/cmssw/pull/38590. \r\nThis is done in commit 19e04f4afa53b6eac5a96a270b49747ef12fb283.\r\nAdditionally this contains commit 06b919bb9d0ba72137aa41a900f5af9f4c2da50d  which fixes a problem with the vector hits workflow spotted in master and commit 651c25a09e7facf2fc30ffb2d1df90e24426c3da which makes the `ClusterStorer::rekey` methods non-`const` as per recommendations in https://github.com/cms-sw/cmssw/pull/40363.\r\n\r\n#### PR validation:\r\n\r\nRun two typical workflows for Run-3 and Phase-2 with\r\n\r\n```\r\nrunTheMatrix.py -l 11634.0,20834.0 -t 4 -j 8 --ibeos\r\n```\r\n\r\nAnd tested the event content of `TkAlMinBias` indeed changes as expected.\r\n\r\n#### If this PR is a backport please specify the original PR and why you need to backport that PR. If this PR will be backported please specify to which release cycle the backport is meant for:\r\n\r\nThis is a combined backport of https://github.com/cms-sw/cmssw/pull/40323 and https://github.com/cms-sw/cmssw/pull/40363 (partially backported). It is backported in this cycle in order to use it for the production of `ALCARECO`s within the context of the L1T production happening in that cycle, see https://its.cern.ch/jira/browse/PDMVRELVALS-178 and [McM](https://cms-pdmv.cern.ch/mcm/edit?db_name=mccms&query=TRK-2022Dec07-00001&page=0)", "branch": "CMSSW_12_5_X", "changed_files": 26, "comments": 7, "commits": 4, "created_at": "1671697128", "deletions": 35, "labels": ["reconstruction-pending", "alca-approved", "pending-signatures", "tests-rejected", "orp-pending", "backport-ok"], "milestone": "CMSSW_12_5_X", "number": 40395, "release-notes": [], "review_comments": 0, "state": "open", "title": "[12.5.X] Adjust collections of Tracker clusters to be saved for Phase-2 ALCARECO", "updated_at": "1671716253", "user": "mmusich"}