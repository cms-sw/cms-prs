{"additions": 20, "auther_ref": "fix_das_client_ibeos", "auther_sha": "bd92dcedd38c731655a9183b8570ddf8744a4b34", "author": "kpedro88", "body": "#### PR description:\r\n\r\nBugs:\r\n1. The file of parent process information sometimes gets detected as a binary file by grep (maybe OS- or version-dependent) because of some unicode symbols. This means the check for `/cmsDriver.py` could fail. Using `-a` tells grep to treat it like a text file. Further, the grep checks can be simplified (using the exit code instead of just counting matches).\r\n2. `das_client` was written before `dasgoclient`. The latter uses single-flag long options, which would not be handled correctly in the `das_client` command line parsing. Also, the regex to match the `=` sign did not handle the presence of multiple `=` signs properly (e.g. in `-query=\"file dataset=/x/y/z\"`).\r\n\r\nLogic:\r\n1. The file list returned by `das_client` was only processed by `ibeos-lfn-sort` when `das_client` was called by `cmsDriver.py`. However, the logic in `Utilities/General/scripts/dasgoclient` specifies that `das_client` will be used only when `CMSSW_USE_IBEOS` is enabled (see #46114). Therefore, the use of `das_client` implies the desire to use all `ibeos` functionality, so the `ibeos` location should always be prepended. Returning a limited set of results is still only done in the `cmsDriver.py` case, by modifying the meaning/usage of the `CMSSW_LIMIT_RESULTS` variable (now with a more specific name). The new scheme exploits the fact that `head` with a negative value for the `-n` argument prints all but the last n values, and `-0` is a valid argument.\r\n2. Correspondingly, `runTheMatrix.py` is modified so that it activates `CMSSW_USE_IBEOS` for every command when the flag is provided.\r\n\r\nThe logic changes are especially useful to read pileup inputs from old relvals that have long since been deleted from disk, but are still cached in the ibeos location. (Somehow the bot manages this when running IB/PR tests, but I do not understand how. Users running the same commands could not achieve the same behavior, which was reported and led to this PR.)\r\n\r\n@smuzaffar please let me know if any of the changes here will interfere with the bot.\r\n\r\n#### PR validation:\r\n\r\nChecked how the scripts ran with various cases using `set -x`.\r\n\r\nRan workflow 250202.181 successfully with the `--ibeos` option.\r\n\r\nAlso checked 136.731 (used to test #46114).\r\n\r\n#### If this PR is a backport please specify the original PR and why you need to backport that PR. If this PR will be backported please specify to which release cycle the backport is meant for:\r\n\r\nNot a backport. May be backported to 15_0_X or older cycles if requested.\r\n\r\nattn: @jhakala ", "branch": "master", "changed_files": 3, "comments": 3, "commits": 5, "created_at": "1751028014", "deletions": 17, "labels": ["core-pending", "pending-signatures", "tests-pending", "orp-pending", "pdmv-pending", "upgrade-pending", "code-checks-approved"], "milestone": "CMSSW_15_1_X", "number": 48432, "release-notes": [], "review_comments": 0, "state": "open", "title": "Fix bugs and logic in ibeos das client", "updated_at": "1751028154", "user": "kpedro88"}