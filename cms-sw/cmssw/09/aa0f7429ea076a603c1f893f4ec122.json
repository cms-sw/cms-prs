{"additions": 527, "auther_ref": "gartung-mkFit-sse3-vectorize", "auther_sha": "796b37a3fbcd38c507963856392ae2d792444107", "author": "gartung", "body": "See discussion in https://github.com/trackreco/cmssw/pull/93\r\n\r\nSplit large loops in `PropagationMPlex` into smaller loops, converting loop temporary floats into function temporary arrays of floats. This allows `gcc -msse3` to convert loops with floating point operations into `simd` instructions. \r\n\r\nUnder EL8 use system provided mvec which implements vectorized trig functions.  Under sl7, Intel's svml library must be linked to get the same performance. \r\n\r\n\r\nBelow is quoted the data from running the stand alone mkFit executable. This shows the improvements from this PR and the improvements from using AVX and AVX2 instructions sets as well as the improvements from using libmvec on el8.\r\n\r\n```\r\nbase-avx.log:Total Matriplex fit = 0.00000  --- Build  BHMX = 0.00000  STDMX = 0.00000  CEMX = 0.00000  MIMI = 31.67810\r\nbase-avx.log:Total event > 1 fit = 0.00000  --- Build  BHMX = 0.00000  STDMX = 0.00000  CEMX = 0.00000  MIMI = 31.56959\r\nbase-avx.log:Total event loop time 48.90405 simtracks 787323 seedtracks 2933807 builtcands 0 maxhits 4651 on lay 0\r\nbase-avx2.log:Total Matriplex fit = 0.00000  --- Build  BHMX = 0.00000  STDMX = 0.00000  CEMX = 0.00000  MIMI = 29.00773\r\nbase-avx2.log:Total event > 1 fit = 0.00000  --- Build  BHMX = 0.00000  STDMX = 0.00000  CEMX = 0.00000  MIMI = 28.90690\r\nbase-avx2.log:Total event loop time 45.81278 simtracks 787323 seedtracks 2933807 builtcands 0 maxhits 4651 on lay 0\r\nbase-sse3.log:Total Matriplex fit = 0.00000  --- Build  BHMX = 0.00000  STDMX = 0.00000  CEMX = 0.00000  MIMI = 29.63152\r\nbase-sse3.log:Total event > 1 fit = 0.00000  --- Build  BHMX = 0.00000  STDMX = 0.00000  CEMX = 0.00000  MIMI = 29.52981\r\nbase-sse3.log:Total event loop time 46.68341 simtracks 787323 seedtracks 2933807 builtcands 0 maxhits 4651 on lay 0\r\nmod-avx-mvec.log:Total Matriplex fit = 0.00000  --- Build  BHMX = 0.00000  STDMX = 0.00000  CEMX = 0.00000  MIMI = 19.27232\r\nmod-avx-mvec.log:Total event > 1 fit = 0.00000  --- Build  BHMX = 0.00000  STDMX = 0.00000  CEMX = 0.00000  MIMI = 19.20447\r\nmod-avx-mvec.log:Total event loop time 34.17708 simtracks 787323 seedtracks 2933807 builtcands 0 maxhits 4651 on lay 0\r\nmod-avx.log:Total Matriplex fit = 0.00000  --- Build  BHMX = 0.00000  STDMX = 0.00000  CEMX = 0.00000  MIMI = 25.20377\r\nmod-avx.log:Total event > 1 fit = 0.00000  --- Build  BHMX = 0.00000  STDMX = 0.00000  CEMX = 0.00000  MIMI = 25.11508\r\nmod-avx.log:Total event loop time 41.42097 simtracks 787323 seedtracks 2933807 builtcands 0 maxhits 4651 on lay 0\r\nmod-avx2-mvec.log:Total Matriplex fit = 0.00000  --- Build  BHMX = 0.00000  STDMX = 0.00000  CEMX = 0.00000  MIMI = 17.54373\r\nmod-avx2-mvec.log:Total event > 1 fit = 0.00000  --- Build  BHMX = 0.00000  STDMX = 0.00000  CEMX = 0.00000  MIMI = 17.48136\r\nmod-avx2-mvec.log:Total event loop time 32.55088 simtracks 787323 seedtracks 2933807 builtcands 0 maxhits 4651 on lay 0\r\nmod-avx2.log:Total Matriplex fit = 0.00000  --- Build  BHMX = 0.00000  STDMX = 0.00000  CEMX = 0.00000  MIMI = 24.33769\r\nmod-avx2.log:Total event > 1 fit = 0.00000  --- Build  BHMX = 0.00000  STDMX = 0.00000  CEMX = 0.00000  MIMI = 24.25216\r\nmod-avx2.log:Total event loop time 40.42988 simtracks 787323 seedtracks 2933807 builtcands 0 maxhits 4651 on lay 0\r\nmod-sse3-2.log:Total Matriplex fit = 0.00000  --- Build  BHMX = 0.00000  STDMX = 0.00000  CEMX = 0.00000  MIMI = 24.45082\r\nmod-sse3-2.log:Total event > 1 fit = 0.00000  --- Build  BHMX = 0.00000  STDMX = 0.00000  CEMX = 0.00000  MIMI = 24.36551\r\nmod-sse3-2.log:Total event loop time 40.47400 simtracks 787323 seedtracks 2933807 builtcands 0 maxhits 4651 on lay 0\r\nmod-sse3-fm.log:Total Matriplex fit = 0.00000  --- Build  BHMX = 0.00000  STDMX = 0.00000  CEMX = 0.00000  MIMI = 24.54694\r\nmod-sse3-fm.log:Total event > 1 fit = 0.00000  --- Build  BHMX = 0.00000  STDMX = 0.00000  CEMX = 0.00000  MIMI = 24.46173\r\nmod-sse3-fm.log:Total event loop time 40.77979 simtracks 787323 seedtracks 2933807 builtcands 0 maxhits 4651 on lay 0\r\nmod-sse3-mvec.log:Total Matriplex fit = 0.00000  --- Build  BHMX = 0.00000  STDMX = 0.00000  CEMX = 0.00000  MIMI = 21.45716\r\nmod-sse3-mvec.log:Total event > 1 fit = 0.00000  --- Build  BHMX = 0.00000  STDMX = 0.00000  CEMX = 0.00000  MIMI = 21.38178\r\nmod-sse3-mvec.log:Total event loop time 36.64679 simtracks 787323 seedtracks 2933807 builtcands 0 maxhits 4651 on lay 0\r\nmod-sse3-svml.log:Total Matriplex fit = 0.00000  --- Build  BHMX = 0.00000  STDMX = 0.00000  CEMX = 0.00000  MIMI = 21.59713\r\nmod-sse3-svml.log:Total event > 1 fit = 0.00000  --- Build  BHMX = 0.00000  STDMX = 0.00000  CEMX = 0.00000  MIMI = 21.52169\r\nmod-sse3-svml.log:Total event loop time 37.08196 simtracks 787323 seedtracks 2933807 builtcands 0 maxhits 4651 on lay 0\r\nmod-sse3.log:Total Matriplex fit = 0.00000  --- Build  BHMX = 0.00000  STDMX = 0.00000  CEMX = 0.00000  MIMI = 24.95528\r\nmod-sse3.log:Total event > 1 fit = 0.00000  --- Build  BHMX = 0.00000  STDMX = 0.00000  CEMX = 0.00000  MIMI = 24.87442\r\nmod-sse3.log:Total event loop time 41.11285 simtracks 787323 seedtracks 2933807 builtcands 0 maxhits 4651 on lay 0\r\n```\r\n\r\n\r\n\r\n\r\n", "branch": "master", "changed_files": 4, "comments": 17, "commits": 14, "created_at": "1652105289", "deletions": 196, "labels": ["reconstruction-pending", "pending-signatures", "tests-pending", "orp-pending", "code-checks-pending", "tracking"], "milestone": "CMSSW_12_4_X", "number": 37868, "release-notes": [], "review_comments": 5, "state": "open", "title": "RecoTracker/MkFitCore: factorize loops to allow gcc -msse3 to vectorize loops", "updated_at": "1652189884", "user": "gartung"}