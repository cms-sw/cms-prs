{"additions": 552, "auther_ref": "gartung-mkFit-sse3-vectorize", "auther_sha": "8866ca64dc913d274f25da401c321cc5d2193790", "author": "gartung", "body": "See discussion in https://github.com/trackreco/cmssw/pull/93\r\n\r\nSplit large loops in `PropagationMPlex` into smaller loops, converting loop temporary floats into function temporary arrays of floats. This allows `gcc -msse3` to convert loops with floating point operations into `simd` instructions. \r\n\r\nUnder EL8 use system provided mvec which implements vectorized trig functions.  Under sl7, Intel's svml library must be linked to get the same performance. \r\n\r\n\r\nBelow is quoted the data from running the stand alone mkFit executable. This shows the improvements from this PR and the improvements from using AVX and AVX2 instructions sets as well as the improvements from using libmvec on el8.\r\n\r\n\r\nNo changes `gcc -msse3`\r\n\r\n```\r\n================================================================\r\n=== TOTAL for 100 events\r\n================================================================\r\nTotal Matriplex fit = 0.00000  --- Build  BHMX = 0.00000  STDMX = 0.00000  CEMX = 0.00000  MIMI = 29.63152\r\nTotal event > 1 fit = 0.00000  --- Build  BHMX = 0.00000  STDMX = 0.00000  CEMX = 0.00000  MIMI = 29.52981\r\nTotal event loop time 46.68341 simtracks 787323 seedtracks 2933807 builtcands 0 maxhits 4651 on lay 0\r\n```\r\n\r\nNo changes `gcc -mavx`\r\n\r\n```\r\n================================================================\r\n=== TOTAL for 100 events\r\n================================================================\r\nTotal Matriplex fit = 0.00000  --- Build  BHMX = 0.00000  STDMX = 0.00000  CEMX = 0.00000  MIMI = 31.67810\r\nTotal event > 1 fit = 0.00000  --- Build  BHMX = 0.00000  STDMX = 0.00000  CEMX = 0.00000  MIMI = 31.56959\r\nTotal event loop time 48.90405 simtracks 787323 seedtracks 2933807 builtcands 0 maxhits 4651 on lay 0\r\n```\r\n\r\nNo changes `gcc -mavx2 -mfma`\r\n\r\n```\r\n================================================================\r\n=== TOTAL for 100 events\r\n================================================================\r\nTotal Matriplex fit = 0.00000  --- Build  BHMX = 0.00000  STDMX = 0.00000  CEMX = 0.00000  MIMI = 29.00773\r\nTotal event > 1 fit = 0.00000  --- Build  BHMX = 0.00000  STDMX = 0.00000  CEMX = 0.00000  MIMI = 28.90690\r\nTotal event loop time 45.81278 simtracks 787323 seedtracks 2933807 builtcands 0 maxhits 4651 on lay 0\r\n================================================================\r\n```\r\n\r\nWith changes `gcc -msse3  -ffastmath -mveclibabi=svml  -lsvml`\r\n\r\n```\r\n================================================================\r\n=== TOTAL for 100 events\r\n================================================================\r\nTotal Matriplex fit = 0.00000  --- Build  BHMX = 0.00000  STDMX = 0.00000  CEMX = 0.00000  MIMI = 21.65558\r\nTotal event > 1 fit = 0.00000  --- Build  BHMX = 0.00000  STDMX = 0.00000  CEMX = 0.00000  MIMI = 21.58022\r\nTotal event loop time 37.01423 simtracks 787323 seedtracks 2933807 builtcands 0 maxhits 4651 on lay 0\r\n================================================================\r\n```\r\n\r\nWith changes `gcc -mavx -ffastmath -mveclibabi=svml  -lsvml`\r\n\r\n```\r\n================================================================\r\n=== TOTAL for 100 events\r\n================================================================\r\nTotal Matriplex fit = 0.00000  --- Build  BHMX = 0.00000  STDMX = 0.00000  CEMX = 0.00000  MIMI = 18.64836\r\nTotal event > 1 fit = 0.00000  --- Build  BHMX = 0.00000  STDMX = 0.00000  CEMX = 0.00000  MIMI = 18.58693\r\nTotal event loop time 33.58694 simtracks 787323 seedtracks 2933807 builtcands 0 maxhits 4651 on lay 0\r\n================================================================\r\n```\r\n\r\nWith changes `gcc -mavx2 -mfma`\r\n\r\n```\r\n================================================================\r\n=== TOTAL for 100 events\r\n================================================================\r\nTotal Matriplex fit = 0.00000  --- Build  BHMX = 0.00000  STDMX = 0.00000  CEMX = 0.00000  MIMI = 24.14937\r\nTotal event > 1 fit = 0.00000  --- Build  BHMX = 0.00000  STDMX = 0.00000  CEMX = 0.00000  MIMI = 24.06449\r\nTotal event loop time 40.26953 simtracks 787323 seedtracks 2933807 builtcands 0 maxhits 4651 on lay 0\r\n```\r\n\r\nWith changes `gcc -mavx2 -mfma -ffastmath`\r\n```\r\n================================================================\r\n=== TOTAL for 100 events\r\n================================================================\r\nTotal Matriplex fit = 0.00000  --- Build  BHMX = 0.00000  STDMX = 0.00000  CEMX = 0.00000  MIMI = 21.65153\r\nTotal event > 1 fit = 0.00000  --- Build  BHMX = 0.00000  STDMX = 0.00000  CEMX = 0.00000  MIMI = 21.58067\r\nTotal event loop time 36.93315 simtracks 787323 seedtracks 2933807 builtcands 0 maxhits 4651 on lay 0\r\n```\r\n\r\nWith changes `gcc -mavx2 -mfma -ffastmath -mveclibabi=svml  -lsvml`\r\n\r\n```\r\n================================================================\r\n=== TOTAL for 100 events\r\n================================================================\r\nTotal Matriplex fit = 0.00000  --- Build  BHMX = 0.00000  STDMX = 0.00000  CEMX = 0.00000  MIMI = 17.75612\r\nTotal event > 1 fit = 0.00000  --- Build  BHMX = 0.00000  STDMX = 0.00000  CEMX = 0.00000  MIMI = 17.69385\r\nTotal event loop time 32.37217 simtracks 787323 seedtracks 2933807 builtcands 0 maxhits 4651 on lay 0\r\n================================================================\r\n```\r\n\r\nWith changes `gcc -mavx2 -mfma -ffastmath -lmvec`\r\n\r\n```\r\n================================================================\r\n=== TOTAL for 100 events\r\n================================================================\r\nTotal Matriplex fit = 0.00000  --- Build  BHMX = 0.00000  STDMX = 0.00000  CEMX = 0.00000  MIMI = 17.16427\r\nTotal event > 1 fit = 0.00000  --- Build  BHMX = 0.00000  STDMX = 0.00000  CEMX = 0.00000  MIMI = 17.10306\r\nTotal event loop time 31.63744 simtracks 787323 seedtracks 2933807 builtcands 0 maxhits 4651 on lay 0\r\n```\r\n\r\nNo changes `icc -mAVX2` which adds `-lsvml`\r\n\r\n```\r\n================================================================\r\n=== TOTAL for 100 events\r\n================================================================\r\nTotal Matriplex fit = 0.00000  --- Build  BHMX = 0.00000  STDMX = 0.00000  CEMX = 0.00000  MIMI = 14.38005\r\nTotal event > 1 fit = 0.00000  --- Build  BHMX = 0.00000  STDMX = 0.00000  CEMX = 0.00000  MIMI = 14.33141\r\nTotal event loop time 28.65396 simtracks 787323 seedtracks 2933807 builtcands 0 maxhits 4651 on lay 0\r\n```\r\n\r\nWith changes `icc -mAVX2` which adds `-lsvml`\r\n\r\n```\r\n================================================================\r\n=== TOTAL for 100 events\r\n================================================================\r\nTotal Matriplex fit = 0.00000  --- Build  BHMX = 0.00000  STDMX = 0.00000  CEMX = 0.00000  MIMI = 15.08185\r\nTotal event > 1 fit = 0.00000  --- Build  BHMX = 0.00000  STDMX = 0.00000  CEMX = 0.00000  MIMI = 15.03019\r\nTotal event loop time 29.54984 simtracks 787323 seedtracks 2933807 builtcands 0 maxhits 4651 on lay 0\r\n```\r\n", "branch": "master", "changed_files": 5, "comments": 57, "commits": 20, "created_at": "1652105289", "deletions": 195, "labels": ["reconstruction-pending", "core-pending", "pending-signatures", "tests-pending", "orp-pending", "code-checks-approved", "tracking"], "milestone": "CMSSW_12_4_X", "number": 37868, "release-notes": [], "review_comments": 12, "state": "open", "title": "RecoTracker/MkFitCore: factorize loops to allow gcc -msse3 to vectorize loops", "updated_at": "1652444251", "user": "gartung"}