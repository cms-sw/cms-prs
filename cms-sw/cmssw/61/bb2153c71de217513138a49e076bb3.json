{"additions": 1495, "auther_ref": "CTPPS_final", "auther_sha": "89b9a759e186693e01307efd97318c52614f8a30", "author": "ghugo83", "body": "Port CTPPS to DD4hep.\r\n\r\nThere was duplicated geometry building code, relying on old DD. \r\nHence, a first step was to reorganize CTPPS geometry building, to gather duplicated functionalities.\r\nThen, the now unique and commonly used geometry building code, was ported to DD4hep.\r\n\r\n### Reorganize PPS geometry building:\r\n- **Geometry builder**:  CTPPSGeometryESModule.cc, now named **PPSGeometryESProducer.cc**\r\n(in Geometry/VeryForwardGeometryBuilder/plugins).\r\n**The geometry building functionalities are moved out from this producer, and placed in DetGeomDescBuilder.cc and DetGeomDesc.cc** (in Geometry/VeryForwardGeometryBuilder).\r\nAvoid usage of empty constructors followed by setters: instead, do the maximum at construction time. \r\n**This results in most of the geometry building (and hence the DD4hep migration) being treated in DetGeomDesc constructor, assisted by several helper functions to compute sensor type, solid shape parameters, DetId, etc.**\r\n\r\n- **PPS geometry writer to DB**: **PPSGeometryBuilder.cc** \r\n(in CondTools/Geometry/plugins).\r\nThere was heavily duplicated geometry building code here. \r\n**Instead, now just call the newly created DetGeomDescBuilder.cc** (in Geometry/VeryForwardGeometryBuilder), which contains all the common functionalities to build the (DD4hep) geometry.\r\n**In order to store information with persistent data, use PDetGeomDesc constructor** (in CondFormats/GeometryObjects/interface/PDetGeomDesc.h), instead of a lot of setters.\r\n\r\nNB: Tried to clean code here and there after the reorganization. Though, this is not a full re-writing of the code itself, which is a different topic.\r\n\r\n### DD4hep migration:\r\n- Switch to DD4hep-based versions of **DDCompactView and DDFilteredView**.\r\n- **DDTranslation  dd4hep::Direction** (ROOT::Math::XYZVector).\r\n- **DDRotationMatrix  dd4hep::Rotation3D** (ROOT::Math::Rotation3D).\r\n- **Fixed name casting regressions** (due to namespace not appearing with DD4hep).\r\n- **Fixed sensor type computation regressions** (due to namespace not appearing with DD4hep). Use a SpecPar section to select the 2x2:RPixWafer volumes.\r\n- **Fixed ID computation regressions** (due to different order of parent volumes copy numbers with DD4hep).\r\n- **Fixed shape parameters regressions** (due to different order / units with DD4hep). Only uses the Box parameters. Struct to access data.\r\n- **Debug and fixed units.** Since mm was the reference until now, by fear of regression, CTPPS team (with @wpcarvalho) has decided to keep mm as reference. Hence conversions as needed.\r\n\r\n**Ported (and tested) all scenarios to DD4hep:**\r\n**XMLs-based scenarios**:\r\n- geometryPPS_CMSxz_fromDD_2016_cfi\r\n- geometryPPS_CMSxz_fromDD_2017_cfi\r\n- geometryPPS_CMSxz_fromDD_2018_cfi\r\n- geometryRPFromDD_2017_cfi\r\n- geometryRPFromDD_2018_cfi\r\nThe associated XMLs are placed in  Geometry/VeryForwardGeometry/data/dd4hep.\r\n\r\n**DB scenario**:\r\n- geometryRPFromDB_cfi\r\nThis scenario is especially important, as it is the one called by RecoPPS/Configuration/python/recoCTPPS_cff.py#L12 , hence by all the matrix workflows.\r\n\r\n### PR validation:\r\n- **No regression anymore for any geo info** (any DetGeomDesc data member nor any solid shape parameter).\r\n**Fully tested on all volumes and all 6 scenarios.**\r\nMax diff is 1 um.\r\n- No regression as tested by Jan, thanks! (results from @jan-kaspar ):\r\n**\"Direct\" simulation, using geometry from XML files**: [make_cmp_simu.pdf](https://github.com/cms-sw/cmssw/files/5124309/make_cmp_simu.pdf)\r\n**Reconstruction of LHC data (RAW to proton), using geometry from DB**: [make_cmp_reco.pdf](https://github.com/cms-sw/cmssw/files/5124310/make_cmp_reco.pdf)\r\n\r\n@jan-kaspar @wpcarvalho @mundim @forthommel @malbouis @fabferro @dpiparo @cvuosalo @ianna @civanch \r\n", "branch": "master", "changed_files": 44, "closed_at": "1599068632", "comments": 88, "commits": 74, "created_at": "1598360070", "deletions": 1914, "labels": ["alca-approved", "code-checks-approved", "comparison-available", "db-approved", "dqm-approved", "fully-signed", "geometry-approved", "orp-approved", "reconstruction-approved", "simulation-approved", "tests-approved", "urgent"], "merge_commit_sha": "499518f59fbedc9c37805127692dd1cf6fca6181", "merged_at": "1599068632", "merged_by": "silviodonato", "milestone": "CMSSW_11_2_X", "number": 31240, "release-notes": [], "review_comments": 44, "state": "closed", "title": "Port CTPPS to DD4hep", "updated_at": "1599068665", "user": "ghugo83"}