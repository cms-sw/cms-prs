{"additions": 43, "auther_ref": "devel_fixZeroADCOfPixelDigi", "auther_sha": "94bd1e54d0f2f4cb86235866d8788482d6ce5462", "author": "missirol", "body": "#### PR description:\r\n\r\nThis PR aims to fix a crash observed offline when running the HLT on recent Run-3 collision events (might be a matter of time before the crash occurs online).\r\n\r\nThe issue was found by @Sam-Harper for TSG-FOG, and comes from the (legacy) pixel local reconstruction.\r\n\r\nA minimal recipe to reproduce the crash on `lxplus` can be found below [*]; the [log file](https://github.com/cms-sw/cmssw/files/8791685/hlt.log) with stack trace, plus additional printouts, is attached (look for \"detId=304185360\" and \"moduleInd=283\").\r\n\r\nIt looks like the origin of the issue is a silent type conversion from `int` to `uint16_t`, which changes the ADC value of a pixel (expressed in number of electrons) from `65536` to `0`.\r\n\r\nThis leads to a crash from a failed assertion in [`SiPixelRecHitSoAFromLegacy`](https://github.com/cms-sw/cmssw/blob/dedad560602adc5e6fc2038d55c47ba60649f140/RecoLocalTracker/SiPixelRecHits/plugins/SiPixelRecHitSoAFromLegacy.cc#L237).\r\n\r\nThis PR is one way to fix this. Experts can surely come up with a better solution (but a quick turnaround might be needed).\r\n\r\n_Edit_ : the crash occurs only for the CPU-based pixel reco used at HLT, but the issue behind it also applies to the GPU-based reco. The original PR has been updated based on https://github.com/cms-sw/cmssw/pull/38113#issuecomment-1140792515 and earlier comments by experts.\r\n\r\nThe fix will need to be backported to `12_4_X` and `12_3_X`.\r\n\r\nFYI: @silviodonato @mzarucki @fwyzard @Martin-Grunewald \r\n\r\nAttn: @ferencek @OzAmram @VinInn @mmusich\r\n\r\n\r\n#### PR validation:\r\n\r\nChecked on 1 event, where it solves the crash.\r\n\r\n[*] Recipe to reproduce the crash (the `merge-topic` simply adds printouts for convenience).\r\n```bash\r\n#!/bin/bash\r\n\r\nscram p CMSSW CMSSW_12_3_4_patch2\r\ncd CMSSW_12_3_4_patch2/src\r\neval `scram runtime -sh`\r\ngit cms-merge-topic missirol:keep_debugPixelDigiZero_run352417\r\nscram b -j 4\r\n\r\nhltGetConfiguration /dev/CMSSW_12_3_0/GRun \\\r\n --globaltag auto:run3_hlt_GRun \\\r\n --data \\\r\n --unprescale \\\r\n --paths MC_AK4PFJets_v* \\\r\n --output minimal \\\r\n --max-events -1 \\\r\n --l1-emulator uGT --eras Run3 \\\r\n --input root://cms-xrd-global.cern.ch//eos/cms/store/group/dpg_trigger/comm_trigger/TriggerStudiesGroup/FOG/minBias3_352417_LS68.root \\\r\n > hlt.py\r\n\r\ncat <<@EOF >> hlt.py\r\nprocess.source.eventsToProcess = cms.untracked.VEventRange('352417:68:66107185')\r\nprocess.options.numberOfThreads = 1\r\n@EOF\r\n\r\ncmsRun hlt.py &> hlt.log\r\n```\r\n\r\n#### If this PR is a backport, please specify the original PR and why you need to backport that PR:\r\n\r\nN/A", "branch": "master", "changed_files": 3, "comments": 29, "commits": 1, "created_at": "1653758787", "deletions": 28, "labels": ["reconstruction-pending", "pending-signatures", "tests-pending", "orp-pending", "bug-fix", "urgent", "code-checks-pending", "trk-dpg-pending"], "milestone": "CMSSW_12_5_X", "number": 38113, "release-notes": [], "review_comments": 3, "state": "open", "title": "guard against `uint16_t` overflows of Pixel ADC values", "updated_at": "1653898191", "user": "missirol"}