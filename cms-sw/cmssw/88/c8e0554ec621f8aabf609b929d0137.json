{"additions": 18, "auther_ref": "mm_dev_trim_down_alcaprompt_15_0_X", "auther_sha": "fff845e821156cfae8544845da865d00880f0f9d", "author": "mmusich", "body": "backport of https://github.com/cms-sw/cmssw/pull/48924\r\n\r\n#### PR description:\r\n\r\nFrom the original PR\r\n\r\n> In the context of the Next Generation Triggers Task 3.4 (\"[Optimal HLT Calibrations](https://cms-ngt-hlt.docs.cern.ch/Task34/)\") we are interested in speeding up the calibration procedures with the aim of implementing real time calibrations for the phase-2 upgrade HLT. \r\n> A stepping stone towards that, consists in the [*NGT Demonstrator*](https://indico.cern.ch/event/1504131/contributions/6341017/attachments/3028520/5345755/NGT-HLT_OptimalCalibrations_AlCaDBWorkshop_10.03.2025_Zarucki.pdf#page=7) which we plan to deploy and operate during Run 3 (late 2025 and 2026). \r\n> The \"calibration leg\" of such demonstrator is planned to run a trimmed down version of the Prompt Calibration Loop delivering [selected alignment and calibrations](https://indico.cern.ch/event/1504131/contributions/6341017/attachments/3028520/5345755/NGT-HLT_OptimalCalibrations_AlCaDBWorkshop_10.03.2025_Zarucki.pdf#page=15). \r\n> While looking at optimizing the performance of PCL (see also https://github.com/cms-sw/cmssw/pull/48886) we noticed that a non negligible amount of resources is spent in running duplicated modules (those are different instances of the same `EDModule` configured in the exactly same way but with a different label, thus run by the framework).\r\n> An example in identifying such modules if provided below [*]. The resulting output is available [here](https://marcomusich.web.cern.ch/NGT/3.4/duplicates_step3.txt).\r\n> The goal of this PR is neutralize the CPU / timing penalty from the worst offenders (a more optimal configuration would likely need attention from AlCaDB and involvement of different groups).\r\n\r\n#### PR validation:\r\n\r\n\r\nWe have run the following command:\r\n\r\n```bash\r\n#!/bin/bash\r\n\r\ncmsDriver.py step3 --conditions 140X_dataRun3_Express_v3 \\\r\n\t-s ALCAOUTPUT:SiStripCalZeroBias+SiStripPCLHistos,ALCA:PromptCalibProd+PromptCalibProdSiStrip+PromptCalibProdSiPixelAli+PromptCalibProdSiStripGains+PromptCalibProdSiStripGainsAAG+PromptCalibProdSiPixel+PromptCalibProdSiPixelLA+PromptCalibProdSiStripHitEff+PromptCalibProdSiPixelAliHG+PromptCalibProdSiPixelAliHGComb \\\r\n\t--datatier ALCARECO --eventcontent ALCARECO --triggerResultsProcess RECO -n -1 \\\r\n\t--filein file:step2_nomod.root --no_exec --fileout file:step3_nomod.root --python_filename step3_ALCAOUTPUT_ALCA.py\r\n\r\ncat <<@EOF>> step3_ALCAOUTPUT_ALCA_nomod.py\r\nprocess.options.numberOfStreams = 8\r\nprocess.options.numberOfThreads = 8\r\n\r\nprocess.load('HLTrigger.Timer.FastTimerService_cfi')\r\n\r\nprocess.FastTimerService.writeJSONSummary = True\r\nprocess.FastTimerService.jsonFileName = \"timing_tracking_upperbound_s3_nomod.json\"\r\n\r\n@EOF\r\n\r\ncmsRun step3_ALCAOUTPUT_ALCA.py\r\n```\r\non around 40k events from run and measured the timing using either or not the changes in this branch:\r\n\r\n| [w/o this PR](https://marcomusich.web.cern.ch/circles/web/piechart.php?colours=default&data_name=data&dataset=timing_tracking_upperbound_s3_nomod&groups=packages&local=false&resource=time_real&show_labels=true&show_animations=true&threshold=0)  | [w/ this PR](https://marcomusich.web.cern.ch/circles/web/piechart.php?colours=default&data_name=data&dataset=timing_tracking_upperbound_s3&groups=packages&local=false&resource=time_real&show_labels=true&show_animations=true&threshold=0) |\r\n| ------------- | ------------- |\r\n| <img width=\"1094\" height=\"1084\" alt=\"Screenshot from 2025-09-14 17-35-33\" src=\"https://github.com/user-attachments/assets/d2683609-4c03-4581-8f0f-5bb284e4f959\" /> | <img width=\"1094\" height=\"1084\" alt=\"Screenshot from 2025-09-14 17-35-43\" src=\"https://github.com/user-attachments/assets/9f9a5c47-509f-40f0-a90d-5e6a62eeca1c\" /> |\r\n\r\nThe timing reduction is of around 30% of the job total. \r\n\r\n#### If this PR is a backport please specify the original PR and why you need to backport that PR. If this PR will be backported please specify to which release cycle the backport is meant for:\r\n\r\nVerbatim backport of https://github.com/cms-sw/cmssw/pull/48924 to CMSSW_15_0_X, intended for data-taking operations. \r\n\r\n---\r\n[*]\r\n\r\n```\r\ncmsrel CMSSW_15_0_14\r\ncd CMSSW_15_0_14/src/\r\ncmsDriver.py step3 --conditions 140X_dataRun3_Express_v3 \\\r\n    -s ALCAOUTPUT:SiStripCalZeroBias+SiStripPCLHistos,ALCA:PromptCalibProd+PromptCalibProdSiStrip+PromptCalibProdSiPixelAli+PromptCalibProdSiStripGains+PromptCalibProdSiStripGainsAAG+PromptCalibProdSiPixel+PromptCalibProdSiPixelLA+PromptCalibProdSiStripHitEff+PromptCalibProdSiPixelAliHG+PromptCalibProdSiPixelAliHGComb \\\r\n    --datatier ALCARECO --eventcontent ALCARECO --triggerResultsProcess RECO -n -1 \\\r\n    --filein file:step2.root --no_exec --fileout file:step3.root\r\nedmConfigDump step3_ALCAOUTPUT_ALCA.py > dump.py\r\nhltFindDuplicates dump.py\r\n```\r\n", "branch": "CMSSW_15_0_X", "changed_files": 3, "comments": 6, "commits": 2, "created_at": "1758085075", "deletions": 69, "labels": ["alca-pending", "pending-signatures", "tests-approved", "orp-pending", "backport-ok", "performance-improvements", "trk", "ngt"], "milestone": "CMSSW_15_0_X", "number": 48943, "release-notes": [], "review_comments": 0, "state": "open", "title": "[15.0.X] Trim down `ALCAPROMPT` step in the Prompt Calibration Loop", "updated_at": "1758093700", "user": "mmusich"}