{"additions": 94, "auther_ref": "dqm-fix-empty-lumis", "auther_sha": "b4c63f1c24dcb2ebefb33193c3c248e4ff893bd2", "author": "schneiml", "body": "#### PR description:\r\n\r\nAs reported in #29605, it can happen that a `DQMOneEDAnalyzer` does not\r\nproduce its per lumi MEs, because there were no events in the\r\nLumisection and it only calls `enterLumi` as needed per event.\r\n\r\nTo prevent this, we need to make sure that lumi ME are always created\r\nfor every ME, but we can't have lumi transitions in `DQMOneEDAnalyzer`, so\r\nit needs to happen in a global callback. But there we can't safely use\r\n`enterLumi`, since that would corrupt the module's local MEs.\r\n\r\nThe solution is to have a new method, `initLumi`, dedicated to\r\ninitializing global MEs, but not touching local MEs. This is actually a\r\nnice thing in general, since now `initLumi`/`cleanupLumi` form a symmetrical\r\npair (create/destroy global MEs), as well as `enterLumi`/`leaveLumi` (update\r\nlocal MEs). All of these are idempotent, as before.\r\n\r\nThere are a bunch of corner cases around booking: `initLumi` *must* be\r\ncalled before `enterLumi`, but the global callback that triggers it\r\nglobally might (will) happen before booking has happened for the module.\r\nSo we also need to do it after booking. There is a race related to lumi\r\nMEs if `globalBeginLumi` can happen *before* `beginRun` finishes for all\r\nplugins. This should not happen for now, as I understand.\r\n\r\nThis should fix #29605.\r\n\r\nThe \"empty lumis\" unit test is quite ugly, since `EmptySource` does not really support empty lumisections.\r\n\r\n#### PR validation:\r\n\r\n4.28 passes in my local test. A new unit test tests empty lumisections.\r\n\r\n", "branch": "master", "changed_files": 8, "closed_at": "1588704969", "comments": 19, "commits": 4, "created_at": "1588680376", "deletions": 11, "labels": ["code-checks-approved", "comparison-available", "dqm-approved", "fully-signed", "orp-approved", "tests-approved"], "merge_commit_sha": "0dd520dac3c9f26a92f415da5198b91816b5eeae", "merged_at": "1588704968", "merged_by": "cmsbuild", "milestone": "CMSSW_11_1_X", "number": 29738, "release-notes": [], "review_comments": 0, "state": "closed", "title": "DQM: Fix empty lumis with per-lumi plots in DQMOneEDAnalyzer", "updated_at": "1589199096", "user": "schneiml"}