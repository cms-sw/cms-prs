{"additions": 4, "auther_ref": "fc-speedupMtdNumbering", "auther_sha": "3a7667e240c198ce7fe35bc6a0f9fb9e04e6ee77", "author": "fabiocos", "body": "#### PR description:\r\n\r\nThe DDD implementation of the MTD reconstruction geometry creation, in the ```DDCmsMTDConstruction``` class of ```Geometry/MTDNumberingBuilder``` is a killer for the startup CMSSW performances. It turns out that the veto filtering on non sensitive volumes is the key responsible for this, likely due to an excessive number of ```find``` of strings in the logical name of processed volumes. Just removing it, without impact on the geometry reconstructed, effectively solves the problem.\r\n\r\nAs a side note, the DD4hep version, implemented in parallel since 2020, does not suffer of this issue, using a different filtering approach. Unfortunately this is of little help, since we are still in the middle of the transition between different geometry back-ends.\r\n\r\nAddressing https://github.com/cms-sw/cmssw/issues/43062 .\r\n\r\n#### PR validation:\r\n\r\nThe MTD reconstruction geometry unit tests pass, showing that the same geometry as before is reconstructed. Both ```Tracer``` timing and igprof profiling show a sizeable improvement, from almost 50 down to 3 seconds on the machine used for tests.\r\n\r\nBefore:\r\n\r\n```\r\nBegin processing the 1st record. Run 1, Event 1, LumiSection 1 on stream 0 at 26-Oct-2023 17:03:28.265 CEST\r\n26-Oct-2023 17:03:28.26 CEST  ++++ starting: processing event : stream = 0 run = 1 lumi = 1 event = 1 time = 1\r\n26-Oct-2023 17:03:28.26 CEST  ++++++ starting: processing path 'p1' : stream = 0\r\n26-Oct-2023 17:03:28.26 CEST  ++++++++ starting: prefetching before processing event for module: stream = 0 label = 'prod' id = 3\r\n26-Oct-2023 17:03:28.26 CEST  ++++++++ starting: prefetching for esmodule: label = 'mtdNumberingGeometry' type = MTDGeometricTimingDetESModule in record = IdealGeometryRecord\r\n26-Oct-2023 17:03:28.26 CEST  ++++++++++ starting: prefetching for esmodule: label = '' type = XMLIdealGeometryESSource in record = IdealGeometryRecord\r\n26-Oct-2023 17:03:28.26 CEST  ++++++++++ finished: prefetching for esmodule: label = '' type = XMLIdealGeometryESSource in record = IdealGeometryRecord\r\n26-Oct-2023 17:03:28.26 CEST  ++++++++++ starting: processing esmodule: label = '' type = XMLIdealGeometryESSource in record = IdealGeometryRecord\r\n26-Oct-2023 17:03:31.47 CEST  ++++++++++ finished: processing esmodule: label = '' type = XMLIdealGeometryESSource in record = IdealGeometryRecord\r\n26-Oct-2023 17:03:31.47 CEST  ++++++++ finished: prefetching for esmodule: label = 'mtdNumberingGeometry' type = MTDGeometricTimingDetESModule in record = IdealGeometryRecord\r\n26-Oct-2023 17:03:31.47 CEST  ++++++++ starting: processing esmodule: label = 'mtdNumberingGeometry' type = MTDGeometricTimingDetESModule in record = IdealGeometryRecord\r\n26-Oct-2023 17:04:08.03 CEST  ++++++++ finished: processing esmodule: label = 'mtdNumberingGeometry' type = MTDGeometricTimingDetESModule in record = IdealGeometryRecord\r\n26-Oct-2023 17:04:08.03 CEST  ++++++++ finished: prefetching before processing event for module: stream = 0 label = 'prod' id = 3\r\n26-Oct-2023 17:04:08.03 CEST  ++++++++ starting: processing event for module: stream = 0 label = 'prod' id = 3\r\n%MSG-i GeometricTimingDetAnalyzer:  GeometricTimingDetAnalyzer:prod  26-Oct-2023 17:04:08 CEST Run: 1 Event: 1\r\nBeginning MTD GeometricTimingDet container dump \r\n%MSG\r\n```\r\n\r\nWith this PR:\r\n\r\n\r\n```\r\nBegin processing the 1st record. Run 1, Event 1, LumiSection 1 on stream 0 at 26-Oct-2023 17:22:07.701 CEST\r\n26-Oct-2023 17:22:07.70 CEST  ++++ starting: processing event : stream = 0 run = 1 lumi = 1 event = 1 time = 1\r\n26-Oct-2023 17:22:07.70 CEST  ++++++ starting: processing path 'p1' : stream = 0\r\n26-Oct-2023 17:22:07.70 CEST  ++++++++ starting: prefetching before processing event for module: stream = 0 label = 'prod' id = 3\r\n26-Oct-2023 17:22:07.70 CEST  ++++++++ starting: prefetching for esmodule: label = 'mtdNumberingGeometry' type = MTDGeometricTimingDetESModule in record = IdealGeometryRecord\r\n26-Oct-2023 17:22:07.70 CEST  ++++++++++ starting: prefetching for esmodule: label = '' type = XMLIdealGeometryESSource in record = IdealGeometryRecord\r\n26-Oct-2023 17:22:07.70 CEST  ++++++++++ finished: prefetching for esmodule: label = '' type = XMLIdealGeometryESSource in record = IdealGeometryRecord\r\n26-Oct-2023 17:22:07.70 CEST  ++++++++++ starting: processing esmodule: label = '' type = XMLIdealGeometryESSource in record = IdealGeometryRecord\r\n26-Oct-2023 17:22:10.70 CEST  ++++++++++ finished: processing esmodule: label = '' type = XMLIdealGeometryESSource in record = IdealGeometryRecord\r\n26-Oct-2023 17:22:10.70 CEST  ++++++++ finished: prefetching for esmodule: label = 'mtdNumberingGeometry' type = MTDGeometricTimingDetESModule in record = IdealGeometryRecord\r\n26-Oct-2023 17:22:10.70 CEST  ++++++++ starting: processing esmodule: label = 'mtdNumberingGeometry' type = MTDGeometricTimingDetESModule in record = IdealGeometryRecord\r\n%MSG-i MTDNumbering:   MTDGeometricTimingDetESModule:mtdNumberingGeometry@callESModule  26-Oct-2023 17:22:10 CEST Run: 1 Event: 1\r\nTop level node = OCMS\r\n%MSG\r\n```", "branch": "master", "changed_files": 1, "comments": 34, "commits": 2, "created_at": "1698328176", "deletions": 50, "labels": ["geometry-approved", "fully-signed", "tests-approved", "orp-pending", "upgrade-approved", "code-checks-approved"], "milestone": "CMSSW_13_3_X", "number": 43124, "release-notes": [], "review_comments": 5, "state": "open", "title": "MTD geometry: speed up MTD reco geometry construction", "updated_at": "1699256711", "user": "fabiocos"}