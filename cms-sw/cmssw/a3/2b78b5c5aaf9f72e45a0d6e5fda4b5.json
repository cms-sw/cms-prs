{"additions": 28, "auther_ref": "mm_fix_ticl_barrel_hltconfiguration", "auther_sha": "75b5b680db30088a30cb8122d7899b902443ed48", "author": "mmusich", "body": "#### PR description:\r\n\r\nMultiple fixes are required to run the TICL-barrel validation at HLT.\r\n\r\n## First issue\r\n\r\nRunning:\r\n\r\n```\r\ncmsDriver.py step2 --step L1P2GT,HLT:NGTScouting,VALIDATION:@hltValidation \\\r\n\t\t\t\t --conditions auto:phase2_realistic_T33 \\\r\n\t\t\t\t --datatier GEN-SIM-DIGI-RAW,DQMIO \\\r\n\t\t\t\t -n 4 \\\r\n\t\t\t\t --eventcontent FEVTDEBUGHLT,DQMIO \\\r\n\t\t\t\t --geometry ExtendedRun4D110 \\\r\n\t\t\t\t --era Phase2C17I13M9 \\\r\n\t\t\t\t --procModifier ticl_barrel \\\r\n\t\t\t\t --filein file:/eos/cms/store/relval/CMSSW_15_1_0_pre4/RelValTTbar_14TeV/GEN-SIM-DIGI-RAW/PU_150X_mcRun4_realistic_v1_STD_Run4D110_PU-v1/2580000/e01960c2-2b0f-4911-b35f-f71629844dee.root \\\r\n\t\t\t\t --fileout file:step2.root \\\r\n\t\t\t\t --nThreads 1 \\\r\n\t\t\t\t --process HLTX \\\r\n\t\t\t\t --inputCommands='keep *, drop *_hlt*_*_HLT, drop triggerTriggerFilterObjectWithRefs_l1t*_*_HLT'\r\n```\r\n\r\nleads to:\r\n\r\n```\r\n----- Begin Fatal Exception 17-Jul-2025 11:24:05 CEST-----------------------\r\nAn exception of category 'ScheduleExecutionFailure' occurred while\r\n   [0] Calling beginJob\r\nException Message:\r\nUnrunnable schedule\r\nThe Path/EndPath configuration could cause the job to deadlock\r\n  module 'hltParticleFlowRecHitECALUnseeded' is on path 'DST_PFScouting' and depends on module 'hltEcalRecHit'\r\n  module 'hltEcalRecHit' is on path 'DST_PFScouting' and follows module 'hltParticleFlowRecHitECALUnseeded' on the path\r\n----- End Fatal Exception -------------------------------------------------\r\n```\r\n\r\nThe command used to test https://github.com/cms-sw/cmssw/pull/47859 was\r\n\r\n```bash\r\nHLTrigger/Configuration/scripts/hltPhase2UpgradeIntegrationTests --globaltag auto:phase2_realistic_T33 --geometry ExtendedRun4D110 --events 10 --threads 4 --procModifiers ticl_barrel\r\n```\r\n\r\nwhich does not test the `DST_PFScouting` path, used [here](https://github.com/cms-sw/cmssw/blob/e152e7e2b26dd10cb2a20a5f1bc26ac6f8e4f0e6/HLTrigger/Configuration/python/HLT_NGTScouting_cff.py#L292). \r\n\r\n~~Would it make sense to add `HLT:NGTScouting` [here](https://github.com/cms-sw/cmssw/blob/e152e7e2b26dd10cb2a20a5f1bc26ac6f8e4f0e6/HLTrigger/Configuration/scripts/hltPhase2UpgradeIntegrationTests#L146) to avoid these issues in the future?~~ (This has been addressed at https://github.com/cms-sw/cmssw/pull/48664 + https://github.com/cms-sw/cms-bot/pull/2545 )\r\n\r\n\r\n\r\n## Second issue\r\n\r\nHaving fixed the ordering of the sequences in `DST_PFScouting`, the following error is observed when running the above step2 command with  `--procModifier alpaka,ticl_barrel`:\r\n\r\n```\r\n----- Begin Fatal Exception 17-Jul-2025 18:16:59 CEST-----------------------\r\nAn exception of category 'ProductNotFound' occurred while\r\n   [0] Processing  Event run: 1 lumi: 61 event: 6001 stream: 0\r\n   [1] Running path 'DST_PFScouting'\r\n   [2] Calling method for module MergeClusterProducer/'hltMergeLayerClusters'\r\nException Message:\r\nPrincipal::getByToken: Found zero products matching all criteria\r\nLooking for type: std::vector<reco::CaloCluster>\r\nLooking for module label: hltHgcalLayerClustersEE\r\nLooking for productInstanceName: \r\n\r\n   Additional Info:\r\n      [a] If you wish to continue processing events after a ProductNotFound exception,\r\nadd \"TryToContinue = cms.untracked.vstring('ProductNotFound')\" to the \"options\" PSet in the configuration.\r\n\r\n----- End Fatal Exception -------------------------------------------------\r\n```\r\n\r\nThis is due to a bug in the CE-E layer cluster input collection used when the `alpaka` and `ticl_barrel` modifiers are both active. The fix consists on defining what happens when both modifiers are active, via the `(ticl_barrel & alpaka).toModify(...)` call.\r\nIn parallel, I added the negation ~ operator in some `.toModify()` calls. This improves clarity and makes the code more efficient, since [this call](https://github.com/cms-sw/cmssw/blob/e152e7e2b26dd10cb2a20a5f1bc26ac6f8e4f0e6/FWCore/ParameterSet/python/Config.py#L1712) is not run.\r\n\r\n#### PR validation:\r\n\r\nTested with `runTheMatrix.py -w upgrade -l 29634.771` (wf from [48687](https://github.com/cms-sw/cmssw/pull/48687)).\r\n\r\n#### If this PR is a backport please specify the original PR and why you need to backport that PR. If this PR will be backported please specify to which release cycle the backport is meant for:\r\n\r\nN/A", "branch": "master", "changed_files": 3, "closed_at": "1755709411", "comments": 22, "commits": 4, "created_at": "1755507554", "deletions": 43, "labels": ["hlt-approved", "fully-signed", "tests-approved", "orp-approved", "code-checks-approved", "ngt"], "merge_commit_sha": "763da79e4e09c5053b9d64c6516816c4942bdd51", "merged_at": "1755709411", "merged_by": "cmsbuild", "milestone": "CMSSW_15_1_X", "number": 48756, "release-notes": [], "review_comments": 0, "state": "closed", "title": "fix ticl barrel in ph-2 HLT configuration", "updated_at": "1759471180", "user": "mmusich"}