{"additions": 968, "auther_ref": "cpu_only_cleanup", "auther_sha": "1ab83f467e7a2d1ba4261f3bcecf3609814061e4", "author": "GPUOfflinePV-CMS", "body": "Vast majority of the work from @giorgiopizz.\r\n\r\nThis PR proposes the addition of a new track clusterizer and a new 3D position estimator for the `PrimaryVertexProducer`:\r\n\r\n- the new clusterizer sorts the tracks in the z coordinate, splits them in blocks of same size (set by default to `512`) with a fixed overlap fraction between blocks (set by default to `0.5`) and performs independently the Determistin Annealing along all the blocks. The block size and the overlap fraction are made configurable parameters.\r\n\r\n- the new estimator iteratively estimates the vertex 3D coordinates and errors using the weighted mean of tracks impact point at the beamspot position and uncertainty. The iterations includes an outlier rejection to improve the performance. \r\n\r\nThis PR **does not** introduce the new vertexing as default but add these options to the `PrimaryVertexProducer`. The new clustering and vertexing are used only in case the (new) processes modifiers `vertexInBlocks` and  `weightedVertexing` are added to the process. Two workflows are added to the matrix to test this setups: `*.278` which runs the full reco with the weighted vertexing and the `*.279` which runs `trackingOnly` wfs. A version of the algorithm for BS constrained vertexing is also added.\r\n\r\n### Samples for validation\r\n\r\n- Phase1: `/RelValTTbar_14TeV/CMSSW_12_5_0_pre5-PU_125X_mcRun3_2022_realistic_v3-v2/`\r\n- Phase2: `/RelValTTbar_14TeV/CMSSW_12_4_0_pre3-PU_123X_mcRun4_realistic_v11_2026D88PU200-v1/`\r\n\r\n### Computational Performance\r\n\r\nHere the timing performance for various working points evaluated on `fu-c2a02-37-01` machine at P5 (`8 threads 8 streams`).\r\n\r\n`PrimaryVertexProducer` cpu time for Phase1/Phase2 samples for different `block_size`s and `overlap_frac`s:\r\n\r\n<p align=center>\r\n<img width=\"300\" src=\"https://user-images.githubusercontent.com/16901146/195576720-878dfcf3-9b46-4bec-93ca-e1876299f742.png\">       <img width=\"300\"  src=\"https://user-images.githubusercontent.com/16901146/195577060-f90d569d-352d-4eb2-85f8-199b45646126.png\"> \r\n</p>\r\n\r\n`PrimaryVertexProducer` speed up w.r.t the current producer for Phase1/Phase2 samples for different `block_size`s and `overlap_frac`s:\r\n\r\n<p align=center>\r\n<img width=\"300\" alt=\"phase1_speedup\" src=\"https://user-images.githubusercontent.com/16901146/195577817-c741e795-3741-4dcf-8caa-50a6818a8cfd.png\">         <img width=\"300\" alt=\"phase2_speedup\" src=\"https://user-images.githubusercontent.com/16901146/195577498-b1bc347b-88be-40ab-be64-c167afbba8cc.png\">\r\n</p>\r\n\r\n### Physics Performance\r\n\r\n - Phase1 validation plots (from MTV), with the `overlap_frac=0.5` and `block_size=256` or `block_size=128` [here](https://adiflori.web.cern.ch/adiflori/phase1_vertices/plots_vertex.html).  \r\n - Phase2 validation plots for `block_size=128,256,512` (in all plots `cpu` stands for the current algorithm version):\r\n   - [plots](https://adiflori.web.cern.ch/adiflori/cpu_vertexing/plots/phase2/mtv_0p15/) for  `overlap_frac=0.15`;  \r\n   - [plots](https://adiflori.web.cern.ch/adiflori/cpu_vertexing/plots/phase2/mtv_0p25/) for  `overlap_frac=0.25`;  \r\n   - [plots](https://adiflori.web.cern.ch/adiflori/cpu_vertexing/plots/phase2/mtv_0p50/) for  `overlap_frac=0.50`.  \r\n - Phase2 [different contributions](https://gpizzati.web.cern.ch/pv/plots_approval_t2/all/ ): find here a collection of results that shows the different contributions of the new clusterizer and the new estimator altogether and decoupled.\r\n\r\n### Further references and readings\r\n\r\nhttps://indico.cern.ch/event/1175120/#2-offloading-deterministic-ann\r\nhttps://indico.cern.ch/event/1206394/#47-dp-note-approval-primary-ve\r\nhttps://indico.cern.ch/event/1152032/#4-offloading-deterministic-ann", "branch": "master", "changed_files": 10, "comments": 39, "commits": 5, "created_at": "1667805549", "deletions": 27, "labels": ["reconstruction-pending", "operations-pending", "pending-signatures", "tests-pending", "orp-pending", "pdmv-pending", "upgrade-pending", "code-checks-rejected", "performance-improvements", "tracking"], "milestone": "CMSSW_12_6_X", "number": 39995, "release-notes": [], "review_comments": 17, "state": "open", "title": "New Vertex Clustering in Blocks and Weighted Mean Estimator", "updated_at": "1668500531", "user": "AdrianoDee"}