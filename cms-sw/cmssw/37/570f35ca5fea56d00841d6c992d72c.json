{"additions": 206, "auther_ref": "failedToRegisterConsumes", "auther_sha": "7b2d9a7bdfe7bf064a3086a5473e3051b8358d18", "author": "makortel", "body": "#### PR description:\r\n\r\nhttps://github.com/cms-sw/cmssw/pull/38864 reported a case where an EDAnalyzer using `Event::getByLabel()`  without declaring the consumed data products got a `ProductNotFound` exception instead of more explanatory `GetByLabelWithoutRegistration` exception. I traced this down to `ProductResolverIndexHelper` not being populated (from `ProductRegistry` with ~~non-consumed branches~~ branches that have product type that is not consumed in the job (either via the same or different branch)\r\nhttps://github.com/cms-sw/cmssw/blob/db4ff9a6cf2fea967f3d80ca084d195e6f5a17ed/DataFormats/Provenance/src/ProductRegistry.cc#L419-L422\r\nleading to `ProductResolverIndexHelper::index()` returning a `ProductResolverIndexInvalid` and  `Principal::findProductByLabel()` returning `nullptr`, which is interpreted as `ProductNotFound` by calling code.\r\n\r\nThis PR proposes to change the `Principal::findProductByLabel()` to check the branch existence directly from `ProductRegistry` after getting `ProductResolverIndexInvalid`, and throw `GetByLabelWithoutRegistration` exception if the branch in question is present. This adds some cost, but only in case\r\n* code calls consumes but uses (deprecated) `getByLabel()` to get the data, and\r\n* product in question does not exist, and\r\n* code checks the `Handle` validity and is able to ignore the missing product\r\n\r\nI would expect this case to be rare, and therefore the cost to be acceptable. I also think we should make an effort to address the remaining `getByLabel()` calls in the near-to-medium-future.\r\n\r\n#### PR validation:\r\n\r\nChecked that the test configuration in #38864 now throws `GetByLabelWithoutRegistration` exception.", "branch": "master", "changed_files": 6, "closed_at": "1659394482", "comments": 21, "commits": 2, "created_at": "1658941625", "deletions": 0, "labels": ["core-approved", "fully-signed", "tests-approved", "orp-approved", "code-checks-approved"], "merge_commit_sha": "79e78392252b6a0a58b883b612f6118ea8be99c2", "merged_at": "1659394482", "merged_by": "cmsbuild", "milestone": "CMSSW_12_5_X", "number": 38875, "release-notes": [], "review_comments": 0, "state": "closed", "title": "Throw GetByLabelWithoutRegistration exception also when no module in a job registered consumption of a given branch", "updated_at": "1659394482", "user": "makortel"}