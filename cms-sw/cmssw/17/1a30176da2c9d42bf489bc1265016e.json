{"additions": 15, "auther_ref": "gpu_crash_34831_fix_2021_09_10_release12_1_X", "auther_sha": "1444e50135f468a310e7b2abde7df9c665aa598d", "author": "czangela", "body": "#### PR description:\r\n\r\nThese changes address the GPU error brought up in #34831 [comment](https://github.com/cms-sw/cmssw/issues/34831#issuecomment-896409931). [1]\r\n\r\nThe was error apparently was due to a `digi` at `row` 0 `col` 0, and the `adc` value not being (correctly) set in the packing, and then when checking in [SiPixelDigisClustersFromSoA.cc#137](https://cmssdt.cern.ch/dxr/CMSSW/source/RecoLocalTracker/SiPixelClusterizer/plugins/SiPixelDigisClustersFromSoA.cc#137) that one digi was skipped, so the associated cluster never got created, so later one ends up with one more rechit than actual clusters in that one module.\r\n\r\nThis is the actual digi being lost:\r\n`Digi index 754; clusid 8; rawIdArr 344545284; adc 25661, pdigi: 00000000000000000000000000000000`\r\n\r\nSince the adc value is not being retrieved from the packed format but a [separate adc array (see SiPixelDigisSoA)](https://cmssdt.cern.ch/dxr/CMSSW/source/DataFormats/SiPixelDigi/interface/SiPixelDigisSoA.h#25), \r\nadding `digis.adc(i) == 0` is an innocent extra condition that solves the crash.\r\n\r\nProbably an **extra look at packing on the GPU is required and maybe a fix as well**.\r\n\r\n[1]\r\n```\r\ncmsRun: /data/cmsbld/jenkins/workspace/auto-builds/CMSSW_11_3_4-slc7_amd64_gcc900/build/CMSSW_11_3_4-build/tmp/BUILDROOT/58d469321d6ecb0427dd1e9f6c3703d5/opt/cmssw/slc7_amd64_gcc900/cms/cmssw/CMSSW_11_3_4/src/RecoLocalTracker/SiPixelRecHits/plugins/SiPixelRecHitFromCUDA.cc:143: \r\nvirtual void SiPixelRecHitFromCUDA::produce(edm::Event&, const edm::EventSetup&): \r\nAssertion `nhits <= dsv.size()' failed.\r\n\r\n\r\nA fatal system signal has occurred: abort signal\r\nThe following is the call stack containing the origin of the signal.\r\n\r\n...\r\n\r\nModule: SiPixelRecHitFromCUDA:hltSiPixelRecHits@cuda (crashed)\r\n```\r\n\r\n#### PR validation:\r\n\r\nAtm it was only checked that the recipe described in #34831 does not crash in 11_3_4.\r\n\r\n#### if this PR is a backport please specify the original PR and why you need to backport that PR:", "branch": "master", "changed_files": 4, "comments": 24, "commits": 2, "created_at": "1631281197", "deletions": 4, "labels": ["reconstruction-pending", "pending-signatures", "tests-approved", "orp-pending", "bug-fix", "code-checks-approved", "heterogeneous-pending"], "milestone": "CMSSW_12_1_X", "number": 35229, "release-notes": [], "review_comments": 0, "state": "open", "title": "Fix for SiPixelRecHitFromCUDA crash during online GPU tests", "updated_at": "1631788229", "user": "czangela"}