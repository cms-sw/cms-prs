{"additions": 160, "auther_ref": "12_6_X-discardls", "auther_sha": "fb80c07fb11a5e16eba227c50a4dff5256d80035", "author": "smorovic", "body": "#### PR description:\r\n\r\nTwo changes are implemented for the file-based output protocol:\r\n\r\nEarly \"initemp\" file marker:\r\n* A file marker is created in constructor (.initemp of .ini depending on the stream type and content availability at construction). From 12_6_X, as noticed in tests, beginRun (or globalBeginRun) in GlobalEvFOutputModule can be called after event processing in the source starts, so creating such markers at beginRun is no longer sufficient. Marker needs to be created early for hltd daemon to know which streams are in the run, and therefore wait for output completion until lumisection can be closed in the merging system. Standard INI file is still created with information from beginRun, except in case of DQMHistograms where it is empty, so creation was moved to constructor.\r\n\r\n* Changes are implemented in the GlobalEvFOutputModule (data streams), DQMFileSaverPB (DQMHistograms stream) and L1/HLTriggerJsonMonitoring (L1/HLTRates streams). **Note:** in combination with correspoding changes in hltd, this patch is **required** for CMSSW_12_6_X being used in the HLT environment, as collecting output doesn't work with current version of the sw.\r\n\r\nDiscard LS:\r\n* appearance of a file marker in hltd run directory will trigger discard of specific LS data locally in CMSSW. Motivation for this is freeing space in temporary ramdisks in HLT to allow data processing to be unblocked. With concurrent lumisections (N = 2 by default in HLT), LS potentially doesn't get closed until N new lumisections are queued, so a range of several lumisections is checked by the input source. In the output module, a new file marker check (this is a fast file operation done in ramdisk) is performed before each event is written. Discarding is implemented only for the data streams, since special streams are negligible in size.\r\n\r\n#### PR validation:\r\nTested and verified in a small DAQ cluster providing environment (services) analogous to a production BU-FU setup.", "branch": "master", "changed_files": 8, "comments": 16, "commits": 11, "created_at": "1668687534", "deletions": 41, "labels": ["dqm-pending", "hlt-pending", "daq-approved", "pending-signatures", "orp-pending", "tests-started", "bug-fix", "code-checks-approved"], "milestone": "CMSSW_12_6_X", "number": 40099, "release-notes": [], "review_comments": 8, "state": "open", "title": "(DAQ) File based protocol update (12_6_X)", "updated_at": "1669045584", "user": "smorovic"}