{"additions": 202, "auther_ref": "bsEDP", "auther_sha": "a4e259a3931cf0ae9368f43bdb4ef6d5d19c95b4", "author": "lguzzi", "body": "#### PR description:\r\nThis PR moves the online beam spot arbitration between the two DQM clients (legacy and hlt) to the EDProducer ([RecoVertex/plugin/BeamSpotOnlineProducer.cc](RecoVertex/plugin/BeamSpotOnlineProducer.cc)), removing the need for the ESProducer ([RecoVertex/plugin/OnlineBeamSpotESProducer.cc](RecoVertex/plugin/OnlineBeamSpotESProducer.cc)). These modifications were asked in https://github.com/cms-sw/cmssw/issues/39840 to allow selecting the proper event timestamp instead of the wall-clock time during the record selection.\r\nThe main modification is in [RecoVertex/plugin/BeamSpotOnlineProducer.cc](RecoVertex/plugin/BeamSpotOnlineProducer.cc):\r\n- now reading the two DQM records (```BeamSpotOnlineLegacyObjectsRcd``` and ```BeamSpotOnlineHLTObjectsRcd```) instead of the transient record.\r\n- the ```useTransientRecord``` argument is renamed ```useBSOnlineRecords```.\r\n- three arguments are added to the producer and used in the arbitration.\r\n  - ```sigmaZThreshold``` (default 2 cm) is used to accept or reject a single record based on the beam spot sigmaZ (must be higher than threshold to be accepted). This selection was done before in the ESProducer.\r\n  - ```sigmaXYThreshold``` (default 4 mum) is used to accept or reject a single record based on the beam spot sigmaX and sigmaY (must be higher than threshold to be accepted). This selection was done before in the ESProducer.\r\n  - ```timeThreshold``` (default 48 h) is is used to accept or reject a single record based on the elapsed time between the event and the record creation. This selection was done similarly in the ESProducer but is now using the event proper timestamp instead of the job wall-clock time.\r\n \r\nThe logic for the record arbitration is unchanged.\r\nThe ESProducer is also removed from the phase2 simplified HLT menu and the EDProducer is set accordingly.\r\nThis only affects online operations (running with ```useBSOnlineRecords=cms.bool(True)```).\r\n\r\nThe [OnlineBeamMonitor.cc](DQM/BeamMonitor/plugins/OnlineBeamMonitor.cc) has also been updated to fetch the information saved in the HLT collection instead of the transient record. This is done in the first event of each lumisection.\r\n\r\n#### PR validation:\r\n\r\nI validated this PR using the suggested recipe:\r\n```\r\ncd src\r\nscram b distclean \r\ngit cms-checkdeps -a -A\r\nscram b -j 8\r\nscram b runtests use-ibeos\r\n```\r\ngives no failures.\r\n```\r\nrunTheMatrix.py -l limited -i all --ibeos\r\n```\r\n~fails on 4 workflows for unrelated problems (input files not available on any site) [*].~ gives no failures.\r\n```\r\naddOnTests.py\r\n```\r\n~fails 14 times due to unavailable files [**].~ gives no failures.\r\n\r\nI also checked that re-running the HLT writes in the hltOnlineBeamSpot collection the same information as before (running on /HLTMonitor/Run2024I-Express-v2/FEVTHLTALL run=386852, see [here](https://lguzzi.web.cern.ch/lguzzi/BeamSpot/EDP_migration/plots/)).\r\n\r\n\r\n#### If this PR is a backport please specify the original PR and why you need to backport that PR. If this PR will be backported please specify to which release cycle the backport is meant for:\r\n\r\nneed a backport to 15_0_X\r\n\r\n[*] https://lguzzi.web.cern.ch/lguzzi/BeamSpot/EDP_migration/test_runthematrix/ \r\n[**] https://lguzzi.web.cern.ch/lguzzi/BeamSpot/EDP_migration/addOnTests/ \r\n\r\nFYI @missirol @mtosi @rovere @VourMa @gennai @francescobrivio ", "branch": "master", "changed_files": 23, "comments": 23, "commits": 7, "created_at": "1739810247", "deletions": 221, "labels": ["reconstruction-pending", "dqm-pending", "hlt-pending", "alca-pending", "db-pending", "operations-pending", "pending-signatures", "tests-pending", "orp-pending", "code-checks-approved", "tracking"], "milestone": "CMSSW_15_1_X", "number": 47378, "release-notes": [], "review_comments": 34, "state": "open", "title": "move online beam spot arbitration to the edproducer", "updated_at": "1740670909", "user": "lguzzi"}