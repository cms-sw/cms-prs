{"additions": 27, "auther_ref": "fc-psimhitOffset", "auther_sha": "7c3287f15b88223c0fa3d7244af47e47c9772657", "author": "fabiocos", "body": "#### PR description:\r\n\r\nFollowing the discussion about https://github.com/cms-sw/cmssw/pull/42455 at the simulation meeting https://indico.cern.ch/event/1313529/ , this PR implements:\r\n\r\n- a default base track id offset in the ```PSimHit``` class, and methods to add and retrieve offsets and the original track id;\r\n- propagates its use to the ```MtdSD``` class, keeping the previous logical behaviour unaltered;\r\n- adds a protection in the ```SimTrackManager``` throwing an exception if tracks with a track Id larger than the base offset are proposed for permanent storage. \r\n\r\nThe previous offset of 100000000 is doubled to 200000000 , in order to stay safe also in presence of Heavy Ion samples. A test with 1k events of wf. 24950 shows that track Ids close to 90k are possible in these very populated events. The chosen base offset allows anyway a large number of possible offsets to be stored, before hitting the limit of maximum size of an unsigned integer (UINT_MAX = 4294967295). \r\n\r\n@makortel The proposed implementation does not technically modify persistent data members or existing interfaces, and for this reason no change of class version for schema evolution is added. The track Id member meaning is potentially enlarged now, but in a way that should be backward compatible (although no mechanism prevents in principle track ids larger than the base offset for the past, they are not expected for the reasons mentioned above).\r\n\r\n#### PR validation:\r\n\r\nCode runs, and provides the expected track ids in BTL hits, as shown by the dump of the test class ```SimHitCaloHitDumper``` updated in this PR. e.g.\r\n\r\n```\r\nBTLHits hits in the event = 160\r\n\r\n\r\n1653680716  (2.65248,0.0823182,0.866362)  4.77149 Energy = 0.00187623 Track Id = 104\r\n1653623364  (-23.5429,0.117936,1.5)  5.13729 Energy = 0.00161607 Track Id = 104\r\n1653623365  (-24.0755,-1.56,0.419155)  5.14377 Energy = 0.00234347 Track Id = 104\r\n1653623365  (-24.306,-0.0968286,-1.34526)  5.15137 Energy = 0.000306122 Track Id = 104\r\n1654395712  (-19.9635,-0.910802,0.345843)  12.8854 Energy = 0.000179942 Track Id = 400000104\r\n1654392652  (-12.1859,-1.46623,1.02566)  12.7973 Energy = 0.000569917 Track Id = 400000104\r\n1653999172  (13.007,1.17016,0.636569)  10.2406 Energy = 0.000445038 Track Id = 400000104\r\n1653672524  (-4.91178,-0.848405,1.26667)  7.25785 Energy = 7.98462e-05 Track Id = 600000104\r\n1653680719  (-9.67319,0.640687,1.5)  4.83673 Energy = 0.00299444 Track Id = 104\r\n1653683776  (-10.1171,-1.56,0.396154)  4.84311 Energy = 0.0044181 Track Id = 104\r\n1653680719  (-11.8098,0.169878,1.29515)  4.84187 Energy = 4.56779e-05 Track Id = 104\r\n1658860419  (-11.4223,1.38335,-1.1103)  14.1081 Energy = 0.000175683 Track Id = 200000097\r\n1658465159  (-1.0942,-1.36393,-0.899755)  15.5332 Energy = 0.000232008 Track Id = 600000097\r\n1657874062  (5.81779,-0.420891,0.367464)  17.0341 Energy = 9.31307e-06 Track Id = 600000095\r\n1657938761  (-20.3771,-0.024968,-1.10717)  16.9043 Energy = 0.000180497 Track Id = 600000095\r\n1658477452  (20.7793,-0.806021,-1.09933)  21.7767 Energy = 8.5945e-05 Track Id = 600000095\r\n1658855297  (18.1346,-0.17453,-1.09467)  19.5952 Energy = 0.000181718 Track Id = 600000095\r\n1658470222  (-26.2811,-0.0460031,-1.09773)  20.8468 Energy = 9.98849e-05 Track Id = 600000095\r\n1656816974  (1.77915,1.51598,-1.5887)  27.6375 Energy = 0.000116488 Track Id = 600000095\r\n1657162311  (10.6521,-0.669832,-0.934452)  23.207 Energy = 7.398e-05 Track Id = 600000094\r\n1657414280  (19.3899,-1.10402,-1.37687)  21.04 Energy = 0.000219651 Track Id = 600000094\r\n1659064132  (16.9131,0.625088,0.0171433)  11.4986 Energy = 0.000175298 Track Id = 200000093\r\n1654934147  (-11.4032,0.155602,-1.45387)  24.4696 Energy = 6.67964e-05 Track Id = 600000091\r\n1654916993  (5.30227,-1.55327,-0.816225)  16.2435 Energy = 0.000136397 Track Id = 600000091\r\n1654147467  (-8.32702,1.05475,-1.77296)  19.5695 Energy = 0.000112557 Track Id = 600000091\r\n1654408013  (26.8781,-0.0967704,0.240067)  17.055 Energy = 6.3314e-05 Track Id = 600000091\r\n1654408013  (26.8781,-0.0967704,0.240067)  17.055 Energy = 0.00026036 Track Id = 600000091\r\n1654460047  (-23.8675,1.4109,-0.816348)  21.194 Energy = 0.000118696 Track Id = 600000091\r\n1654808458  (17.9005,1.04276,-1.19358)  13.5182 Energy = 0.000903361 Track Id = 600000090\r\n1659050564  (8.15412,-0.0136119,1.5)  4.77013 Energy = 0.0021346 Track Id = 86\r\n1659050565  (7.92549,-1.56,0.25996)  4.77723 Energy = 0.00107187 Track Id = 86\r\n(...)\r\n```", "branch": "master", "changed_files": 7, "comments": 8, "commits": 1, "created_at": "1691479940", "deletions": 7, "labels": ["simulation-approved", "pending-signatures", "tests-approved", "orp-pending", "hold", "code-checks-approved"], "milestone": "CMSSW_13_3_X", "number": 42506, "release-notes": [], "review_comments": 0, "state": "open", "title": "Simulation: define PSimHit track Id offset and propagate to MTD hit categories", "updated_at": "1691562023", "user": "fabiocos"}