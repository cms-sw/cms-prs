{"additions": 863, "auther_ref": "master", "auther_sha": "6c1010a73df7385cb26c96ec4e437c1e7d90c76c", "author": "ctdax", "body": "#### PR description:\r\n\r\n<!-- Please replace this text with a description of the feature proposed or problem addressed, specifying:\r\n  - what changes are expected in the output if any, \r\n  - what other PRs or externals it depends upon if any,\r\n  - link to any additional material useful to provide a documentation for this PR (slides, JIRA tickets, related pull requestes, hypernews, TWiki or Indico pages)  -->\r\n\r\nThis pull request introduces the ability to decay R-hadrons during simulation using a side instance of Pythia8. A generator is required to decay the underlying SUSY particle to hadronize the outgoing partons. This will allow users to simulate detector interactions of long-lived R-hadrons with proper decays for the first time.\r\n\r\n[See the talk given here.](https://indico.cern.ch/event/1613012/#76-r-hadron-decays)\r\n\r\n##### How to use it\r\n- Create a SLHA decay table that includes the decays and widths of the underlying SUSY particle in the R-hadron, e.g. the gluino or the stop.\r\n- Pass the SLHA decay table to `SLHAFileForPythia8` inside of process.generator or process.g4SimHits in the python config file. Optionally, commands can be passed directly to the instance of pythia that handles the R-hadron decay via `RhadronPythiaDecayerCommandFile`, e.g.\r\n \r\n```python\r\nprocess.generator = cms.EDFilter(\"Pythia8ConcurrentGeneratorFilter\",\r\n    SLHAFileForPythia8 = cms.string('SimG4Core/CustomPhysics/data/TESTDECAY_GLUINO1800_STOP500.txt'),\r\n    RhadronPythiaDecayerCommandFile = cms.untracked.string('SimG4Core/CustomPhysics/data/RhadronPythiaDecayerCommands.txt'),\r\n...\r\n)\r\n```\r\n- Make sure the event generator doesn't decay the SUSY particle before it is handed to Geant for simulation. If the event generator is pythia, you can force the SUSY particle to not decay via `pythia8CommonSettings` in the python config file:\r\n\r\n```python\r\nprocess.generator = cms.EDFilter(\"Pythia8ConcurrentGeneratorFilter\",\r\n    PythiaParameters = cms.PSet(\r\n        pythia8CommonSettings = cms.vstring(\r\n            '1000021:mayDecay = off'\r\n        )\r\n    )\r\n)\r\n```\r\n\r\n##### Explanation of changes\r\n- **RHadronPythiaDecayer.cc/RHadronPythiaDecayer.h:** Utilizes G4Decay::DecayIt() to decay the R-hadron. Because it is defined as an external decayer, when G4Decay::DecayIt() calls ImportDecayProducts() it calls the function inside of RHadronPythiaDecayer. This file strips the incoming R-hadron down to its constituents, decays the underlying SUSY particle, then lets Pythia handle the hadronization. The decay products are returned to G4Decay::DecayIt() for them to be simulated in Geant.\r\n- **RHadronPythiaDecayDataManager.h:** Holds the decay information during simulation to be passed to RHDecayTracer.cc during the EDM step.\r\n- **RHDecayTracer.cc/RHDecayTracer.h:** Adds the R-hadron decay vertex to a new GenParticleCollection. It also includes the entire history of the R-hadron. This will allow users to view all of the relevant information regarding the decay, such as the incoming and outgoing particles, after the simulation ends.\r\n- **SimG4Core/CustomPhysics/BuildFile.xml:** Pythia8Interface is required to generate the R-hadron decays in Pythia. DataFormats/HepMCCandidate is required for RHDecayTracer to work.\r\n- **SimG4Core/CustomPhysics/plugins/module.cc:** Define the RHDecayTracer framework module\r\n- **SimG4Core/CustomPhysics/python/Exotica_HSCP_SIM_cfi.py:** Handles the inputs `SLHAFileForPythia8` and `RhadronPythiaDecayerCommandFile`. Adds the RHDecayTracer module to the process.\r\n- **SimG4Core/CustomPhysics/src/CustomParticleFactory.cc:** Forces the lifetime of R-hadrons to match the lifetime of their underlying SUSY particle, which is read in from the SLHA table. The modification to Line298 `if ((ToLower(line).find(\"block\") < line.npos) || (line == \"#\")) {` forces the skipping of commented lines in the SLHA text file.\r\n- **SimG4Core/CustomPhysics/src/CustomPhysicsList.cc:** Sets the R-hadron decay process to be the external pythia decayer. \r\n- **SimG4Core/CustomPhysics/data/RhadronPythiaDecayerCommands.txt:** A new .txt file that contains default commands for the Pythia instance that decays the Rhadrons.\r\n- **SimG4Core/CustomPhysics/python/CustomPhysics_cfi.py:** Adds the `RhadronPythiaDecayerCommandFile` parameter to the config file.\r\n\r\n##### Confirmation of 4-momentum conservation at the decay\r\nA histogram plotting the difference in 4-momentum between the R-hadron and its decay products in 50 events is shown below. These are the 4-momenta in the $p_T$, $\\eta$, $\\phi$ basis after the decay products are handed back to Geant. All entries are consistent with 0 difference except for some floating-point error.\r\n\r\n<img width=\"2176\" height=\"1166\" alt=\"4pDifferenceAtDecay\" src=\"https://github.com/user-attachments/assets/85d4c379-9d14-4386-9218-85dc2a8cc7c6\" />\r\n\r\n\r\n#### PR validation:\r\n\r\n<!-- Please replace this text with a description of which tests have been performed to verify the correctness of the PR, including the eventual addition of new code for testing like unit tests, test configurations, additions or updates to the runTheMatrix test workflows -->\r\n\r\nAll tests below ran successfully.\r\n```bash\r\ncd src\r\nscram b distclean \r\ngit cms-checkdeps -a -A\r\nscram b -j 8\r\nscram b runtests use-ibeos\r\nrunTheMatrix.py -l limited -i all --ibeos\r\n```\r\n\r\nBefore submitting your pull requests, make sure you followed this checklist:\r\n- verify that the PR is really intended for the chosen branch\r\n- verify that changes follow [CMS Naming, Coding, And Style Rules](http://cms-sw.github.io/cms_coding_rules.html)\r\n- verify that the PR passes the basic test procedure suggested in the [CMSSW PR instructions](https://cms-sw.github.io/PRWorkflow.html)\r\n\r\n<!-- Please delete the text above after you verified all points of the checklist  -->\r\n", "branch": "master", "changed_files": 12, "comments": 22, "commits": 4, "created_at": "1763500094", "deletions": 13, "labels": ["simulation-pending", "pending-signatures", "tests-pending", "orp-pending", "code-checks-approved"], "milestone": "CMSSW_16_1_X", "number": 49414, "release-notes": [], "review_comments": 31, "state": "open", "title": "Added Pythia-based Rhadron decays during Geant simulation", "updated_at": "1771105322", "user": "ctdax"}