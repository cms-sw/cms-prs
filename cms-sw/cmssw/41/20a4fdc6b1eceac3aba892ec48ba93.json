{"additions": 52, "auther_ref": "digimoprh_sharedmemory_160X", "auther_sha": "a487e5e24ecda7bef832abc151862340ed8d1a1b", "author": "AdrianoDee", "body": "#### PR description:\r\n\r\nThis PR proposes a couple of fixes for the digi morphing to work properly for differen conditions (when acitve or not):\r\n- defining a `maxPixInModuleForMorphing` constant depending on the `TrackerTraits` to be used to define the number of threads for the `FindClus` kernel. This also sizes the histogram holding the pixels in a module:\r\n\r\n```c++\r\nusing Hist = cms::alpakatools::HistoContainer<uint16_t,\r\n                                                      TrackerTraits::clusterBinning,\r\n                                                      TrackerTraits::maxPixInModuleForMorphing,\r\n                                                      TrackerTraits::clusterBits,\r\n                                                      uint16_t>;                                                      \r\n```\r\n\r\n- having a different `maxIterGPU` per topology (given the different number of pixels affects the number of iterations we can use to cover the full module);\r\n- limiting the `maxFakesInModule` configuration parameter to take into account the `maxPixInModuleForMorphing` max to avoid the histogram overflowing.\r\n\r\n#### PR validation:\r\n\r\n`160.03502` run.\r\n\r\nRunning successfully the test from @henriettepetersen :\r\n\r\n```\r\nhltConfigFromDB --configName /online/collisions/2025/2e34/v1.2/HLT/V2 > hlt.py\r\ncp /gpu_data/store/data/Run2025C/EphemeralHLTPhysics/FED/run393240_cff.py .\r\ncat >> hlt.py << @EOF\r\n\r\nprocess.load('run393240_cff')\r\n\r\nfrom Configuration.AlCa.GlobalTag import GlobalTag as customiseGlobalTag\r\nprocess.GlobalTag = customiseGlobalTag(process.GlobalTag, globaltag = '150X_dataRun3_HLT_v1')\r\n\r\nfrom HLTrigger.Configuration.customizeHLTforCMSSW import customizeHLTforCMSSW\r\nprocess = customizeHLTforCMSSW(process)\r\n\r\nprocess.PrescaleService.lvl1DefaultLabel = '2p0E34'\r\nprocess.PrescaleService.forceDefault = True\r\n\r\nprocess.options.wantSummary = False\r\nprocess.MessageLogger.cerr.enableStatistics = cms.untracked.bool(False)\r\n\r\nprocess.FastTimerService.writeJSONSummary = True\r\n\r\nprocess.ThroughputService = cms.Service('ThroughputService',\r\n    enableDQM = cms.untracked.bool(False),\r\n    printEventSummary = cms.untracked.bool(True),\r\n    eventResolution = cms.untracked.uint32(100),\r\n    eventRange = cms.untracked.uint32(10300),\r\n)\r\nprocess.MessageLogger.cerr.ThroughputService = cms.untracked.PSet(\r\n    limit = cms.untracked.int32(10000000),\r\n    reportEvery = cms.untracked.int32(1)\r\n)\r\n\r\nimport os\r\nos.makedirs('%s/run%d' % (process.EvFDaqDirector.baseDir.value(), process.EvFDaqDirector.runNumber.value()), exist_ok=True)\r\n\r\nprocess.options.numberOfThreads = 32\r\nprocess.options.numberOfStreams = 24\r\nprocess.options.numberOfConcurrentLuminosityBlocks = 2\r\nprocess.maxEvents.input = 10300\r\n\r\nprocess.hltSiPixelClustersSoA.DoDigiMorphing = cms.bool( True )\r\nprocess.hltSiPixelClustersSoASerialSync.DoDigiMorphing = cms.bool( True )\r\n\r\n@EOF\r\n\r\n# run the configuration\r\ncmsRun hlt.py\r\n```\r\n\r\nBackport is needed to `15_1_X` for HI data taking.", "branch": "master", "changed_files": 4, "comments": 20, "commits": 2, "created_at": "1759136146", "deletions": 19, "labels": ["reconstruction-pending", "geometry-pending", "pending-signatures", "tests-approved", "orp-pending", "bug-fix", "urgent", "code-checks-approved", "heterogeneous-pending", "trk"], "milestone": "CMSSW_16_0_X", "number": 49021, "release-notes": [], "review_comments": 21, "state": "open", "title": "Fixes for Digi Morphing: Limiting Histogram Size and Decoupling for `TrackerTraits`", "updated_at": "1759469508", "user": "AdrianoDee"}