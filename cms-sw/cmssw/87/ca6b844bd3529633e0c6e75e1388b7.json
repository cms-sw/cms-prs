{"additions": 84, "auther_ref": "pixel_dqm_client_changes_for_CMSHLT-3147_15_0_X", "auther_sha": "3bfcdf38461ace7917985a5c19be5fbce61c3b41", "author": "mmusich", "body": "backport of https://github.com/cms-sw/cmssw/pull/49237\r\n\r\n#### PR description:\r\n\r\nThis PR is opened in preparation of the integration of the ticket [CMSHLT-3147](https://its.cern.ch/jira/browse/CMSHLT-3147).\r\nIn a nutshell that ticket suggests that the DQM plugins which are currently in the Path `DQM_PixelReconstruction_v` (Sequence: `HLTDQMPixelReconstruction`) and in the Path `DQM_PixelReconstruction_v` (Sequece `HLTDQMPixelReconstruction`) can be removed from the HLT combined table, as long as the Tracker-DPG and/or Tracking-POG experts move the corresponding monitoring sequence into the appropriate online-DQM client (which reads the `DQMGPUvsCPU` streamer files).\r\nThis latter point is proposed in this PR, in which we change the client `DQM/Integration/python/clients/pixelgpu_dqm_sourceclient-live_cfg.py` to include directly the modules responsible of monitoring of the GPU vs CPU comparisons, as the input data to feed them will be sent by the input `DQMGPUvsCPU`  stream.\r\n\r\n#### PR validation:\r\n\r\nIn addition to the tests in https://github.com/cms-sw/cmssw/pull/49237#issue-3563189015 I created a suitable set of streamer files using the following script to test the Heavy Ion menu:\r\n\r\n```bash\r\n#!/bin/bash -ex                                                                                       \r\nRUNNUMBER=362321\r\nLUMISECTION=231\r\nNEVENTS=500\r\n\r\n# cmsrel CMSSW_15_1_0_patch2\r\n# cd CMSSW_15_1_0_patch2/src/\r\n# cmsenv                                                                                                                                                                                                   \r\n# scram b                                                                                                                                   \r\n\r\nINPUTFILE=root://eoscms.cern.ch//eos/cms//store/user/cmsbuild/store/hidata/HIRun2022A/HITestRaw0/RAW/v1/000/362/321/00000/f467ee64-fc64-47a6-9d8a-7ca73ebca2bd.root \r\nrm -rf run${RUNNUMBER}*\r\n\r\n# run on 100 events of LS 131, with 100 events per input file                                                                                             \r\nconvertToRaw -f ${NEVENTS} -l ${NEVENTS} -r ${RUNNUMBER}:${LUMISECTION} -s rawDataRepacker -o . -- \"${INPUTFILE}\"\r\n\r\ntmpfile=$(mktemp)\r\n#hltConfigFromDB --configName /users/musich/tests/dev/CMSSW_15_1_0/CMSHLT-3147/HIon > \"${tmpfile}\"\r\nhltConfigFromDB --configName /dev/CMSSW_15_1_0/HIon/V14 > \"${tmpfile}\"\r\nsed -i 's|process = cms.Process( \"HLT\" )|from Configuration.Eras.Era_Run3_cff import Run3\\nprocess = cms.Process( \"HLT\", Run3 )|g' \"${tmpfile}\"\r\ncat <<@EOF >> \"${tmpfile}\"\r\nprocess.load(\"run${RUNNUMBER}_cff\")\r\n\r\n# to run without any HLT prescales                                                  \r\ndel process.PrescaleService\r\ndel process.MessageLogger\r\nprocess.load('FWCore.MessageLogger.MessageLogger_cfi')\r\n\r\n# override the GlobalTag, connection string and pfnPrefix\r\nfrom Configuration.AlCa.GlobalTag import GlobalTag as customiseGlobalTag\r\nprocess.GlobalTag = customiseGlobalTag(\r\n    process.GlobalTag,\r\n    globaltag = \"150X_dataRun3_HLT_v1\",\r\n    conditions = \"L1Menu_CollisionsHeavyIons2024_v1_0_6_xml,L1TUtmTriggerMenuRcd,frontier://FrontierProd/CMS_CONDITIONS,,9999-12-31 23:59:59.000\"\r\n)\r\n\r\n# run the Full L1T emulator, then repack the data into a new RAW collection, to be used by the HLT\r\nfrom HLTrigger.Configuration.CustomConfigs import L1REPACK\r\nprocess = L1REPACK(process, \"uGT\")\r\n\r\nprocess.options.numberOfThreads = 32\r\nprocess.options.numberOfStreams = 32\r\n\r\nprocess.options.wantSummary = True\r\n# process.PrescaleService.forceDefault = True\r\n@EOF\r\nedmConfigDump \"${tmpfile}\" > hlt.py\r\n\r\ncmsRun hlt.py &> hlt.log\r\n\r\nbash -c 'echo $$ > cmsrun.pid; exec cmsRun hlt.py &> hlt.log'\r\njob_pid=$(cat cmsrun.pid)\r\necho \"cmsRun is running with PID: $job_pid\"\r\n\r\n# remove input files to save space\r\nrm -f run362321/run362321_ls0*_index*.*\r\n\r\n# prepare the files by concatenating the .ini and .dat files\r\nmkdir -p preparedHIon\r\n\r\ncat run362321/run362321_ls0000_streamHIDQMGPUvsCPU_pid${job_pid}.ini run362321/run362321_ls0231_streamHIDQMGPUvsCPU_pid${job_pid}.dat > preparedHIon/run362321_ls0231_streamHIDQMGPUvsCPU_pid${job_pid}.dat\r\ncp run362321/run362321_ls0231_streamHIDQMGPUvsCPU_pid${job_pid}.jsn preparedHIon/run362321_ls0231_streamHIDQMGPUvsCPU_pid${job_pid}_prep.jsn\r\n\r\n# now remove the extra 0\r\n\r\ninput=\"preparedHIon/run362321_ls0231_streamHIDQMGPUvsCPU_pid${job_pid}_prep.jsn\"\r\noutput=\"preparedHIon/run362321_ls0231_streamHIDQMGPUvsCPU_pid${job_pid}.jsn\"\r\n\r\njq '\r\n  .data as $d |\r\n  .data = (\r\n    reduce range(0; $d|length) as $i ([]; \r\n      if ($i > 0 and .[-1] == \"0\" and $d[$i] == \"0\") \r\n      then . \r\n      else . + [$d[$i]] \r\n      end\r\n    )\r\n  )\r\n' \"$input\" > \"$output\"\r\n\r\nrm -fr preparedHIon/run362321_ls0231_streamHIDQMGPUvsCPU_pid${job_pid}_prep.jsn\r\nrm -fr preparedHIon/run362321_ls0231_streamHIDQMGPUvsCPU_pid${job_pid}.ini\r\n```\r\n\r\nand then placed the resulting files under the path `$CMSSW_BASE/src/DQM/Integration/data/run362321`.\r\nAfter applying the following extra changes to the package:\r\n\r\n```diff\r\ndiff --git a/DQM/Integration/test/BuildFile.xml b/DQM/Integration/test/BuildFile.xml\r\nindex c5f5763d8d2..3e80cc4769f 100644\r\n--- a/DQM/Integration/test/BuildFile.xml\r\n+++ b/DQM/Integration/test/BuildFile.xml\r\n@@ -29,7 +29,7 @@\r\n <test name=\"TestDQMOnlineClient-onlinebeammonitor_dqm_sourceclient\" command=\"runtest.sh onlinebeammonitor_dqm_sourceclient-live_cfg.py 381594 pp_run\"/>\r\n <test name=\"TestDQMOnlineClient-ecalgpu_dqm_sourceclient\" command=\"runtest.sh ecalgpu_dqm_sourceclient-live_cfg.py 381594\"/>\r\n <test name=\"TestDQMOnlineClient-hcalgpu_dqm_sourceclient\" command=\"runtest.sh hcalgpu_dqm_sourceclient-live_cfg.py 381594\"/>\r\n-<test name=\"TestDQMOnlineClient-pixelgpu_dqm_sourceclient\" command=\"runtest.sh pixelgpu_dqm_sourceclient-live_cfg.py 381594\"/>\r\n+<test name=\"TestDQMOnlineClient-pixelgpu_dqm_sourceclient\" command=\"runtest.sh pixelgpu_dqm_sourceclient-live_cfg.py 362321 hi_run\"/>\r\n <test name=\"TestDQMOnlineClient-pfgpu_dqm_sourceclient\" command=\"runtest.sh pfgpu_dqm_sourceclient-live_cfg.py 381594\"/>\r\n <!-- streamDQMCalibration is required -->\r\n <!-- <test name=\"TestDQMOnlineClient-ecalcalib_dqm_sourceclient\" command=\"runtest.sh ecalcalib_dqm_sourceclient-live_cfg.py\" /> -->\r\n```\r\n\r\nI then run the unit test of the package via: \r\n\r\n```bash\r\n scram b runtests_TestDQMOnlineClient-pixelgpu_dqm_sourceclient\r\n```\r\n\r\nand I did not observe any issues.\r\n\r\n#### If this PR is a backport please specify the original PR and why you need to backport that PR. If this PR will be backported please specify to which release cycle the backport is meant for:\r\n\r\nVerbatim backport of https://github.com/cms-sw/cmssw/pull/49237 for 2025 PbPb operations.", "branch": "CMSSW_15_1_X", "changed_files": 2, "comments": 17, "commits": 3, "created_at": "1762180118", "deletions": 16, "labels": ["dqm-approved", "fully-signed", "tests-approved", "orp-pending", "urgent", "requires-external", "backport-ok"], "milestone": "CMSSW_15_1_X", "number": 49296, "release-notes": [], "review_comments": 0, "state": "open", "title": "[15.1.X] Pixel GPU Online DQM Client changes for CMSHLT-3147", "updated_at": "1762262920", "user": "mmusich"}