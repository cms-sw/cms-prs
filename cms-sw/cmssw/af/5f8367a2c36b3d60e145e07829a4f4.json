{"additions": 10, "auther_ref": "production_cuts", "auther_sha": "7abcd85577b4dcb3106e45e37a6dc2f133baf8f4", "author": "ghugo83", "body": "DDD: The matching of a DDLogicalPart with a production cut SpecPar happens here: \r\nhttps://github.com/cms-sw/cmssw/blob/master/SimG4Core/Geometry/src/DDG4ProductionCuts.cc#L85\r\nWhich itself calls:\r\nhttps://github.com/cms-sw/cmssw/blob/master/DetectorDescription/Core/interface/DDMapper.h#L170 \r\n**The DDD search stops when a first match is found.**\r\n\r\n**DD4hep: Instead, for each volume, all SpecPars are looped on**:\r\nhttps://github.com/cms-sw/cmssw/blob/master/SimG4Core/Geometry/src/DDG4ProductionCuts.cc#L116\r\nFor each search, expensive regex-match can be called: https://github.com/cms-sw/cmssw/blob/master/SimG4Core/Geometry/src/DDG4ProductionCuts.cc#L122\r\n\r\nTo reproduce the same results between DDD and DD4hep, it is necessary that the searches have same behavior.\r\n- This PR fixes the production cuts for the `hcalouteralgo:MBBT_R1P` volume. \r\nMore generally, order-dependent results, and extra occurrences of production cuts with DD4hep are now fixed.\r\n\r\nNB: To avoid having order-dependent production cuts, the regex in the XMLs could be fixed, but this would only solve specific occurrences of this more general problem.\r\n\r\n- Additionally, this should results in perf improvements with DD4hep. \r\n\r\nNB: This search pattern over SpecPars appears often in CMSSW-DD4hep. \r\nIt would be interesting to see whether there are other situations (outside of production cuts), where the default DDD behavior was also to stop search after first match. In that case, similar fixes could allow significant perf improvements with DD4hep, while additionally providing the same search behavior with DD4hep as DDD, hence reducing the risks of discrepancies.\r\n\r\n@ianna @cvuosalo @civanch @bsunanda ", "branch": "master", "changed_files": 1, "closed_at": "1615279671", "comments": 9, "commits": 1, "created_at": "1615206401", "deletions": 2, "labels": ["code-checks-approved", "fully-signed", "orp-approved", "simulation-approved", "tests-approved"], "merge_commit_sha": "0ab3e70975b7be64acc6ad1c2128b2a15ffbac41", "merged_at": "1615279671", "merged_by": "cmsbuild", "milestone": "CMSSW_11_3_X", "number": 33101, "release-notes": [], "review_comments": 0, "state": "closed", "title": "Production cuts: DD4hep needs to reproduce same behavior as DDD.", "updated_at": "1615279671", "user": "ghugo83"}