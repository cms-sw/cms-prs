{"additions": 40986, "auther_ref": "alpaka_port_13_1", "auther_sha": "4fb1dd53443a5165389ddb12d7809cb33a733fb5", "author": "PixelTracksAlpaka", "body": "#### PR description:\r\n\r\nCommon work with @borzari and @nothingface0.\r\n\r\nThis PR will allow to run Pixel Tracks Reconstruction in Alpaka. It's still a work in progress and needs to be properly tested. We are opening it so that it is (more) public and may be reviewed by experts. \r\n\r\nWill updated the description accordingly while updating the PR.\r\n\r\nThis includes https://github.com/cms-sw/cmssw/pull/40932 with the latest comments received addressed.\r\n\r\nThis is *not to merge* and it's here for testing purposes. It has been split in 8 smaller PRs, to be merged in sequence, to ease the review:\r\n\r\n- https://github.com/cms-sw/cmssw/pull/43295\r\n- https://github.com/cms-sw/cmssw/pull/41285\r\n- https://github.com/cms-sw/cmssw/pull/41286\r\n- https://github.com/cms-sw/cmssw/pull/41287\r\n- https://github.com/cms-sw/cmssw/pull/41288\r\n- https://github.com/cms-sw/cmssw/pull/43294\r\n\r\n(@ericcano)\r\n\r\n\r\n------\r\n### 21st November\r\n\r\nTested with #43064, everything is fine. Some general clean-up renaming:\r\n- all the SOA `DataFormats` now are in the form `DataFormats/XYXSoA/`;\r\n- naming uniformly the SoA classes with `XYZHost`, `XYZDevice`, `XYZsSoACollection`;\r\n- started to remove all the remaining `*GPU` objects in Alpaka code either with `*Device` or nothing (e.g. `GPUAlgo` -> `Algo`);\r\n- fixing `CopyToHost` methods to avoid useless specialization for `Host` to `Host` copy;\r\n-   added `ASSERT_DEVICE_MATCHES_HOST_COLLECTION` everywhere\r\n-  used the \"automatic dictionary\" generator with `SET_PORTABLEHOSTCOLLECTION_READ_RULES`;\r\n- using `std::conditional_t` for collection Host/Device definition.\r\n\r\nThe resolution problem was solved by @borzari spotting this (a great catch!):\r\n```diff\r\n--- a/RecoTracker/PixelTrackFitting/interface/alpaka/BrokenLine.h\r\n+++ b/RecoTracker/PixelTrackFitting/interface/alpaka/BrokenLine.h\r\n@@ -121,7 +121,7 @@ namespace ALPAKA_ACCELERATOR_NAMESPACE {\r\n       scalar tempC = -rho * y0 + tempSmallU * cosPhi;\r\n       scalar tempB = rho * x0 + tempSmallU * sinPhi;\r\n       scalar tempA = 2. * deltaOrth + rho * (riemannFit::sqr(deltaOrth) + riemannFit::sqr(deltaPara));\r\n-      scalar tempU = alpaka::math::sin(acc, 1. + rho * tempA);\r\n+      scalar tempU = alpaka::math::sqrt(acc, 1. + rho * tempA);\r\n \r\n       // Intermediate computations for the error matrix transform\r\n       scalar xi = 1. / (riemannFit::sqr(tempB) + riemannFit::sqr(tempC));\r\ndiff --git a/RecoTracker/PixelTrackFitting/plugins/PixelTrackDumpAlpaka.cc b/RecoTracker/PixelTrackFitting/plugins/PixelTrackDumpAlpaka.cc\r\nindex 7524fa012eb..2b70db60900 100644\r\n```\r\n------\r\n### 15th November\r\n\r\nThis now includes #43064 up to 5f9c2e62c82c8f5a6ea6cb93a2e67bb3ec564388.\r\n \r\n------\r\n### 19th October \r\n\r\nWe will use this PR as a proxy for the full development in order to be able to run the integration tests. Changing the status to \"Ready to review\" to be able to run the bot commands and checks.\r\n\r\n\r\n### Module Naming\r\n\r\nFor the moment we applied the following rule for the naming:\r\n1. where the module had in it's name `CUDA` we simply drop the `CUDA` suffix;\r\n2. where this is not possible or doesn't apply we appended `Alpaka` to the module name.\r\n\r\nWhere 2. usually applies to SoA to legacy converters.\r\n\r\n#### Additional workflows\r\n\r\nAn `alpaka` process modifier is added togheter with a set of new workflows:\r\n\r\n- `*.55` running Pixel only in Alpaka;\r\n- `*.554` running Pixel only in Alpaka for profiling;\r\n- `*.557` running Pixel only in Alpaka for CPU vs GPU validation;\r\n\r\nA note: in order to cohabit with the CUDA workflows, for the modules providing the conversion to legacy formats, we had to live with the `SwitchProducedCUDA` logic. For example, for the local reco configurations, `siPixelRecHitsPreSplitting` is defined as:\r\n\r\n```python \r\n# SwitchProducer wrapping the legacy pixel rechit producer\r\nsiPixelRecHitsPreSplitting = SwitchProducerCUDA(\r\n    cpu = siPixelRecHits.clone(\r\n        src = 'siPixelClustersPreSplitting'\r\n    )\r\n)\r\n```\r\n\r\nand in order to be able to modify or replace it with `toModify` or `toReplaceWith`, the `alpaka` modifier acts on the `cpu` branch of the `SwitchProducedCUDA`.\r\n\r\n```python\r\n(alpaka & ~phase2_tracker).toModify(siPixelRecHitsPreSplitting,\r\n    cpu = _siPixelRecHitFromSoAAlpakaPhase1.clone(\r\n            pixelRecHitSrc = cms.InputTag('siPixelRecHitsPreSplittingAlpaka'),\r\n            src = cms.InputTag('siPixelClustersPreSplitting'))\r\n)\r\n```\r\nThis was the only way we found to keep the same naming for the final AoS products.\r\n\r\n#### Run3 Physics Results\r\n\r\nFind [here](https://adiflori.web.cern.ch/adiflori/alpaka_prof/run3_plots/) all the validation plots from MTV for Run3 ttbar.\r\n\r\nResults are almost perfectly overlapping with the exception for the $d_{xy}$ resolution that is degradated (see e.g. [here](https://adiflori.web.cern.ch/adiflori/alpaka_prof/run3_plots/gpu_quads/plots_pixel_pixel/resolutionsPt.pdf)). We are investigating this and should have spotted the culprit.\r\n\r\n#### Run3 Througput\r\n\r\nRunning a profiling workflow on Run3 data (Run 370293) on `fu-c2a02-37-02` we see a degradation in performance (around 20% in througput).\r\n\r\n\r\n![](https://adiflori.web.cern.ch/adiflori/alpaka_prof/zoom.png)\r\n\r\nNote that when running a single EDM stream CUDA and Alpaka throughput are the same.\r\n\r\n------\r\n### 20th October\r\n\r\nWith 66f48f9889b0796d184e80b19682cbf757e8c413 fixed tests (thanks to @ericcano). For the moment commented the `testOneHistoContainer` tests since the issue is solved in #43064. `RecoTracker/PixelTrackFitting/testEigenGPUNoFit_t` fails also in a clean `CMSSW_13_3_X_2023-10-18-1100`.\r\n", "branch": "master", "changed_files": 476, "comments": 54, "commits": 150, "created_at": "1679395679", "deletions": 4226, "labels": ["reconstruction-pending", "simulation-pending", "dqm-pending", "l1-pending", "hlt-pending", "core-pending", "alca-pending", "db-pending", "geometry-pending", "operations-pending", "pending-signatures", "tests-pending", "orp-pending", "new-package-pending", "pdmv-pending", "upgrade-pending", "code-checks-pending", "xpog-pending", "heterogeneous-pending", "tracking", "trk"], "milestone": "CMSSW_14_0_X", "number": 41117, "release-notes": [], "review_comments": 85, "state": "open", "title": "Porting Pixel Tracks to Alpaka [Not to Merge] ", "updated_at": "1700776000", "user": "AdrianoDee"}