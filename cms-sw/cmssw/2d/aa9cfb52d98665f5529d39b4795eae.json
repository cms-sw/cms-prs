{"additions": 50, "auther_ref": "patch-4", "auther_sha": "563dec9e5827d4d3c256d0307fadc91fce457a7c", "author": "lgray", "body": "This PR implements smarter rehashing within the HGCDigitizer classes yielding a factor 7 improvement in speed of that module in high pileup. There is also a scheme to keep the hash table size under control using a running average of the occupancy, this allows us to maintain a slim memory profile and small total number of rehashes.\r\n\r\nResults below are with 200PU in D4 using CMSSW_9_0_X_2016-12-11-110.\r\n\r\nigprof output before patch:\r\n```\r\n- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - \r\n            0.0  .........       0.02 / 2'873.81     <spontaneous> [1]\r\n           65.4  .........   1'880.77 / 2'121.26     edm::MixingModule::pileAllWorkers(edm::EventPrincipal const&, edm::ModuleCallingContext const*, int, int, int&, edm::EventSetup const&, edm::StreamID const&) [28]\r\n[29]       65.4   1'880.79       0.13 / 1'880.66   edm::MixingModule::accumulateEvent(PileUpEventPrincipal const&, edm::EventSetup const&, edm::StreamID const&)\r\n           42.2  .........   1'213.16 / 1'213.16     HGCDigitizer::accumulate(PileUpEventPrincipal const&, edm::EventSetup const&, CLHEP::HepRandomEngine*) [30]\r\n            9.7  .........     279.27 / 279.27       void cms::Phase2TrackerDigitizer::accumulate_local<PileUpEventPrincipal>(PileUpEventPrincipal const&, edm::EventSetup const&) [43]\r\n            5.4  .........     154.53 / 154.53       EcalDigiProducer::accumulate(PileUpEventPrincipal const&, edm::EventSetup const&, edm::StreamID const&) [96]\r\n            4.7  .........     134.16 / 134.16       TrackingTruthAccumulator::accumulate(PileUpEventPrincipal const&, edm::EventSetup const&, edm::StreamID const&) [105]\r\n            1.8  .........      52.12 / 52.14        cms::PileupVertexAccumulator::accumulate(PileUpEventPrincipal const&, edm::EventSetup const&, edm::StreamID const&) [163]\r\n            1.1  .........      30.56 / 30.56        HcalDigitizer::accumulate(PileUpEventPrincipal const&, edm::EventSetup const&, CLHEP::HepRandomEngine*) [616]\r\n            0.5  .........      14.09 / 14.09        CaloTruthAccumulator::accumulate(PileUpEventPrincipal const&, edm::EventSetup const&, edm::StreamID const&) [1008]\r\n            0.1  .........       1.98 / 1.98         EcalTimeDigiProducer::accumulate(PileUpEventPrincipal const&, edm::EventSetup const&, edm::StreamID const&) [1427]\r\n            0.0  .........       0.68 / 0.68         SiStripDigitizer::accumulate(PileUpEventPrincipal const&, edm::EventSetup const&, edm::StreamID const&) [1940]\r\n            0.0  .........       0.05 / 0.05         HGCDigiProducer::accumulate(PileUpEventPrincipal const&, edm::EventSetup const&, edm::StreamID const&) [3987]\r\n            0.0  .........       0.04 / 0.04         HcalDigiProducer::accumulate(PileUpEventPrincipal const&, edm::EventSetup const&, edm::StreamID const&) [4145]\r\n            0.0  .........       0.02 / 0.02         cms::Phase2TrackerDigitizer::accumulate(PileUpEventPrincipal const&, edm::EventSetup const&, edm::StreamID const&) [5949]\r\n\r\n- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - \r\n```\r\n\r\nigprof output with patch:\r\n```\r\n- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - \r\n            0.0  .........       0.02 / 1'773.66     <spontaneous> [1]\r\n           46.3  .........     821.99 / 1'062.78     edm::MixingModule::pileAllWorkers(edm::EventPrincipal const&, edm::ModuleCallingContext const*, int, int, int&, edm::EventSetup const&, edm::StreamID const&) [28]\r\n[29]       46.3     822.01       0.11 / 821.90     edm::MixingModule::accumulateEvent(PileUpEventPrincipal const&, edm::EventSetup const&, edm::StreamID const&)\r\n           15.5  .........     274.75 / 274.75       void cms::Phase2TrackerDigitizer::accumulate_local<PileUpEventPrincipal>(PileUpEventPrincipal const&, edm::EventSetup const&) [40]\r\n            9.6  .........     170.05 / 170.05       HGCDigitizer::accumulate(PileUpEventPrincipal const&, edm::EventSetup const&, CLHEP::HepRandomEngine*) [86]\r\n            8.6  .........     152.25 / 152.25       EcalDigiProducer::accumulate(PileUpEventPrincipal const&, edm::EventSetup const&, edm::StreamID const&) [95]\r\n            7.3  .........     130.35 / 130.35       TrackingTruthAccumulator::accumulate(PileUpEventPrincipal const&, edm::EventSetup const&, edm::StreamID const&) [105]\r\n            2.8  .........      50.13 / 50.19        cms::PileupVertexAccumulator::accumulate(PileUpEventPrincipal const&, edm::EventSetup const&, edm::StreamID const&) [162]\r\n            1.6  .........      28.95 / 28.95        HcalDigitizer::accumulate(PileUpEventPrincipal const&, edm::EventSetup const&, CLHEP::HepRandomEngine*) [637]\r\n            0.8  .........      13.32 / 13.32        CaloTruthAccumulator::accumulate(PileUpEventPrincipal const&, edm::EventSetup const&, edm::StreamID const&) [1011]\r\n            0.1  .........       1.45 / 1.45         EcalTimeDigiProducer::accumulate(PileUpEventPrincipal const&, edm::EventSetup const&, edm::StreamID const&) [1519]\r\n            0.0  .........       0.56 / 0.56         SiStripDigitizer::accumulate(PileUpEventPrincipal const&, edm::EventSetup const&, edm::StreamID const&) [2010]\r\n            0.0  .........       0.03 / 0.03         HcalDigiProducer::accumulate(PileUpEventPrincipal const&, edm::EventSetup const&, edm::StreamID const&) [5124]\r\n            0.0  .........       0.02 / 0.02         HGCDigiProducer::accumulate(PileUpEventPrincipal const&, edm::EventSetup const&, edm::StreamID const&) [5406]\r\n            0.0  .........       0.02 / 0.02         cms::Phase2TrackerDigitizer::accumulate(PileUpEventPrincipal const&, edm::EventSetup const&, edm::StreamID const&) [5409]\r\n\r\n- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - \r\n```\r\n\r\nvirtual and rss before patch:\r\n```\r\nMemoryReport> Peak virtual size 5676.52 Mbytes\r\n Key events increasing vsize: \r\n[2] run: 1 lumi: 1 event: 5  vsize = 3972.17 deltaVsize = 160 rss = 2923.42 delta = 425.906\r\n[6] run: 1 lumi: 1 event: 20  vsize = 4556.52 deltaVsize = 224 rss = 3304.84 delta = 381.422\r\n[8] run: 1 lumi: 1 event: 1  vsize = 5324.52 deltaVsize = 672 rss = 3686.03 delta = 381.188\r\n[9] run: 1 lumi: 1 event: 18  vsize = 5676.52 deltaVsize = 352 rss = 3875.34 delta = 189.309\r\n[0] run: 0 lumi: 0 event: 0  vsize = 0 deltaVsize = 0 rss = 0 delta = 0\r\n[8] run: 1 lumi: 1 event: 1  vsize = 5324.52 deltaVsize = 672 rss = 3686.03 delta = 276.277\r\n[10] run: 1 lumi: 1 event: 37  vsize = 5676.52 deltaVsize = 0 rss = 3687.72 delta = -187.617\r\n[9] run: 1 lumi: 1 event: 18  vsize = 5676.52 deltaVsize = 352 rss = 3875.34 delta = 189.309\r\n```\r\n\r\nvirtual and rss after patch:\r\n```\r\nMemoryReport> Peak virtual size 5646.11 Mbytes\r\n Key events increasing vsize: \r\n[2] run: 1 lumi: 1 event: 5  vsize = 3973.76 deltaVsize = 160 rss = 2930.69 delta = 442.617\r\n[5] run: 1 lumi: 1 event: 7  vsize = 4398.11 deltaVsize = 168 rss = 3194.73 delta = 264.039\r\n[8] run: 1 lumi: 1 event: 1  vsize = 5262.11 deltaVsize = 672 rss = 3718.68 delta = 523.949\r\n[9] run: 1 lumi: 1 event: 18  vsize = 5454.11 deltaVsize = 192 rss = 3851.01 delta = 132.328\r\n[10] run: 1 lumi: 1 event: 37  vsize = 5646.11 deltaVsize = 192 rss = 3870.63 delta = 19.6211\r\n[8] run: 1 lumi: 1 event: 1  vsize = 5262.11 deltaVsize = 672 rss = 3718.68 delta = 317.082\r\n[9] run: 1 lumi: 1 event: 18  vsize = 5454.11 deltaVsize = 192 rss = 3851.01 delta = 132.328\r\n[10] run: 1 lumi: 1 event: 37  vsize = 5646.11 deltaVsize = 192 rss = 3870.63 delta = 19.6211\r\n```", "branch": "CMSSW_9_0_X", "changed_files": 2, "closed_at": "1481553348", "comments": 12, "commits": 2, "created_at": "1481494036", "deletions": 5, "labels": ["comparison-available", "fully-signed", "orp-approved", "simulation-approved", "tests-approved"], "merge_commit_sha": "ec230e4ca7b294aeb2394203a91c14b2fd8e8db5", "merged_at": "1481553348", "merged_by": "cmsbuild", "milestone": "CMSSW_9_0_X", "number": 16972, "release-notes": [], "review_comments": 0, "state": "closed", "title": "Speed improvement to HGCDigitizer", "updated_at": "1481553348", "user": "lgray"}