{"additions": 224, "auther_ref": "fixSwitchThreadSafety", "auther_sha": "d521f7f7a2354a38b466cb6d1f16c981a2cbecf1", "author": "makortel", "body": "#### PR description:\r\n\r\nThis PR fixes three thread safety issues in SwitchProducer ProductResolvers that I realized while addressing #28680\r\n- `SwitchBaseProductResolver::prefetchRequested_` is now re-set to `false` in `resetProductData_()`\r\n   * Current behavior (without re-setting) could lead to starvation if there are many consumers (in Tasks) for the SwitchProducer products. This indeed happens with enhanced tests (multiple consumers, multiple threads)\r\n- Call `ProductData::unsafe_setWrapper()` in the prefetching phase as suggested by @Dr15Jones in #28680 \r\n   * The ordering of the tasks ensures that exactly one task is accessing the `ProductData` at the time of the call, after which the tasks for the product consumers are spawned.\r\n- `SwitchBaseProductResolver::waitingTasks_` is reset in `resetProductData_()`\r\n  * Current behavior (without reset) leads to product consumer tasks being spawned too early from 2nd event onwards\r\n\r\nIn addition this PR\r\n- Moves `putProduct_()` from `SwitchBaseProductResolver` to `SwitchProducerProductResolver`\r\n   * The `putProduct_()` should never be called from `SwitchAliasProductResolver` (and now throws an exception)\r\n- Moves the call to `updateProvenance()` to a proper place in `SwitchProducerProductResolver`\r\n   * The earlier placement looked suspicious (why update if got an exception), and the problem in the provenance tracking was confirmed by enhancing the tests to check the provenance information also for the test configuration where the SwitchProcucer is in a Path\r\n\r\nFixes #28680.\r\n\r\n#### PR validation:\r\n\r\nCode compiles, unit tests run.", "branch": "master", "changed_files": 10, "closed_at": "1577788129", "comments": 32, "commits": 8, "created_at": "1577473293", "deletions": 77, "labels": ["code-checks-approved", "comparison-available", "core-approved", "fully-signed", "orp-approved", "tests-approved"], "merge_commit_sha": "8f299bccf2d6d10e6e50920b48ed9301cbcbdc98", "merged_at": "1577788129", "merged_by": "cmsbuild", "milestone": "CMSSW_11_1_X", "number": 28686, "release-notes": [], "review_comments": 5, "state": "closed", "title": "Fix thread safety issues in SwitchProducer ProductResolvers", "updated_at": "1577788130", "user": "makortel"}