{"additions": 6, "auther_ref": "fix_closebygun", "auther_sha": "2343d5286b41b334c726c9bd5ed772dff6f145ba", "author": "bfonta", "body": "#### PR description:\r\n\r\nThe current computation of the `z` coordinate when `ControlledByREta` is active has a bug (introduced in https://github.com/cms-sw/cmssw/pull/45515) which is here fixed. The correct formula is `z = sinh(eta) * R`. Notice the fix is coherent with the other rewrites of the same formula a couple of lines above the bug.\r\n\r\nI took this chance to also fix:\r\n+ a spurious increment of the `phi` passed by the user for the first particle being generated, and\r\n+ ensure the min and max values of `fR` are considered when `ControlledByREta = true`.\r\n\r\n\r\n#### PR validation:\r\n\r\nThe fixed `z` computation was validated with the following script:\r\n\r\n```c++\r\n#include <iostream>\r\n#include <cmath>\r\n\r\ndouble func_old(double r, double eta) {\r\n  return std::sinh(eta) / r;\r\n}\r\n\r\ndouble func_new(double r, double eta) {\r\n  return std::sinh(eta) * r;\r\n}\r\n\r\ndouble func_intuitive(double r, double eta) {\r\n  return r / std::tan(2*std::atan(std::exp(-eta)));\r\n}\r\n\r\nint main(int argc, char** argv)\r\n{\r\n  double fEta=0.2;\r\n  for(double fR=1.; fR<40.; ++fR) {\r\n\tstd::cout << \"Old: \" << func_old(fR, fEta) << \" \\t New: \" << func_new(fR, fEta) << \" \\t Intuitive: \" << func_intuitive(fR, fEta) << std::endl;\r\n  }\r\n  return 0;\r\n}\r\n```\r\n\r\nwhich compares the old and new definition plus an \"intuitive\" definition based on the  $\\tan(\\theta)=R/z$ relation plus a conversion from $\\theta$ to $\\eta$.\r\nAdditionally, events were generated and were found to obey the eta and phi values passed by the user.", "branch": "master", "changed_files": 1, "comments": 5, "commits": 1, "created_at": "1762953076", "deletions": 8, "labels": ["generators-pending", "pending-signatures", "tests-pending", "orp-pending", "code-checks-approved", "ngt"], "milestone": "CMSSW_16_0_X", "number": 49375, "release-notes": [], "review_comments": 0, "state": "open", "title": "Fix ControlledByREta in CloseByParticleGun", "updated_at": "1762954083", "user": "bfonta"}