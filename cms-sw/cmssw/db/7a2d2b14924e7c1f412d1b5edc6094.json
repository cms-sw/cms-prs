{"additions": 718, "auther_ref": "cuda_backport_alpaka_tests", "auther_sha": "d2e962a5e1aa0473ae4c33bdc0773fb60327ea2e", "author": "fwyzard", "body": "#### PR description:\r\n\r\nTo ease the migration from CUDA to Alpaka, reimplement in CUDA the `PortableHostCollection` and `PortableDeviceCollection` originally developed for the Alpaka data formats, along with the `PortableTestObjects` tests.\r\n\r\nThe CUDA version is in the `cms::cuda` namespace.\r\n\r\nThe data format functionality requires extending the `cms::cuda::host::make_unique<T>` to support pageable (_i.e._ non-pinned) host memory.\r\n\r\n#### PR validation:\r\n\r\nThe new unit tests run successfully, both with and without GPUs:\r\n```\r\n$ cmsRun HeterogeneousCore/CUDATest/python/writer.py \r\n%MSG-i CUDAService:  (NoModuleName) 06-Sep-2022 17:39:19 CEST pre-events\r\nCUDA runtime version 11.5, driver version 11.6, NVIDIA driver version 510.47.03\r\nCUDA device 0: Tesla T4 (sm_75)\r\nCUDA device 1: Tesla T4 (sm_75)\r\n%MSG\r\n...\r\n\r\n$ edmDumpEventContent test.root \r\nType                                  Module                 Label     Process    \r\n----------------------------------------------------------------------------------\r\ncms::cuda::PortableHostCollection<portabletest::TestSoALayout<128,false> >    \"testProducer\"         \"\"        \"Writer\"   \r\ncms::cuda::PortableHostCollection<portabletest::TestSoALayout<128,false> >    \"testProducerSerial\"   \"\"        \"Writer\"   \r\n\r\n$ CUDA_VISIBLE_DEVICES= cmsRun HeterogeneousCore/CUDATest/python/writer.py \r\n%MSG-i CUDAService:  (NoModuleName) 06-Sep-2022 17:39:58 CEST pre-events\r\nCUDAService disabled by configuration\r\n%MSG\r\n...\r\n\r\n$ edmDumpEventContent test.root \r\nType                                  Module                 Label     Process    \r\n----------------------------------------------------------------------------------\r\ncms::cuda::PortableHostCollection<portabletest::TestSoALayout<128,false> >    \"testProducer\"         \"\"        \"Writer\"   \r\ncms::cuda::PortableHostCollection<portabletest::TestSoALayout<128,false> >    \"testProducerSerial\"   \"\"        \"Writer\"   \r\n\r\n$ cmsRun HeterogeneousCore/CUDATest/python/reader.py \r\n06-Sep-2022 17:40:26 CEST  Initiating request to open file file:test.root\r\n06-Sep-2022 17:40:26 CEST  Successfully opened file file:test.root\r\n...\r\n```\r\n\r\nRegarding the changes to the `cms::cuda::host::unique_ptr<T>`, they were tested also in CMSSW 12.4.8 on a GPU-enabled HLT workflow, to make sure they do not have any negative impact on the performance.\r\n\r\nVanilla CMSSW_12_4_8\r\n```\r\nRunning 4 times over 10300 events with 8 jobs, each with 32 threads, 32 streams and 1 GPUs\r\n   798.2    0.2 ev/s (10000 events, 98.6% overlap)\r\n   797.5    0.2 ev/s (10000 events, 98.8% overlap)\r\n   799.4    0.2 ev/s (10000 events, 99.3% overlap)\r\n   800.3    0.2 ev/s (10000 events, 99.1% overlap)\r\n --------------------\r\n   798.8    1.3 ev/s\r\n```\r\n\r\nWith the equivalent changes as in this PR:\r\n```\r\nRunning 4 times over 10300 events with 8 jobs, each with 32 threads, 32 streams and 1 GPUs\r\n   798.2    0.2 ev/s (10000 events, 99.1% overlap)\r\n   798.4    0.2 ev/s (10000 events, 99.0% overlap)\r\n   798.0    0.2 ev/s (10000 events, 98.7% overlap)\r\n   798.1    0.2 ev/s (10000 events, 99.4% overlap)\r\n --------------------\r\n   798.2    0.2 ev/s\r\n```\r\n\r\n\r\n\r\n#### If this PR is a backport please specify the original PR and why you need to backport that PR. If this PR will be backported please specify to which release cycle the backport is meant for:\r\n\r\nBackport of #39319 to CMSSW 12.5.x.", "branch": "CMSSW_12_5_X", "changed_files": 27, "closed_at": "1662922347", "comments": 24, "commits": 5, "created_at": "1662472205", "deletions": 12, "labels": ["fully-signed", "tests-approved", "orp-approved", "backport-ok", "heterogeneous-approved"], "merge_commit_sha": "75fe478263126eccebe0bbdefcb7daa3ddd4afbb", "merged_at": "1662922347", "merged_by": "cmsbuild", "milestone": "CMSSW_12_5_X", "number": 39321, "release-notes": [], "review_comments": 0, "state": "closed", "title": "Reimplement the PortableCollection and related tests in CUDA [12.5.x]", "updated_at": "1662922348", "user": "fwyzard"}