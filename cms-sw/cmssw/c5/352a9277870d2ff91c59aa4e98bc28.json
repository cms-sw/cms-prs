{"additions": 1833, "auther_ref": "embedding_dev_CMSSW_15_1_0_pre1_improveCode", "auther_sha": "3f549be453b571b6e85889147043d41b3fafbbc6", "author": "KIT-CMS", "body": "#### PR description:\r\n\r\nThis PR restructures and cleans the [tau embedding method](https://twiki.cern.ch/twiki/bin/viewauth/CMS/TauEmbeddingSamplesUL) ([`TauAnalysis/MCEmbeddingTools`](https://github.com/cms-sw/cmssw/tree/master/TauAnalysis/MCEmbeddingTools)) so that it is possible to produce RUN 3 tau embedding samples with CMS submission workflows.\r\nOne goal was to remove the need of `--customise` or `--customise_commands` in the tau embedding `cmsDriver.py` commands.\r\nThis was possible due to modifiers and the possibility to add python config fragments to some `cmsDriver.py` steps.\r\nOnly the `HLT` step required additional modification of the `cmsDriver.py` [config builder](https://github.com/cms-sw/cmssw/pull/48408/files#diff-cdb26c43130acb8faa9c94529dd55a55671d2621695d7c5a2a47aa20a62e62df).\r\n\r\nThe other goal of this PR is to have more understandable, better commented code and therefore sustainable code.\r\n\r\n#### Tau embedding `cmsDriver.py` commands\r\nWith the changes introduced in this PR, tau embedding samples can be produced using the following `cmsDriver.py` commands.\r\n\r\n<details>\r\n<summary>Selection</summary>\r\n\r\n```shell\r\ncmsDriver.py \\\r\n--step RAW2DIGI,L1Reco,RECO,PAT,FILTER:TauAnalysis/MCEmbeddingTools/Selection_FILTER_cff.makePatMuonsZmumuSelection \\\r\n--processName SELECT \\\r\n--data \\\r\n--scenario pp \\\r\n--conditions auto:run3_data \\\r\n--era Run3_2024 \\\r\n--eventcontent RAWRECO \\\r\n--datatier RAWRECO \\\r\n--outputCommands 'keep *_selectedMuonsForEmbedding_*_SELECT','keep *_patMuonsAfterID_*_SELECT','keep *_slimmedMuons_*_SELECT','keep *_slimmedMuonTrackExtras_*_SELECT','keep recoVertexs_offlineSlimmedPrimaryVertices_*_SELECT','keep *_firstStepPrimaryVertices_*_SELECT','keep *_ecalDrivenElectronSeeds_*_SELECT' \\\r\n--filein \"root://cmsdcache-kit-disk.gridka.de:1094//store/data/Run2024C/Muon0/RAW/v1/000/380/115/00000/00979445-916c-42e2-8038-428d7bd4f176.root\" \\\r\n--fileout ...\r\n```\r\n\r\n</details>\r\n<details>\r\n<summary>LHE and Cleaning</summary>\r\n\r\n```shell\r\ncmsDriver.py \\\r\n--step USER:TauAnalysis/MCEmbeddingTools/LHE_USER_cff.embeddingLHEProducerTask,RAW2DIGI,RECO:TauAnalysis/MCEmbeddingTools/Cleaning_RECO_cff.reconstruction \\\r\n--processName LHEembeddingCLEAN \\\r\n--data \\\r\n--scenario pp \\\r\n--conditions auto:run3_data \\\r\n--era Run3_2024 \\\r\n--eventcontent RAWRECO \\\r\n--datatier RAWRECO \\\r\n--outputCommands 'drop *_*_*_SELECT','drop recoIsoDepositedmValueMap_muIsoDepositTk_*_*','drop recoIsoDepositedmValueMap_muIsoDepositTkDisplaced_*_*','drop *_ctppsProtons_*_*','drop *_ctppsLocalTrackLiteProducer_*_*','drop *_ctppsDiamondLocalTracks_*_*','drop *_ctppsDiamondRecHits_*_*','drop *_ctppsDiamondRawToDigi_*_*','drop *_ctppsPixelLocalTracks_*_*','drop *_ctppsPixelRecHits_*_*','drop *_ctppsPixelClusters_*_*','drop *_ctppsPixelDigis_*_*','drop *_totemRPLocalTrackFitter_*_*','drop *_totemRPUVPatternFinder_*_*','drop *_totemRPRecHitProducer_*_*','drop *_totemRPClusterProducer_*_*','drop *_totemRPRawToDigi_*_*','drop *_muonSimClassifier_*_*','keep *_patMuonsAfterID_*_SELECT','keep *_slimmedMuons_*_SELECT','keep *_selectedMuonsForEmbedding_*_SELECT','keep recoVertexs_offlineSlimmedPrimaryVertices_*_SELECT','keep *_firstStepPrimaryVertices_*_SELECT','keep *_offlineBeamSpot_*_SELECT','keep *_l1extraParticles_*_SELECT','keep TrajectorySeeds_*_*_*','keep recoElectronSeeds_*_*_*','keep *_generalTracks_*_LHEembeddingCLEAN','keep *_generalTracks_*_CLEAN','keep *_cosmicsVetoTracksRaw_*_LHEembeddingCLEAN','keep *_cosmicsVetoTracksRaw_*_CLEAN','keep *_electronGsfTracks_*_LHEembeddingCLEAN','keep *_electronGsfTracks_*_CLEAN','keep *_lowPtGsfEleGsfTracks_*_LHEembeddingCLEAN','keep *_lowPtGsfEleGsfTracks_*_CLEAN','keep *_displacedTracks_*_LHEembeddingCLEAN','keep *_displacedTracks_*_CLEAN','keep *_ckfOutInTracksFromConversions_*_LHEembeddingCLEAN','keep *_ckfOutInTracksFromConversions_*_CLEAN','keep *_muons1stStep_*_LHEembeddingCLEAN','keep *_muons1stStep_*_CLEAN','keep *_displacedMuons1stStep_*_LHEembeddingCLEAN','keep *_displacedMuons1stStep_*_CLEAN','keep *_conversions_*_LHEembeddingCLEAN','keep *_conversions_*_CLEAN','keep *_allConversions_*_LHEembeddingCLEAN','keep *_allConversions_*_CLEAN','keep *_particleFlowTmp_*_LHEembeddingCLEAN','keep *_particleFlowTmp_*_CLEAN','keep *_ecalDigis_*_LHEembeddingCLEAN','keep *_ecalDigis_*_CLEAN','keep *_hcalDigis_*_LHEembeddingCLEAN','keep *_hcalDigis_*_CLEAN','keep *_ecalRecHit_*_LHEembeddingCLEAN','keep *_ecalRecHit_*_CLEAN','keep *_ecalPreshowerRecHit_*_LHEembeddingCLEAN','keep *_ecalPreshowerRecHit_*_CLEAN','keep *_hbhereco_*_LHEembeddingCLEAN','keep *_hbhereco_*_CLEAN','keep *_horeco_*_LHEembeddingCLEAN','keep *_horeco_*_CLEAN','keep *_hfreco_*_LHEembeddingCLEAN','keep *_hfreco_*_CLEAN','keep *_standAloneMuons_*_LHEembeddingCLEAN','keep *_glbTrackQual_*_LHEembeddingCLEAN','keep *_externalLHEProducer_*_LHEembedding','keep *_externalLHEProducer_*_LHEembeddingCLEAN' \\\r\n--procModifiers tau_embedding_mu_to_mu \\\r\n--filein ... \\\r\n--fileout ...\r\n```\r\n\r\n</details>\r\n<details>\r\n<summary>Simulation Gen</summary>\r\n\r\n```shell\r\ncmsDriver.py TauAnalysis/MCEmbeddingTools/python/Simulation_GEN_cfi.py \\\r\n--step GEN,SIM,DIGI,L1,DIGI2RAW \\\r\n--processName SIMembeddingpreHLT \\\r\n--mc \\\r\n--beamspot DBrealistic \\\r\n--geometry DB:Extended \\\r\n--era Run3_2024 \\\r\n--conditions auto:phase1_2024_realistic \\\r\n--eventcontent RAWSIM \\\r\n--datatier RAWSIM \\\r\n--outputCommands 'keep *_*_*_LHEembeddingCLEAN','keep *_*_*_SELECT','drop *_muonReducedTrackExtras_*_*','drop *_*_uncleanedConversions_*','drop *_diamondSampicLocalTracks_*_*','keep *_*_unsmeared_*', \\\r\n--procModifiers tau_embedding_mu_to_mu \\\r\n--filein ... \\\r\n--fileout ...\r\n```\r\n\r\n</details>\r\n<details>\r\n<summary>Simulation HLT</summary>\r\n\r\n```shell\r\ncmsDriver.py \\\r\n--step HLT:TauAnalysis/MCEmbeddingTools/Simulation_HLT_customiser_cff.embeddingHLTCustomiser.Fake2 \\\r\n--processName SIMembeddingHLT \\\r\n--mc \\\r\n--beamspot DBrealistic \\\r\n--geometry DB:Extended \\\r\n--era Run3_2024 \\\r\n--conditions auto:phase1_2024_realistic \\\r\n--eventcontent RAWSIM \\\r\n--datatier RAWSIM \\\r\n--outputCommands 'keep *_*_*_SELECT','keep *_*_*_LHEembeddingCLEAN','keep *_*_unsmeared_SIMembeddingpreHLT','keep DcsStatuss_hltScalersRawToDigi_*_*' \\\r\n--filein ... \\\r\n--fileout ...\r\n```\r\n\r\n</details>\r\n<details>\r\n<summary>Simulation Reco</summary>\r\n\r\n```shell\r\ncmsDriver.py \\\r\n--step RAW2DIGI,L1Reco,RECO:TauAnalysis/MCEmbeddingTools/Simulation_RECO_cff.reconstruction,RECOSIM \\\r\n--processName SIMembedding \\\r\n--mc \\\r\n--beamspot DBrealistic \\\r\n--geometry DB:Extended \\\r\n--era Run3_2024 \\\r\n--conditions auto:phase1_2024_realistic \\\r\n--eventcontent RAWRECOSIMHLT \\\r\n--datatier RAW-RECO-SIM \\\r\n--outputCommands 'keep *_*_*_LHEembeddingCLEAN','keep *_*_*_SELECT','keep *_genParticles_*_SIMembedding','keep *_standAloneMuons_*_SIMembedding','keep *_glbTrackQual_*_SIMembedding','keep *_generator_*_SIMembedding','keep *_addPileupInfo_*_SIMembedding','keep *_selectedMuonsForEmbedding_*_*','keep *_slimmedAddPileupInfo_*_*','keep *_embeddingHltPixelVertices_*_*','keep *_*_vertexPosition_*','keep recoMuons_muonsFromCosmics_*_*','keep recoTracks_cosmicMuons1Leg_*_*','keep recoMuons_muonsFromCosmics1Leg_*_*','keep *_muonDTDigis_*_*','keep *_muonCSCDigis_*_*','keep TrajectorySeeds_*_*_*','keep recoElectronSeeds_*_*_*','drop recoIsoDepositedmValueMap_muIsoDepositTk_*_*','drop recoIsoDepositedmValueMap_muIsoDepositTkDisplaced_*_*','drop *_ctppsProtons_*_*','drop *_ctppsLocalTrackLiteProducer_*_*','drop *_ctppsDiamondLocalTracks_*_*','drop *_ctppsDiamondRecHits_*_*','drop *_ctppsDiamondRawToDigi_*_*','drop *_ctppsPixelLocalTracks_*_*','drop *_ctppsPixelRecHits_*_*','drop *_ctppsPixelClusters_*_*','drop *_ctppsPixelDigis_*_*','drop *_totemRPLocalTrackFitter_*_*','drop *_totemRPUVPatternFinder_*_*','drop *_totemRPRecHitProducer_*_*','drop *_totemRPClusterProducer_*_*','drop *_totemRPRawToDigi_*_*','drop *_muonSimClassifier_*_*','keep *_generalTracks_*_SIMembedding','keep *_cosmicsVetoTracksRaw_*_SIMembedding','keep *_electronGsfTracks_*_SIMembedding','keep *_lowPtGsfEleGsfTracks_*_SIMembedding','keep *_displacedTracks_*_SIMembedding','keep *_ckfOutInTracksFromConversions_*_SIMembedding','keep *_muons1stStep_*_SIMembedding','keep *_displacedMuons1stStep_*_SIMembedding','keep *_conversions_*_SIMembedding','keep *_allConversions_*_SIMembedding','keep *_particleFlowTmp_*_SIMembedding','keep *_ecalDigis_*_SIMembedding','keep *_hcalDigis_*_SIMembedding','keep *_ecalRecHit_*_SIMembedding','keep *_ecalPreshowerRecHit_*_SIMembedding','keep *_hbhereco_*_SIMembedding','keep *_horeco_*_SIMembedding','keep *_hfreco_*_SIMembedding','keep *_*_unsmeared_SIMembeddingpreHLT','keep *_hltScalersRawToDigi_*_SIMembeddingHLT' \\\r\n--filein ... \\\r\n--fileout ...\r\n```\r\n\r\n</details>\r\n<details>\r\n<summary>Merging</summary>\r\n\r\n```shell\r\ncmsDriver.py \\\r\n--step USER:TauAnalysis/MCEmbeddingTools/Merging_USER_cff.merge_step,PAT \\\r\n--processName MERGE \\\r\n--data \\\r\n--scenario pp \\\r\n--conditions auto:run3_data \\\r\n--era Run3_2024 \\\r\n--eventcontent MINIAODSIM \\\r\n--datatier USER \\\r\n--inputCommands 'keep *_*_*_*' \\\r\n--outputCommands 'drop *_*_*_SELECT','keep *_prunedGenParticles_*_MERGE','keep *_generator_*_SIMembeddingpreHLT','keep *_generator_*_SIMembeddingHLT','keep *_generator_*_SIMembedding','keep *_selectedMuonsForEmbedding_*_*','keep *_unpackedPatTrigger_*_*','keep patPackedGenParticles_packedGenParticles_*_*','keep recoGenParticles_prunedGenParticles_*_*','keep *_packedPFCandidateToGenAssociation_*_*','keep *_lostTracksToGenAssociation_*_*','keep LHEEventProduct_*_*_*','keep GenFilterInfo_*_*_*','keep GenLumiInfoHeader_generator_*_*','keep GenLumiInfoProduct_*_*_*','keep GenEventInfoProduct_generator_*_*','keep recoGenParticles_genPUProtons_*_*','keep *_slimmedGenJetsFlavourInfos_*_*','keep *_slimmedGenJets__*','keep *_slimmedGenJetsAK8__*','keep *_slimmedGenJetsAK8SoftDropSubJets__*','keep *_genMetTrue_*_*','keep LHERunInfoProduct_*_*_*','keep GenRunInfoProduct_*_*_*','keep *_genParticles_xyz0_*','keep *_genParticles_t0_*' \\\r\n--filein ... \\\r\n--fileout ...\r\n```\r\n\r\n</details>\r\n<details>\r\n<summary>NanoAOD</summary>\r\n\r\n```shell\r\ncmsDriver.py \\\r\n--step NANO:TauAnalysis/MCEmbeddingTools/Nano_cff.embedding_nanoAOD_seq \\\r\n--data \\\r\n--scenario pp \\\r\n--conditions auto:run3_data \\\r\n--era Run3_2024 \\\r\n--eventcontent NANOAODSIM \\\r\n--datatier NANOAODSIM \\\r\n--outputCommands 'keep edmTriggerResults_*_*_SIMembeddingpreHLT','keep edmTriggerResults_*_*_SIMembeddingHLT','keep edmTriggerResults_*_*_SIMembedding','keep edmTriggerResults_*_*_MERGE','keep edmTriggerResults_*_*_NANO' \\\r\n--filein ... \\\r\n--fileout ...\r\n```\r\n\r\n</details>\r\n\r\n\r\n#### PR validation:\r\n\r\nI had to disable the tests, as I first have to get RAW samples from tape to create a small set of samples I can use. The test `.root` files right now are only useable for the old structure. \r\nI will deliver tests in the next pull request.", "branch": "master", "changed_files": 48, "comments": 12, "commits": 17, "created_at": "1750854918", "deletions": 1613, "labels": ["simulation-pending", "operations-pending", "pending-signatures", "tests-pending", "orp-pending", "code-checks-approved"], "milestone": "CMSSW_15_1_X", "number": 48408, "release-notes": [], "review_comments": 15, "state": "open", "title": "Restructure and comment the tau embedding method", "updated_at": "1751381659", "user": "winterchristian"}