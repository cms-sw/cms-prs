{"additions": 1120, "auther_ref": "pps-alignment-global-pcl", "auther_sha": "731501bd2ff337741ed66571082decd9fa93b1d7", "author": "CTPPS", "body": "#### PR description:\r\n\r\nThe main purpose of this PR is to add some new files and modifications required to run the PPS alignment procedure in the PCL. The implementation is based on #33215. Note that the modifications include updating two files in `CalibPPS/TimingCalibration`.\r\n\r\nIt is important for us to be able to test it on Tier0 as soon as possible, so these changes are supposed to be included in CMSSW_12_1_0. Since the deadline for CMSSW_12_1_0_pre5 is 19/10, we kindly ask for a quick review.\r\n\r\nThis PR also improves `PPSAlignmentWorker` and `PPSAlignmentHarvester`. It applies a refactor, fixes some bugs and adds some new functionality to the code in the `CalibPPS/AlignmentGlobal` package. The main modifications are listed below:\r\n- huge refactor in the worker and the harvester\r\n- README update to include new parameters from the `PPSAlignmentConfiguration` conditions format\r\n- `test` folder update\r\n- Replaced `PPSAlignmentConfig` with `PPSAlignmentConfiguration` in the worker and the harvester.\r\n- Added support for the new parameters from `PPSAlignmentConfiguration`.\r\n- Now, the harvester can save an sqlite file with the alignment results.\r\n- Updated the debug mode in the harvester to save more plots.\r\n- Fixed odd fitting in the harvester (in the `yAlignment` method).\r\n\r\nApart from that, this PR adds a `RetrieveCTPPSRPAlignmentCorrectionsData` module required to properly test writing an sqlite file containing a `CTPPSRPAlignmentCorrectionsData` object.\r\n\r\nThe PR is a continuation of the strategy presented in the [AlCaDB meeting on 30 August](https://indico.cern.ch/event/1069114/). The previous PR were:\r\n- #31728 - first version of the code responsible for the PPS alignment,\r\n- #34844 and #34845 - bug fix with backport,\r\n- #35174 - new, final conditions object - `PPSAlignmentConfiguration`.\r\n\r\nThere are still some smaller changes foreseen, but they have been moved to the next PR, since it is vital to merge the PCL changes as soon as possible.\r\n\r\n#### PR validation:\r\n\r\n- The code returns correct results running on data from Run 2. Check out `CalibPPS/AlignmentGlobal/test` for an example.\r\n- A new matrix test workflow has been added - `1042`. It does not crash, but I've observed that the harvester (4th step) does not see any plots booked by the worker (3rd step). I don't know if that's because of a faulty configuration of the relval steps or wrong command used to run it (`runTheMatrix.py -l 1042 --ibeos`). Please, let me know if you know the answer to that. If not, I can remove that matrix test from this PR. By the way, I've observed the same problem while running the workflow `1041`, which is very similar to `1042`.\r\n- To be able to run the matrix test, a candidate GT has been created - `121X_dataRun3_Prompt_Candidate_2021_10_09_12_20_39`. For now, it is still listed as `--conditions` in `relval_steps.py`. Please, let me know if I have to replace it with `auto:run3_data_express`.\r\n- In case they are needed, I attach the memory consumption plots acquired during running the procedure using a representative dataset from 2018.\r\n![alignment_memory_check](https://user-images.githubusercontent.com/56218578/137006760-ffaac854-e6fa-48c3-bd36-51b458cc3549.png)\r\n", "branch": "master", "changed_files": 26, "comments": 8, "commits": 13, "created_at": "1634060929", "deletions": 709, "labels": ["alca-pending", "db-pending", "operations-pending", "pending-signatures", "tests-pending", "orp-pending", "pdmv-pending", "upgrade-pending", "code-checks-pending"], "milestone": "CMSSW_12_1_X", "number": 35631, "release-notes": [], "review_comments": 9, "state": "open", "title": "Added PPS Alignment to the Prompt Calibration Loop", "updated_at": "1634136615", "user": "MatiXOfficial"}