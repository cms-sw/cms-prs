{"additions": 319, "auther_ref": "devel_hltL1TMatchedPFJetsVBFFilter", "auther_sha": "9b288f5f3983341271ef426e353cbed16c8719bf", "author": "missirol", "body": "#### PR description:\r\n\r\nThis PR adds new `HLTFilter`s which are meant to be used for an update of the VBF-parking triggers of the current HLT pp menu.\r\n\r\nThe new `HLTFilter`s are instantiations of the plugin template `HLTL1TMatchedJetsVBFFilter`, which serves as an improved version of the `EDProducer` template [`L1TJetsMatching`](https://github.com/cms-sw/cmssw/blob/6975683d2fb2d3c4f92f60a0266e49591dcdd042/RecoTauTag/HLTProducers/interface/L1TJetsMatching.h).\r\n\r\nFor further details, see [CMSHLT-2887](https://its.cern.ch/jira/browse/CMSHLT-2887).\r\n\r\nAttn: @portalesHEP\r\n\r\n#### PR validation:\r\n\r\nCompared the results of the latest `GRun` menu before and after customising the relevant Paths with the introduction of instances of `HLTL1TMatchedPFJetsVBFFilter`. The trigger results [2] of the manual tests in [1] are as expected.\r\n\r\n[1]\r\n```bash\r\n#!/bin/bash\r\n\r\njobLabel=hlt1\r\nif [ ! -f \"${jobLabel}\".py ]; then\r\n  hltGetConfiguration \\\r\n   /dev/CMSSW_13_0_0/GRun \\\r\n   --paths HLT_VBF_DiPFJet*,-HLT_VBF_DiPFJet*Detajj*,HLTriggerFinalPath \\\r\n   --max-events 1000 \\\r\n   --output minimal --no-prescale \\\r\n   --mc --globaltag 126X_mcRun3_2023_forPU65_v5 \\\r\n   --input /store/mc/Run3Winter23Digi/VBFHHto2B2Tau_CV-1_C2V-2_C3-1_TuneCP5_13p6TeV_madgraph-pythia8/GEN-SIM-RAW/126X_mcRun3_2023_forPU65_v1-v2/40000/a94d16bb-8df9-4eab-8c89-a5594aef6a48.root \\\r\n   --eras Run3 --l1-emulator FullMC --l1 L1Menu_Collisions2023_v1_3_0_xml \\\r\n   > \"${jobLabel}\".py\r\n  cat <<EOF >> \"${jobLabel}\".py\r\nprocess.options.numberOfThreads = 1\r\nprocess.options.numberOfStreams = 0\r\nEOF\r\n  echo -e \"\\n=== ${jobLabel} ===\"\r\n  edmConfigDump \"${jobLabel}\".py > \"${jobLabel}\"_dump.py && \\\r\n   cmsRun \"${jobLabel}\".py &> \"${jobLabel}\".log && \\\r\n   mv output.root \"${jobLabel}\".root && \\\r\n   grep TrigRepor \"${jobLabel}\".log | head -20\r\nelse\r\n  echo \"Skipping ${jobLabel}\"\r\nfi\r\n\r\n# customise using the new filter without changing the cuts in any HLT Paths (expect same exact trigger results)\r\njobLabel=hlt2\r\nif [ ! -f \"${jobLabel}\".py ]; then\r\n  cp hlt1.py \"${jobLabel}\".py\r\n  cat <<EOF >> \"${jobLabel}\".py\r\nfrom HLTrigger.JetMET.hltL1TMatchedPFJetsVBFFilter_cfi import hltL1TMatchedPFJetsVBFFilter as _hltL1TMatchedPFJetsVBFFilter\r\n\r\ndef _redefineLastFilterOfVBFParkingPaths(process, producerLabel, filterLabels):\r\n\r\n    mod_p = getattr(process, producerLabel)\r\n\r\n    for filterLabel in filterLabels:\r\n        mod_f = getattr(process, filterLabel)\r\n\r\n        setattr(process, filterLabel, _hltL1TMatchedPFJetsVBFFilter.clone(\r\n            src = mod_p.JetSrc,\r\n            maxJetDeltaR = mod_p.matchingR,\r\n            l1tJetRefs = mod_p.L1JetTrigger,\r\n            algorithm = mod_p.matchingMode,\r\n            minPt1 = mod_p.pt1Min,\r\n            minPt2 = mod_p.pt2Min,\r\n            minPt3 = mod_p.pt3Min,\r\n            minInvMass = mod_p.mjjMin,\r\n            minNJets = mod_f.MinN,\r\n            maxNJets = mod_f.MinN\r\n        ))\r\n\r\n    delattr(process, producerLabel)\r\n\r\n    return process\r\n\r\n_fooDict = {\r\n    'hltL1PFJetsMatchingVBFinclMedium1050': ['hltL1PFJetCategoriesVBFinclMedium1050', 'hltL1PFJetCategoriesVBFinclMedium1050TripleJet'],\r\n    'hltL1PFJetsMatchingVBFinclTight1050': ['hltL1PFJetCategoriesVBFinclTight1050', 'hltL1PFJetCategoriesVBFinclTight1050TripleJet'],\r\n    'hltL1TPFJetsMatchingVBFDijetTight650': ['hltL1PFJetCategoriesVBFdijetTightQuadjet650', 'hltL1PFJetCategoriesVBFdijetTightFivejet650', 'hltL1PFJetCategoriesVBFdijetTightSixjet650'],\r\n    'hltL1PFJetsMatchingVBFMETTight550': ['hltL1PFJetCategoriesVBFMETTight550', 'hltL1PFJetCategoriesVBFMETTight550Triplejet'],\r\n    'hltL1PFJetsMatchingVBFMuTight650': ['hltL1PFJetCategoriesVBFMuTight650', 'hltL1PFJetCategoriesVBFMuTight650Triplejet'],\r\n}\r\n\r\nfor key,val in _fooDict.items():\r\n    process = _redefineLastFilterOfVBFParkingPaths(process, key, val)\r\nEOF\r\n  echo -e \"\\n=== ${jobLabel} ===\"\r\n  edmConfigDump \"${jobLabel}\".py > \"${jobLabel}\"_dump.py && \\\r\n   cmsRun \"${jobLabel}\".py &> \"${jobLabel}\".log && \\\r\n   mv output.root \"${jobLabel}\".root && \\\r\n   grep TrigRepor \"${jobLabel}\".log | head -20\r\nelse\r\n  echo \"Skipping ${jobLabel}\"\r\nfi\r\n\r\n# customise fully (new filter, \"merge\" paths using maxNJets=-1),\r\n# expect remaining Paths to the logical OR of the old ones (hlt1)\r\njobLabel=hlt3\r\nif [ ! -f \"${jobLabel}\".py ]; then\r\n  cp hlt1.py \"${jobLabel}\".py\r\n  cat <<EOF >> \"${jobLabel}\".py\r\nfrom HLTrigger.JetMET.hltL1TMatchedPFJetsVBFFilter_cfi import hltL1TMatchedPFJetsVBFFilter as _hltL1TMatchedPFJetsVBFFilter\r\n\r\ndef _redefineLastFilterOfVBFParkingPaths(process, producerLabel, filterLabels):\r\n\r\n    mod_p = getattr(process, producerLabel)\r\n\r\n    for filterLabel in filterLabels:\r\n        mod_f = getattr(process, filterLabel)\r\n\r\n        setattr(process, filterLabel, _hltL1TMatchedPFJetsVBFFilter.clone(\r\n            src = mod_p.JetSrc,\r\n            maxJetDeltaR = mod_p.matchingR,\r\n            l1tJetRefs = mod_p.L1JetTrigger,\r\n            algorithm = mod_p.matchingMode,\r\n            minPt1 = mod_p.pt1Min,\r\n            minPt2 = mod_p.pt2Min,\r\n            minPt3 = mod_p.pt3Min,\r\n            minInvMass = mod_p.mjjMin,\r\n            minNJets = mod_f.MinN,\r\n            maxNJets = -1\r\n        ))\r\n\r\n    delattr(process, producerLabel)\r\n\r\n    return process\r\n\r\n_fooDict = {\r\n    'hltL1PFJetsMatchingVBFinclMedium1050': ['hltL1PFJetCategoriesVBFinclMedium1050'],\r\n    'hltL1PFJetsMatchingVBFinclTight1050': ['hltL1PFJetCategoriesVBFinclTight1050'],\r\n    'hltL1TPFJetsMatchingVBFDijetTight650': ['hltL1PFJetCategoriesVBFdijetTightQuadjet650'],\r\n    'hltL1PFJetsMatchingVBFMETTight550': ['hltL1PFJetCategoriesVBFMETTight550'],\r\n    'hltL1PFJetsMatchingVBFMuTight650': ['hltL1PFJetCategoriesVBFMuTight650'],\r\n}\r\n\r\nfor key,val in _fooDict.items():\r\n    process = _redefineLastFilterOfVBFParkingPaths(process, key, val)\r\n\r\nfor foo in [foo for foo in process.paths_() if '_TriplePFJet_v' in foo or 'FiveJet_v' in foo or 'SixJet_v' in foo]:\r\n    delattr(process, foo)\r\nEOF\r\n  echo -e \"\\n=== ${jobLabel} ===\"\r\n  edmConfigDump \"${jobLabel}\".py > \"${jobLabel}\"_dump.py && \\\r\n   cmsRun \"${jobLabel}\".py &> \"${jobLabel}\".log && \\\r\n   mv output.root \"${jobLabel}\".root && \\\r\n   grep TrigRepor \"${jobLabel}\".log | head -20\r\nelse\r\n  echo \"Skipping ${jobLabel}\"\r\nfi\r\n```\r\n\r\n[2]\r\n```\r\n=== hlt1 ===\r\nTrigReport ---------- Event  Summary ------------\r\nTrigReport Events total = 1000 passed = 607 failed = 393\r\nTrigReport ---------- Path   Summary ------------\r\nTrigReport  Trig Bit#   Executed     Passed     Failed      Error Name\r\nTrigReport     1    0       1000        318        682          0 HLT_VBF_DiPFJet110_40_Mjj1050_v1\r\nTrigReport     1    1       1000         62        938          0 HLT_VBF_DiPFJet110_40_Mjj1050_TriplePFJet_v1\r\nTrigReport     1    2       1000        289        711          0 HLT_VBF_DiPFJet125_45_Mjj1050_v1\r\nTrigReport     1    3       1000         69        931          0 HLT_VBF_DiPFJet125_45_Mjj1050_TriplePFJet_v1\r\nTrigReport     1    4       1000        379        621          0 HLT_VBF_DiPFJet75_45_Mjj650_DiPFJet60_JetMatchingQuadJet_v1\r\nTrigReport     1    5       1000          0       1000          0 HLT_VBF_DiPFJet75_45_Mjj650_DiPFJet60_JetMatchingFiveJet_v1\r\nTrigReport     1    6       1000          2        998          0 HLT_VBF_DiPFJet75_45_Mjj650_DiPFJet60_JetMatchingSixJet_v1\r\nTrigReport     1    7       1000        341        659          0 HLT_VBF_DiPFJet80_45_Mjj550_PFMETNoMu85_v1\r\nTrigReport     1    8       1000         25        975          0 HLT_VBF_DiPFJet80_45_Mjj550_PFMETNoMu85_TriplePFJet_v1\r\nTrigReport     1    9       1000        172        828          0 HLT_VBF_DiPFJet95_45_Mjj650_Mu3_TrkIsoVVL_v1\r\nTrigReport     1   10       1000         16        984          0 HLT_VBF_DiPFJet95_45_Mjj650_Mu3_TrkIsoVVL_TriplePFJet_v1\r\nTrigReport     1   11       1000        264        736          0 HLT_VBF_DiPFJet45_Mjj550_MediumDeepTauPFTauHPS45_L2NN_eta2p1_v1\r\nTrigReport     1   12       1000        183        817          0 HLT_VBF_DiPFJet50_Mjj550_Photon22_v1\r\nTrigReport     1   13       1000         83        917          0 HLT_VBF_DiPFJet50_Mjj500_Ele22_eta2p1_WPTight_Gsf_v1\r\nTrigReport     1   14       1000          0       1000          0 HLTriggerFinalPath\r\nTrigReport -------End-Path   Summary ------------\r\n\r\n=== hlt2 ===\r\nTrigReport ---------- Event  Summary ------------\r\nTrigReport Events total = 1000 passed = 607 failed = 393\r\nTrigReport ---------- Path   Summary ------------\r\nTrigReport  Trig Bit#   Executed     Passed     Failed      Error Name\r\nTrigReport     1    0       1000        318        682          0 HLT_VBF_DiPFJet110_40_Mjj1050_v1\r\nTrigReport     1    1       1000         62        938          0 HLT_VBF_DiPFJet110_40_Mjj1050_TriplePFJet_v1\r\nTrigReport     1    2       1000        289        711          0 HLT_VBF_DiPFJet125_45_Mjj1050_v1\r\nTrigReport     1    3       1000         69        931          0 HLT_VBF_DiPFJet125_45_Mjj1050_TriplePFJet_v1\r\nTrigReport     1    4       1000        379        621          0 HLT_VBF_DiPFJet75_45_Mjj650_DiPFJet60_JetMatchingQuadJet_v1\r\nTrigReport     1    5       1000          0       1000          0 HLT_VBF_DiPFJet75_45_Mjj650_DiPFJet60_JetMatchingFiveJet_v1\r\nTrigReport     1    6       1000          2        998          0 HLT_VBF_DiPFJet75_45_Mjj650_DiPFJet60_JetMatchingSixJet_v1\r\nTrigReport     1    7       1000        341        659          0 HLT_VBF_DiPFJet80_45_Mjj550_PFMETNoMu85_v1\r\nTrigReport     1    8       1000         25        975          0 HLT_VBF_DiPFJet80_45_Mjj550_PFMETNoMu85_TriplePFJet_v1\r\nTrigReport     1    9       1000        172        828          0 HLT_VBF_DiPFJet95_45_Mjj650_Mu3_TrkIsoVVL_v1\r\nTrigReport     1   10       1000         16        984          0 HLT_VBF_DiPFJet95_45_Mjj650_Mu3_TrkIsoVVL_TriplePFJet_v1\r\nTrigReport     1   11       1000        264        736          0 HLT_VBF_DiPFJet45_Mjj550_MediumDeepTauPFTauHPS45_L2NN_eta2p1_v1\r\nTrigReport     1   12       1000        183        817          0 HLT_VBF_DiPFJet50_Mjj550_Photon22_v1\r\nTrigReport     1   13       1000         83        917          0 HLT_VBF_DiPFJet50_Mjj500_Ele22_eta2p1_WPTight_Gsf_v1\r\nTrigReport     1   14       1000          0       1000          0 HLTriggerFinalPath\r\nTrigReport -------End-Path   Summary ------------\r\n\r\n=== hlt3 ===\r\nTrigReport ---------- Event  Summary ------------\r\nTrigReport Events total = 1000 passed = 607 failed = 393\r\nTrigReport ---------- Path   Summary ------------\r\nTrigReport  Trig Bit#   Executed     Passed     Failed      Error Name\r\nTrigReport     1    0       1000        380        620          0 HLT_VBF_DiPFJet110_40_Mjj1050_v1\r\nTrigReport     1    1       1000        358        642          0 HLT_VBF_DiPFJet125_45_Mjj1050_v1\r\nTrigReport     1    2       1000        381        619          0 HLT_VBF_DiPFJet75_45_Mjj650_DiPFJet60_JetMatchingQuadJet_v1\r\nTrigReport     1    3       1000        366        634          0 HLT_VBF_DiPFJet80_45_Mjj550_PFMETNoMu85_v1\r\nTrigReport     1    4       1000        188        812          0 HLT_VBF_DiPFJet95_45_Mjj650_Mu3_TrkIsoVVL_v1\r\nTrigReport     1    5       1000        264        736          0 HLT_VBF_DiPFJet45_Mjj550_MediumDeepTauPFTauHPS45_L2NN_eta2p1_v1\r\nTrigReport     1    6       1000        183        817          0 HLT_VBF_DiPFJet50_Mjj550_Photon22_v1\r\nTrigReport     1    7       1000         83        917          0 HLT_VBF_DiPFJet50_Mjj500_Ele22_eta2p1_WPTight_Gsf_v1\r\nTrigReport     1    8       1000          0       1000          0 HLTriggerFinalPath\r\nTrigReport -------End-Path   Summary ------------\r\nTrigReport  Trig Bit#   Executed     Passed     Failed      Error Name\r\nTrigReport     0    0       1000       1000          0          0 @finalPath\r\nTrigReport ---------- Modules in Path: HLT_VBF_DiPFJet110_40_Mjj1050_v1 ------------\r\nTrigReport  Trig Bit#    Visited     Passed     Failed      Error Name\r\nTrigReport     1    0       1000       1000          0          0 hltTriggerType\r\nTrigReport     1    1       1000       1000          0          0 hltGtStage2Digis\r\n```\r\n\r\n#### If this PR is a backport, please specify the original PR and why you need to backport that PR. If this PR will be backported, please specify to which release cycle the backport is meant for:\r\n\r\n`CMSSW_13_2_X`\r\n\r\nNot needed for ppRef nor HIon, but useful to start the cleanup of the HLT pp menu ahead of 2024.\r\n", "branch": "master", "changed_files": 3, "comments": 4, "commits": 1, "created_at": "1691741334", "deletions": 0, "labels": ["hlt-pending", "pending-signatures", "tests-approved", "orp-pending", "code-checks-approved"], "milestone": "CMSSW_13_3_X", "number": 42543, "release-notes": [], "review_comments": 0, "state": "open", "title": "add `HLTFilter` template `HLTL1TMatchedJetsVBFFilter`", "updated_at": "1691756752", "user": "missirol"}