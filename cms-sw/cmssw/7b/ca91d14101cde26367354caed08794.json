{"additions": 1194, "auther_ref": "cocoa_to_dd4hep", "auther_sha": "7af821c9afe9537ac8afa5e05e432404c98416f5", "author": "ghugo83", "body": "Moved COCOA DD dependencies to DD4hep.\r\nAs discussed in https://github.com/cms-sw/cmssw/pull/25356. \r\n\r\n**General description of COCOA:**\r\nhttps://cds.cern.ch/record/1047121/files/p193.pdf\r\nCOCOA is now basically standalone alignment software. \r\nIt is designed to simulate and reconstruct optical alignment systems for CMS. It was also used (in the past I presume) to analyze the CMS optical alignment data, and pass the alignment correction to the CMS reconstruction.\r\n\r\n**PR description**:\r\nFollowing was done for port to DD4hep (this can also be seen as a HOWTO):\r\n- DetectorDescription/Core -> DetectorDescription/DDCMS dependencies.\r\n- Switch to DD4hep-based versions of DDCompactView and DDFilteredView.\r\n- Switch to DD4hep-based geometry building of a cms::DDDetector optical alignment system, with DDDetectorESProducer.\r\n- Remove use of old DDExpandedNode and navigation.\r\n- DDLogicalPart -> dd4hep::PlacedVolume and her friends.\r\n- DDTranslation -> dd4hep::Direction (ROOT::Math::XYZVector)\r\n- DDRotationMatrix -> dd4hep::Rotation3D (ROOT::Math::Rotation3D)\r\n- Remove use of DDsvalues_type and DDValue -> Instead, use of cms::DDSpecParRegistry,  cms::DDSpecParRefs, and cms::DDSpecPar::value<T>.\r\n\r\n**PR validation:**\r\nHad to 'reconstruct' input files to be able to run COCOA.\r\nNotably created an input XML file + an OpticalAlignmentsRcd stored in local .db.\r\nCreated small guide: Alignment/CocoaApplication/README.md, so that one can now easily run COCOA and reproduce results.\r\nNo regression due to port to DD4hep: \r\n- Fully checked ideal geometry building, perfectly matching geometry from XML.\r\n- Checked parameters and measurements from XMLs. \r\n\r\n**Bugs in COCOA:**\r\nWhile checking for regressions, I spotted & fixed the following issues in COCOA (independent from port to DD4hep). Visible in the code before PR:\r\n- https://github.com/cms-sw/cmssw/blob/CMSSW_10_3_X/Alignment/CocoaApplication/src/CocoaAnalyzer.cc#L214\r\ncolX, colY and colZ are obviously not columns, but rows. \r\nThis results in the rotation matrix rotclhep to be ill-formed (transpose, hence inverse, of what it should be). Hence, the local rotations in ideal geometry were inverse of what they should be, and could not be properly checked against those of the geometry from DB.\r\n- https://github.com/cms-sw/cmssw/blob/CMSSW_10_3_X/Alignment/CocoaFit/src/CocoaDBMgr.cc#L191\r\nThis is used to write results to DB. Error in the conversion (!!!), should go from m (in COCOA) to cm (in DB). Hence data stored in DB was wrong...\r\n- https://github.com/cms-sw/cmssw/blob/CMSSW_10_3_X/Alignment/CocoaApplication/src/CocoaAnalyzer.cc#L343 \r\nstd::string type is initialized with value from previous iteration. Hence, within the loop, there is a telescopage of its values. This leads to dimFactor being not properly calculated, hence all 'extra alignment parameters' values were wrong.\r\n\r\n**Disclaimer:**\r\nThe COCOA packages were very bad style, I re-wrote and commented only part of them, in the context of the port to DD4hep. Notably, src/CocoaAnalyzer.cc was removed then restored, hence I am partially attributed parts of old code there which is not mine.\r\nI fully debugged COCOA behavior in the fields of ideal geometry building + measurements corrections + results write to DB. Though, there are other important aspects in the alignment which I did not debug (notably the least-square parameters fitting).\r\n\r\n\r\n\r\n", "branch": "master", "changed_files": 13, "closed_at": "1594232383", "comments": 29, "commits": 2, "created_at": "1593697866", "deletions": 387, "labels": ["alca-approved", "code-checks-approved", "comparison-available", "fully-signed", "geometry-approved", "orp-approved", "tests-approved"], "merge_commit_sha": "d7f103c459dd195eaa651ce0c30e4bd4bfd0fe43", "merged_at": "1594232383", "merged_by": "cmsbuild", "milestone": "CMSSW_11_2_X", "number": 30507, "release-notes": [], "review_comments": 31, "state": "closed", "title": "Port COCOA to rely on DD4hep", "updated_at": "1594232383", "user": "ghugo83"}