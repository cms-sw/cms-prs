{"additions": 2247, "auther_ref": "dev-106X-bacportConcurrentGenUtilities", "auther_sha": "0cf3e81834b8aca603a386ddcbe7db72e4e73f86", "author": "colizz", "body": "#### PR description:\r\n\r\nBackports of all recently developed/modified concurrent GEN utilities to 10_6_X, to benefit UL event processing.\r\n\r\nThe PR includes the following changes\r\n\r\n1. #33985 \r\n2. #34146\r\n3. #34173 \r\n4. #34437 \r\n5. #34525\r\n6. #34436 (this is the change to the analysis code)\r\n7. Backport the changes on cfi/cff files in `Configuration/Generator/python` to enable concurrent GEN. This includes several items (see details in https://github.com/cms-sw/cmssw/pull/34527#issuecomment-893693894):\r\n    - Backport MG and Pythia config #29554\r\n    - Backport Herwig config changes #32337, #33599\r\n    - Big backport from #34710 following the same four-step rule. It also includes the backport of #29305, #33516, #34463 with the same goal (these are never backported to 10_6_X)\r\n8. #34804\r\n9. #35072\r\n\r\nSmall modifications are made, if necessary, to adapt the 10_6_X code. Please see details in each commit message.\r\n\r\n\r\n#### PR validation:\r\n\r\nValidations are made on specific UL processes to see the GEN utility works (some recipes below). \r\nWe also validate the physics result on the vast UL samples under 10_6_X, which are reported to GEN group. Please see [slides here](https://indico.cern.ch/event/1058787/contributions/4449901/attachments/2283917/3881832/21.07.19_GEN_Update%20on%20multi-threading%20validation.pdf).\r\n\r\n1.\r\n  \r\nvalidated on [`JME-RunIISummer20UL17wmLHEGEN-00001`](https://cms-pdmv.cern.ch/mcm/requests?prepid=JME-RunIISummer20UL17wmLHEGEN-00001) (MG5+Herwig7)\r\n```shell\r\ncd $CMSSW_BASE/src\r\ncurl -s -k https://cms-pdmv.cern.ch/mcm/public/restapi/requests/get_fragment/JME-RunIISummer20UL17wmLHEGEN-00001 --retry 3 --create-dirs -o Configuration/GenProduction/python/JME-RunIISummer20UL17wmLHEGEN-00001-fragment.py\r\nscram b -j8\r\ncd ../..\r\ncmsDriver.py Configuration/GenProduction/python/JME-RunIISummer20UL17wmLHEGEN-00001-fragment.py --python_filename JME-RunIISummer20UL17wmLHEGEN-00001_1_cfg.py --eventcontent RAWSIM,LHE --customise Configuration/DataProcessing/Utils.addMonitoring --datatier GEN,LHE --fileout file:JME-RunIISummer20UL17wmLHEGEN-00001.root --conditions 106X_mc2017_realistic_v6 --beamspot Realistic25ns13TeVEarly2017Collision --step LHE,GEN --geometry DB:Extended --era Run2_2017 --mc -n 20 --nThreads 4 \\\r\n --customise_commands=\"process.externalLHEProducer.generateConcurrently = cms.untracked.bool(True); process.externalLHEProducer.postGenerationCommand = cms.untracked.vstring('mergeLHE.py', '-i', 'thread*/cmsgrid_final.lhe', '-o', 'cmsgrid_final.lhe')\"\r\n```\r\n\r\n2&3: \r\n\r\nvalidated on Pythia8+Tauola workflow\r\n```shell\r\ncmsDriver.py GGToHtautau_13TeV_pythia8_Tauola_taupinu_cff --conditions auto:run2_mc -s GEN --datatier GEN --beamspot Realistic8TeVCollision -n 20 --relval 250000,5000 --eventcontent RAWSIM --fileout file:step1.root --nThreads 4 \\\r\n --customise_commands=\"from GeneratorInterface.Core.ExternalGeneratorFilter import ExternalGeneratorFilter; process.generator = ExternalGeneratorFilter(process.generator, _external_process_components_=cms.vstring('HepPDTESSource'))\"\r\n```\r\n\r\n4:\r\n\r\nvalidated on [`B2G-RunIISummer19UL17wmLHEGEN-00001`](https://cms-pdmv.cern.ch/mcm/requests?prepid=B2G-RunIISummer19UL17wmLHEGEN-00001) (MG5+Pythia8)\r\n\r\n```shell\r\ncd $CMSSW_BASE/src\r\ncurl -s -k https://cms-pdmv.cern.ch/mcm/public/restapi/requests/get_fragment/B2G-RunIISummer19UL17wmLHEGEN-00001 --retry 3 --create-dirs -o Configuration/GenProduction/python/B2G-RunIISummer19UL17wmLHEGEN-00001-fragment.py\r\nscram b -j8\r\ncd ../..\r\ncmsDriver.py Configuration/GenProduction/python/B2G-RunIISummer19UL17wmLHEGEN-00001-fragment.py --python_filename B2G-RunIISummer19UL17wmLHEGEN-00001_1_cfg.py --eventcontent RAWSIM,LHE --customise Configuration/DataProcessing/Utils.addMonitoring --datatier GEN,LHE --fileout file:B2G-RunIISummer19UL17wmLHEGEN-00001.root --conditions 106X_mc2017_realistic_v6 --beamspot Realistic25ns13TeVEarly2017Collision --step LHE,GEN --geometry DB:Extended --era Run2_2017 --mc -n 20 --nThreads 4 \\\r\n --customise_commands=\"process.externalLHEProducer.scriptName = cms.FileInPath('GeneratorInterface/LHEInterface/data/run_generic_tarball_cvmfs_madgraphLO_multithread.sh')\"\r\n```\r\n\r\n5. See validation in the original PR.\r\n\r\n6.\r\n\r\nvalidated on Pythia8+Tauola and process till the NanoGEN step\r\n\r\n```shell\r\ncmsDriver.py GGToHtautau_13TeV_pythia8_Tauola_taupinu_cff --conditions auto:run2_mc -s GEN,NANOGEN --datatier NANOAODSIM --beamspot Realistic8TeVCollision -n 20 --relval 250000,5000 --eventcontent NANOAODSIM --fileout file:nanogen.root \\\r\n --customise_commands=\"from GeneratorInterface.Core.ExternalGeneratorFilter import ExternalGeneratorFilter; process.generator = ExternalGeneratorFilter(process.generator, _external_process_components_=cms.vstring('HepPDTESSource'))\"\r\necho \"Events->Show(10)\" | root -l nanogen.root\r\n```\r\nSee that the `GenJet_partonFlavour` branch is recovered.\r\n\r\n7. Validated on all modified/added RelVal workflows. See details in https://github.com/cms-sw/cmssw/pull/34527#issuecomment-893693894\r\n\r\n8/9. See validation in the original PR.", "branch": "CMSSW_10_6_X", "changed_files": 201, "closed_at": "1630417010", "comments": 52, "commits": 12, "created_at": "1626460319", "deletions": 297, "labels": ["analysis-approved", "generators-approved", "fully-signed", "tests-approved", "pdmv-approved", "orp-approved", "upgrade-approved", "backport-ok"], "merge_commit_sha": "7ecfafe85f56e66e96e3c763a9ece984f0b9829d", "merged_at": "1630417010", "merged_by": "cmsbuild", "milestone": "CMSSW_10_6_X", "number": 34527, "release-notes": [], "review_comments": 0, "state": "closed", "title": "[10_6_X] Backport concurrent GEN utilities", "updated_at": "1631597050", "user": "colizz"}