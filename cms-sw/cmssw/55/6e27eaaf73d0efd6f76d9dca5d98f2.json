{"additions": 6, "auther_ref": "conddb-cc8-unittest", "auther_sha": "2ff57292f5d5962502b55e200ec34e032a03827c", "author": "smuzaffar", "body": "This fixes the CondDB unit tests for CC8. Valgrind generated the following [a] output which point to the deletion of `edm::ServiceToken` causing these unit tests to fail.\r\n\r\n@makortel , @Dr15Jones , does this change makes any sense? No idea why removing the `static` allows these tests to run under CC8\r\n\r\n[a]\r\n```\r\n==21221== Invalid read of size 4\r\n==21221==    at 0x407060: __exchange_and_add (atomicity.h:49)\r\n==21221==    by 0x407060: __exchange_and_add_dispatch (atomicity.h:82)\r\n==21221==    by 0x407060: __exchange_and_add_dispatch (atomicity.h:78)\r\n==21221==    by 0x407060: _M_release (shared_ptr_base.h:152)\r\n==21221==    by 0x407060: ~__shared_count (shared_ptr_base.h:728)\r\n==21221==    by 0x407060: ~__shared_ptr (shared_ptr_base.h:1167)\r\n==21221==    by 0x407060: ~shared_ptr (shared_ptr.h:103)\r\n==21221==    by 0x407060: edm::ServiceToken::~ServiceToken() (ServiceToken.h:40)\r\n==21221==    by 0x7AE1E9B: __run_exit_handlers (in /usr/lib64/libc-2.28.so)\r\n==21221==    by 0x7AE1FCF: exit (in /usr/lib64/libc-2.28.so)\r\n==21221==    by 0x7ACB6A9: (below main) (in /usr/lib64/libc-2.28.so)\r\n==21221==  Address 0x8d23378 is 8 bytes inside a block of size 2,672 free'd\r\n==21221==    at 0x4035DD0: operator delete(void*) (in /cvmfs/cms-ib.cern.ch/nweek-02643/cc8_amd64_gcc8/external/valgrind/3.15.0-bcolbf2/lib/valgrind/vgpreload_memcheck-amd64-linux.so)\r\n==21221==    by 0x41C8EE7: _M_release (shared_ptr_base.h:171)\r\n==21221==    by 0x41C8EE7: _M_release (shared_ptr_base.h:148)\r\n==21221==    by 0x41C8EE7: operator= (shared_ptr_base.h:747)\r\n==21221==    by 0x41C8EE7: operator= (shared_ptr_base.h:1078)\r\n==21221==    by 0x41C8EE7: operator= (shared_ptr.h:103)\r\n==21221==    by 0x41C8EE7: edm::ServiceRegistry::unsetContext(edm::ServiceToken const&) (ServiceRegistry.cc:58)\r\n==21221==    by 0x406F88: edm::ServiceRegistry::Operate::~Operate() (ServiceRegistry.h:43)\r\n==21221==    by 0x7AE1E9B: __run_exit_handlers (in /usr/lib64/libc-2.28.so)\r\n==21221==    by 0x7AE1FCF: exit (in /usr/lib64/libc-2.28.so)\r\n==21221==    by 0x7ACB6A9: (below main) (in /usr/lib64/libc-2.28.so)\r\n==21221==  Block was alloc'd at\r\n==21221==    at 0x4034DB2: operator new(unsigned long) (in /cvmfs/cms-ib.cern.ch/nweek-02643/cc8_amd64_gcc8/external/valgrind/3.15.0-bcolbf2/lib/valgrind/vgpreload_memcheck-amd64-linux.so)\r\n==21221==    by 0x41C9017: allocate (new_allocator.h:111)\r\n==21221==    by 0x41C9017: allocate (alloc_traits.h:436)\r\n==21221==    by 0x41C9017: __allocate_guarded<std::allocator<std::_Sp_counted_ptr_inplace<edm::serviceregistry::ServicesManager, std::allocator<edm::serviceregistry::ServicesManager>, (__gnu_cxx::_Lock_policy)2> > > (allocated_ptr.h:97)\r\n==21221==    by 0x41C9017: __shared_count<edm::serviceregistry::ServicesManager, std::allocator<edm::serviceregistry::ServicesManager>, std::vector<edm::ParameterSet, std::allocator<edm::ParameterSet> >&> (shared_ptr_base.h:675)\r\n==21221==    by 0x41C9017: __shared_ptr<std::allocator<edm::serviceregistry::ServicesManager>, std::vector<edm::ParameterSet, std::allocator<edm::ParameterSet> >&> (shared_ptr_base.h:1342)\r\n==21221==    by 0x41C9017: shared_ptr<std::allocator<edm::serviceregistry::ServicesManager>, std::vector<edm::ParameterSet, std::allocator<edm::ParameterSet> >&> (shared_ptr.h:359)\r\n==21221==    by 0x41C9017: allocate_shared<edm::serviceregistry::ServicesManager, std::allocator<edm::serviceregistry::ServicesManager>, std::vector<edm::ParameterSet, std::allocator<edm::ParameterSet> >&> (shared_ptr.h:706)\r\n==21221==    by 0x41C9017: make_shared<edm::serviceregistry::ServicesManager, std::vector<edm::ParameterSet, std::allocator<edm::ParameterSet> >&> (shared_ptr.h:722)\r\n==21221==    by 0x41C9017: edm::ServiceRegistry::createSet(std::vector<edm::ParameterSet, std::allocator<edm::ParameterSet> >&) (ServiceRegistry.cc:77)\r\n==21221==    by 0x406AAC: main (testFrontier.cpp:27)\r\n\r\n```", "branch": "master", "changed_files": 3, "closed_at": "1598339155", "comments": 12, "commits": 1, "created_at": "1598269633", "deletions": 6, "labels": ["code-checks-approved", "comparison-available", "db-approved", "fully-signed", "orp-approved", "tests-approved"], "merge_commit_sha": "10fa06dd7509a00dcacd286735da2dc1ae0677c3", "merged_at": "1598339154", "merged_by": "cmsbuild", "milestone": "CMSSW_11_2_X", "number": 31215, "release-notes": [], "review_comments": 0, "state": "closed", "title": "Fix CondDB unit tests", "updated_at": "1598339155", "user": "smuzaffar"}