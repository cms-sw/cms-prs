{"additions": 99, "auther_ref": "JERFormula1020pre2", "auther_sha": "4a4479a0d62336735996647361f1d4fffb0479e5", "author": "kpedro88", "body": "Brief history lesson:\r\n* #11584: custom (stateless, thread-safe and -efficient) `FormulaEvaluator` used for JECs\r\n* #16283: static warning fixed in JER use of `TFormula`: required copying `TFormula` each time `JME::JetResolutionObject::evaluateFormula()` is called\r\n\r\nIt turns out copying `TFormula` objects is really slow. Using a stateless evaluator should be much faster.\r\n\r\nI modified the `JetResolutionObject` to use `FormulaEvaluator` (preserving `TFormula` for the \"standalone\" case). I had to add support for `sqrt` and `abs` functions in the parser.\r\n\r\nI tested this in my ntuple code and observed a 100x speedup in the `evaluateFormula()` function, with no changes in JER-related quantities in 5000 ttbar events.\r\n\r\nBefore:\r\n```\r\n            8.5  .........      45.81 / 399.31       edm::stream::EDProducerAdaptorBase::doEvent(edm::EventPrincipal const&, edm::EventSetup const&, edm::ActivityRegistry*, edm::ModuleCallingContext const*) [14]\r\n[30]        8.5      45.81       0.00 / 45.81      @{pluginPhysicsToolsPatUtils_plugins.so+813138}\r\n            8.4  .........      45.17 / 52.64        JME::JetResolutionObject::evaluateFormula(JME::JetResolutionObject::Record const&, JME::JetParameters const&) const [27]\r\n            0.1  .........       0.64 / 0.76         JME::JetResolution::getResolution(JME::JetParameters const&) const [1106]\r\n```\r\n\r\nAfter:\r\n```\r\n            0.2  .........       0.88 / 329.62       edm::stream::EDProducerAdaptorBase::doEvent(edm::EventPrincipal const&, edm::EventSetup const&, edm::ActivityRegistry*, edm::ModuleCallingContext const*) [14]\r\n[975]       0.2       0.88       0.00 / 0.88       @{pluginPhysicsToolsPatUtils_plugins.so+813138}\r\n            0.1  .........       0.50 / 0.55         JME::JetResolution::getResolution(JME::JetParameters const&) const [1230]\r\n            0.1  .........       0.37 / 0.40         JME::JetResolutionObject::evaluateFormula(JME::JetResolutionObject::Record const&, JME::JetParameters const&) const [1483]\r\n```\r\n\r\nThis PR will be backported to 94X for analysis use.", "branch": "master", "changed_files": 4, "closed_at": "1525374169", "comments": 21, "commits": 3, "created_at": "1525204337", "deletions": 9, "labels": ["analysis-pending", "code-checks-approved", "comparison-available", "db-approved", "orp-approved", "pending-signatures", "reconstruction-approved", "tests-approved"], "merge_commit_sha": "f4ffc8bffbbfe88fffe91cf5dd8849ea5c6af621", "merged_at": "1525374169", "merged_by": "cmsbuild", "milestone": "CMSSW_10_2_X", "number": 23106, "release-notes": [], "review_comments": 0, "state": "closed", "title": "Use FormulaEvaluator for JER", "updated_at": "1525374169", "user": "kpedro88"}