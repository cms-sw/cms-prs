{"additions": 152, "auther_ref": "memoryCleanupG4", "auther_sha": "0c78f963461be4d8be481f76423c097f42e35702", "author": "Dr15Jones", "body": "#### PR description:\r\n\r\nDecrease the memory held by OscarMTProducer during event processing. This is accomplished by\r\n- clearing temporary memory used for processing an event at the end of that event instead of at the beginning of the next event\r\n- clear the G4 allocator used to store all CaloG4Hits each event rather than letting it grow for the entire job (this was found by IgProf)\r\n- cleanup memory at the end of the job thereby making it easier to use tools to find per event memory leaks.\r\n\r\n#### PR validation:\r\n\r\nThis was triggered from the production problem here: https://hypernews.cern.ch/HyperNews/CMS/get/simDevelopment/1891.html\r\n\r\nI used the configuration from the hypernews and ran IgProfService to isolate memory leaks and per-event memory hoarding. Once all the changes were done, I ran it under CMSSW_10_6_ASAN_X_2019-04-26-2300 to double check there were no memory errors (it was clean).\r\n\r\nUsing the original code running with 8 threads on only 20 events, the memory kept growing and reached RSS=3.6GB After the code change, running on 8 threads over 135 events the job was still around RSS=2GB after 20 and stayed near 2.2GB until the very end of the job  when it grew temporarily to RSS=3.4.", "branch": "master", "changed_files": 11, "closed_at": "1556865954", "comments": 19, "commits": 11, "created_at": "1556642530", "deletions": 86, "labels": ["code-checks-approved", "comparison-available", "fully-signed", "orp-approved", "simulation-approved", "tests-approved"], "merge_commit_sha": "b950223ce2507f264f063bef1771ba066b68527d", "merged_at": "1556865954", "merged_by": "cmsbuild", "milestone": "CMSSW_10_6_X", "number": 26578, "release-notes": [], "review_comments": 0, "state": "closed", "title": "Decrease memory used by OscarMTProducer", "updated_at": "1556865954", "user": "Dr15Jones"}