{"additions": 210, "auther_ref": "parallel_hadd_75x_ok", "auther_sha": "4631a36f3f857a2950eede9cd741e4bca4b0aa55", "author": "dmitrijus", "body": "(forward port of https://github.com/cms-sw/cmssw/pull/10280)\n## Removed a few small optimizations:\n- first file is no longer added to the set, but merged on top  of an empty set, just like any other file;\n- removed dirnames, objnames, fullnames string caches;\n- removed fullname from MicroME, since it can be generated using other fields;\n- replaced 'custom' merge algorithm with std::set::insert (with hints).\n\nAs a result, the code is way more simplier and does not increase the\ntime it takes to merge.\n## Implement multi-process merging in fastHadd.\n\nA group of processes are organized in a virtual tree.\n\nEach process has a unique node_id (1 - number_of_proc) and\nwill start (fork) 2*node_id + {0,1} processes (if new node_id <=\nnumber_of_proc).\n\nEach process will merge all files identified by (file_index % (node_id - 1) == 0),\nplus all histograms from his child processes.\nIPC is done via pipe()s.\n\nThis gives us somewhat good latency. With 7 processes this will\ndecrease the merging down 11s (see below).\n\nI have tried using threads to merge faster, but this was futile.\nRoot just has too many global internal states.\nAnd I couldn't serialize root access, since it takes the majority of time.\n\nI've tried fastParallelHadd.py (changing various parameters),\nbut the lowest time I could get was ~26seconds.\n\nAll numbers were done using fastHadd to merge 100 files, summary:\n\n```\n- 50.321s, 227mb  -> old fastHadd with no changes\n- 50.198s, 225mb  -> new fastHadd\n- 18.719s, 550mb  -> new fastHadd, using 3 processes\n- 11.143s, 1202mb -> new fastHadd, using 7 processes\n```\n\nMemory is sum of proportional set size (PSS).\n\nI will make ports to 75 and 76 after and if this is accepted.\n", "branch": "CMSSW_7_5_X", "changed_files": 2, "closed_at": "1438260865", "comments": 3, "commits": 2, "created_at": "1438237110", "deletions": 321, "labels": ["comparison-pending", "dqm-approved", "fully-signed", "orp-pending", "tests-pending"], "merge_commit_sha": "bab7a528bcb8e96e18f8895b948d4aa00042b4ea", "merged_at": "1438260864", "merged_by": "davidlange6", "milestone": "CMSSW_7_5_X", "number": 10469, "release-notes": [], "review_comments": 0, "state": "closed", "title": "  Implement multi-processing in fastHadd to merge DQM histograms faster", "updated_at": "1438260865", "user": "dmitrijus"}