{"additions": 178, "auther_ref": "bugfix/ticl_barrel_dst_sequence", "auther_sha": "83103164b9d7ba58458ef5d3e07c8130a1d2643a", "author": "bfonta", "body": "#### PR description:\r\n\r\nMultiple fixes are required to run the TICL-barrel validation at HLT.\r\n\r\n##### First issue\r\n\r\nRunning:\r\n\r\n```bash\r\ncmsDriver.py step2 --step L1P2GT,HLT:NGTScouting,VALIDATION:@hltValidation \\\r\n\t\t\t\t --conditions auto:phase2_realistic_T33 \\\r\n\t\t\t\t --datatier GEN-SIM-DIGI-RAW,DQMIO \\\r\n\t\t\t\t -n 4 \\\r\n\t\t\t\t --eventcontent FEVTDEBUGHLT,DQMIO \\\r\n\t\t\t\t --geometry ExtendedRun4D110 \\\r\n\t\t\t\t --era Phase2C17I13M9 \\\r\n\t\t\t\t --procModifier ticl_barrel \\\r\n\t\t\t\t --filein file:/eos/cms/store/relval/CMSSW_15_1_0_pre4/RelValTTbar_14TeV/GEN-SIM-DIGI-RAW/PU_150X_mcRun4_realistic_v1_STD_Run4D110_PU-v1/2580000/e01960c2-2b0f-4911-b35f-f71629844dee.root \\\r\n\t\t\t\t --fileout file:step2.root \\\r\n\t\t\t\t --nThreads 1 \\\r\n\t\t\t\t --process HLTX \\\r\n\t\t\t\t --inputCommands='keep *, drop *_hlt*_*_HLT, drop triggerTriggerFilterObjectWithRefs_l1t*_*_HLT'\r\n```\r\n\r\nleads to:\r\n\r\n```\r\n----- Begin Fatal Exception 17-Jul-2025 11:24:05 CEST-----------------------\r\nAn exception of category 'ScheduleExecutionFailure' occurred while\r\n   [0] Calling beginJob\r\nException Message:\r\nUnrunnable schedule\r\nThe Path/EndPath configuration could cause the job to deadlock\r\n  module 'hltParticleFlowRecHitECALUnseeded' is on path 'DST_PFScouting' and depends on module 'hltEcalRecHit'\r\n  module 'hltEcalRecHit' is on path 'DST_PFScouting' and follows module 'hltParticleFlowRecHitECALUnseeded' on the path\r\n----- End Fatal Exception -------------------------------------------------\r\n```\r\n\r\nThe command used to test #47859 was \r\n\r\n```bash\r\nHLTrigger/Configuration/scripts/hltPhase2UpgradeIntegrationTests --globaltag auto:phase2_realistic_T33 --geometry ExtendedRun4D110 --events 10 --threads 4 --procModifiers ticl_barrel\r\n```\r\n\r\nwhich does not test the ```DST_PFScouting``` path, used [here](https://github.com/cms-sw/cmssw/blob/e152e7e2b26dd10cb2a20a5f1bc26ac6f8e4f0e6/HLTrigger/Configuration/python/HLT_NGTScouting_cff.py#L292). Would it make sense to add ```HLT:NGTScouting``` [here](https://github.com/cms-sw/cmssw/blob/e152e7e2b26dd10cb2a20a5f1bc26ac6f8e4f0e6/HLTrigger/Configuration/scripts/hltPhase2UpgradeIntegrationTests#L146) to avoid these issues in the future?\r\n\r\nKudos to @brusale for the fix.\r\n\r\n##### Second issue\r\n\r\nHaving fixed the ordering of the sequences in ```DST_PFScouting```, the following error is observed when running the above step2 command with  ``` --procModifier alpaka,ticl_barrel```:\r\n\r\n```\r\n----- Begin Fatal Exception 17-Jul-2025 18:16:59 CEST-----------------------\r\nAn exception of category 'ProductNotFound' occurred while\r\n   [0] Processing  Event run: 1 lumi: 61 event: 6001 stream: 0\r\n   [1] Running path 'DST_PFScouting'\r\n   [2] Calling method for module MergeClusterProducer/'hltMergeLayerClusters'\r\nException Message:\r\nPrincipal::getByToken: Found zero products matching all criteria\r\nLooking for type: std::vector<reco::CaloCluster>\r\nLooking for module label: hltHgcalLayerClustersEE\r\nLooking for productInstanceName: \r\n\r\n   Additional Info:\r\n      [a] If you wish to continue processing events after a ProductNotFound exception,\r\nadd \"TryToContinue = cms.untracked.vstring('ProductNotFound')\" to the \"options\" PSet in the configuration.\r\n\r\n----- End Fatal Exception -------------------------------------------------\r\n```\r\n\r\nThis is due to a bug in the CE-E layer cluster input collection used when the ```alpaka``` and ```ticl_barrel``` modifiers are both active. The fix consists on defining what happens when both modifiers are active, via the ```(ticl_barrel & alpaka).toModify(...)``` call.\r\nIn parallel, I added the negation ```~``` operator in some ```.toModify()``` calls. This improves clarity and makes the code more efficient, since [this call](https://github.com/cms-sw/cmssw/blob/e152e7e2b26dd10cb2a20a5f1bc26ac6f8e4f0e6/FWCore/ParameterSet/python/Config.py#L1712) is not run.\r\n\r\n##### Other issues\r\n\r\nOther minor bugs were fixed, such as slight code inefficiencies, mismatched input tags, and missing ```fillDescriptions()```.\r\n\r\n#### PR validation:\r\n\r\nTested with the following command on top of ```CMSSW_15_1_0_pre5```:\r\n\r\n```bash\r\nNEVENTS=24\r\nGEOM=\"ExtendedRun4D110\"\r\nERA=\"Phase2C17I13M9\"\r\nCONDS=\"auto:phase2_realistic_T33\"\r\nPROCMODS=\"alpaka,ticl_barrel,ticl_v5\"\r\nVALIDSEQ=\"@hltValidation\"\r\nHLTSEQ=\"NGTScouting\"\r\n\r\nfunction mystep2() {\r\n    cmsDriver.py step2 -s L1P2GT,HLT:\"${HLTSEQ}\",DQM:trackingMonitorHLT,VALIDATION:\"${VALIDSEQ}\" \\\r\n         --conditions \"${CONDS}\" \\\r\n         --datatier GEN-SIM-DIGI-RAW,DQMIO \\\r\n         -n ${NEVENTS} \\\r\n         --eventcontent FEVTDEBUGHLT,DQMIO \\\r\n         --geometry \"${GEOM}\" \\\r\n         --era \"${ERA}\" \\\r\n         --procModifier \"${PROCMODS}\" \\\r\n         --customise SLHCUpgradeSimulations/Configuration/aging.customise_aging_1000 \\\r\n         --filein file:/eos/cms/store/relval/CMSSW_15_1_0_pre5/RelValTTbar_14TeV/GEN-SIM-DIGI-RAW/PU_150X_mcRun4_realistic_v1_STD_Run4D110_PU-v1/2580000/fc4d8a79-582f-4a08-8fbd-190e161cfdaf.root \\\r\n         --fileout file:step2.root \\\r\n         --nThreads 24 \\\r\n         --process HLTX \\\r\n         --inputCommands='keep *, drop *_hlt*_*_HLT, drop triggerTriggerFilterObjectWithRefs_l1t*_*_HLT' \r\n}\r\n\r\nfunction mystep3() {\r\n    cmsDriver.py step3 -s HARVESTING:\"${VALIDSEQ}\" \\\r\n         --conditions \"${CONDS}\" \\\r\n         --mc \\\r\n         --geometry \"${GEOM}\" \\\r\n         --scenario pp \\\r\n         --filetype DQM \\\r\n         --era \"${ERA}\" \\\r\n         --procModifier \"${PROCMODS}\" \\\r\n         -n ${NEVENTS}  \\\r\n         --filein file:step2_inDQM.root \\\r\n         --fileout file:step3.root\r\n}\r\n\r\nmystep2 && mystep3\r\n```\r\n\r\n", "branch": "master", "changed_files": 24, "comments": 61, "commits": 15, "created_at": "1752747765", "deletions": 175, "labels": ["reconstruction-pending", "simulation-pending", "dqm-pending", "core-approved", "pending-signatures", "tests-pending", "orp-pending", "upgrade-pending", "code-checks-pending", "ngt"], "milestone": "CMSSW_16_0_X", "number": 48565, "release-notes": [], "review_comments": 2, "state": "open", "title": "Bugfixes to TICL-barrel", "updated_at": "1759233175", "user": "bfonta"}