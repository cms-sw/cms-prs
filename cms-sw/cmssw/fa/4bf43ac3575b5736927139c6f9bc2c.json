{"additions": 294, "auther_ref": "fixingStripGainPCLWorker_forAlCaReco", "auther_sha": "799da4227ab67ccecde2a981deddf98f9c25d98d", "author": "mmusich", "body": "When trying to reproduce some `ALCAPROMPT` files of the flavour `PromptCalibProdSiStripGains`, starting from the EOY 2016 ReReco `ALCARECO` data, a segmentation fault was encountered, basically due to the overwriting of the elements of a vector of `MonitorElements`.  \r\nThis occurred whenever two calls of `dqmBeginRun` happened at the same event (not sure why this should happen at all, framework-wise). \r\nI think this has not been seen at Tier-0 due to lack of run transitions in the express `ALCAPROMPT` production (?).\r\nAnyway a reproducer can be found [here](https://gist.github.com/mmusich/f70abd1a51f030bd8bddcf76801739a1), while the original stack of the segfault [here](https://gist.github.com/mmusich/292c77b1efe4df715592e807d3acbc53).\r\nThis is fixed by clearing the vectors of `MonitorElements` each time the `dqmBeginRun` method is entered.  \r\nI profited of this PR to reorganize slightly the code avoiding to copy MonitorElement pointers in several places and added a unit-test, as this is a production mode we would like to support. \r\n\r\nTo be sure the (already large) memory footprint for this workflow is not increased I plot the RSS vs processing time for step2 of worfklow 1001.0 in the:\r\n\r\n   * single-threaded case:\r\n \r\n![image](https://user-images.githubusercontent.com/5082376/36263158-ce3d0a98-1269-11e8-81ac-eced2afbec76.png)\r\n\r\n   * multi-threaded case (via `process.options.numberOfStreams = cms.untracked.uint32(8)` )\r\n\r\n![image](https://user-images.githubusercontent.com/5082376/36263177-deebffe8-1269-11e8-8e32-d1855e8c2de1.png)\r\n", "branch": "master", "changed_files": 9, "closed_at": "1519053608", "comments": 22, "commits": 5, "created_at": "1518706176", "deletions": 107, "labels": ["alca-approved", "bug-fix", "code-checks-approved", "comparison-available", "fully-signed", "orp-approved", "tests-approved"], "merge_commit_sha": "e2a7b57a9908ff1e297f3a616b8e19c8682e1c06", "merged_at": "1519053608", "merged_by": "cmsbuild", "milestone": "CMSSW_10_1_X", "number": 22238, "release-notes": [], "review_comments": 9, "state": "closed", "title": "Fixing SiStripGainsPCLWorker when running on AlCaReco input dataset", "updated_at": "1519053608", "user": "mmusich"}