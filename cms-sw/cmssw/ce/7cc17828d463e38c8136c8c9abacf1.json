{"additions": 10, "auther_ref": "mm_dev_fix_for_45639", "auther_sha": "24d4fd21c58c95ee35d1e840e5ce8aeacc37b4a8", "author": "mmusich", "body": "#### PR description:\r\n\r\nThis PR is meant as a fix for the situation that occurred in online HLT operations and lead to https://github.com/cms-sw/cmssw/issues/45639. \r\nAs explained in detailed https://github.com/cms-sw/cmssw/issues/45639#issuecomment-2270661982, in this event, some states have positive pz-sign, and some states have negative pz-sign, which is a problem.\r\nThe chain of calls is the following: `GsfMultiStateUpdator` calls `MultiTrajectoryStateAssembler::combinedState()` , which in turn calls `MultiTrajectoryStateAssembler::prepareCombinedState()`. At this stage, the algo tries to fix the problem by calling `removeWrongPz()`. In most cases `removeWrongPz` will solve the issue.\r\nIn one special case , where `meanPz=0`, it will not be able to solve the issue and it will let the charged-flipped states pass which will create the crash later on, where there is another check of pz-sign.\r\nThis PR circumvents the issue by explicitly logging an error when this happens, clear the states vector and then do an early return.\r\n\r\n#### PR validation:\r\n\r\nTested in `CMSSW_14_0_13_MULTIARCH` + this commit https://github.com/mmusich/cmssw/commit/24d4fd21c58c95ee35d1e840e5ce8aeacc37b4a8 with the reproducer at https://github.com/cms-sw/cmssw/issues/45639#issue-2448433243:\r\n\r\n```bash\r\n#!/bin/bash -ex\r\n\r\n# CMSSW_14_0_13_MULTIARCHS\r\n\r\nhltGetConfiguration run:384069 \\\r\n--globaltag 140X_dataRun3_HLT_v3 \\\r\n--data \\\r\n--no-prescale \\\r\n--no-output \\\r\n--max-events -1 \\\r\n--input '/store/group/tsg/FOG/error_stream_root/run384069/run384069_ls0689_index000033_fu-c2b04-35-01_pid2378323.root,/store/group/tsg/FOG/error_stream_root/run384069/run384069_ls0689_index000067_fu-c2b0\r\n4-35-01_pid2378323.root' > hlt.py\r\n\r\ncat <<@EOF >> hlt.py\r\ndel process.MessageLogger\r\nprocess.load('FWCore.MessageService.MessageLogger_cfi')  \r\nprocess.options.wantSummary = True\r\nprocess.options.numberOfThreads = 1\r\nprocess.options.numberOfStreams = 0\r\n@EOF\r\n\r\ncmsRun hlt.py &> hlt.log\r\n```\r\n\r\nand observed no crash. \r\n\r\n## **N.B.** \r\nIt's worth noting that the crash doesn't appear to start with in `CMSSW_14_0_13` (tout-cout) , so it looks like the `MULTIARCHS` variant (hence `x86-64-v3` micro-architecture) is triggering the problem in the first place, see https://github.com/cms-sw/cmssw/issues/45639#issuecomment-2270869959. \r\n\r\n#### If this PR is a backport please specify the original PR and why you need to backport that PR. If this PR will be backported please specify to which release cycle the backport is meant for:\r\n\r\nNot a backport, but will be backported to CMSSW_14_0_X for 2024 online HLT operations.\r\n", "branch": "master", "changed_files": 1, "comments": 7, "commits": 1, "created_at": "1722932296", "deletions": 1, "labels": ["reconstruction-approved", "fully-signed", "tests-approved", "orp-pending", "code-checks-approved", "tracking"], "milestone": "CMSSW_14_1_X", "number": 45646, "release-notes": [], "review_comments": 0, "state": "open", "title": "`MultiTrajectoryStateAssembler`: protect `removeWrongPz` when average pZ sign is identically 0", "updated_at": "1722949797", "user": "mmusich"}