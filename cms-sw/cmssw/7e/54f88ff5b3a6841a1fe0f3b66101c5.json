{"additions": 391, "auther_ref": "Navigation", "auther_sha": "9078747c2f85f325939b0e6dd29551944ef32828", "author": "VinInn", "body": "On Friday Chris reported that\nTrackings use of DetLayer is inherently thread unsafe. The NavigationSchool is in the EventSetup but it gives non-const access to its internal DetLayers:\nhttps://cmssdt.cern.ch/SDT/lxr/source/TrackingTools/DetLayers/interface/NavigationSchool.h?v=CMSSW_7_1_X_2014-04-25-0200#028\nand those DetLayers are constantly being modified by other code:\n       https://cmssdt.cern.ch/SDT/lxr/source/TrackingTools/DetLayers/src/NavigationSetter.cc?v=CMSSW_7_1_X_2014-04-25-0200#059\nIn addition, the DetLayers have internally a NavigableLayer\\* which they give non-const access to and call non-const methods on in its own const functions:\n       https://cmssdt.cern.ch/SDT/lxr/source/TrackingTools/DetLayers/interface/DetLayer.h?v=CMSSW_7_1_X_2014-04-25-0200#050\nand to top it off, some types inheriting from NavigableLayer use mutables\n       https://cmssdt.cern.ch/SDT/lxr/source/RecoTracker/TkNavigation/interface/SimpleNavigableLayer.h?v=CMSSW_7_1_X_2014-04-25-0200#042\nThe only way to deal with this now is to mark all modules which interact with DetLayers as thread-unsafe.\n\nAfter a week-end long of code analysis I come to the conclusion that the best solution will be:\nto create a vector of NavigableLayer const \\*  in the NavigationSchool (or equivalent)\nusing DetLayer::seqNum as index.\nOne should them to manage to get the NavigationSchool  everywhere \nnextLayers and compatibleLayers are invoked a trivial indirection will do the trick\n\nThis is \na) easy to find all calls to nextLayers and compatibleLayers.\nLabour intensive to percolate the navigation school. NOT error-prone\nb) quite logical,  it will reassign the responsibility of navigation to the Navigation!\nc) No changes to configation (unless percolation fails)\n\nPlan there're is\n1) The infrastructure for both tracker and muon is trivial to build.\nI wil do it togehter with a couple of use case.\n\n2) at that point the Labour intensive part can be split in many pieces: it it just to find the way to percolate navigation scool and modify the calling sequence to \nnextLayers and compatibleLayers by few characters (litterally!)\n\n3) remove all mutable including the Navigation Setter.\nadd const here and there (maybe a couple of cost_cast in the NavigationSchool itself)\n\nDONE\n\n---\n\nstatus : this PR\n\n1)\ndone for Base class, Simple, Cosmic and Muon\nall three tested with properly modified already existing unit tests\n\n2)\ndone in CkfTrajectoryBuilder and Maker (+ partial in Conversion f/w/c TrBuilder)\none NavigationSetter gone!\n\nat this point we ca go in Parallel.\nThis PR is therefore requested to be integrated to allow other developers to modify various bits of code\nthat require NavigationSchool to be percolated\n\nNo regression expected\nNo regression observed\n", "branch": "CMSSW_7_1_X", "changed_files": 23, "closed_at": "1398844825", "comments": 18, "commits": 13, "created_at": "1398689858", "deletions": 158, "labels": ["comparison-pending", "pending-signatures", "reconstruction-pending", "tests-approved"], "milestone": "CMSSW_7_1_0_pre8", "number": 3547, "release-notes": [], "review_comments": 2, "state": "closed", "title": "Navigation", "updated_at": "1492768316", "user": "VinInn"}