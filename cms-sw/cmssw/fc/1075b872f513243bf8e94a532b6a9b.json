{"additions": 27, "auther_ref": "CUDA_fix_concurrent_EventSetup_filling", "auther_sha": "097fe4ab00feb29e17d53db33993ad2533c65d8f", "author": "fwyzard", "body": "#### PR description:\r\n\r\nWhen multiple CUDA devices are available, each CUDA EventSetup object uses a different CUDA event to keep track if the conditions have been uploaded to each device. However, all events were associated to the default device, instead of the correct one, leading to a runtime error when multiple devices were used.\r\n\r\nThese changes associate to the correct CUDA device the events used to track if the conditions have been transferred.\r\n\r\n#### PR validation:\r\n\r\nWithout this PR, running any GPU-enabled job on a system with multiple GPUs would fail with the error\r\n```\r\n----- Begin Fatal Exception 19-Aug-2021 10:35:57 CEST-----------------------\r\nAn exception of category 'StdException' occurred while\r\n   [0] Processing  Event run: 1 lumi: 1 event: 6 stream: 1\r\n   [1] Running path 'dqmoffline_step'\r\n   [2] Prefetching for module PrimaryVertexMonitor/'pixelPVMonitor'\r\n   [3] Prefetching for module PixelVertexProducerFromSoA/'pixelVertices'\r\n   [4] Prefetching for module PixelVertexSoAFromCUDA/'pixelVerticesSoA@cuda'\r\n   [5] Prefetching for module PixelVertexProducerCUDA/'pixelVerticesCUDA'\r\n   [6] Prefetching for module CAHitNtupletCUDA/'pixelTracksCUDA'\r\n   [7] Prefetching for module SiPixelRecHitCUDA/'siPixelRecHitsPreSplittingCUDA'\r\n   [8] Calling method for module SiPixelRawToClusterCUDA/'siPixelClustersPreSplittingCUDA'\r\nException Message:\r\nA std::exception was thrown.\r\n\r\n/build/cmsbld/jenkins/workspace/build-any-ib/w/tmp/BUILDROOT/28bc67141038e9b7c17a74564c8e6173/opt/cmssw/slc7_amd64_gcc900/cms/cmssw/CMSSW_12_1_X_2021-08-15-0000/src/HeterogeneousCore/CUDACore/interface/ESProduct.h, line 80:\r\ncudaCheck(cudaEventRecord(data.m_event.get(), cudaStream));\r\ncudaErrorInvalidResourceHandle: invalid resource handle\r\n----- End Fatal Exception -------------------------------------------------\r\n```\r\n\r\nWith this PR, these jobs complete correctly.\r\nFor example, step 3 from `runTheMatrix.py -l 10824.502 -e -t4 --what gpu`:\r\n```\r\n$ cudaComputeCapabilities \r\n   0     6.1    GeForce GTX 1080 Ti\r\n   1     6.1    GeForce GTX 1080 Ti\r\n   2     6.1    GeForce GTX 1080 Ti\r\n   3     6.1    GeForce GTX 1080 Ti\r\n   4     6.1    GeForce GTX 1080 Ti\r\n   5     6.1    GeForce GTX 1080 Ti\r\n   6     6.1    GeForce GTX 1080 Ti\r\n   7     6.1    GeForce GTX 1080 Ti\r\n\r\n$ cmsRun step3_RAW2DIGI_RECO_VALIDATION_\r\nDQM.py\r\n%MSG-i ThreadStreamSetup:  (NoModuleName) 19-Aug-2021 10:59:19 CEST pre-events\r\nsetting # threads 4\r\nsetting # streams 4\r\n%MSG\r\n19-Aug-2021 10:59:32 CEST  Initiating request to open file file:step2.root\r\n19-Aug-2021 10:59:33 CEST  Successfully opened file file:step2.root\r\nBegin processing the 1st record. Run 1, Event 6, LumiSection 1 on stream 0 at 19-Aug-2021 10:59:40.893 CEST\r\nBegin processing the 2nd record. Run 1, Event 2, LumiSection 1 on stream 1 at 19-Aug-2021 10:59:40.918 CEST\r\nBegin processing the 3rd record. Run 1, Event 3, LumiSection 1 on stream 3 at 19-Aug-2021 10:59:40.918 CEST\r\nBegin processing the 4th record. Run 1, Event 4, LumiSection 1 on stream 2 at 19-Aug-2021 10:59:40.937 CEST\r\nBegin processing the 5th record. Run 1, Event 1, LumiSection 1 on stream 2 at 19-Aug-2021 10:59:46.703 CEST\r\nBegin processing the 6th record. Run 1, Event 5, LumiSection 1 on stream 1 at 19-Aug-2021 10:59:46.813 CEST\r\nBegin processing the 7th record. Run 1, Event 8, LumiSection 1 on stream 0 at 19-Aug-2021 10:59:46.851 CEST\r\nBegin processing the 8th record. Run 1, Event 9, LumiSection 1 on stream 3 at 19-Aug-2021 10:59:46.947 CEST\r\nBegin processing the 9th record. Run 1, Event 7, LumiSection 1 on stream 2 at 19-Aug-2021 10:59:47.269 CEST\r\nBegin processing the 10th record. Run 1, Event 10, LumiSection 1 on stream 3 at 19-Aug-2021 10:59:47.469 CEST\r\n19-Aug-2021 10:59:48 CEST  Closed file file:step2.root\r\n```\r\n\r\n#### If this PR is a backport please specify the original PR and why you need to backport that PR:\r\n\r\nThese changes should be backported to CMSSW_12_0_X.\r\nThese changes should be backported to CMSSW_11_3_X if there are plans to use that release cycle for more online tests.\r\n", "branch": "master", "changed_files": 2, "closed_at": "1629401051", "comments": 17, "commits": 2, "created_at": "1629358223", "deletions": 10, "labels": ["fully-signed", "tests-approved", "bug-fix", "orp-approved", "code-checks-approved", "heterogeneous-approved"], "merge_commit_sha": "d653ec0282fde39fe1e101ccec267e2a50bc31a0", "merged_at": "1629401051", "merged_by": "cmsbuild", "milestone": "CMSSW_12_1_X", "number": 34948, "release-notes": [], "review_comments": 0, "state": "closed", "title": "Fix uploading the EventSetup conditions to multiple CUDA devices", "updated_at": "1629401052", "user": "fwyzard"}