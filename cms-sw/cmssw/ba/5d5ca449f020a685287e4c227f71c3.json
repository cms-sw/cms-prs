{"additions": 1223, "auther_ref": "FastSimConstGlobalRebase2", "auther_sha": "6cee54bae6985f62f76570b543501d38de48285e", "author": "kpedro88", "body": "#### PR description:\r\n\r\n`FastSimProducer`, the module that runs the SIM step for FastSim, was originally written as a stream producer. This means that its member variables are duplicated for each stream, including lots of derived geometry information. Many of the member variable classes have many non-const functions that mutate variables during the processing.\r\n\r\nThis PR refactors `FastSimProducer` to be a global producer by:\r\n1. Moving all geometry-dependent information into a `RunCache` (geometry can only change at run boundaries)\r\n2. Moving all mutable state into a `StreamCache`, containing as few variables as possible so most memory is no longer duplicated across streams\r\n3. Making all member class functions `const` (mutable state is passed from the cache as function arguments)\r\n\r\nIn the process of making these changes, a number of code improvements were implemented:\r\n1. class member variables use underscores (very helpful for migrating to `const` and identifying mutable state)\r\n2. use smart pointers (avoid `new`)\r\n3. magic numbers -> named constants\r\n4. remove unused members, methods, commented-out code\r\n5. eliminate some unnecessary steps (e.g. copying hits twice)\r\n6. try to avoid delayed initialization patterns (RAII)\r\n7. bug fix in `NuclearInteractionOutput.txt` file (now also disabled by default, since it was wrong for many years anyway)\r\n8. reduce printouts\r\n9. introduce useful typedef\r\n10. avoid unnecessary copies (pass by const ref)\r\n\r\nThis is the PR that led to the discovery of the issues now fixed in #49562. That PR was submitted first to ensure that this PR includes only technical improvements and does not change outputs at all.\r\n\r\n#### PR validation:\r\n\r\n1. Ran application on 36 streams/threads to ensure no crashes from data races.\r\n2. Ran helgrind just to be really sure there are no data races.\r\n3. Compared output before and after PR and saw no differences (technical changes only, implemented carefully to ensure random number sequences are preserved)\r\n4. Examined computing performance using TimeMemorySummary:\r\n    Memory: reduced by ~50 MB/stream (for Run 3)\r\n    <img width=\"426\" height=\"289\" alt=\"fastsim_global_mem\" src=\"https://github.com/user-attachments/assets/255a52ed-3701-4c08-86d9-9fb37d7842ea\" />\r\n    CPU: also improved (but not as reliable a measurement, to be double checked at larger scale later)\r\n    <img width=\"426\" height=\"289\" alt=\"fastsim_global_cpu\" src=\"https://github.com/user-attachments/assets/431116c5-2dcc-446c-b8e9-be8e3382c4d4\" />\r\n    These comparisons only consider the SIM step.\r\n\r\nThe memory improvements are expected to be more important for the eventual HGCal FastSim implementation, because of its much more complex geometry.\r\n\r\n#### If this PR is a backport please specify the original PR and why you need to backport that PR. If this PR will be backported please specify to which release cycle the backport is meant for:\r\n\r\nNot a backport, not intended to be backported.", "branch": "master", "changed_files": 55, "comments": 9, "commits": 30, "created_at": "1765295545", "deletions": 1369, "labels": ["fastsim-approved", "simulation-approved", "fully-signed", "tests-approved", "orp-pending", "code-checks-approved"], "milestone": "CMSSW_16_0_X", "number": 49583, "release-notes": [], "review_comments": 0, "state": "open", "title": "FastSim global producer", "updated_at": "1765320942", "user": "kpedro88"}