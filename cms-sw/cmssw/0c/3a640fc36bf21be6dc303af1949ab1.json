{"additions": 14, "auther_ref": "mm_fix_TrackingRecHitsSoACollection_14_2_X", "auther_sha": "e7893f2f8b8454740bf3434c089d4de995f7be9e", "author": "mmusich", "body": "#### PR description:\r\n\r\nThis PR is meant as a fix for https://github.com/cms-sw/cmssw/issues/45834, and builds on top of the earlier fix https://github.com/cms-sw/cmssw/pull/45743 for issue https://github.com/cms-sw/cmssw/issues/45708.\r\nIn a nutshell, `CopyHost::copyAsync()` returns before the `alpaka::memcpy` call in `TrackingRecHitsSoACollection` if the `size()` of the input `deviceData` is null (i.e. there are no input hits).\r\nAdditionally protect `CAHitNtupletGenerator` by returning before launching kernels when there are less than 2 hits.\r\n\r\n#### PR validation:\r\n\r\nMultiple tests have been performed with this branch:\r\n\r\nI tested successfully (on `lxplus8-gpu`):\r\n   * the script at https://github.com/cms-sw/cmssw/issues/45834#issue-2494223656 (standard FOG-like tests for pp)\r\n   * the script at https://github.com/cms-sw/cmssw/issues/45708#issue-2468792471 (hybrid GPU+CPU menu, `HIon`-like)\r\n   * `runTheMatrix.py --what upgrade -l 12861.402`  \r\n   \r\nAdditionally, following the example at https://github.com/cms-sw/cmssw/issues/45834#issuecomment-2317801292 I  I feed the \"alpaka-migrated\" menu from [CMSHLT-3284](https://its.cern.ch/jira/browse/CMSHLT-3284) into the relval machinery via:\r\n\r\n```bash\r\ncmsrel CMSSW_14_0_15\r\ncd CMSSW_14_0_15/src\r\ncmsenv\r\ngit cms-addpkg HLTrigger/Configuration\r\ngit cms-addpkg Configuration/PyReleaseValidation\r\nhltGetConfiguration /users/soohwan/HLT_140X/Alpaka/HIonV173/V10 \\\r\n   --globaltag auto:phase1_2024_realistic \\\r\n   --mc \\\r\n   --unprescale \\\r\n   --cff > \"${CMSSW_BASE}\"/src/HLTrigger/Configuration/python/HLT_User_cff.py\r\nscram b -j 20   \r\n```\r\n\r\nand then apply the following patch:\r\n\r\n```diff\r\ndiff --git a/Configuration/PyReleaseValidation/python/upgradeWorkflowComponents.py b/Configuration/PyReleaseValidation/python/upgradeWorkflowComponents.py\r\nindex 8a70a74aa0c..f9dc0a0397f 100644\r\n--- a/Configuration/PyReleaseValidation/python/upgradeWorkflowComponents.py\r\n+++ b/Configuration/PyReleaseValidation/python/upgradeWorkflowComponents.py\r\n@@ -2865,7 +2865,7 @@ upgradeProperties[2017] = {\r\n     '2022HI' : {\r\n         'Geom' : 'DB:Extended',\r\n         'GT':'auto:phase1_2022_realistic_hi',\r\n-        'HLTmenu': '@fake2',\r\n+        'HLTmenu': 'User',\r\n         'Era':'Run3_pp_on_PbPb',\r\n         'BeamSpot': 'DBrealistic',\r\n         'ScenToRun' : ['GenSim','Digi','RecoNano','HARVESTNano','ALCA'],\r\n@@ -2873,7 +2873,7 @@ upgradeProperties[2017] = {\r\n     '2022HIRP' : {\r\n         'Geom' : 'DB:Extended',\r\n         'GT':'auto:phase1_2022_realistic_hi',\r\n-        'HLTmenu': '@fake2',\r\n+        'HLTmenu': 'User',\r\n         'Era':'Run3_pp_on_PbPb_approxSiStripClusters',\r\n         'BeamSpot': 'DBrealistic',\r\n         'ScenToRun' : ['GenSim','Digi','RecoNano','HARVESTNano','ALCA'],\r\n@@ -2881,7 +2881,7 @@ upgradeProperties[2017] = {\r\n     '2023HI' : {\r\n         'Geom' : 'DB:Extended',\r\n         'GT':'auto:phase1_2023_realistic_hi',\r\n-        'HLTmenu': '@fake2',\r\n+        'HLTmenu': 'User',\r\n         'Era':'Run3_pp_on_PbPb',\r\n         'BeamSpot': 'DBrealistic',\r\n         'ScenToRun' : ['GenSim','Digi','RecoNano','HARVESTNano','ALCA'],\r\n@@ -2889,7 +2889,7 @@ upgradeProperties[2017] = {\r\n     '2023HIRP' : {\r\n         'Geom' : 'DB:Extended',\r\n         'GT':'auto:phase1_2023_realistic_hi',\r\n-        'HLTmenu': '@fake2',\r\n+        'HLTmenu': 'User',\r\n         'Era':'Run3_pp_on_PbPb_approxSiStripClusters',\r\n         'BeamSpot': 'DBrealistic',\r\n         'ScenToRun' : ['GenSim','Digi','RecoNano','HARVESTNano','ALCA'],\r\n```\r\n\r\nin a release that I have prepared with this and then finally run:\r\n   * `runTheMatrix.py --what upgrade -l 15261.0 --maxSteps 2` (neutrino gun input)\r\n   * `runTheMatrix.py --what upgrade -l 15224.0 --maxSteps 2` (TTbar input)\r\n\r\nBoth tests run fine.\r\n\r\n#### If this PR is a backport please specify the original PR and why you need to backport that PR. If this PR will be backported please specify to which release cycle the backport is meant for:\r\n\r\nNot a backport, but will need to be backported down to `CMSSW_14_0_X` for data-taking purposes.", "branch": "master", "changed_files": 2, "comments": 16, "commits": 1, "created_at": "1724957947", "deletions": 0, "labels": ["reconstruction-approved", "fully-signed", "tests-approved", "orp-pending", "urgent", "code-checks-approved", "heterogeneous-approved", "tracking"], "milestone": "CMSSW_14_2_X", "number": 45837, "release-notes": [], "review_comments": 3, "state": "open", "title": "`TrackingRecHitsSoACollection`: early return `hostData` in `CopyHost::copyAsync()` when there aren't hits", "updated_at": "1725345329", "user": "mmusich"}