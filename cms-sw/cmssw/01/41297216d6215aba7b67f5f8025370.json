{"additions": 91, "auther_ref": "alca-run-dependent-mc_12_0_X", "auther_sha": "8c537cbd2829f91b2ef5c1625e6d301378c19360", "author": "christopheralanwest", "body": "#### PR description:\r\n\r\nFor Run 3, it is intended to support the use of run-dependent MC using the scheme described in the [Time-Dependent MC Working group final recommendations](https://docs.google.com/document/d/1GLADYZP_ad1bPyrEBPpkRPT22Oru6fC_KKZmfgDgwZo/edit#). The proposed run assignment scheme uses a fixed mapping of lumiblock number to run number. Though this procedure is technically supported already by CMSSW, the lumiblock to run mapping required currently must be constructed manually from the run probability distribution, the number of lumiblocks in the sample and the events per lumiblock. This mapping, `firstLuminosityBlockForEachRun` is then specified individually for each workflow.\r\n\r\nThis PR adds two options for configuring this mapping from `cmsDriver.py` options. The first, `--runsAndWeightsForMCInteger`, allows for directly specifying a run probability distribution. In contrast to the Run 1 procedure, here the relative weighting of events per IOV is a rational number. As an example,\r\n\r\n```\r\n--runsAndWeightsForMCInteger \"[315257, 315257, 316082]\"\r\n```\r\n\r\nwould result in two IOVs, one starting at `run = 315257` and the second starting at `run = 316082` with twice as many events in the IOV starting at `run = 315257`.\r\n\r\nThe options `--runsAndWeightsForMCInteger` and `--runsScenarioForMCInteger` are directly analogous to the options  `--runsAndWeightsForMC` and `--runsScenarioForMC` for the Run-1 run-dependent MC scheme. I decided to introduce new options rather than try to overload the existing options depending upon the input. I could of course change this behavior, if desired.\r\n\r\nIn order to properly construct the lumi-to-run mapping for the digi-premixing step, it is necessary to know the total number of lumiblocks in the sample. This is determined by using the existing `--relval` option used by the GEN-SIM step also for the digi-premixing step. In this PR, I am focusing on the relval workflows as it is desirable to use relvals to test run-dependent MC procedures prior to proposing changes needed for large productions.\r\n\r\nTo simplify the configuration of run-dependent MC, I've introduced a new process modifier `runDependent` to contain configuration options specific to run-dependent MC. For now, this amounts to using the setting\r\n\r\n```\r\nprocess.mixData.workers.ecal.timeDependent=True\r\n```\r\n\r\nin the DIGI-PREMIX step and forcing the run number to 1 in the HARVEST step.\r\n\r\nFinally, the default settings for the run-dependent MC workflows have been changed so that the number of lumiblocks in the same evenly divides the number of IOVs. This is necessary to apply the IOV weighting with 9 evenly weighted IOVs, as used by recent tests of run-dependent MC.\r\n\r\n#### PR validation:\r\n\r\nThis PR was tested by dumping the python files for all of the workflows `250202.172,250202.183,250206.182,250200.182,250202.182` with `edmConfigDump` and comparing the results before and after the changes.\r\n\r\nFor standard 2018 run-dependent workflows 250200.182, 250202.182 and 250206.182, corresponding to ZEE, TTbar and ZMM, the changes in each step are as follows:\r\n\r\nGEN-SIM:\r\n- Added `process.EcalLaserCorrectionServiceMC = cms.ESProducer(\"EcalLaserCorrectionServiceMC\")`\r\n- Modified number of events per lumiblock: `numberEventsInLuminosityBlock = cms.untracked.uint32(5)` -> `numberEventsInLuminosityBlock = cms.untracked.uint32(50)`\r\n\r\nstep 2:\r\n- Modified lumiblock-to-run mapping. Changed from:\r\n\r\n```\r\nprocess.source.firstLuminosityBlockForEachRun = cms.untracked.VLuminosityBlockID(*[cms.LuminosityBlockID(x,y) for x,y in ((315257, 1), (316082, 222), (316720, 445), (317527, 668), (320917, 890), (321414, 1112), (321973, 1334), (322492, 1556), (324245, 1779))]) \r\n```\r\n\r\nto \r\n```\r\nprocess.source.firstLuminosityBlockForEachRun = cms.untracked.VLuminosityBlockID(*[cms.LuminosityBlockID(x,y) for x,y in ((315257, 1), (316082, 21), (316720, 41), (317527, 61), (320917, 81), (321414, 101), (321973, 121), (322492, 141), (324245, 161))])\r\n```\r\nstep 3:\r\n- No Changes\r\n\r\nstep 4:\r\n- Added `process.EcalLaserCorrectionServiceMC = cms.ESProducer(\"EcalLaserCorrectionServiceMC\")`\r\n\r\n\r\nThe additional ESProducer in the GEN-SIM step and step 4 is harmless as nothing in the GEN-SIM or HARVESTING step can consume this product.\r\n\r\nFor workflow 250202.183, which is a version of workflow 250202.182 that is intended to run multi-IOV MC jobs in IBs, the only changes are the additional `ESProducer` in the GEN-SIM step and step 4. No changes are needed for the lumiblock mapping in this case as the lumi-to-run mapping is configured differently for this workflow.\r\n\r\nIn the 2017 run-dependent workflow 250202.172, the additional `ESProducer` has been added to the GEN-SIM step, step 3 and step 4. There is no lumiblock-to-run splitting in this case.\r\n\r\nIn addition, I verified that the options `--runsAndWeightsForMCInteger [315257, 316082, 316720, 317527, 320917, 321414, 321973, 322492, 324245]` and `--runsScenarioForMCInteger Run2018_Equal_Lumi_Integer_Weights` result in identical configurations, as intended.\r\n\r\n#### if this PR is a backport please specify the original PR and why you need to backport that PR:\r\n\r\nThis PR is not a backport and there is currently no use case for a backport.", "branch": "master", "changed_files": 12, "closed_at": "1621897656", "comments": 41, "commits": 3, "created_at": "1619568848", "deletions": 13, "labels": ["alca-approved", "code-checks-approved", "fully-signed", "operations-approved", "orp-approved", "pdmv-approved", "simulation-approved", "tests-approved", "upgrade-approved"], "merge_commit_sha": "5d0f11bc512a9f5c0bc2b5816fc1c0f01b8c220d", "merged_at": "1621897656", "merged_by": "cmsbuild", "milestone": "CMSSW_12_0_X", "number": 33555, "release-notes": [], "review_comments": 2, "state": "closed", "title": "Make run-dependent MC configurable with cmsDriver options", "updated_at": "1621897657", "user": "christopheralanwest"}