{"additions": 15, "auther_ref": "fix-stack-overflow-val", "auther_sha": "b1343842a41574cbe310eb027312e66d0efe1d63", "author": "davidlt", "body": "ASan detected stack-buffer-overflow (READ of 23 bytes) in\nstd::basic_string constructor which is called by\n`SimHitsValidationHcal::getHistogramTypes()`.\n\nA quick test showed that we always overflow `name2`, it's usual size is\n21-23 chars.\n\nThe patch doubles buffers size for `name1` and `name2` to 40 bytes and\nuses `snprintf` to make sure it never overflows.\n\n```\nlen(name1) = 6\nlen(name2) = 23\n\nlen(name1) = 6\nlen(name2) = 23\n\nlen(name1) = 6\nlen(name2) = 21\n\nlen(name1) = 6\nlen(name2) = 21\n\nlen(name1) = 6\nlen(name2) = 21\n\nlen(name1) = 6\nlen(name2) = 21\n\nlen(name1) = 6\nlen(name2) = 21\n\nlen(name1) = 6\nlen(name2) = 21\n```\n\n```\n=================================================================\n==14834==ERROR: AddressSanitizer: stack-buffer-overflow on address 0x7fff0da5ef04 at pc 0x46b04a bp 0x7fff0da5ea90 sp 0x7fff0da5e9d8\nREAD of size 23 at 0x7fff0da5ef04 thread T0\n   #0 0x46b049 in memcpy (/mnt/build/davidlt/asan2/a/slc6_amd64_gcc493/cms/cmssw/CMSSW_7_6_ASAN_X_2015-10-19-1100/bin/slc6_amd64_gcc493/cmsRun+0x46b049)\n   #1 0x7f47b5a8fdc9 in std::char_traits<char>::copy(char*, char const*, unsigned long) (/mnt/build/davidlt/asan2/a/slc6_amd64_gcc493/external/gcc/4.9.3/lib64/libstdc++.so.6+0x63dc9)\n   #2 0x7f47b5a9065f in _Y_ZNSs7_M_copyEPcPKcm (/mnt/build/davidlt/asan2/a/slc6_amd64_gcc493/external/gcc/4.9.3/lib64/libstdc++.so.6+0x6465f)\n   #3 0x7f47b5b031d5 in std::string::_S_copy_chars(char*, char const*, char const*) (/mnt/build/davidlt/asan2/a/slc6_amd64_gcc493/external/gcc/4.9.3/lib64/libstdc++.so.6+0xd71d5)\n   #4 0x7f47b7e92d66 in char* std::string::_S_construct<char const*>(char const*, char const*, std::allocator<char> const&, std::forward_iterator_tag) (/mnt/build/davidlt/asan2/CMSSW_7_6_ASAN_X_2015-10-19-1100/lib/slc6_amd64_gcc493/libFWCoreUtilities.so+0xcbd66)\n   #5 0x7f47b7e9282b in char* std::string::_S_construct_aux<char const*>(char const*, char const*, std::allocator<char> const&, std::__false_type) /mnt/build/davidlt/asan2/a/slc6_amd64_gcc493/external/gcc/4.9.3/include/c++/4.9.3/bits/basic_string.h:1743\n   #6 0x7f47b7e92711 in char* std::string::_S_construct<char const*>(char const*, char const*, std::allocator<char> const&) /mnt/build/davidlt/asan2/a/slc6_amd64_gcc493/external/gcc/4.9.3/include/c++/4.9.3/bits/basic_string.h:1764\n   #7 0x7f47b5b03891 in std::basic_string<char, std::char_traits<char>, std::allocator<char> >::basic_string(char const*, std::allocator<char> const&) (/mnt/build/davidlt/asan2/a/slc6_amd64_gcc493/external/gcc/4.9.3/lib64/libstdc++.so.6+0xd7891)\n   #8 0x7f478afbf134 in SimHitsValidationHcal::getHistogramTypes() /mnt/build/davidlt/asan2/CMSSW_7_6_ASAN_X_2015-10-19-1100/src/Validation/HcalHits/src/SimHitsValidationHcal.cc:431\n   #9 0x7f478afb9b46 in SimHitsValidationHcal::bookHistograms(DQMStore::IBooker&, edm::Run const&, edm::EventSetup const&) /mnt/build/davidlt/asan2/CMSSW_7_6_ASAN_X_2015-10-19-1100/src/Validation/HcalHits/src/SimHitsValidationHcal.cc:38\n   #10 0x7f47a6757891 in DQMEDAnalyzer::beginRun(edm::Run const&, edm::EventSetup const&)::{lambda(DQMStore::IBooker&)#1}::operator()(DQMStore::IBooker&) const (/mnt/build/davidlt/asan2/CMSSW_7_6_ASAN_X_2015-10-19-1100/lib/slc6_amd64_gcc493/libDQMServicesCore.so+0x7f891)\n   #11 0x7f47a675828c in bookTransaction<DQMEDAnalyzer::beginRun(const edm::Run&, const edm::EventSetup&)::<lambda(DQMStore::IBooker&)> > /mnt/build/davidlt/asan2/CMSSW_7_6_ASAN_X_2015-10-19-1100/src/DQMServices/Core/interface/DQMStore.h:254\n   #12 0x7f47a6757997 in DQMEDAnalyzer::beginRun(edm::Run const&, edm::EventSetup const&) /mnt/build/davidlt/asan2/CMSSW_7_6_ASAN_X_2015-10-19-1100/src/DQMServices/Core/src/DQMEDAnalyzer.cc:26\n   #13 0x7f47b887de5e in edm::stream::EDAnalyzerAdaptorBase::doStreamBeginRun(edm::StreamID, edm::RunPrincipal&, edm::EventSetup const&, edm::ModuleCallingContext const*) (/mnt/build/davidlt/asan2/a/slc6_amd64_gcc493/cms/cmssw/CMSSW_7_6_ASAN_X_2015-10-19-1100/lib/slc6_amd64_gcc493/libFWCoreFramework.so+0x3a9e5e)\n   #14 0x7f47b8858965 in edm::WorkerT<edm::stream::EDAnalyzerAdaptorBase>::implDoStreamBegin(edm::StreamID, edm::RunPrincipal&, edm::EventSetup const&, edm::ModuleCallingContext const*) (/mnt/build/davidlt/asan2/a/slc6_amd64_gcc493/cms/cmssw/CMSSW_7_6_ASAN_X_2015-10-19-1100/lib/slc6_amd64_gcc493/libFWCoreFramework.so+0x384965)\n   #15 0x7f47b866d2e2 in decltype ({parm#1}()) edm::convertException::wrap<bool edm::Worker::doWork<edm::OccurrenceTraits<edm::RunPrincipal, (edm::BranchActionType)1> >(edm::OccurrenceTraits<edm::RunPrincipal, (edm::BranchActionType)1>::MyPrincipal&, edm::EventSetup const&, edm::StreamID, edm::ParentContext const&, edm::OccurrenceTraits<edm::RunPrincipal, (edm::BranchActionType)1>::Context const*)::{lambda()#1}>(bool edm::Worker::doWork<edm::OccurrenceTraits<edm::RunPrincipal, (edm::BranchActionType)1> >(edm::OccurrenceTraits<edm::RunPrincipal, (edm::BranchActionType)1>::MyPrincipal&, edm::EventSetup const&, edm::StreamID, edm::ParentContext const&, edm::OccurrenceTraits<edm::RunPrincipal, (edm::BranchActionType)1>::Context const*)::{lambda()#1}) (/mnt/build/davidlt/asan2/a/slc6_amd64_gcc493/cms/cmssw/CMSSW_7_6_ASAN_X_2015-10-19-1100/lib/slc6_amd64_gcc493/libFWCoreFramework.so+0x1992e2)\n   #16 0x7f47b866d76d in bool edm::Worker::doWork<edm::OccurrenceTraits<edm::RunPrincipal, (edm::BranchActionType)1> >(edm::OccurrenceTraits<edm::RunPrincipal, (edm::BranchActionType)1>::MyPrincipal&, edm::EventSetup const&, edm::StreamID, edm::ParentContext const&, edm::OccurrenceTraits<edm::RunPrincipal, (edm::BranchActionType)1>::Context const*) (/mnt/build/davidlt/asan2/a/slc6_amd64_gcc493/cms/cmssw/CMSSW_7_6_ASAN_X_2015-10-19-1100/lib/slc6_amd64_gcc493/libFWCoreFramework.so+0x19976d)\n   #17 0x7f47b866dca3 in decltype ({parm#1}()) edm::convertException::wrap<void edm::Path::processOneOccurrence<edm::OccurrenceTraits<edm::RunPrincipal, (edm::BranchActionType)1> >(edm::OccurrenceTraits<edm::RunPrincipal, (edm::BranchActionType)1>::MyPrincipal&, edm::EventSetup const&, edm::StreamID const&, edm::OccurrenceTraits<edm::RunPrincipal, (edm::BranchActionType)1>::Context const*)::{lambda()#1}>(void edm::Path::processOneOccurrence<edm::OccurrenceTraits<edm::RunPrincipal, (edm::BranchActionType)1> >(edm::OccurrenceTraits<edm::RunPrincipal, (edm::BranchActionType)1>::MyPrincipal&, edm::EventSetup const&, edm::StreamID const&, edm::OccurrenceTraits<edm::RunPrincipal, (edm::BranchActionType)1>::Context const*)::{lambda()#1}) (/mnt/build/davidlt/asan2/a/slc6_amd64_gcc493/cms/cmssw/CMSSW_7_6_ASAN_X_2015-10-19-1100/lib/slc6_amd64_gcc493/libFWCoreFramework.so+0x199ca3)\n   #18 0x7f47b866e078 in void edm::Path::processOneOccurrence<edm::OccurrenceTraits<edm::RunPrincipal, (edm::BranchActionType)1> >(edm::OccurrenceTraits<edm::RunPrincipal, (edm::BranchActionType)1>::MyPrincipal&, edm::EventSetup const&, edm::StreamID const&, edm::OccurrenceTraits<edm::RunPrincipal, (edm::BranchActionType)1>::Context const*) (/mnt/build/davidlt/asan2/a/slc6_amd64_gcc493/cms/cmssw/CMSSW_7_6_ASAN_X_2015-10-19-1100/lib/slc6_amd64_gcc493/libFWCoreFramework.so+0x19a078)\n   #19 0x7f47b866e53c in decltype ({parm#1}()) edm::convertException::wrap<void edm::StreamSchedule::processOneStream<edm::OccurrenceTraits<edm::RunPrincipal, (edm::BranchActionType)1> >(edm::OccurrenceTraits<edm::RunPrincipal, (edm::BranchActionType)1>::MyPrincipal&, edm::EventSetup const&, bool)::{lambda()#1}>(void edm::StreamSchedule::processOneStream<edm::OccurrenceTraits<edm::RunPrincipal, (edm::BranchActionType)1> >(edm::OccurrenceTraits<edm::RunPrincipal, (edm::BranchActionType)1>::MyPrincipal&, edm::EventSetup const&, bool)::{lambda()#1}) (/mnt/build/davidlt/asan2/a/slc6_amd64_gcc493/cms/cmssw/CMSSW_7_6_ASAN_X_2015-10-19-1100/lib/slc6_amd64_gcc493/libFWCoreFramework.so+0x19a53c)\n   #20 0x7f47b866f3a7 in void edm::StreamSchedule::processOneStream<edm::OccurrenceTraits<edm::RunPrincipal, (edm::BranchActionType)1> >(edm::OccurrenceTraits<edm::RunPrincipal, (edm::BranchActionType)1>::MyPrincipal&, edm::EventSetup const&, bool) (/mnt/build/davidlt/asan2/a/slc6_amd64_gcc493/cms/cmssw/CMSSW_7_6_ASAN_X_2015-10-19-1100/lib/slc6_amd64_gcc493/libFWCoreFramework.so+0x19b3a7)\n   #21 0x7f47b864ec68 in edm::EventProcessor::beginRun(statemachine::Run const&) (/mnt/build/davidlt/asan2/a/slc6_amd64_gcc493/cms/cmssw/CMSSW_7_6_ASAN_X_2015-10-19-1100/lib/slc6_amd64_gcc493/libFWCoreFramework.so+0x17ac68)\n   #22 0x7f47b85ef497 in statemachine::HandleRuns::beginRun(statemachine::Run const&) (/mnt/build/davidlt/asan2/a/slc6_amd64_gcc493/cms/cmssw/CMSSW_7_6_ASAN_X_2015-10-19-1100/lib/slc6_amd64_gcc493/libFWCoreFramework.so+0x11b497)\n   #23 0x7f47b85ef676 in statemachine::HandleRuns::setupCurrentRun() (/mnt/build/davidlt/asan2/a/slc6_amd64_gcc493/cms/cmssw/CMSSW_7_6_ASAN_X_2015-10-19-1100/lib/slc6_amd64_gcc493/libFWCoreFramework.so+0x11b676)\n   #24 0x7f47b85f5574 in statemachine::NewRun::NewRun(boost::statechart::state<statemachine::NewRun, statemachine::HandleRuns, boost::mpl::list<mpl_::na, mpl_::na, mpl_::na, mpl_::na, mpl_::na, mpl_::na, mpl_::na, mpl_::na, mpl_::na, mpl_::na, mpl_::na, mpl_::na, mpl_::na, mpl_::na, mpl_::na, mpl_::na, mpl_::na, mpl_::na, mpl_::na, mpl_::na>, (boost::statechart::history_mode)0>::my_context) (/mnt/build/davidlt/asan2/a/slc6_amd64_gcc493/cms/cmssw/CMSSW_7_6_ASAN_X_2015-10-19-1100/lib/slc6_amd64_gcc493/libFWCoreFramework.so+0x121574)\n   #25 0x7f47b86141d3 in boost::statechart::state<statemachine::HandleRuns, statemachine::HandleFiles, statemachine::NewRun, (boost::statechart::history_mode)0>::deep_construct(boost::intrusive_ptr<statemachine::HandleFiles> const&, boost::statechart::state_machine<statemachine::Machine, statemachine::Starting, std::allocator<void>, boost::statechart::null_exception_translator>&) (/mnt/build/davidlt/asan2/a/slc6_amd64_gcc493/cms/cmssw/CMSSW_7_6_ASAN_X_2015-10-19-1100/lib/slc6_amd64_gcc493/libFWCoreFramework.so+0x1401d3)\n   #26 0x7f47b8614970 in boost::statechart::simple_state<statemachine::FirstFile, statemachine::HandleFiles, boost::mpl::list<mpl_::na, mpl_::na, mpl_::na, mpl_::na, mpl_::na, mpl_::na, mpl_::na, mpl_::na, mpl_::na, mpl_::na, mpl_::na, mpl_::na, mpl_::na, mpl_::na, mpl_::na, mpl_::na, mpl_::na, mpl_::na, mpl_::na, mpl_::na>, (boost::statechart::history_mode)0>::react_impl(boost::statechart::event_base const&, void const*) (/mnt/build/davidlt/asan2/a/slc6_amd64_gcc493/cms/cmssw/CMSSW_7_6_ASAN_X_2015-10-19-1100/lib/slc6_amd64_gcc493/libFWCoreFramework.so+0x140970)\n   #27 0x7f47b866275d in boost::statechart::state_machine<statemachine::Machine, statemachine::Starting, std::allocator<void>, boost::statechart::null_exception_translator>::process_event(boost::statechart::event_base const&) (/mnt/build/davidlt/asan2/a/slc6_amd64_gcc493/cms/cmssw/CMSSW_7_6_ASAN_X_2015-10-19-1100/lib/slc6_amd64_gcc493/libFWCoreFramework.so+0x18e75d)\n   #28 0x7f47b863bb29 in edm::EventProcessor::runToCompletion() (/mnt/build/davidlt/asan2/a/slc6_amd64_gcc493/cms/cmssw/CMSSW_7_6_ASAN_X_2015-10-19-1100/lib/slc6_amd64_gcc493/libFWCoreFramework.so+0x167b29)\n   #29 0x4a97c7 in main::{lambda()#1}::operator()() const (/mnt/build/davidlt/asan2/a/slc6_amd64_gcc493/cms/cmssw/CMSSW_7_6_ASAN_X_2015-10-19-1100/bin/slc6_amd64_gcc493/cmsRun+0x4a97c7)\n   #30 0x41f2ca in main (/mnt/build/davidlt/asan2/a/slc6_amd64_gcc493/cms/cmssw/CMSSW_7_6_ASAN_X_2015-10-19-1100/bin/slc6_amd64_gcc493/cmsRun+0x41f2ca)\n   #31 0x7f47b51fcd5c in __libc_start_main (/lib64/libc.so.6+0x1ed5c)\n   #32 0x41f7f4 (/mnt/build/davidlt/asan2/a/slc6_amd64_gcc493/cms/cmssw/CMSSW_7_6_ASAN_X_2015-10-19-1100/bin/slc6_amd64_gcc493/cmsRun+0x41f7f4)\n\nAddress 0x7fff0da5ef04 is located in stack of thread T0 at offset 372 in frame\n   #0 0x7f478afbe1b5 in SimHitsValidationHcal::getHistogramTypes() /mnt/build/davidlt/asan2/CMSSW_7_6_ASAN_X_2015-10-19-1100/src/Validation/HcalHits/src/SimHitsValidationHcal.cc:370\n\n This frame has 8 object(s):\n   [32, 36) 'maxDepth'\n   [96, 112) 'names'\n   [160, 176) 'type'\n   [224, 240) 'dept0'\n   [288, 308) 'name1'\n   [352, 372) 'name2' <== Memory access at offset 372 overflows this variable\n   [416, 448) 'hfty1'\n   [480, 512) 'hfty2'\nHINT: this may be a false positive if your program uses some custom stack unwind mechanism or swapcontext\n     (longjmp and C++ exceptions *are* supported)\nSUMMARY: AddressSanitizer: stack-buffer-overflow ??:0 memcpy\nShadow bytes around the buggy address:\n 0x100061b43d90: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00\n 0x100061b43da0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00\n 0x100061b43db0: 00 00 f1 f1 f1 f1 04 f4 f4 f4 f2 f2 f2 f2 00 00\n 0x100061b43dc0: f4 f4 f2 f2 f2 f2 00 00 f4 f4 f2 f2 f2 f2 00 00\n 0x100061b43dd0: f4 f4 f2 f2 f2 f2 00 00 04 f4 f2 f2 f2 f2 00 00\n=>0x100061b43de0:[04]f4 f2 f2 f2 f2 00 00 00 00 f2 f2 f2 f2 00 00\n 0x100061b43df0: 00 00 f3 f3 f3 f3 00 00 00 00 00 00 00 00 00 00\n 0x100061b43e00: 00 00 00 00 00 00 00 00 00 00 00 00 f1 f1 f1 f1\n 0x100061b43e10: 00 00 00 f4 f2 f2 f2 f2 00 00 00 f4 f2 f2 f2 f2\n 0x100061b43e20: 00 00 00 00 f2 f2 f2 f2 00 00 00 00 00 00 00 00\n 0x100061b43e30: 00 00 00 00 04 f4 f4 f4 f2 f2 f2 f2 00 00 00 00\nShadow byte legend (one shadow byte represents 8 application bytes):\n Addressable:           00\n Partially addressable: 01 02 03 04 05 06 07 \n Heap left redzone:       fa\n Heap right redzone:      fb\n Freed heap region:       fd\n Stack left redzone:      f1\n Stack mid redzone:       f2\n Stack right redzone:     f3\n Stack partial redzone:   f4\n Stack after return:      f5\n Stack use after scope:   f8\n Global redzone:          f9\n Global init order:       f6\n Poisoned by user:        f7\n Contiguous container OOB:fc\n ASan internal:           fe\n==14834==ABORTING\n```\n\nSigned-off-by: David Abdurachmanov David.Abdurachmanov@cern.ch\n", "branch": "CMSSW_7_6_X", "changed_files": 1, "closed_at": "1446024127", "comments": 6, "commits": 1, "created_at": "1445341399", "deletions": 15, "labels": ["comparison-available", "dqm-pending", "orp-pending", "pending-signatures", "tests-approved"], "merge_commit_sha": "493de3dea273b55a7672f2e6712563ba157772b7", "merged_at": "1446024127", "merged_by": "davidlange6", "milestone": "CMSSW_7_6_X", "number": 11987, "release-notes": [], "review_comments": 0, "state": "closed", "title": "Double buffer size for 'name1' and 'name2'", "updated_at": "1446024127", "user": "davidlt"}