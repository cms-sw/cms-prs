{"additions": 1578, "auther_ref": "parallel_oldDD_DD4hep", "auther_sha": "a1cb064cf1cbb8a493fd8d018ee9f03cd9ea2152", "author": "ghugo83", "body": "### PR description: \r\n\r\nThis is a **change of paradigm** of https://github.com/cms-sw/cmssw/pull/31240 , which was fully porting PPS to rely on DD4hep.\r\n\r\nHere instead, **old DD scenarios and geometry building are restored and used by default** in CTPPS Sim and Reco.\r\n**old DD scenarios are not affected in any way.**\r\n\r\nDD4hep scenarios and geometry building are **added**, and can be used in CTPPS simulation and reconstruction steps instead, **in test files**, by loading the dd4hep scenarios instead (in Geometry.VeryForwardGeometry.dd4hep).\r\n\r\nThe legacy geometry building code is reshaped, so that the code for building geometry with old DD and DD4hep is in common. A fromDD4hep boolean is used when necessary.\r\n\r\nNB: This includes few fixes (in legacy code) mentioned in https://github.com/cms-sw/cmssw/issues/31297 , at the occasion of previous PR.\r\nNB 2 : The commits are from the last 3 days, and allow full change of paradigm.\r\nNB 3: If any issue, time to say it now :) \r\nNB 4: Please keep comments related to this PR, I cannot rewrite full PPS packages legacy code unfortunately ;)\r\n\r\n@jan-kaspar @wpcarvalho @mundim @forthommel @malbouis @fabferro @dpiparo @cvuosalo @ianna @civanch \r\n\r\nMore details, on dedicated topics, in sections below.\r\n\r\n\r\n### [1] Scenarios available for both oldDD and DD4hep:\r\nThe scenarios for old DD are still in Geometry/VeryForwardGeometry, and are **untouched**.\r\nThe scenarios for DD4hep are in Geometry.VeryForwardGeometry/dd4hep.\r\n\r\n**XMLs-based scenarios**:\r\n- geometryPPS_CMSxz_fromDD_2016_cfi\r\n- geometryPPS_CMSxz_fromDD_2017_cfi\r\n- geometryPPS_CMSxz_fromDD_2018_cfi\r\n- geometryRPFromDD_2017_cfi\r\n- geometryRPFromDD_2018_cfi\r\n\r\n**DB scenario**:\r\n- geometryRPFromDB_cfi\r\n\r\n\r\n### [2] PR validation:\r\nChecked **no regression in old DD** + Checked **no difference between oldDD and DD4hep**.\r\n\r\n- **All workflows are untouched and rely on old DD**.\r\n\r\n- **No diff on any geo info, when using DD4hep.** (volume names, materials, placements, shapes, sensor types, DetIds, etc).\r\n**Fully tested on all volumes and all 6 scenarios.**\r\nMax diff in placement is 1 um.\r\nDD4hep is only used by test files anyway. \r\n\r\n- No regression in reconstruction, when using DD4hep. (tests scripts from @jan-kaspar , big thanks!):\r\n**\"Direct\" simulation, using geometry from XML files**: [make_cmp_simu.pdf](https://github.com/cms-sw/cmssw/files/5124309/make_cmp_simu.pdf)\r\n**Reconstruction of LHC data (RAW to proton), using geometry from DB**: [make_cmp_reco.pdf](https://github.com/cms-sw/cmssw/files/5124310/make_cmp_reco.pdf)\r\nDD4hep is only used by test files anyway. \r\n\r\n\r\n### [3] PPS geometry building re-organization: \r\nPPS geometry building legacy code was heavily duplicated.\r\nHence, a first step was to reorganize CTPPS geometry building, to remove duplicated functionalities.\r\nNow, generic geometry building code is used both by old DD and DD4hep.\r\n\r\n\r\n### [4] DD4hep migration:\r\n- Switch to DD4hep-based versions of **DDCompactView and DDFilteredView**.\r\n- **DDTranslation  dd4hep::Direction** (ROOT::Math::XYZVector).\r\n- **DDRotationMatrix  dd4hep::Rotation3D** (ROOT::Math::Rotation3D).\r\n- **Fixed name casting regressions** (due to namespace not appearing with DD4hep).\r\n- **Fixed sensor type computation regressions** (due to namespace not appearing with DD4hep). Use a SpecPar section to select the 2x2:RPixWafer volumes.\r\n- **Fixed ID computation regressions** (due to different order of parent volumes copy numbers with DD4hep).\r\n- **Fixed shape parameters regressions** (due to different order / units with DD4hep). Only uses the Box parameters. Struct to access data.\r\n- **Debug and fixed units.** Since mm was the reference until now, by fear of regression, CTPPS team (with @wpcarvalho) has decided to keep mm as reference. Hence conversions as needed.", "branch": "master", "changed_files": 43, "closed_at": "1600194392", "comments": 88, "commits": 43, "created_at": "1599487878", "deletions": 1034, "labels": ["alca-approved", "code-checks-approved", "comparison-available", "db-approved", "dqm-approved", "fully-signed", "geometry-approved", "orp-approved", "reconstruction-approved", "simulation-approved", "tests-approved", "urgent"], "merge_commit_sha": "eabe255ca79afc2adf0f01ec3ac19c63ed41b737", "merged_at": "1600194391", "merged_by": "cmsbuild", "milestone": "CMSSW_11_2_X", "number": 31383, "release-notes": [], "review_comments": 21, "state": "closed", "title": "CTPPS Sim and Reco: Change of paradigm: oldDD and DD4hep in parallel", "updated_at": "1600194392", "user": "ghugo83"}