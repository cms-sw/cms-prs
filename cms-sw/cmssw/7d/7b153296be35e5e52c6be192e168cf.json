{"additions": 75, "auther_ref": "productIDModuleTypeResolverWorkaround_140x", "auther_sha": "a77f7cda749e562977bb019b9535d1d1bb641c91", "author": "makortel", "body": "#### PR description:\r\n\r\nThis PR is a backport of https://github.com/cms-sw/cmssw/pull/44698. Original description\r\n> This PR is a temporary workaround for the issue discussed in #44643. In short, with an HLT menu that uses Alpaka modules, when some HLT processes use GPU and some do not, the fact that the different backends of Alpaka modules produce different transient data products cause the ProductIDs to be different between the CPU-only and CPU+GPU processes, and presently there is not enough metadata available in the final streamer file for the framework to keep properly track of the various indices, that leads to de-referencing of `edm::Ref` to fail in a subsequent job (for longer description see [#44643 (comment)](https://github.com/cms-sw/cmssw/issues/44643#issuecomment-2046098157)).\r\n> \r\n> This PR works around the problem by making a subset(*) of the Alpaka EDProducers on the CPU serial backend, for each \"device-side data product\" they produce (that in reality are the \"host-side data products\" directly) they register the production of the corresponding CUDA backend data product. This hack makes the CPU-serial and CUDA backend EDProducers to register the production of exactly the same data products, that leads to equal ProductIDs for the same data products between CPU-only and CPU+GPU jobs, circumventing the problem.\r\n> \r\n> (*) ECAL, PF, and phase1 Pixel EDProducers, that are either being used in the present HLT menu, or are planned to be used in the near future\r\n> \r\n> The use of strings for the CUDA backend data products is ugly, but avoids the need to have a compile-time dependence on the CUDA backend code in the CPU serial backend code (I actually tried that first, but ran into compilation issues; probably our present build rules prevent the use of Alpaka CUDA backend types in the CPU serial backend code). At runtime the added explicit CUDA dependence will likely break on platforms that do not support CUDA (all our code directly depending on CUDA would be broken anyway, so the temporary loss of functionality seems acceptable).\r\n> \r\n> This PR is intended to be reverted when the necessary metadata to deal with the different ProductIDs in different HLT processes (CPU-only vs. CPU+GPU) gets propagated to the framework), whose details are being discussed in #44643 .\r\n\r\n\r\n\r\n\r\n#### PR validation:\r\n\r\nSee https://github.com/cms-sw/cmssw/pull/44698\r\n\r\n#### If this PR is a backport please specify the original PR and why you need to backport that PR. If this PR will be backported please specify to which release cycle the backport is meant for:\r\n\r\nBackport of https://github.com/cms-sw/cmssw/pull/44698", "branch": "CMSSW_14_0_X", "changed_files": 11, "comments": 13, "commits": 1, "created_at": "1712773577", "deletions": 6, "labels": ["alca-approved", "reconstruction-approved", "fully-signed", "tests-approved", "orp-pending", "urgent", "backport-ok", "heterogeneous-approved", "tracking", "trk"], "milestone": "CMSSW_14_0_X", "number": 44699, "release-notes": [], "review_comments": 0, "state": "open", "title": "[14_0_X] Workaround to produce exactly same data products in Serial and CUDA backends in Alpaka modules possibly used at HLT", "updated_at": "1712846222", "user": "makortel"}