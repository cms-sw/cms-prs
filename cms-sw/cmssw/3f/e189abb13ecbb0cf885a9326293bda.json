{"additions": 89, "auther_ref": "fc-mchist20241026", "auther_sha": "48ca33ec29770582ec09ff595ba990c50b0ba881", "author": "fabiocos", "body": "#### PR description:\r\n\r\nThis PR extends and hopefully completes the past work on MTD hit classification proposed in https://github.com/cms-sw/cmssw/pull/41318 and https://github.com/cms-sw/cmssw/pull/42455 . There are two main developments:\r\n\r\n- the information about the last ancestor track ID stored in the event history is saved as an additional ```unsigned int``` member of ```TrackInformation```. This allows the user to link a hit to an object present in the history, but without going back to the original generator-level mother, e.g. a hit can be in this way easily linked to a conversion electron instead of being pushed to the incoming photon that converts. This is used to define the MTD track Id instead of ```mcTruthID```. This information depends on the ```setStoreTrack()``` method use, and the update of the ```idLastStoredAncestor``` information is consistently done in any place where the to-be-stored flag is set;\r\n\r\n- a new ```hitClassID``` member is added to the ```TimingSD``` class, and used in ```MtdSD``` to detect hits that are impinging on ETL from back instead of front (and the information is also propagated to ```TrackInformation``` exploiting still unused bits in the ```mtdStatus_``` word). By exploiting the geometry of the detector, a simple check on the entry and exit point global z is enough to decide whether the hit has been produced by a particle entering from front or back of the silicon sensor. This piece of information is then used to propagate a new offset to hits from tracks entering ETL sensors from back, in this way backscattering in ETL can be separated as well from hits of tracks flowing towards HGCAL.\r\n\r\n#### PR validation:\r\n\r\nThe code has been tested with detailed verbosity on both a single pion and single gamma guns, and provides the expected hit classification. Now secondary hits are produced only by particles not stored in the history, while hits by secondary particle stored in history are seen as direct hits of those. An example of the effect of this change can be seen on the association of hits to electrons from conversion (wf. 29604 SingleGammaPt10_pythia8_cfi):\r\n\r\n```\r\nBegin processing the 1st record. Run 1, Event 1, LumiSection 1 on stream 0 at 17-Dec-2024 11:08:19.132 CET\r\n\r\n SimVertex / SimTrack structure dump \r\n\r\n SimVertex in the event = 86\r\n SimTracks in the event = 101\r\n\r\n\r\nSimVertex 0 = (0.0014826,-0.000194954,0.551332,3.37798e-10), -1, 0\r\n\r\n  SimTrack 0 = 22, (7.93891,-6.07255,12.2045,15.7751), 0, 2 Track Id = 1\r\n  ---> Corresponding to HepMC particle          2       22 +7.94e+00,-6.07e+00,+1.22e+01,+1.58e+01   1\r\n  SimTrack 1 = 22, (-7.93891,6.07255,-12.2045,15.7751), 0, 3 Track Id = 2\r\n  ---> Corresponding to HepMC particle          3       22 -7.94e+00,+6.07e+00,-1.22e+01,+1.58e+01   1\r\n\r\n\r\nSimVertex 1 = (-87.4786,66.9141,-133.932,6.13607e-09), 2, 1\r\n\r\n  SimTrack 2 = 11, (-0.202473,0.155515,-0.311717,0.402924), 1, -1 Track Id = 3\r\n  SimTrack 3 = -11, (-7.73712,5.91611,-11.8928,15.3721), 1, -1 Track Id = 4\r\n\r\n\r\nSimVertex 2 = (-87.5881,66.9978,-134.1,6.14332e-09), 4, 2\r\n\r\n  SimTrack 4 = 22, (-0.113616,0.0869321,-0.174619,0.225738), 2, -1 Track Id = 5\r\n\r\n\r\nSimVertex 3 = (-91.6664,70.1364,-140.38,6.41415e-09), 4, 3\r\n\r\n  SimTrack 5 = 22, (-0.163296,0.126294,-0.251812,0.325615), 3, -1 Track Id = 6\r\n\r\n\r\nSimVertex 4 = (-91.8113,70.2485,-140.604,6.42379e-09), 4, 4\r\n\r\n  SimTrack 6 = 22, (-0.115089,0.0891966,-0.177946,0.229927), 4, -1 Track Id = 7\r\n\r\n\r\nSimVertex 5 = (-91.8433,70.2733,-140.653,6.42592e-09), 4, 5\r\n\r\n  SimTrack 7 = 22, (-1.93526,1.49976,-2.99142,3.86563), 5, -1 Track Id = 8\r\n  SimTrack 8 = -11, (-5.36472,4.15773,-8.29391,10.7171), 5, -1 Track Id = 9\r\n\r\n\r\nSimVertex 6 = (-91.905,70.3211,-140.749,6.43004e-09), 9, 6\r\n\r\n  SimTrack 9 = 22, (-0.000820454,0.000635435,-0.00126899,0.00163929), 6, -1 Track Id = 10\r\n```\r\n\r\nprovides as hits:\r\n\r\n```\r\n11:09 farmui02 el8:x86_64 1297> grep -e ^Begin -e \"MtdSD: T\" cmsExec_SingleGammaPt10_pythia8_cfi_GEN_SIM_20241217_110419.log | head -n 10\r\nBegin processing the 1st record. Run 1, Event 1, LumiSection 1 on stream 0 at 17-Dec-2024 11:05:59.880 CET\r\nMtdSD: Track ID: 4 BTL Track ID: 2:4\r\nMtdSD: Track ID: 4 BTL Track ID: 2:4\r\nMtdSD: Track ID: 4 BTL Track ID: 2:4\r\nMtdSD: Track ID: 4 BTL Track ID: 2:4\r\nMtdSD: Track ID: 9 BTL Track ID: 2:9\r\nMtdSD: Track ID: 9 BTL Track ID: 2:9\r\nMtdSD: Track ID: 42 BTL Track ID: 2:600000012\r\nMtdSD: Track ID: 160 BTL Track ID: 2:600000012\r\nMtdSD: Track ID: 848 BTL Track ID: 2:600000012\r\n```", "branch": "master", "changed_files": 15, "closed_at": "1734599832", "comments": 25, "commits": 9, "created_at": "1734426652", "deletions": 12, "labels": ["simulation-approved", "fully-signed", "tests-approved", "orp-approved", "code-checks-approved"], "merge_commit_sha": "f71ba88e321728167226786f2514240cb8547086", "merged_at": "1734599832", "merged_by": "cmsbuild", "milestone": "CMSSW_15_0_X", "number": 46970, "release-notes": [], "review_comments": 3, "state": "closed", "title": "MTD simulation: update hit classification, extend it to ETL, add last stored ancestor information to TrackInformation", "updated_at": "1734599833", "user": "fabiocos"}