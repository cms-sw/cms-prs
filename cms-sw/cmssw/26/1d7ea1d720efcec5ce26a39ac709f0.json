{"additions": 531, "auther_ref": "furtherOptSiPixelLorentzAnglePCLWorker_12_2_X", "auther_sha": "fb67ef3a3caa70b8af111bc3ae520bacdf365ad7", "author": "mmusich", "body": "backport of #36565 and #36538\r\n\r\n#### PR description:\r\n\r\nMiscellanea updates and bug-fixes to the SiPixel LA PCL workflow that are built on top of the replay at https://github.com/dmwm/T0/pull/4635. \r\n\r\n\r\n   * made the processing much faster by calling `SiPixelTemplate::pushfile` in `dqmBeginRun`  instead of the `analyze` method;\r\n   * add basic accepted tracks monitoring;\r\n   * adding plot titles;\r\n   * re-organize folders to have subfolders: (Top) / (BPix) / etc. ..;\r\n   * actually *do* write to DB the values for the \"new\" modules when they are fit;\r\n   * change the default cut value on the fit probability for writing out the payload from 0.5 to 0.1;\r\n   * fix a bug that was causing populating the lists of \"new\" modules and modules attached to a given \"sector\" multiple times (this was triggering several warnings in the harvesting step when populating the DB about multiple `put`s, see https://github.com/cms-sw/cmssw/pull/36535);\r\n   * further memory footprint reduction is achieved in commit 69b9256f3d0be42121c826f63094094fee22375a by loading the `SiPixelTemplate` object in memory on demand in the case in which the module `SiPixelLorentzAnglePCLWorker` is not run in PCL mode (`notInPCL_ = True`) and by reducing the number of bins of the 2D drift vs depth maps.\r\n   * for Run2 replays the list of \"new\" modules is different. That is dealt with via era modifiers;\r\n   * a bug that was messing up the computation of the value of the Lorentz Angle for the \"new\" modules is addressed;\r\n   * monitoring of the input number of clusters and output Lorentz Angle (and fit chi2/ndf) is introduced;\r\n   * `std::endl` at the end of LogMessages is removed as requested at https://github.com/cms-sw/cmssw/pull/36538#issuecomment-998643023 in commit 0cfb6bf446943c82b59b37bd66c4062fd3b8c080\r\n   * some documentation is added;\r\n    \r\n#### PR validation:\r\n\r\nPrivately run:\r\n\r\n```console\r\n cmsDriver.py testReAlCa -s ALCA:PromptCalibProdSiPixelLorentzAngle --conditions 121X_dataRun3_Express_TIER0_REPLAY_Run2_v1 --scenario pp --data --era Run2_2018 --datatier ALCARECO --eventcontent ALCARECO --processName=ReAlCa -n 100000 --dasquery='file dataset=/StreamExpress/Tier0_REPLAY_2021-SiPixelCalSingleMuon-Express-v1/ALCARECO' --customise_commands='process.ALCARECOCalSignleMuonFilterForSiPixelLorentzAngle.TriggerResultsTag = cms.InputTag ( \"TriggerResults\",\"\",\"HLT\" ) ; process.ALCARECOCalSignleMuonFilterForSiPixelLorentzAngle.HLTPaths = [\"*\"]' --nThreads=4 \r\n```\r\n\r\nfollowed by:\r\n\r\n```console\r\n cmsDriver.py stepHarvest -s ALCAHARVEST:SiPixelLA --conditions 121X_dataRun3_Express_TIER0_REPLAY_Run2_v1 --scenario pp --data --era Run2_2018 --filein file:PromptCalibProdSiPixelLorentzAngle.root -n -1\r\n```\r\n\r\n#### Profiling the RSS vs time of the job containing the `ALCA:PromptCalibProdSiPixelLorentzAngle` (run on 4 threads and 4 stream) on 100k events shows a **reduction of about 40% in RSS memory and of 20 times in computing wall-clock time**.\r\n![memory_PR_12_2_X](https://user-images.githubusercontent.com/5082376/149547499-90c976bb-ab49-4bd7-a4ef-747bc84dc1b4.png)\r\n\r\n#### if this PR is a backport please specify the original PR and why you need to backport that PR:\r\n\r\nThis is a combined backport of PRs https://github.com/cms-sw/cmssw/pull/36565 and https://github.com/cms-sw/cmssw/pull/36538 to CMSSW_12_2_X  as agreed at https://github.com/cms-sw/cmssw/pull/36538#issuecomment-997386926 in order to perform a new Tier-0 replay.", "branch": "CMSSW_12_2_X", "changed_files": 6, "closed_at": "1642386564", "comments": 10, "commits": 19, "created_at": "1642173005", "deletions": 292, "labels": ["alca-approved", "fully-signed", "tests-approved", "bug-fix", "orp-approved", "backport-ok"], "merge_commit_sha": "c74088b68fe5dbaf86c865182b11a0bc721ddd88", "merged_at": "1642386564", "merged_by": "cmsbuild", "milestone": "CMSSW_12_2_X", "number": 36711, "release-notes": [], "review_comments": 0, "state": "closed", "title": " [12.2.X] Further optimization of the SiPixel LA PCL workflow", "updated_at": "1642386565", "user": "mmusich"}