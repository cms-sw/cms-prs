{"additions": 125, "auther_ref": "optimize-finecalo-cleanedup", "auther_sha": "7ccd4306e2fa8be70a58d592e185434ce6621651", "author": "tklijnsma", "body": "#### PR description:\r\n\r\nThis patch streamlines the finecalo patch ([PR 32673)](https://github.com/cms-sw/cmssw/pull/32673).\r\n\r\n  - The lookups of the boundary-crossing parent of a track are no longer done in the `createNewHit` method of CaloSD, but only once per track.\r\n  - Boundary-crossing parent lookups are also cached in a map in CaloSD, which leads to a lot less lookups. (A 'lookup' consists of traversing the track history via the SimTrackManager, which is expensive.)\r\n  - Some needless attributes from the CaloHitID classes are removed again.\r\n  - Fixed a bug where in very rare cases hits would still be assigned to the primary rather than the boundary crossing parent.\r\n  - Line 309 in CaloTrkProcessing.cc (introduced in [PR 33056](https://github.com/cms-sw/cmssw/pull/33056)) is disabled for finecalo, as it changes the behavior of finecalo.\r\n\r\nThe CPU time needed per event is about 20% more than default CMSSW (hard to quantify the exact time difference due to slightly varying usage of the compute nodes I am using). This is a significant improvement w.r.t. to the finecalo patch 1, which was anywhere between 100% and 500% slower depending on the simulated event topology (it used to scale with the depth of the decay tree - the cache reduces the complexity of the algorithm immensely).\r\n\r\nPlot of the RSS as a function of time (orange = this patch, green = the previous patch, blue = default CMSSW):\r\n\r\n<img width=\"599\" alt=\"rss_over_time_ttbar\" src=\"https://user-images.githubusercontent.com/11268158/126683112-c3903491-c307-49d4-8d38-9ed01a01d08e.png\">\r\n\r\n#### PR validation:\r\n\r\nI checked event displays of ttbar and of a tau gun, and it looks in order.\r\n", "branch": "master", "changed_files": 6, "closed_at": "1628330383", "comments": 44, "commits": 2, "created_at": "1626968294", "deletions": 156, "labels": ["simulation-approved", "fully-signed", "tests-rejected", "orp-approved", "upgrade-approved", "code-checks-approved"], "merge_commit_sha": "68591f5bc1fc03eb4e5f6d46c56c3bc740173984", "merged_at": "1628330383", "merged_by": "cmsbuild", "milestone": "CMSSW_12_1_X", "number": 34597, "release-notes": [], "review_comments": 9, "state": "closed", "title": "Fixed finecalo performance", "updated_at": "1628330383", "user": "tklijnsma"}