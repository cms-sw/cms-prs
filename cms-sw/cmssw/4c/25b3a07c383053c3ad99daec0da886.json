{"additions": 1898, "auther_ref": "from-CMSSW_15_1_0_pre4", "auther_sha": "d23db6b36a8926464200eeec585b997cda4baadb", "author": "leonardogiannini", "body": "#### PR description:\r\n\r\nThe PR includes a prototype of the final fit using mkFit, aimed at reducing the fitting time (comparable to the building time in some cases where mkFit is used), and a testing workflow in phase2 HLT (29634.7572). The \"final fit\" part of the code has been presented at the tracking POG (see [slides](https://indico.cern.ch/event/1586902/contributions/6717655/attachments/3145724/5584825/update-mkFit-phase2.pdf)).\r\n\r\nThe parallelization happens across groups of tracks with the same number of hits, used to fill the mkFit matriplex, while the vectorization is guaranteed by the usage of mkFit data structures and calculations.\r\n\r\n\r\n\r\n- the core of the fit is in MkFitter.cc, previously unused and now completely rewritten, with these functions\r\n\r\n```\r\nvoid fwdFitInputTracks(TrackVec &cands, std::vector<int> inds, int beg, int end);\r\nvoid fwdFitFitTracks(const EventOfHits &eventofhits,\r\n                     const int N_proc,\r\n                     int nFoundHits,\r\n                     std::vector<std::vector<int>> indices_R2Z,\r\n                     float *chi2);\r\nvoid bkReFitInputTracks(TrackVec &cands, std::vector<int> inds, int beg, int end);\r\nvoid bkReFitFitTracks(const EventOfHits &eventofhits,\r\n                      const int N_proc,\r\n                      int nFoundHits,\r\n                      std::vector<std::vector<int>> indices_R2Z,\r\n                      float *chi2);\r\nvoid reFitOutputTracks(TrackVec &cands, std::vector<int> inds, int beg, int end, int nFoundHits, bool bkw = false);\r\nstd::vector<std::vector<int>> reFitIndices(const EventOfHits &eventofhits, const int N_proc, int nFoundHits);\r\n```\r\n\r\n- the fit is called by MkBuilder.cc, via the wrapper\r\n\r\n```   \r\nvoid fittracks();\r\n\r\n```\r\n\r\n- and the main function, which handles track batches\r\n\r\n```\r\nvoid fit_tracks(MkFitter *mkfitter,\r\n                    int nFoundTracks,\r\n                    std::vector<int> inds,\r\n                    int start_trk,\r\n                    int end_trk,\r\n                    std::map<int, std::vector<int>> *remap = nullptr);\r\n```\r\n\r\n- the fit includes a simple outlier rejection by chi2, handled by the function above. The outlier rejection removes hits based on chi2 and remaps the tracks into the new groups by hit number if passed a map pointer.\r\n- The plugins added are `RecoTracker/MkFit/plugins/MkFitFitProducer.cc` and `RecoTracker/MkFit/plugins/MkFitOutputTrackConverter.cc`\r\n- `RecoTracker/MkFit/plugins/MkFitFitProducer.cc` is used to call the fit. The same tracks are exported and reimported into mkFit, even though the fit could be run internally without copying objects, in order to preserve the modularity. It also the ability to preselect tracks before fitting, mimicking `RecoTracker/MkFit/plugins/MkFitOutputConverter.cc`\r\n- `RecoTracker/MkFit/plugins/MkFitOutputTrackConverter.cc` is used to transform the mkFit output into Track format, bypassing the TrackCandidate format. It is also used to count the missing inner/outer layers. The Trajectory format is missing. This is not a problem in HLT workflows, but the integration into offline tracking requires more work\r\n- CPE, coming from outside mkfit, is used for the pixel tracks. The CPE is imported via a lambda function defined in `RecoTracker/MkFit/plugins/MkFitFitProducer.cc`. The CPE is called in `RecoTracker/MkFitCore/src/KalmanUtilsMPlex.cc`.\r\n\r\n#### PR validation:\r\n\r\nThe PR is validated at HLT with legacy seeds, using mkFit on the hltInitialStepTracks, and comparing mkFit build + CKF fit to mKFit build + mkFit fit, and on top of the workflow 29634.7571, again comparing mkFit build + CKF fit to mKFit build + mkFit fit.\r\n\r\nIn [LegacyCompareFit](http://uaf-10.t2.ucsd.edu/~legianni/FitPRplots/plotsLegacyCompareFit) the hltInitialStepTrackSelectionHighPurity has different response to the current selection, comparable resolution to CKF fit, negative pT bias.\r\n\r\nOverall the hltGeneral collection is comparable in efficiency, fake rate and resolution (the highPtTriplet compensates the slight loss with this selection).\r\n\r\nIn [7571CompareFit](http://uaf-10.t2.ucsd.edu/~legianni/FitPRplots/plots7571CompareFit) the hltGeneral collection shows comparable efficiency, slightly higher fake rate, comparable resolution and again a negative bias in the reconstructed pT.\r\n\r\nThe timing is measured for the example configuration with legacy seeds and for the 7571 vs 7572 workflow:\r\n\r\n- See trackingOnly timing [leagcy-MkFitBuild](http://uaf-10.t2.ucsd.edu/~legianni/web-circles/web/piechart.php?colours=default&data_name=data&dataset=Timing_legacyMkFitBuild&groups=hlt&local=false&resource=time_real&show_labels=true&show_animations=true&threshold=0)  vs [legacy-MkFitBuildFit](http://uaf-10.t2.ucsd.edu/~legianni/web-circles/web/piechart.php?colours=default&data_name=data&dataset=Timing_legacyMkFitFit&groups=hlt&local=false&resource=time_real&show_labels=true&show_animations=true&threshold=0) \r\n\r\n- Relevant modules for hltInitialStep in table:\r\n\r\n\r\n| | CandidatesMkFit | Candidates | CandidatesMkFitFit | Tracks | Tracks (conv) | Total |\r\n|-:|-----------------:|-----------:|---------------------:|--------:|--------:|--------:|\r\n|MkFit build| 209.4 | 8.6 | | 170.7 | | 388.7 |\r\n|MkFit build+fit| 210.3 | | 26.5 | | 26.5 | 263.3|\r\n\r\n\r\n- See trackingOnly timing for the new workflow [7571](http://uaf-10.t2.ucsd.edu/~legianni/web-circles/web/piechart.php?colours=default&data_name=data&dataset=Timing_7571&groups=hlt&local=false&resource=time_real&show_labels=true&show_animations=true&threshold=0) vs  [7572](http://uaf-10.t2.ucsd.edu/~legianni/web-circles/web/piechart.php?colours=default&data_name=data&dataset=Timing_7572&groups=hlt&local=false&resource=time_real&show_labels=true&show_animations=true&threshold=0) \r\n\r\n- Relevant modules for hltInitialStep in table\r\n\r\n| | CandidatesMkFit | Candidates | CandidatesMkFitFit | Tracks | Tracks (conv) | Total |\r\n|-:|-----------------:|-----------:|---------------------:|--------:|--------:|--------:|\r\n|MkFit build| 83.3 | 17.0 | | 239.4 | | 339.7 |\r\n|MkFit build+fit| 81.5 | | 35.7 | | 34.3 | 151.5|\r\n\r\n\r\n#### Extra comments\r\n\r\nSome tuning and additional validation will be needed before this enters a default (HLT) workflow.\r\nFor the offline setup we should still find a solution to not having a full Trajectory.\r\n", "branch": "master", "changed_files": 23, "comments": 14, "commits": 4, "created_at": "1762458246", "deletions": 393, "labels": ["reconstruction-pending", "hlt-pending", "operations-approved", "pending-signatures", "tests-approved", "orp-pending", "pdmv-pending", "code-checks-approved", "tracking"], "milestone": "CMSSW_16_0_X", "number": 49339, "release-notes": [], "review_comments": 13, "state": "open", "title": "[mkFit] final fit initial PR and testing workflow", "updated_at": "1762817630", "user": "leonardogiannini"}