{"additions": 4114, "auther_ref": "thinningSlimming", "auther_sha": "b1c8f445edd916e632840bc3e21e8b9cc9e3753f", "author": "makortel", "body": "#### PR description:\r\n\r\nThis PR extends the framework's thinning feature to support slimming as outlined in https://github.com/cms-sw/cmssw/pull/30544#issuecomment-659771991:\r\n* If there are both thinned and thinned+slimmed collections present, a de-reference of Ref-to-parent goes always only to the thinned collections\r\n   * Even if none of the thinned collections contain the requested element (in which case `nullptr` is returned) and the thinned+slimmed collection would contain the requested element\r\n   * I.e. Ref de-reference means\r\n      * if parent collection is available, return element in it\r\n      * else if any thinned collection (branch) exists\r\n         * if a thinned collection containing the element is available, return the element\r\n         * else return `nullptr`\r\n      * else if a slimmed collection (branch) exists, take the first slimmed collection searching downward through the parentage tree of thinned/slimmed collections, and apply this algorithm recursively with the slimmed collection as the parent collection\r\n      * else return `nullptr`\r\n* The parentage tree of thinned and thinned+slimmed collections may have at most one path from the root (parent) collection to any leaf collection that has slimmed collections visible in that job\r\n   * i.e. one can do e.g. `parent -> slimmed1 -> thinned2 -> slimmed3`, but not any of\r\n      ```\r\n      parent --> slimmed11\r\n             \\-> slimmed21\r\n\r\n      parent --> thinned11 -> slimmed12\r\n             \\-> thinned21 -> slimmed22\r\n\r\n      parent --> thinned11 -> slimmed12\r\n             \\-> slimmed21 -> thinned22\r\n      ```\r\n   * Notably having `slimmed1X` and `slimmed2Y` modules in separate jobs is allowed, assuming the other slimmed products are not visible there.\r\n      * Trying to read both `slimmed1X` and `slimmed2Y` from different files (via primary and secondary inputs) results an error\r\n\r\nIn addition, this PR\r\n* adds an implementation of `thinnedRefFrom()` (suggested in https://github.com/cms-sw/cmssw/pull/30544#issuecomment-655506600) in a way that does not lead to asking asking products from ProductResolvers (https://github.com/cms-sw/cmssw/pull/30544#issuecomment-657605835)\r\n* adds support for thinning `edmNew::DetSetVector` (needed for #30445)\r\n* adds `ThinnedRefSet` to help with `Selector` to keep track of keys to input collection that may come from any of the parent collections in the parentage tree of thinned collections\r\n* adds `reset()` function to be required on the thinning `Selector` classes. It will be called after the object loop to allow clearing any intermediate data structures.\r\n\r\n#### PR validation:\r\n\r\nFramework unit tests pass.", "branch": "master", "changed_files": 76, "closed_at": "1599028331", "comments": 74, "commits": 22, "created_at": "1596841672", "deletions": 160, "labels": ["code-checks-approved", "comparison-available", "core-approved", "fully-signed", "orp-approved", "tests-approved"], "merge_commit_sha": "d4d452e55762746f74348a21fefef0c56ebbbf2e", "merged_at": "1599028331", "merged_by": "cmsbuild", "milestone": "CMSSW_11_2_X", "number": 31100, "release-notes": [], "review_comments": 39, "state": "closed", "title": "Extend thinning to support slimming", "updated_at": "1599028332", "user": "makortel"}