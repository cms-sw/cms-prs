{"additions": 1723, "auther_ref": "devel-mpi-nightly", "auther_sha": "e06a51e0b28bbefc95310a1519250363bac65ffb", "author": "ghyls", "body": "#### PR description:\r\n\r\nThis adds support for device products to the serialisation mechanism under `HeterogeneousCore/TrivialSerialisation`.\r\n\r\nIt implements an alpaka Plugin Factory under `HeterogeneousCore/TrivialSerialisation/interface/alpaka/` similar to the existing host one. Some of the features of this new Plugin Factory are:\r\n\r\n- There is one factory per backend. This is to prevent the \"multiple definitions of plugin X found in different files\" error when two `.so` files define the same plugin from the same factory, for separate backends. The factory registration is as follows:\r\n```cpp\r\nEDM_REGISTER_PLUGINFACTORY(ALPAKA_ACCELERATOR_NAMESPACE::ngt::SerialiserFactoryPortable,\r\n                           \"SerialiserFactoryPortable@\" EDM_STRINGIZE(ALPAKA_ACCELERATOR_NAMESPACE));\r\n```\r\nAnother option was to keep a single factory and attach the `ALPAKA_ACCELERATOR_NAMESPACE` to every plugin, but I found this one to be cleaner.\r\n\r\n- Plugins for device collections are registered via the `DEFINE_PORTABLE_TRIVIAL_SERIALISER_PLUGIN(TYPE, NAME)` macro, where, \r\n  - `TYPE` is the inner product type (e.g. PortableDeviceCollection<...>), not wrapped in DeviceProduct.\r\n  - `NAME` is a human-readable type that can be used to retrieve the serialiser for `TYPE`. This is particularly intended to be used in python files, instead of the complex mangled types. This pattern could be propagated to the existing host plugin factory.\r\n  \r\nFor example, a plugin might be registered as follows:\r\n```cpp\r\nDEFINE_PORTABLE_TRIVIAL_SERIALISER_PLUGIN(ALPAKA_ACCELERATOR_NAMESPACE::hcal::RecHitDeviceCollection,\r\n                                          \"hcal::RecHitDeviceCollection\");\r\n```\r\nand then referred to from a configuration:\r\n```python\r\n    products = cms.VPSet(\r\n    cms.PSet(\r\n        type = cms.string(\"hcal::RecHitDeviceCollection\"),\r\n        ...\r\n```\r\n\r\nThis PR also fixes the header guards of some headers from the non-alpaka serialisation mechanism, and adds plugin definitions for various types in DataFormats.\r\n\r\n#### PR validation:\r\n\r\nThe following tests are included in the PR:\r\n\r\n- `DataFormats/TrivialSerialisation/test/alpaka/test_catch2_MemoryCopyTraitsPortable.dev.cc`\r\n- `HeterogeneousCore/TrivialSerialisation/test/alpaka/test_catch2_portableCollectionsSerialiserPluginFactory.dev.cc`\r\n- `cmsRun ${LOCALTOP}/src/HeterogeneousCore/TrivialSerialisation/test/testGenericClonerPortable_cfg.py`, in `HeterogeneousCore/TrivialSerialisation/test/BuildFile.xml`.\r\n\r\nA description of the tests are included at the top of each file.\r\nAll tests pass.", "branch": "master", "changed_files": 45, "comments": 9, "commits": 1, "created_at": "1771257230", "deletions": 66, "labels": ["reconstruction-pending", "simulation-pending", "core-pending", "pending-signatures", "tests-pending", "orp-pending", "code-checks-approved", "heterogeneous-pending", "tracking"], "milestone": "CMSSW_16_1_X", "number": 50154, "release-notes": [], "review_comments": 5, "state": "open", "title": "Extend the `HeterogeneousCore/TrivialSerialisation` mechanism to device products", "updated_at": "1771599808", "user": "ghyls"}