{"additions": 7, "auther_ref": "geant4mt_fix_G4Event", "auther_sha": "a52ca19fd445e806a25a6997b2d5a0b06ce341ba", "author": "makortel", "body": "Fix the segfault in workflow 122.0 in THREADED build.\n\nThe segfault originates from the destruction of G4Event, which is a unique_ptr member of RunManagerMTWorker. It turns out that G4Event holds thread-local stuff, including effectively G4Allocator (via G4PrimaryParticle). In wf 122.0 it happens (usually) that G4Event (and the G4PrimaryPartifle-related G4Allocator) get\n- destructed in a different thread they were constructed, and\n- destructed twice in this thread.\n\nIn this case it is the dual-destruction that causes the segfault (G4Allocator being nullptr in the second destruction), but the first point needs to be fixed too.\n\nA straightforward fix is to move G4Event to thread-local storage (among other thread-oriented stuff).\n\nIn addition to 122.0, tested with 2.0 in CMSSW_7_4_THREADED_X_2015-01-19-1400 giving identical results.\n\n@civanch @Dr15Jones \n", "branch": "CMSSW_7_4_X", "changed_files": 2, "closed_at": "1421860413", "comments": 11, "commits": 1, "created_at": "1421841672", "deletions": 7, "labels": ["comparison-pending", "fully-signed", "simulation-approved", "tests-approved"], "merge_commit_sha": "0f85b2e692a933c09b709fc19ac9b224b6b18d3e", "merged_at": "1421860413", "merged_by": "cmsbuild", "milestone": "Next CMSSW_7_4_X", "number": 7303, "release-notes": [], "review_comments": 0, "state": "closed", "title": "Move G4Event to TLS in RunManagerMTWorker", "updated_at": "1476951491", "user": "makortel"}