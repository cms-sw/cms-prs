{"additions": 108, "auther_ref": "fastsim-refine-btagdeepflav-CHS_from-CMSSW_13_0_X_2023-01-17-1100", "auther_sha": "324d88e17e5fca91cd6517899cfbd7bde3c40143", "author": "wolfmor", "body": "#### PR description:\r\n\r\nRequires: https://github.com/cms-data/PhysicsTools-NanoAOD/pull/14\r\n\r\nThis PR adds a function that uses a regression neural network to refine the DeepJet discriminators of CHS jets in NanoAOD for FastSim to better match FullSim. The function can be called by including the option `--customise PhysicsTools/NanoAOD/jetsAK4_CHS_cff.nanoAOD_refineFastSim_bTagDeepFlav` in the cmsDriver command and requires the ONNX model added in the above mentioned PR to cms-data. The original values are copied to new variables named with the suffix \"unrefined\".\r\n\r\nDue to a bug in ONNX runtime 1.10.0 (see [here](https://github.com/microsoft/onnxruntime/issues/10305)) graph optimization has to be disabled to evaluate the model. The corresponding option is implemented in BaseMVAValueMapProducer for the ONNX backend.\r\n\r\nThe technique has been presented at the [FastSim Days 2022 Workshop](https://indico.cern.ch/event/1191657/contributions/5016864/). There are plans to make this the default for FastSim in the future and possibly to extend to further collections/variables.\r\n\r\nA complete set of commands to produce NanoAOD files with refined DeepJet discriminators is:\r\n\r\n`cmsDriver.py TTbar_13TeV_TuneCUETP8M1_cfi  --relval 100000,1000 -s GEN,SIM,RECOBEFMIX,DIGI:pdigi_valid,L1,DIGI2RAW,L1Reco,RECO,VALIDATION:@standardValidation,DQM:@standardDQMFS -n 10 --conditions auto:run2_mc --beamspot Realistic25ns13TeV2016Collision --datatier GEN-SIM-DIGI-RECO,DQMIO --eventcontent FEVTDEBUGHLT,DQM --fast  --era Run2_2016\r\nGEN,SIM,RECOBEFMIX,DIGI:pdigi_valid,L1,DIGI2RAW,L1Reco,RECO,VALIDATION:@standardValidation,DQM:@standardDQMFS`\r\n\r\n`cmsDriver.py step3  -s PAT --era Run2_2016 -n -1 --conditions auto:run2_mc --mc  --datatier MINIAODSIM --eventcontent MINIAODSIM --filein file:TTbar_13TeV_TuneCUETP8M1_cfi_GEN_SIM_RECOBEFMIX_DIGI_L1_DIGI2RAW_L1Reco_RECO_VALIDATION_DQM.root --fast`\r\n\r\n`cmsDriver.py  --python_filename NanoAODrefined_cfg.py --eventcontent NANOAODSIM --fast --customise Configuration/DataProcessing/Utils.addMonitoring,PhysicsTools/NanoAOD/jetsAK4_CHS_cff.nanoAOD_refineFastSim_bTagDeepFlav --datatier NANOAODSIM --fileout file:step3_NANO.root --conditions auto:run2_mc --step NANO --filein \"file:step3_PAT.root\" --era run2_nanoAOD_106Xv2 --mc -n -1`\r\n\r\n#### PR validation:\r\n\r\nThe neural network has been trained on GEN-synchronized FastSim/FullSim jet pairs from SUSY simplified model T1tttt events and has been validated also in TTbar events. In both cases, considerably improved agreement with the FullSim output and an improvement in correlations among output observables and external parameters is seen.\r\n\r\n#### If this PR is a backport please specify the original PR and why you need to backport that PR. If this PR will be backported please specify to which release cycle the backport is meant for:\r\n\r\nNeeds to be backported to 12_6.\r\n\r\n@sbein @kpedro88 \r\n", "branch": "master", "changed_files": 4, "comments": 12, "commits": 4, "created_at": "1674025811", "deletions": 33, "labels": ["reconstruction-pending", "pending-signatures", "orp-pending", "pdmv-pending", "tests-started", "upgrade-pending", "requires-external", "code-checks-approved", "xpog-pending", "btv"], "milestone": "CMSSW_13_0_X", "number": 40553, "release-notes": [], "review_comments": 0, "state": "open", "title": "Add function to refine FastSim DeepJet discriminators", "updated_at": "1674478662", "user": "wolfmor"}