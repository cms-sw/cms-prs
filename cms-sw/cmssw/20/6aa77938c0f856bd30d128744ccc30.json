{"additions": 97, "auther_ref": "mc-simBTL-OOT-fixPreMixing", "auther_sha": "3a350ad22733dca5412059943ff21b535b893151", "author": "casarsa", "body": "#### PR description:\r\n\r\nThis PR improves the BTL digitization including the effects on time resolution due to the photon tails of earlier OOT hits in the same crystal, like in PR #28433, and fixes the memory issue that had emerged when testing the premixing for that PR.\r\n\r\nThe cause of the problem was that the method that packs the SIM hits info into the premix bank expects times expressed modulo 25n, but that was not my case. As a consequence, the bit word with the SIM info was corrupted and the unpacking resulted into an overflowing index.\r\n\r\n\r\n#### PR validation:\r\n\r\nThis branch has been tested in CMSSW_11_0_0_pre13 with the TTbar WFs 22234.0 and 22234.99.\r\n\r\n--------------------------------------\r\n**WF 22234.0**\r\n\r\n**step 2:**\r\n\r\nMemoryReport> Peak virtual size 7964.15 Mbytes\r\n Key events increasing vsize: \r\n[60] run: 1 lumi: 1 event: 60  vsize = 6286.11 deltaVsize = 640 rss = 3096.59 delta = 206.461\r\n[249] run: 1 lumi: 1 event: 249  vsize = 7068.14 deltaVsize = 782 rss = 2927.33 delta = -169.258\r\n[485] run: 1 lumi: 1 event: 485  vsize = 7964.15 deltaVsize = 896 rss = 3123.05 delta = 195.715\r\n[0] run: 0 lumi: 0 event: 0  vsize = 0 deltaVsize = 0 rss = 0 delta = 0\r\n[0] run: 0 lumi: 0 event: 0  vsize = 0 deltaVsize = 0 rss = 0 delta = 0\r\n[487] run: 1 lumi: 1 event: 487  vsize = 7964.15 deltaVsize = 0 rss = 3021.71 delta = -101.34\r\n[486] run: 1 lumi: 1 event: 486  vsize = 7964.15 deltaVsize = 0 rss = 3107.3 delta = -15.75\r\n[485] run: 1 lumi: 1 event: 485  vsize = 7964.15 deltaVsize = 896 rss = 3123.05 delta = 124.598\r\nTimeReport> Time report complete in 44014 seconds\r\n Time Summary: \r\n - Min event:   65.8531\r\n - Max event:   110.886\r\n - Avg event:   87.1839\r\n - Total loop:  43980.1\r\n - Total init:  33.3893\r\n - Total job:   44014\r\n - EventSetup Lock:   8.51154e-05\r\n - EventSetup Get:   76.1835\r\n Event Throughput: 0.0113688 ev/s\r\n CPU Summary: \r\n - Total loop:  41805.5\r\n - Total init:  11.4153\r\n - Total extra: 0\r\n - Total job:   41817.4\r\n\r\n**step 3**\r\n\r\nMemoryReport> Peak virtual size 12965.9 Mbytes\r\n Key events increasing vsize: \r\n[32] run: 1 lumi: 1 event: 32  vsize = 10146.7 deltaVsize = 1024 rss = 6783.16 delta = 280.848\r\n[143] run: 1 lumi: 1 event: 143  vsize = 11426.8 deltaVsize = 1280 rss = 6918.56 delta = 135.406\r\n[408] run: 1 lumi: 1 event: 408  vsize = 12962.9 deltaVsize = 1535 rss = 7269.84 delta = 351.277\r\n[492] run: 1 lumi: 1 event: 492  vsize = 12965.9 deltaVsize = 3 rss = 7312.45 delta = 42.6055\r\n[0] run: 0 lumi: 0 event: 0  vsize = 0 deltaVsize = 0 rss = 0 delta = 0\r\n[494] run: 1 lumi: 1 event: 494  vsize = 12963.9 deltaVsize = -2 rss = 6955.95 delta = -356.496\r\n[493] run: 1 lumi: 1 event: 493  vsize = 12963.9 deltaVsize = -2 rss = 7115.16 delta = -197.281\r\n[492] run: 1 lumi: 1 event: 492  vsize = 12965.9 deltaVsize = 3 rss = 7312.45 delta = 42.6055\r\nTimeReport> Time report complete in 89719 seconds\r\n Time Summary: \r\n - Min event:   104.361\r\n - Max event:   346.13\r\n - Avg event:   175.392\r\n - Total loop:  89587.9\r\n - Total init:  121.492\r\n - Total job:   89719\r\n - EventSetup Lock:   0.000196457\r\n - EventSetup Get:   83.9121\r\n Event Throughput: 0.00558111 ev/s\r\n CPU Summary: \r\n - Total loop:  82191.3\r\n - Total init:  96.2134\r\n - Total extra: 0\r\n - Total job:   82296.5\r\n\r\n--------------------------------------\r\n**WF 22234.99**\r\n\r\npremix bank size:\r\n\r\n> MTDSimAccumulator_mix_FTLBarrel_DIGI. 2.97066e+06 2.39297e+06\r\n> PMTDSimAccumulator_mix_FTLEndcap_DIGI. 1.33694e+06 779230\r\n\r\n\r\n**step 3**\r\n\r\nMemoryReport> Peak virtual size 5278.37 Mbytes\r\n Key events increasing vsize: \r\n[2] run: 1 lumi: 1 event: 2  vsize = 4446.24 deltaVsize = 12 rss = 2998.72 delta = -134.793\r\n[16] run: 1 lumi: 1 event: 16  vsize = 4830.32 deltaVsize = 384 rss = 2981.2 delta = -17.5234\r\n[458] run: 1 lumi: 1 event: 458  vsize = 5278.37 deltaVsize = 448 rss = 3136.12 delta = 154.93\r\n[0] run: 0 lumi: 0 event: 0  vsize = 0 deltaVsize = 0 rss = 0 delta = 0\r\n[0] run: 0 lumi: 0 event: 0  vsize = 0 deltaVsize = 0 rss = 0 delta = 0\r\n[460] run: 1 lumi: 1 event: 460  vsize = 5278.37 deltaVsize = 0 rss = 3103.74 delta = -32.3867\r\n[459] run: 1 lumi: 1 event: 459  vsize = 5278.37 deltaVsize = 0 rss = 3062.41 delta = -73.7148\r\n[458] run: 1 lumi: 1 event: 458  vsize = 5278.37 deltaVsize = 448 rss = 3136.12 delta = 3.17578\r\nTimeReport> Time report complete in 24610.4 seconds\r\n Time Summary: \r\n - Min event:   39.9079\r\n - Max event:   104.543\r\n - Avg event:   48.7014\r\n - Total loop:  24556\r\n - Total init:  53.7632\r\n - Total job:   24610.4\r\n - EventSetup Lock:   7.58171e-05\r\n - EventSetup Get:   67.2327\r\n Event Throughput: 0.0203616 ev/s\r\n CPU Summary: \r\n - Total loop:  22172.9\r\n - Total init:  12.3361\r\n - Total extra: 0\r\n - Total job:   22185.7\r\n\r\n\r\n**step 4**\r\n\r\nMemoryReport> Peak virtual size 9123.34 Mbytes\r\n Key events increasing vsize: \r\n[2] run: 1 lumi: 1 event: 2  vsize = 7422.96 deltaVsize = 660.016 rss = 5336.09 delta = -65.8555\r\n[15] run: 1 lumi: 1 event: 15  vsize = 8227.02 deltaVsize = 768 rss = 5545.06 delta = 208.977\r\n[154] run: 1 lumi: 1 event: 154  vsize = 9123.32 deltaVsize = 896 rss = 5983.21 delta = 438.148\r\n[458] run: 1 lumi: 1 event: 458  vsize = 9123.34 deltaVsize = 0.0195312 rss = 6423.86 delta = 440.652\r\n[0] run: 0 lumi: 0 event: 0  vsize = 0 deltaVsize = 0 rss = 0 delta = 0\r\n[460] run: 1 lumi: 1 event: 460  vsize = 9123.34 deltaVsize = 0 rss = 6370.79 delta = -53.0742\r\n[459] run: 1 lumi: 1 event: 459  vsize = 9123.34 deltaVsize = 0 rss = 6262.03 delta = -161.836\r\n[458] run: 1 lumi: 1 event: 458  vsize = 9123.34 deltaVsize = 0.0195312 rss = 6423.86 delta = 440.652\r\nTimeReport> Time report complete in 81246.8 seconds\r\n Time Summary: \r\n - Min event:   89.7388\r\n - Max event:   467.405\r\n - Avg event:   158.661\r\n - Total loop:  81027.2\r\n - Total init:  166.451\r\n - Total job:   81246.8\r\n - EventSetup Lock:   0.000249386\r\n - EventSetup Get:   101.051\r\n Event Throughput: 0.00617077 ev/s\r\n CPU Summary: \r\n - Total loop:  75961.9\r\n - Total init:  120.744\r\n - Total extra: 0\r\n - Total job:   76134.6\r\n \r\n\r\n=============================================\r\n\r\nIn the case of current code, as a reference:\r\n\r\n**WF 22234.0**\r\n\r\n**step 2**\r\n\r\nMemoryReport> Peak virtual size 6286.12 Mbytes\r\n Key events increasing vsize: \r\n[4] run: 1 lumi: 1 event: 4  vsize = 5134.07 deltaVsize = 448 rss = 3084.34 delta = -16\r\n[15] run: 1 lumi: 1 event: 15  vsize = 5646.11 deltaVsize = 512 rss = 3022.9 delta = -61.4336\r\n[61] run: 1 lumi: 1 event: 61  vsize = 6286.12 deltaVsize = 640 rss = 3414.31 delta = 391.41\r\n[0] run: 0 lumi: 0 event: 0  vsize = 0 deltaVsize = 0 rss = 0 delta = 0\r\n[0] run: 0 lumi: 0 event: 0  vsize = 0 deltaVsize = 0 rss = 0 delta = 0\r\n[63] run: 1 lumi: 1 event: 63  vsize = 6286.12 deltaVsize = 0 rss = 3323.92 delta = -90.3945\r\n[62] run: 1 lumi: 1 event: 62  vsize = 6286.12 deltaVsize = 0 rss = 3402.76 delta = -11.5547\r\n[61] run: 1 lumi: 1 event: 61  vsize = 6286.12 deltaVsize = 640 rss = 3414.31 delta = -82.2305\r\nTimeReport> Time report complete in 9059.45 seconds\r\n Time Summary: \r\n - Min event:   73.8451\r\n - Max event:   114.501\r\n - Avg event:   89.0312\r\n - Total loop:  9016.34\r\n - Total init:  42.7557\r\n - Total job:   9059.45\r\n - EventSetup Lock:   9.46522e-05\r\n - EventSetup Get:   73.5861\r\n Event Throughput: 0.011091 ev/s\r\n CPU Summary: \r\n - Total loop:  8343.95\r\n - Total init:  21.0478\r\n - Total extra: 0\r\n - Total job:   8365.25\r\n\r\n\r\n**step 3**\r\n\r\nMemoryReport> Peak virtual size 10145.7 Mbytes\r\n Key events increasing vsize: \r\n[3] run: 1 lumi: 1 event: 3  vsize = 9089.55 deltaVsize = 4 rss = 6709.96 delta = 18.8125\r\n[6] run: 1 lumi: 1 event: 6  vsize = 9121.55 deltaVsize = 32 rss = 6750.29 delta = 40.3281\r\n[29] run: 1 lumi: 1 event: 29  vsize = 10145.7 deltaVsize = 1024 rss = 7010.46 delta = 260.172\r\n[83] run: 1 lumi: 1 event: 83  vsize = 10145.7 deltaVsize = 0.0273438 rss = 7426.93 delta = 416.469\r\n[46] run: 1 lumi: 1 event: 46  vsize = 10145.7 deltaVsize = 0.0078125 rss = 7203.63 delta = 193.168\r\n[85] run: 1 lumi: 1 event: 85  vsize = 10145.7 deltaVsize = 0 rss = 7077.25 delta = -349.68\r\n[84] run: 1 lumi: 1 event: 84  vsize = 10145.7 deltaVsize = 0 rss = 7218.67 delta = -208.262\r\n[83] run: 1 lumi: 1 event: 83  vsize = 10145.7 deltaVsize = 0.0273438 rss = 7426.93 delta = 223.301\r\nTimeReport> Time report complete in 19135.3 seconds\r\n Time Summary: \r\n - Min event:   129.462\r\n - Max event:   314.8\r\n - Avg event:   185.461\r\n - Total loop:  18963.7\r\n - Total init:  162.735\r\n - Total job:   19135.3\r\n - EventSetup Lock:   0.000247478\r\n - EventSetup Get:   92.7902\r\n Event Throughput: 0.00527324 ev/s\r\n CPU Summary: \r\n - Total loop:  17414.4\r\n - Total init:  117.035\r\n - Total extra: 0\r\n - Total job:   17539.8", "branch": "master", "changed_files": 8, "closed_at": "1580200782", "comments": 25, "commits": 4, "created_at": "1579271599", "deletions": 49, "labels": ["code-checks-approved", "comparison-available", "fully-signed", "orp-approved", "simulation-approved", "tests-approved", "upgrade-approved"], "merge_commit_sha": "2e0839acc2907eff938539cda7196d4b4245706a", "merged_at": "1580200782", "merged_by": "cmsbuild", "milestone": "CMSSW_11_1_X", "number": 28757, "release-notes": [], "review_comments": 0, "state": "closed", "title": "BTL simulation: OOT effects + premix fix", "updated_at": "1580200782", "user": "casarsa"}