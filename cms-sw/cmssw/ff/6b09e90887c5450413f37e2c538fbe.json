{"additions": 1, "auther_ref": "hybridzsfixtruncate8", "auther_sha": "a4bc48d3ac0e501735c57fd51e50df071028ac4b", "author": "pieterdavid", "body": "This change should fix most of the differences observed between standard zero-suppression and the hybrid mode in https://github.com/cms-sw/cmssw/pull/24597 (e.g. in the cluster charge distribution). I'm sorry for figuring it out just after the other PR got merged.\r\nIn the currently planned scenario (10bit hybridZS data taking, 8bit repacking in the HLT), the following happens: for the \"non-flagged\" APVs (without modified baseline), baseline subtraction and zero-suppression are performed, and digis saved with 10bit precision (in the emulation as well as in the FED firmware). When running the remaining zero-suppression in software afterwards, the \"flagged\" APVs are zero-suppressed and their digis brought in the range 0-255 ([255,1022]-> 254, 1023->255), and repacked in the 8bit ZS raw format.\r\nThe problem is that for the non-flagged APVs the 10bit digis were simply [copied](https://github.com/cms-sw/cmssw/blob/998183e58ab4280b63f4cee3059eaae407d89147/RecoLocalTracker/SiStripZeroSuppression/src/SiStripRawProcessingAlgorithms.cc#L82), but the packer [assumes](https://github.com/cms-sw/cmssw/blob/998183e58ab4280b63f4cee3059eaae407d89147/EventFilter/SiStripRawToDigi/plugins/SiStripDigiToRaw.cc#L112) they are also already 8bit-truncated and simply discards the two most significant bits (so `adc % 256` instead of 254 (or 255)). Therefore, clusters with adc>255 strips got a lower total charge or were split.\r\n\r\nThe following plots show the number of digis and clusters, and cluster charge and width, in the hybrid zero-suppressed scenario (red) compared to standard zero-suppression with `process.siStripZeroSuppression.Algorithms.CommonModeNoiseSubtractionMode = \"Median\"` (black) to maximally align the zero-suppression settings, to be compared with those in https://github.com/cms-sw/cmssw/pull/24597#issuecomment-423974148 .\r\n![plotdigistatdiff_ndigis](https://user-images.githubusercontent.com/8883677/46012895-e011f480-c0ca-11e8-80cf-c968aed4035a.png)\r\n![plotclusterstatdiff_nclus](https://user-images.githubusercontent.com/8883677/46012920-ee601080-c0ca-11e8-9931-7c042383e6c4.png)\r\n![plotclusterstatdiff_cluswidth](https://user-images.githubusercontent.com/8883677/46012927-f4ee8800-c0ca-11e8-81b9-6741b1d4bcd8.png)\r\n![plotclusterstatdiff_cluscharge](https://user-images.githubusercontent.com/8883677/46012930-f6b84b80-c0ca-11e8-947a-d5ddd434e8b7.png)\r\n\r\nCC: @icali @CesarBernardes @erikbutz @mmusich @echabert ", "branch": "master", "changed_files": 1, "comments": 16, "commits": 1, "created_at": "1537870149", "deletions": 1, "labels": ["bug-fix", "code-checks-approved", "comparison-available", "orp-pending", "pending-signatures", "reconstruction-pending", "tests-approved"], "milestone": "CMSSW_10_3_X", "number": 24654, "release-notes": [], "review_comments": 0, "state": "open", "title": "Bug fix: truncate when copying digis in hybrid zero-suppression", "updated_at": "1537900150", "user": "pieterdavid"}