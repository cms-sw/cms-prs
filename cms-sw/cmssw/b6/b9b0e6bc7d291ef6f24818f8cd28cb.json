{"additions": 3, "auther_ref": "CUDA_fix_concurrent_EventSetup_filling", "auther_sha": "03b30c3ac500efe6ca2aa949396d4cb00dbffae0", "author": "fwyzard", "body": "#### PR description:\r\n\r\nWhen multiple CUDA streams are trying to initialise the same EventSetup object, the first one to do so starts the asynchronous operations, and the others are supposed to wait for it to finish. However, code for recording the CUDA event was missing, so the other streams would find the default- constructed event, which is always \"valid\".\r\n\r\nAdding the missing call to record the event fixes the problem.\r\n\r\n#### PR validation:\r\n\r\nWithout this PR, running multiple jobs with few threads each crashes fairly soon:\r\n```\r\nRunning indefinitely over 10100 events with 4 jobs, each with 3 threads, 3 streams and 1 GPUs\r\n   373.5    0.1 ev/s (10000 events, 99.8% overlap)\r\n   366.1    0.1 ev/s (10000 events, 99.8% overlap)\r\n   363.5    0.1 ev/s (10000 events, 99.8% overlap)\r\n   362.4    0.1 ev/s (10000 events, 100.0% overlap)\r\n   362.4    0.1 ev/s (10000 events, 99.7% overlap)\r\nThe underlying cmsRun job was killed by signal 6\r\n\r\nThe last lines of the error log are:\r\nModule: none\r\nModule: CAHitNtupletCUDA:hltPixelTracksCUDA\r\nModule: CAHitNtupletCUDA:hltPixelTracksCUDA\r\nModule: CAHitNtupletCUDA:hltPixelTracksCUDA\r\nModule: CAHitNtupletCUDA:hltPixelTracksCUDA\r\n\r\nA fatal system signal has occurred: abort signal\r\n```\r\n\r\nWith this PR, no crash is observed after a large number of tests:\r\n```\r\nRunning indefinitely over 10100 events with 4 jobs, each with 3 threads, 3 streams and 1 GPUs\r\n   372.1    0.1 ev/s (10000 events, 99.9% overlap)\r\n   365.3    0.1 ev/s (10000 events, 99.9% overlap)\r\n   362.5    0.1 ev/s (10000 events, 99.9% overlap)\r\n   361.9    0.1 ev/s (10000 events, 99.6% overlap)\r\n   361.0    0.1 ev/s (10000 events, 99.9% overlap)\r\n   361.3    0.1 ev/s (10000 events, 99.6% overlap)\r\n   361.7    0.1 ev/s (10000 events, 99.9% overlap)\r\n   361.0    0.1 ev/s (10000 events, 99.7% overlap)\r\n   361.2    0.1 ev/s (10000 events, 99.9% overlap)\r\n   361.0    0.1 ev/s (10000 events, 100.0% overlap)\r\n   361.2    0.1 ev/s (10000 events, 99.9% overlap)\r\n   361.8    0.1 ev/s (10000 events, 100.0% overlap)\r\n   361.7    0.1 ev/s (10000 events, 99.8% overlap)\r\n   360.9    0.1 ev/s (10000 events, 99.8% overlap)\r\n   361.2    0.1 ev/s (10000 events, 99.9% overlap)\r\n   361.6    0.1 ev/s (10000 events, 99.9% overlap)\r\n   ...\r\n```\r\n", "branch": "master", "changed_files": 1, "closed_at": "1627966633", "comments": 11, "commits": 1, "created_at": "1627906832", "deletions": 0, "labels": ["bug-fix", "code-checks-approved", "fully-signed", "heterogeneous-approved", "orp-approved", "tests-rejected"], "merge_commit_sha": "0f91c34524ddb0a193c1573fa813ce8d82d1a757", "merged_at": "1627966633", "merged_by": "cmsbuild", "milestone": "CMSSW_12_1_X", "number": 34725, "release-notes": [], "review_comments": 0, "state": "closed", "title": "Fix uploading EventSetup conditions from multiple CUDA streams", "updated_at": "1627966633", "user": "fwyzard"}