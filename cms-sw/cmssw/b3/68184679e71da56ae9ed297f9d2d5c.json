{"additions": 206, "auther_ref": "CMSSW_9_2_3_patch1/sign935/cscRUreproducible", "auther_sha": "404d1d9cdcb8decf3938ea35c37d811689c848b5", "author": "slava77", "body": "make method buildSegments const and move all varying data members to an AlgoState percolated through all methods. \r\n\r\nThis is a somewhat mindless method to make each call independent and resolve the problem with reproducibility running the algorithm in multithreaded mode or otherwise reordered events.\r\nWith this solution the reproducibility is effectively enforced by the compiler.\r\n\r\nThe code is called chamber-by chamber. Clearly, there was a changing memory between calls to build a segment in different chambers. After the constness is enforced, the order of calls between chambers or between events shouldn't matter.\r\n\r\nChanges, compared to the baseline (black CMSSW_9_2_3_patch1) in wf 27411 (10 muons per event)\r\nin one thread:\r\n![all_sign935-mt1vsorig_tenmuextendede2023d17wf27411p0c_cscdetidcscsegmentsownedrangemap_cscsegments__reco_obj_collection__data__degreesoffreedom](https://user-images.githubusercontent.com/4676718/27506679-b63a2d60-5872-11e7-94aa-fc0254132199.png)\r\n\r\nBaseline CMSSW_9_2_3_patch1 comparison between single-thread run (black) and multi-thread (red, using 8 threads)\r\n![all_orig-mt8vsorig_tenmuextendede2023d17wf27411p0c_cscdetidcscsegmentsownedrangemap_cscsegments__reco_obj_collection__data__localposition_x](https://user-images.githubusercontent.com/4676718/27506701-4240604a-5873-11e7-9bc0-98d5889e05d7.png)\r\nin this test the events are still somewhat in order and on the same events there should be no differences. This explains much smaller size of changes in the multithread-single thread.\r\n\r\nAfter the fix there are no differences in the cscSegments distributions in comparison between MT1 and MT8 runs.\r\n", "branch": "master", "changed_files": 2, "closed_at": "1498390105", "comments": 20, "commits": 1, "created_at": "1498282165", "deletions": 191, "labels": ["comparison-available", "fully-signed", "orp-approved", "reconstruction-approved", "tests-approved"], "merge_commit_sha": "59a599d710933374063b2cc3cc897e578c4ff04a", "merged_at": "1498390105", "merged_by": "cmsbuild", "milestone": "CMSSW_9_2_X", "number": 19421, "release-notes": [], "review_comments": 1, "state": "closed", "title": "make RU CSC segment algorithm reproducible by enforcing constness", "updated_at": "1498390105", "user": "slava77"}