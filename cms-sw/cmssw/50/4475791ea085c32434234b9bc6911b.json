{"additions": 47, "auther_ref": "StableFBnew", "auther_sha": "d65010f2efcbca2031f8e95c4375b4e2d533b52e", "author": "VinInn", "body": "The fishbone has been made deterministic and order independent.\r\nThe main change is (of course) removing the ```break```  in the combinatorial double loop.\r\n\r\nresults:\r\n=====\r\n\r\nTiming: \r\n--------\r\n\r\nnegligible effect.\r\n\r\n```\r\nbreak\r\nT4:\r\n   846.7    0.7 ev/s (4900 events)\r\n   831.0    1.5 ev/s (4900 events)\r\n   816.4    1.3 ev/s (4900 events)\r\n   817.1    1.9 ev/s (4900 events)\r\n --------------------\r\n   827.8   14.3 ev/s\r\nA10:\r\n  1126.9    7.9 ev/s (4900 events)\r\n  1100.6    7.7 ev/s (4900 events)\r\n  1126.8    7.6 ev/s (4900 events)\r\n  1103.4    6.2 ev/s (4900 events)\r\n --------------------\r\n  1114.4   14.4 ev/s\r\n\r\n\r\nno break\r\nT4:\r\n   822.0    2.0 ev/s (4900 events)\r\n   827.6    1.7 ev/s (4900 events)\r\n   822.3    1.6 ev/s (4900 events)\r\n   827.1    2.1 ev/s (4900 events)\r\n --------------------\r\n   824.7    3.0 ev/s\r\nA10:\r\n  1187.3    2.7 ev/s (4900 events)\r\n  1121.4    7.8 ev/s (4900 events)\r\n  1132.4    2.2 ev/s (4900 events)\r\n  1096.5    7.1 ev/s (4900 events)\r\n --------------------\r\n  1134.4   38.3 ev/s\r\n```\r\n\r\n\r\n\r\nMTV\r\n-----\r\nslight increase of duplicate (as more fishbone cells are created) for Loose tracks. no effect on HP\r\nhttp://innocent.home.cern.ch/innocent/RelVal/gpuMTVstableFB/\r\n\r\n\r\ndetailed comparison of reproducibility\r\n--------------------------------------\r\n\r\n\r\ncounters on 1000 TTBAR events\r\n```\r\nbreak\r\n||Counters | nEvents | nHits | nCells | nTuples | nFitTacks  |  nLooseTracks  |  nGoodTracks | nUsedHits | nDupHits | nFishCells | nKilledCells | nUsedCells | nZeroTrackCells ||\r\nCounters Raw 1000 11389676 88651895 3908050 1368682 857640 2662036 4878812 3195116 434118 793740 6774466 13927606\r\nCounters Norm 1000 ||  11389.7|  88651.9|  3908.1|  2662.0|  1368.7|  857.6|  4878.8|  3195.1|  0.005|  0.009|  0.076|  0.157||\r\n--\r\nCounters Raw 1000 11389676 88651895 3908121 1368668 857630 2662045 4878809 3195114 434125 793727 6774466 13927643\r\nCounters Norm 1000 ||  11389.7|  88651.9|  3908.1|  2662.0|  1368.7|  857.6|  4878.8|  3195.1|  0.005|  0.009|  0.076|  0.157||\r\n\r\n\r\nno break\r\n|Counters | nEvents | nHits | nCells | nTuples | nFitTacks  |  nLooseTracks  |  nGoodTracks | nUsedHits | nDupHits | nFishCells | nKilledCells | nUsedCells | nZeroTrackCells ||\r\nCounters Raw 1000 11389676 88651895 3906666 1368589 857445 2661798 4878546 3194513 436707 794913 6774466 13928968\r\nCounters Norm 1000 ||  11389.7|  88651.9|  3906.7|  2661.8|  1368.6|  857.4|  4878.5|  3194.5|  0.005|  0.009|  0.076|  0.157|\r\n--\r\nCounters Raw 1000 11389676 88651895 3906666 1368607 857464 2661798 4878546 3194513 436707 794913 6774466 13928968\r\nCounters Norm 1000 ||  11389.7|  88651.9|  3906.7|  2661.8|  1368.6|  857.5|  4878.5|  3194.5|  0.005|  0.009|  0.076|  0.157||\r\n--\r\nCounters Raw 1000 11389676 88651895 3906666 1368608 857449 2661798 4878546 3194513 436707 794913 6774466 13928968\r\nCounters Norm 1000 ||  11389.7|  88651.9|  3906.7|  2661.8|  1368.6|  857.4|  4878.5|  3194.5|  0.005|  0.009|  0.076|  0.157||\r\n\r\n```\r\n\r\n\r\ndump of 10 events\r\n```\r\ncat doDumpTK\r\nsetenv CUDA_VISIBLE_DEVICES 1\r\ncmsRun gpuDebug.py > & bta.log\r\ncmsRun gpuDebug.py > & btb.log\r\ncmsRun gpuDebug.py > & btc.log\r\n\r\ngrep TK bta.log | cut -d ' ' -f 3-100 | sort -g -r > bta.txt\r\ngrep TK btb.log | cut -d ' ' -f 3-100 | sort -g -r > btb.txt\r\ngrep TK btc.log | cut -d ' ' -f 3-100 | sort -g -r > btc.txt\r\ntail -n 4 bt*.log\r\nwc bt*.txt\r\ndiff bta.txt btb.txt | egrep \"<|>\" | wc\r\ndiff bta.txt btc.txt | egrep \"<|>\" | wc\r\ndiff btc.txt btb.txt | egrep \"<|>\" | wc\r\n```\r\n\r\n```\r\nno break\r\n[innocent@patatrack02 ttbar2021]$ source doDumpTK\r\n==> ta.log <==\r\ndropped waiting message count 0\r\n||Counters | nEvents | nHits | nCells | nTuples | nFitTacks  |  nLooseTracks  |  nGoodTracks | nUsedHits | nDupHits | nFishCells | nKilledCells | nUsedCells | nZeroTrackCells ||\r\nCounters Raw 10 121715 1020413 46187 32977 16805 9177 54165 36414 4848 8821 80227 141874\r\nCounters Norm 10 ||  12171.5|  102041.3|  4618.7|  3297.7|  1680.5|  917.7|  5416.5|  3641.4|  0.005|  0.009|  0.079|  0.139||\r\n\r\n==> tb.log <==\r\ndropped waiting message count 0\r\n||Counters | nEvents | nHits | nCells | nTuples | nFitTacks  |  nLooseTracks  |  nGoodTracks | nUsedHits | nDupHits | nFishCells | nKilledCells | nUsedCells | nZeroTrackCells ||\r\nCounters Raw 10 121715 1020413 46187 32977 16806 9178 54165 36414 4848 8821 80227 141874\r\nCounters Norm 10 ||  12171.5|  102041.3|  4618.7|  3297.7|  1680.6|  917.8|  5416.5|  3641.4|  0.005|  0.009|  0.079|  0.139||\r\n\r\n==> tc.log <==\r\ndropped waiting message count 0\r\n||Counters | nEvents | nHits | nCells | nTuples | nFitTacks  |  nLooseTracks  |  nGoodTracks | nUsedHits | nDupHits | nFishCells | nKilledCells | nUsedCells | nZeroTrackCells ||\r\nCounters Raw 10 121715 1020413 46187 32977 16805 9177 54165 36414 4848 8821 80227 141874\r\nCounters Norm 10 ||  12171.5|  102041.3|  4618.7|  3297.7|  1680.5|  917.7|  5416.5|  3641.4|  0.005|  0.009|  0.079|  0.139||\r\n  16807  285717 1975148 ta.txt\r\n  16808  285734 1975272 tb.txt\r\n  16807  285717 1975169 tc.txt\r\n  50422  857168 5925589 total\r\n     71     700    4875\r\n     46     454    3179\r\n     54     513    3563\r\n\r\nbreak\r\n[innocent@patatrack02 ttbar2021]$ source doDumpTK\r\n==> bta.log <==\r\ndropped waiting message count 0\r\n||Counters | nEvents | nHits | nCells | nTuples | nFitTacks  |  nLooseTracks  |  nGoodTracks | nUsedHits | nDupHits | nFishCells | nKilledCells | nUsedCells | nZeroTrackCells ||\r\nCounters Raw 10 121715 1020413 46199 32978 16813 9178 54169 36415 4813 8806 80227 141851\r\nCounters Norm 10 ||  12171.5|  102041.3|  4619.9|  3297.8|  1681.3|  917.8|  5416.9|  3641.5|  0.005|  0.009|  0.079|  0.139||\r\n\r\n==> btb.log <==\r\ndropped waiting message count 0\r\n||Counters | nEvents | nHits | nCells | nTuples | nFitTacks  |  nLooseTracks  |  nGoodTracks | nUsedHits | nDupHits | nFishCells | nKilledCells | nUsedCells | nZeroTrackCells ||\r\nCounters Raw 10 121715 1020413 46205 32979 16808 9180 54169 36421 4810 8805 80227 141848\r\nCounters Norm 10 ||  12171.5|  102041.3|  4620.5|  3297.9|  1680.8|  918.0|  5416.9|  3642.1|  0.005|  0.009|  0.079|  0.139||\r\n\r\n==> btc.log <==\r\ndropped waiting message count 0\r\n||Counters | nEvents | nHits | nCells | nTuples | nFitTacks  |  nLooseTracks  |  nGoodTracks | nUsedHits | nDupHits | nFishCells | nKilledCells | nUsedCells | nZeroTrackCells ||\r\nCounters Raw 10 121715 1020413 46202 32978 16807 9181 54170 36420 4807 8806 80227 141849\r\nCounters Norm 10 ||  12171.5|  102041.3|  4620.2|  3297.8|  1680.7|  918.1|  5417.0|  3642.0|  0.005|  0.009|  0.079|  0.139||\r\n  16815  285853 1976068 bta.txt\r\n  16810  285768 1975451 btb.txt\r\n  16809  285751 1975331 btc.txt\r\n  50434  857372 5926850 total\r\n    204    1955   13446\r\n    251    2393   16459\r\n    248    2373   16396\r\n```\r\n\r\n\r\nIn particular with this PR (no break) comparing 10 events at track level \r\nNO difference in HP quadruplets, only one HP triplet differs.\r\nthe rest are loose triplets (and a couple of loose quadruplets)\r\nREMINDER:\r\nloose tracks are in the collection ONLY to be used for seeding or for algorithms that perform some sort of pre-cleaning\r\n(often a simple association to trimmed-vertices is enough).\r\n\r\nMaking the various ambiguity solvers deterministic and order independent will be much harder and costly\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n", "branch": "master", "changed_files": 6, "comments": 0, "commits": 9, "created_at": "1648551913", "deletions": 25, "labels": ["reconstruction-pending", "pending-signatures", "tests-pending", "orp-pending", "code-checks-pending"], "milestone": "CMSSW_12_4_X", "number": 37398, "release-notes": [], "review_comments": 0, "state": "open", "title": "Stabilize Fishbone", "updated_at": "1648552255", "user": "VinInn"}