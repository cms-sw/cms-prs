{"additions": 2, "auther_ref": "pmandrik-patch-DQMFileSaverPB-master", "auther_sha": "43cc06b19eaf9a00e4106ec10607c12e1fbb858f", "author": "pmandrik", "body": "#### PR description:\r\n\r\nFrom Srecko Morovic mail :\r\n\"We have been seeing rare issues with writing output files in HLT with symptoms of the file sometimes being closed prematurely [1]. We saw similar issues in recent DAQ3 tests that used to happen when DQM File Saver is included (but was not investigated in detail at that time).\r\nOn inspecting the code, it turns out that in this module there is a protocol buffer file stream that is closed, and after that also the file descriptor [2] gets closed. In PB documentation [3] it's stated that the file is already closed by closing the PB stream, so the other close should not be necessary.\r\nThis could cause the race condition we're seeing, e.g. when in a multi-threaded setup some other thread opens the same file descriptor ID between two close calls. Maybe it also is the cause for other problems we have, such as frontier issues we see occasionally, which could be caused by socket fd close called prematurely.\r\nIn my private tests I see the empty output file problem disappearing when I remove line cms-sw#326. Open fd count per process remains constant (so there is no fd leak introduced by this).\r\nConclusion from this is that line 326 should be removed. Please have a look and cross-check yourself.\r\n\r\n[1] http://cmsonline.cern.ch/cms-elog/1127051\r\n[2] https://github.com/cms-sw/cmssw/blob/master/DQMServices/FileIO/plugins/DQMFileSaverPB.cc#L326\r\n[3] https://developers.google.com/protocol-buffers/docs/reference/cpp/google.protobuf.io.zero_copy_stream_impl#FileOutputStream.Close.details\r\n\"\r\n#### PR validation:\r\n\r\nbackport tested at p5 DQM playback", "branch": "master", "changed_files": 1, "closed_at": "1635922438", "comments": 13, "commits": 1, "created_at": "1635418730", "deletions": 5, "labels": ["dqm-approved", "fully-signed", "tests-approved", "orp-approved", "code-checks-approved"], "merge_commit_sha": "fc5836fbbac3d04d652b0eaf50d4d7d72ecf2a1c", "merged_at": "1635922438", "merged_by": "cmsbuild", "milestone": "CMSSW_12_2_X", "number": 35881, "release-notes": [], "review_comments": 0, "state": "closed", "title": "Duplicate file descriptor closure in DQMFileSaverPB fix", "updated_at": "1635922438", "user": "pmandrik"}